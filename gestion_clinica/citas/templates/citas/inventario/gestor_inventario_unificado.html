{% extends 'citas/base.html' %}
{% load custom_filters %}

{% block title %}Gestión de Inventario - Clínica Dental{% endblock %}
{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    :root {
        --turquesa-primary: #14b8a6;
        --turquesa-dark: #0d9488;
        --turquesa-light: #5eead4;
        --turquesa-bg: #f0fdfa;
    }
    
    .inventario-container {
        display: flex;
        gap: 0;
        margin-top: 0;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
        align-items: flex-start;
        width: 100%;
        position: relative;
    }
    
    /* Sidebar Lateral - pegado a la izquierda */
    .inventario-sidebar {
        width: 260px;
        flex-shrink: 0;
        background: white;
        border-radius: 0;
        box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        padding: 20px 0;
        min-height: calc(100vh - 99px);
        position: fixed;
        top: 99px;
        left: 0;
        margin-left: 0;
        border-left: none;
        border-right: 2px solid #e5e7eb;
        z-index: 100;
        overflow-y: auto;
        max-height: calc(100vh - 99px);
        will-change: auto;
        transform: translateZ(0);
        backface-visibility: hidden;
    }
    
    .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        padding-top: 12px;
        background: #f0fdfa;
        border-radius: 0;
    }
    
    .sidebar-header h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .sidebar-header h2 i {
        color: var(--primary-color);
        font-size: 1.2rem;
    }
    
    .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 0 12px;
        margin-top: 8px;
    }
    
    .sidebar-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        border-radius: 6px;
        text-decoration: none;
        color: #64748b;
        font-weight: 500;
        transition: all 0.2s ease;
        font-size: 0.95rem;
        cursor: pointer;
    }
    
    .sidebar-menu-item:hover {
        background: #f8fafc;
        color: var(--primary-color);
    }
    
    .sidebar-menu-item.active {
        background: var(--primary-color);
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
    }
    
    .sidebar-menu-item.active i {
        color: white;
    }
    
    .sidebar-menu-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        transition: color 0.2s ease;
        font-size: 1rem;
    }
    
    .sidebar-menu-item:hover i {
        color: var(--primary-color);
    }
    
    .sidebar-menu-item.active i {
        color: white;
    }
    
    
    /* Contenido Principal */
    .inventario-content {
        flex: 1;
        min-width: 0;
        margin-left: 260px; /* Ancho del sidebar */
        margin-right: 0;
        margin-top: 0;
        padding: 12px 24px;
        padding-top: 12px;
        box-sizing: border-box;
        width: calc(100% - 260px);
        max-width: calc(100vw - 260px);
        position: relative;
        will-change: auto;
    }
    
    .content-section:not(.active) {
        display: none !important;
    }
    
    .content-section.active {
        display: block !important;
        animation: fadeIn 0.2s ease;
    }
    
    /* Header con Estadísticas */
    .header-with-stats {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        margin-top: 0;
        gap: 24px;
        width: 100%;
        max-width: 100%;
        padding: 0;
        flex-wrap: wrap;
    }

    .page-header {
        flex: 1;
        min-width: 0;
        padding: 0;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        line-height: 1.2;
    }

    .page-title i {
        color: #1e293b;
    }

    .page-subtitle {
        color: #64748b;
        font-size: 15px;
        margin: 0;
        line-height: 1.4;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        min-width: 600px;
    }

    .stat-card {
        background: white;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.3s ease;
        border-left: 4px solid var(--turquesa-primary);
        min-width: 140px;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.15);
    }

    .stat-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .stat-content {
        flex: 1;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        margin-top: 4px;
    }

    .section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 24px;
        width: 100%;
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
        width: 100%;
    }

    .search-filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        flex: 1;
        min-width: 0;
    }

    .search-box {
        position: relative;
        min-width: 200px;
        flex: 1;
        max-width: 400px;
    }

    .search-box i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .search-box input, .search-box select {
        width: 100%;
        padding: 10px 12px 10px 40px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .search-box input:focus, .search-box select:focus {
        outline: none;
        border-color: var(--turquesa-primary);
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));
        color: white;
        box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    /* Tablas - Estilo unificado con el resto del sistema */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        margin-top: 0;
        animation: fadeIn 0.4s ease;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background: linear-gradient(135deg, #1f2937, #111827);
        color: white;
        border-bottom: 2px solid #374151;
    }

    .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: white;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table th.text-center {
        text-align: center;
    }

    .data-table th i {
        margin-right: 8px;
        opacity: 0.9;
        color: white;
    }

    .data-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .data-table tbody tr:hover {
        background: #f8fafc;
    }

    .data-table tbody tr.inactive-row {
        opacity: 0.6;
    }
    
    .data-table tbody tr.alert-row {
        background: #fef2f2 !important;
        border-left: 4px solid #ef4444;
    }
    
    .data-table tbody tr.alert-row:hover {
        background: #fee2e2 !important;
    }
    
    .data-table tbody tr.alert-row td {
        color: #991b1b;
        font-weight: 500;
    }

    .data-table td {
        padding: 16px;
        color: #1e293b;
        font-size: 14px;
        vertical-align: middle;
    }

    /* Estilos mejorados para la lista de insumos */
    .insumo-cell-content {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .insumo-image-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(20, 184, 166, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .insumo-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .insumo-image-wrapper:hover .insumo-image {
        transform: scale(1.1);
    }

    .insumo-icon-placeholder {
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .insumo-info {
        min-width: 0;
        flex: 1;
    }

    .insumo-name {
        display: block;
        color: #1e293b;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .insumo-description {
        display: block;
        font-size: 12px;
        color: #64748b;
        line-height: 1.4;
    }

    .categoria-badge {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .categoria-materiales {
        background: #d1fae5;
        color: #065f46;
    }

    .categoria-instrumentos {
        background: #dbeafe;
        color: #1e40af;
    }

    .categoria-medicamentos {
        background: #fce7f3;
        color: #9f1239;
    }

    .categoria-equipos {
        background: #fef3c7;
        color: #92400e;
    }

    .categoria-consumibles {
        background: #e0e7ff;
        color: #3730a3;
    }

    .categoria-otros {
        background: #f3f4f6;
        color: #374151;
    }

    .stock-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stock-amount {
        display: block;
        font-size: 15px;
        font-weight: 600;
        line-height: 1.3;
    }

    .stock-normal {
        color: #1e293b;
    }

    .stock-bajo {
        color: #f59e0b;
    }

    .stock-agotado {
        color: #ef4444;
    }

    .stock-minimum {
        font-size: 12px;
        color: #64748b;
    }

    .precio-amount {
        color: #1e293b;
        font-size: 15px;
        font-weight: 600;
    }

    .precio-empty {
        color: #9ca3af;
        font-size: 14px;
    }

    .proveedor-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #1e293b;
    }

    .proveedor-info i {
        color: var(--turquesa-primary);
        width: 16px;
        flex-shrink: 0;
    }

    .proveedor-empty {
        color: #9ca3af;
        font-size: 14px;
    }

    .insumo-row:hover {
        background: #f8fafc;
    }

    .insumo-row:hover .insumo-image-wrapper {
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
        transform: translateY(-2px);
    }

    .ubicacion-info {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: #1e293b;
    }

    .ubicacion-info i {
        color: var(--turquesa-primary);
        font-size: 12px;
    }

    .ubicacion-empty {
        color: #9ca3af;
        font-size: 14px;
    }

    .estado-badge {
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .estado-disponible {
        background: #d1fae5;
        color: #065f46;
    }

    .estado-stock-bajo {
        background: #fef3c7;
        color: #92400e;
    }

    .estado-agotado {
        background: #fee2e2;
        color: #991b1b;
    }

    .estado-vencimiento {
        background: #fef3c7;
        color: #92400e;
    }

    .estado-badge i {
        font-size: 11px;
    }

    .proveedores-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .proveedor-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .proveedor-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: var(--turquesa-primary);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 4rem;
        color: #d1d5db;
        margin-bottom: 16px;
        display: block;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .empty-state p {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 24px;
    }

    /* Estilos para cards de proveedores - Simplificado */
    .proveedor-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }

    .proveedor-info-main {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .proveedor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .proveedor-name {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
        line-height: 1.3;
    }

    .proveedor-contact {
        font-size: 0.8125rem;
        color: #64748b;
        line-height: 1.4;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        line-height: 1.4;
        white-space: nowrap;
    }

    .status-active {
        background: #d1fae5;
        color: #065f46;
    }

    .status-inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .proveedor-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
        padding: 0;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8125rem;
        color: #4b5563;
        padding: 4px 0;
    }

    .detail-item i {
        color: var(--turquesa-primary);
        width: 16px;
        flex-shrink: 0;
    }

    .proveedor-insumos {
        margin-bottom: 12px;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
    }

    .insumos-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: #f1f5f9;
        color: #475569;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        line-height: 1.4;
    }

    .proveedor-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
        padding-top: 12px;
        border-top: 1px solid #e5e7eb;
        position: relative;
        z-index: 10;
    }

    .proveedor-actions .btn-action {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        position: relative;
        z-index: 20;
        pointer-events: auto;
        white-space: nowrap;
    }

    .proveedor-actions .btn-action:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
    }

    .proveedor-actions .btn-edit {
        background: var(--turquesa-bg);
        color: var(--turquesa-dark);
        border: 1px solid var(--turquesa-primary);
    }

    .proveedor-actions .btn-edit:hover {
        background: var(--turquesa-primary);
        color: white;
        box-shadow: 0 2px 6px rgba(20, 184, 166, 0.25);
    }

    .proveedor-actions .btn-delete {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .proveedor-actions .btn-delete:hover {
        background: #ef4444;
        color: white;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
    }

    .proveedor-card.inactive {
        opacity: 0.7;
    }

    /* Estilos para botones de acción en tablas */
    .action-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .btn-action {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        width: 32px;
        height: 32px;
    }

    .btn-action.btn-primary {
        background: var(--turquesa-bg);
        color: var(--turquesa-dark);
    }

    .btn-action.btn-primary:hover {
        background: var(--turquesa-primary);
        color: white;
    }

    .action-buttons .btn-action.btn-edit {
        background: #dbeafe;
        color: #1e40af;
    }

    .action-buttons .btn-action.btn-edit:hover {
        background: #3b82f6;
        color: white;
    }

    .action-buttons .btn-action.btn-delete {
        background: #fee2e2;
        color: #991b1b;
    }

    .action-buttons .btn-action.btn-delete:hover {
        background: #ef4444;
        color: white;
    }

    .btn-action.btn-info {
        background: #e0f2fe;
        color: #0c4a6e;
    }

    .btn-action.btn-info:hover {
        background: #0ea5e9;
        color: white;
    }

    @media (max-width: 1200px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            min-width: auto;
        }
    }
    
    @media (max-width: 1024px) {
        .inventario-container {
            flex-direction: column;
            margin-left: 0;
        }
        
        .inventario-sidebar {
            width: 100%;
            position: static;
            border-radius: 12px;
            margin-bottom: 24px;
            min-height: auto;
            max-height: none;
            top: auto;
            left: auto;
        }
        
        .inventario-content {
            margin-left: 0;
            padding: 16px;
            width: 100%;
            max-width: 100%;
        }
        
        .sidebar-menu {
            flex-direction: row;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .sidebar-menu-item {
            white-space: nowrap;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            min-width: auto;
        }
        
        .proveedor-details {
            grid-template-columns: 1fr;
        }
        
        .header-with-stats {
            flex-direction: column;
            gap: 16px;
        }
        
        .dashboard-compact {
            width: 100%;
        }
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .search-filters {
            width: 100%;
        }
        
        .search-box {
            max-width: 100%;
        }
    }
    
    /* Override del padding del main-content del base.html */
    .main-content {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }
    
    .inventario-content * {
        box-sizing: border-box;
    }

    /* Paginación - Estilo unificado */
    .pagination {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }

    .pagination-info {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .page-btn {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 36px;
    }

    .page-btn:hover:not(.disabled) {
        background: #f3f4f6;
        border-color: var(--turquesa-primary);
        color: var(--turquesa-primary);
    }

    .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
    }

    .page-current {
        padding: 8px 16px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        color: #374151;
        font-weight: 500;
    }

    /* Sistema de Notificaciones */
    .notification-container {
        position: fixed;
        top: 90px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
        pointer-events: none;
    }

    .notification {
        background: white;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        pointer-events: auto;
        border-left: 4px solid;
        min-width: 320px;
        max-width: 400px;
    }

    .notification.success {
        border-left-color: #10b981;
    }

    .notification.error {
        border-left-color: #ef4444;
    }

    .notification.warning {
        border-left-color: #f59e0b;
    }

    .notification.info {
        border-left-color: var(--turquesa-primary);
    }

    .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        color: white;
    }

    .notification.success .notification-icon {
        background: #10b981;
    }

    .notification.error .notification-icon {
        background: #ef4444;
    }

    .notification.warning .notification-icon {
        background: #f59e0b;
    }

    .notification.info .notification-icon {
        background: var(--turquesa-primary);
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-message {
        font-size: 0.875rem;
        color: #64748b;
        line-height: 1.5;
    }

    .notification-close {
        background: transparent;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
    }

    .notification-close:hover {
        background: #f1f5f9;
        color: #64748b;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .notification.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Estilos para Modal de Confirmación */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-container-simple {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        width: min(90vw, 500px);
        max-width: 500px;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 20px 24px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-delete-edit {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-delete-edit:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
</style>

<div class="inventario-container">
    <!-- Contenedor de Notificaciones -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <!-- Datos de mensajes Django para JavaScript -->
    {% if messages %}
    <script type="application/json" id="django-messages-data">
    [
        {% for message in messages %}
        {
            "type": "{{ message.tags|default:'info' }}",
            "text": "{{ message|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
    </script>
    {% endif %}
    
    <!-- Sidebar Lateral -->
    <div class="inventario-sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-warehouse"></i> Inventario</h2>
        </div>
        <nav class="sidebar-menu">
            <a href="#" class="sidebar-menu-item {% if seccion == 'insumos' %}active{% endif %}" data-seccion="insumos">
                <i class="fas fa-boxes"></i>
                <span>Insumos</span>
            </a>
            <a href="#" class="sidebar-menu-item {% if seccion == 'proveedores' %}active{% endif %}" data-seccion="proveedores">
                <i class="fas fa-truck"></i>
                <span>Proveedores</span>
            </a>
            <a href="#" class="sidebar-menu-item {% if seccion == 'solicitudes' %}active{% endif %}" data-seccion="solicitudes">
                <i class="fas fa-file-invoice"></i>
                <span>Solicitudes</span>
            </a>
        </nav>
    </div>
    
    <!-- Contenido Principal -->
    <div class="inventario-content">
        <!-- Sección: Insumos -->
        <div id="seccion-insumos" class="content-section {% if seccion == 'insumos' %}active{% endif %}">
            {% include 'citas/inventario/secciones/_insumos.html' %}
        </div>
        
        <!-- Sección: Proveedores -->
        <div id="seccion-proveedores" class="content-section {% if seccion == 'proveedores' %}active{% endif %}">
            {% include 'citas/inventario/secciones/_proveedores.html' %}
        </div>
        
        <!-- Sección: Solicitudes -->
        <div id="seccion-solicitudes" class="content-section {% if seccion == 'solicitudes' %}active{% endif %}">
            {% include 'citas/inventario/secciones/_solicitudes.html' %}
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación de Insumo -->
<div id="modalConfirmarEliminacionInsumo" class="modal-overlay" onclick="if(event.target === this) cerrarModalConfirmarEliminacionInsumo()">
    <div class="modal-content modal-container-simple" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
            <button class="modal-close" onclick="cerrarModalConfirmarEliminacionInsumo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Estás seguro de eliminar este insumo?</h3>
                <p style="margin: 0 0 16px 0; color: #64748b; line-height: 1.6;">
                    Esta acción es <strong>PERMANENTE</strong> y eliminará:
                </p>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: left; margin: 16px 0;">
                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                        <li>El registro del insumo en el sistema</li>
                        <li>Su imagen (si existe)</li>
                        <li>Todo su historial de movimientos</li>
                    </ul>
                </div>
                <p style="margin: 16px 0 0 0; color: #ef4444; font-weight: 600;">
                    Esta acción NO se puede deshacer.
                </p>
                <p style="margin: 12px 0 0 0; color: #64748b; font-size: 0.9rem;">
                    Insumo: <strong id="insumoNombreEliminar" style="color: #1e293b;"></strong>
                </p>
                <input type="hidden" id="insumoIdParaEliminar" value="">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalConfirmarEliminacionInsumo()" style="background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <form method="post" action="" id="formEliminarInsumo" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-delete-edit" id="btnConfirmarEliminacionInsumo">
                    <i class="fas fa-trash-alt"></i> Sí, eliminar insumo
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Nueva Solicitud -->
<div id="modalNuevaSolicitud" class="modal-overlay" onclick="if(event.target === this) cerrarModalSolicitud()">
    <div class="modal-content modal-container-simple" style="max-width: 700px;" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));">
            <h3><i class="fas fa-paper-plane"></i> Nueva Solicitud de Insumos</h3>
            <button class="modal-close" onclick="cerrarModalSolicitud()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="{% url 'enviar_solicitud_insumo' %}" id="formNuevaSolicitud">
                {% csrf_token %}
                
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div>
                        <label for="proveedor_solicitud" style="display: block; font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 8px;">
                            <i class="fas fa-truck"></i> Proveedor <span style="color: #ef4444;">*</span>
                        </label>
                        <select id="proveedor_solicitud" name="proveedor_id" class="form-control" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem;">
                            <option value="">-- Seleccionar proveedor --</option>
                            {% for proveedor in proveedores_activos %}
                            <option value="{{ proveedor.id }}">{{ proveedor.nombre }} - {{ proveedor.rut }}</option>
                            {% endfor %}
                        </select>
                        <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Selecciona el proveedor al que realizarás la solicitud</small>
                    </div>
                    
                    <div id="insumos-solicitud-section" style="display: none;">
                        <label style="display: block; font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 8px;">
                            <i class="fas fa-boxes"></i> Insumos del Proveedor <span style="color: #ef4444;">*</span>
                        </label>
                        <div id="insumos-solicitud-container" style="max-height: 300px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f9fafb;">
                            <p style="color: #6b7280; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;">Selecciona un proveedor para ver sus insumos</p>
                        </div>
                        <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Selecciona los insumos que necesitas y especifica las cantidades</small>
                    </div>
                    
                    <div>
                        <label for="fecha_entrega_solicitud" style="display: block; font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 8px;">
                            <i class="fas fa-calendar-check"></i> Fecha de Entrega Esperada <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="date" id="fecha_entrega_solicitud" name="fecha_entrega" class="form-control" required style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem;">
                        <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">Fecha ideal en la que esperas recibir los insumos</small>
                    </div>
                    
                    <div>
                        <label for="observaciones_solicitud" style="display: block; font-weight: 600; color: #374151; font-size: 0.875rem; margin-bottom: 8px;">
                            <i class="fas fa-sticky-note"></i> Observaciones
                        </label>
                        <textarea id="observaciones_solicitud" name="observaciones" class="form-control" rows="3" placeholder="Observaciones adicionales sobre la solicitud..." style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; resize: vertical;"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalSolicitud()" style="background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" form="formNuevaSolicitud" class="btn-primary" style="background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark)); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-paper-plane"></i> Enviar Solicitud
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Marcar Solicitud como Recibida -->
<div id="modalConfirmarSolicitudRecibida" class="modal-overlay" onclick="if(event.target === this) cerrarModalConfirmarSolicitudRecibida()">
    <div class="modal-content modal-container-simple" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark));">
            <h3 style="margin: 0; color: white; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle"></i>
                Confirmar Recepción de Solicitud
            </h3>
            <button class="modal-close" onclick="cerrarModalConfirmarSolicitudRecibida()" style="color: white;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #d1fae5; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check-circle" style="font-size: 32px; color: var(--turquesa-primary);"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Estás seguro de marcar esta solicitud como recibida?</h3>
                <p style="margin: 0 0 16px 0; color: #64748b; line-height: 1.6;">
                    Esta acción registrará automáticamente:
                </p>
                <div style="background: #f8fafc; border-left: 4px solid var(--turquesa-primary); padding: 16px; border-radius: 8px; text-align: left; margin: 16px 0;">
                    <ul style="margin: 0; padding-left: 20px; color: #374151; line-height: 1.8;">
                        <li>Entrada de stock del insumo</li>
                        <li>Movimiento en el historial de inventario</li>
                        <li>Egreso en finanzas (si aplica)</li>
                    </ul>
                </div>
                <p style="margin: 16px 0 0 0; color: #64748b; font-size: 0.9rem; font-style: italic;">
                    Esta acción no se puede deshacer.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalConfirmarSolicitudRecibida()" style="background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn-success" id="btnConfirmarSolicitudRecibida" onclick="confirmarMarcarSolicitudRecibida()" style="background: linear-gradient(135deg, var(--turquesa-primary), var(--turquesa-dark)); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);">
                <i class="fas fa-check-circle"></i> Sí, Marcar como Recibida
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación de Proveedor -->
<div id="modalConfirmarEliminacionProveedor" class="modal-overlay" onclick="if(event.target === this) cerrarModalConfirmarEliminacionProveedor()">
    <div class="modal-content modal-container-simple" onclick="event.stopPropagation()">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
            <button class="modal-close" onclick="cerrarModalConfirmarEliminacionProveedor()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Estás seguro de eliminar este proveedor?</h3>
                <p style="margin: 0 0 16px 0; color: #64748b; line-height: 1.6;">
                    Esta acción es <strong>PERMANENTE</strong> y eliminará:
                </p>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; text-align: left; margin: 16px 0;">
                    <ul style="margin: 0; padding-left: 20px; color: #374151;">
                        <li>El registro del proveedor en el sistema</li>
                        <li>Sus relaciones con insumos</li>
                        <li>Sus solicitudes y pedidos asociados</li>
                    </ul>
                </div>
                <p style="margin: 16px 0 0 0; color: #ef4444; font-weight: 600;">
                    Esta acción NO se puede deshacer.
                </p>
                <p style="margin: 12px 0 0 0; color: #64748b; font-size: 0.9rem;">
                    Proveedor: <strong id="proveedorNombreEliminar" style="color: #1e293b;"></strong>
                </p>
                <input type="hidden" id="proveedorIdParaEliminar" value="">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="cerrarModalConfirmarEliminacionProveedor()" style="background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn-delete-edit" id="btnConfirmarEliminacionProveedor" onclick="confirmarEliminarProveedorFinal()">
                <i class="fas fa-trash-alt"></i> Sí, eliminar proveedor
            </button>
        </div>
    </div>
</div>

<script>
    function cambiarSeccion(seccion) {
        // Ocultar todas las secciones explícitamente
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = 'none';
            section.classList.remove('active');
        });
        
        // Remover active de todos los items del menú
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Mostrar la sección seleccionada
        const seccionElement = document.getElementById('seccion-' + seccion);
        if (seccionElement) {
            seccionElement.style.display = 'block';
            seccionElement.classList.add('active');
        }
        
        // Activar el item del menú correspondiente
        const menuItem = document.querySelector(`.sidebar-menu-item[data-seccion="${seccion}"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }
        
        // Actualizar URL sin recargar
        const url = new URL(window.location);
        url.searchParams.set('seccion', seccion);
        window.history.pushState({}, '', url);
    }
    
    // Event listeners para los items del menú
    document.addEventListener('DOMContentLoaded', function() {
        // Agregar event listeners a los items del menú
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const seccion = this.getAttribute('data-seccion');
                if (seccion) {
                    cambiarSeccion(seccion);
                }
            });
        });
        
        // Cargar sección desde URL al cargar la página (sin animación para evitar movimiento)
        const urlParams = new URLSearchParams(window.location.search);
        const seccion = urlParams.get('seccion') || 'insumos';
        
        // Ocultar todas las secciones que NO sean la activa (explicitamente)
        document.querySelectorAll('.content-section').forEach(section => {
            if (!section.classList.contains('active')) {
                section.style.display = 'none';
            }
            // Si no es la sección correcta, remover active
            const sectionId = section.id.replace('seccion-', '');
            if (sectionId !== seccion) {
                section.classList.remove('active');
                section.style.display = 'none';
            }
        });
        
        // Remover active de todos los items del menú
        document.querySelectorAll('.sidebar-menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Mostrar la sección correcta sin animación
        const seccionElement = document.getElementById('seccion-' + seccion);
        if (seccionElement) {
            seccionElement.style.display = 'block';
            seccionElement.classList.add('active');
        }
        
        // Activar el item del menú correspondiente
        const menuItem = document.querySelector(`.sidebar-menu-item[data-seccion="${seccion}"]`);
        if (menuItem) {
            menuItem.classList.add('active');
        }
    });
    
    // Funciones para modales de proveedores (si se necesitan)
    function mostrarModalCrearProveedor() {
        // Redirigir a la vista de crear proveedor o abrir modal
        window.location.href = '{% url "crear_proveedor" %}';
    }
    
    function mostrarModalSolicitud() {
        document.getElementById('modalNuevaSolicitud').classList.add('show');
        document.body.style.overflow = 'hidden';
        // Establecer fecha mínima como hoy
        const fechaInput = document.getElementById('fecha_entrega_solicitud');
        if (fechaInput) {
            const today = new Date().toISOString().split('T')[0];
            fechaInput.setAttribute('min', today);
        }
    }
    
    function cerrarModalSolicitud() {
        document.getElementById('modalNuevaSolicitud').classList.remove('show');
        document.body.style.overflow = '';
        // Limpiar formulario
        const form = document.getElementById('formNuevaSolicitud');
        if (form) {
            form.reset();
            document.getElementById('insumos-solicitud-container').innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;">Selecciona un proveedor para ver sus insumos</p>';
        }
    }
    
    function editarProveedor(id, nombre, rut, email, telefono, direccion, contacto, sitioWeb, notas, activo) {
        // Construir la URL de edición
        const baseUrl = '{% url "editar_proveedor" 999 %}'.replace('999', id.toString());
        window.location.href = baseUrl;
    }
    
    function solicitarAProveedor(proveedorId, nombre) {
        mostrarModalSolicitud();
    }
    
    function confirmarEliminarProveedor(id, nombre) {
        document.getElementById('proveedorIdParaEliminar').value = id;
        document.getElementById('proveedorNombreEliminar').textContent = nombre;
        document.getElementById('modalConfirmarEliminacionProveedor').classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function cerrarModalConfirmarEliminacionProveedor() {
        document.getElementById('modalConfirmarEliminacionProveedor').classList.remove('show');
        document.body.style.overflow = '';
    }
    
    function confirmarEliminarProveedorFinal() {
        const id = document.getElementById('proveedorIdParaEliminar').value;
        if (id) {
            window.location.href = '{% url "eliminar_proveedor" 999 %}'.replace('999', id);
        }
    }
    
    // Funciones para eliminar insumo
    function confirmarEliminarInsumo(id, nombre) {
        document.getElementById('insumoIdParaEliminar').value = id;
        document.getElementById('insumoNombreEliminar').textContent = nombre;
        const form = document.getElementById('formEliminarInsumo');
        form.action = '{% url "eliminar_insumo" 999 %}'.replace('999', id);
        document.getElementById('modalConfirmarEliminacionInsumo').classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function cerrarModalConfirmarEliminacionInsumo() {
        document.getElementById('modalConfirmarEliminacionInsumo').classList.remove('show');
        document.body.style.overflow = '';
    }
    
    // Función para modal de crear insumo
    function abrirModalCrearInsumo() {
        window.location.href = '{% url "agregar_insumo" %}';
    }
    
    // Sistema de Notificaciones
    function showNotification(type, message, duration = 5000) {
        const validTypes = ['success', 'error', 'warning', 'info'];
        type = validTypes.includes(type) ? type : 'info';
        
        let container = document.getElementById('notificationContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'notification-container';
            document.body.appendChild(container);
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: '<i class="fas fa-check-circle"></i>',
            error: '<i class="fas fa-exclamation-circle"></i>',
            warning: '<i class="fas fa-exclamation-triangle"></i>',
            info: '<i class="fas fa-info-circle"></i>'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icons[type]}</div>
            <div class="notification-content">
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close" onclick="this.closest('.notification').remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(notification);
        
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('hiding');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        return notification;
    }
    
    // Cargar insumos cuando se seleccione un proveedor en el modal de solicitud
    document.addEventListener('DOMContentLoaded', function() {
        const proveedorSelect = document.getElementById('proveedor_solicitud');
        if (proveedorSelect) {
            proveedorSelect.addEventListener('change', function() {
                const proveedorId = this.value;
                const insumosSection = document.getElementById('insumos-solicitud-section');
                const insumosContainer = document.getElementById('insumos-solicitud-container');
                
                if (proveedorId) {
                    insumosSection.style.display = 'block';
                    insumosContainer.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando insumos...</p>';
                    
                    fetch(`/trabajadores/api/insumos-proveedor/${proveedorId}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.insumos.length > 0) {
                                let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
                                data.insumos.forEach(insumo => {
                                    html += `
                                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <input type="checkbox" name="insumos[]" value="${insumo.id}" id="insumo_solicitud_${insumo.id}" class="insumo-checkbox-solicitud" style="width: auto; cursor: pointer;">
                                            <label for="insumo_solicitud_${insumo.id}" style="flex: 1; cursor: pointer; margin: 0;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong style="color: #1f2937; font-size: 0.875rem;">${insumo.nombre}</strong>
                                                        ${insumo.categoria ? `<span style="display: block; color: #6b7280; font-size: 0.75rem; margin-top: 2px;">${insumo.categoria}</span>` : ''}
                                                    </div>
                                                    <div style="text-align: right;">
                                                        ${insumo.precio_unitario ? `<span style="color: #1f2937; font-weight: 600; font-size: 0.875rem;">$${parseFloat(insumo.precio_unitario).toLocaleString('es-CL')}</span>` : '<span style="color: #9ca3af; font-size: 0.75rem;">Sin precio</span>'}
                                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                                            <input type="number" name="cantidad_${insumo.id}" min="1" value="1" placeholder="Cantidad" 
                                                                   class="cantidad-input-solicitud" style="width: 80px; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem;" 
                                                                   disabled>
                                                            <span style="color: #6b7280; font-size: 0.75rem;">${insumo.unidad_medida}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                                insumosContainer.innerHTML = html;
                                
                                // Habilitar/deshabilitar inputs de cantidad según checkbox
                                document.querySelectorAll('.insumo-checkbox-solicitud').forEach(checkbox => {
                                    checkbox.addEventListener('change', function() {
                                        const cantidadInput = this.closest('div').querySelector('.cantidad-input-solicitud');
                                        cantidadInput.disabled = !this.checked;
                                        if (!this.checked) {
                                            cantidadInput.value = 1;
                                        }
                                    });
                                });
                            } else {
                                insumosContainer.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-info-circle"></i> Este proveedor no tiene insumos asociados</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            insumosContainer.innerHTML = '<p style="color: #ef4444; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-exclamation-circle"></i> Error al cargar los insumos</p>';
                        });
                } else {
                    insumosSection.style.display = 'none';
                    insumosContainer.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; margin: 0; text-align: center; padding: 20px;">Selecciona un proveedor para ver sus insumos</p>';
                }
            });
        }
        
        // Validación del formulario de solicitud
        const formSolicitud = document.getElementById('formNuevaSolicitud');
        if (formSolicitud) {
            formSolicitud.addEventListener('submit', function(e) {
                const proveedor = document.getElementById('proveedor_solicitud').value;
                const fechaEntrega = document.getElementById('fecha_entrega_solicitud').value;
                const insumosSeleccionados = document.querySelectorAll('.insumo-checkbox-solicitud:checked');
                
                if (!proveedor) {
                    e.preventDefault();
                    showNotification('error', 'Por favor, selecciona un proveedor.');
                    return false;
                }
                
                if (!fechaEntrega) {
                    e.preventDefault();
                    showNotification('error', 'Por favor, selecciona una fecha de entrega.');
                    return false;
                }
                
                if (insumosSeleccionados.length === 0) {
                    e.preventDefault();
                    showNotification('error', 'Por favor, selecciona al menos un insumo.');
                    return false;
                }
                
                // Validar que todas las cantidades sean válidas
                let cantidadValida = true;
                insumosSeleccionados.forEach(checkbox => {
                    const cantidadInput = checkbox.closest('div').querySelector('.cantidad-input-solicitud');
                    const cantidad = parseInt(cantidadInput.value) || 0;
                    if (cantidad < 1) {
                        cantidadValida = false;
                    }
                });
                
                if (!cantidadValida) {
                    e.preventDefault();
                    showNotification('error', 'Por favor, verifica que todas las cantidades sean mayores a 0.');
                    return false;
                }
            });
        }
    });
    
    // Variable global para almacenar el ID de la solicitud a procesar
    let solicitudIdPendiente = null;
    let botonSolicitudOriginal = null;
    
    // Función para abrir el modal de confirmación
    function marcarSolicitudRecibida(solicitudId, buttonElement) {
        console.log('marcarSolicitudRecibida llamada con ID:', solicitudId, 'tipo:', typeof solicitudId);
        
        // Convertir a número si es string
        const idNumero = parseInt(solicitudId);
        if (isNaN(idNumero) || idNumero <= 0) {
            console.error('Error: solicitudId es inválido', solicitudId);
            showNotification('error', 'Error: ID de solicitud inválido.');
            return;
        }
        
        solicitudIdPendiente = idNumero;
        console.log('solicitudIdPendiente establecido a:', solicitudIdPendiente);
        
        // Obtener el botón desde el elemento pasado o desde el evento
        const button = buttonElement || (window.event ? window.event.target.closest('button') : null);
        
        if (button) {
            botonSolicitudOriginal = {
                element: button,
                html: button.innerHTML,
                disabled: button.disabled
            };
        }
        
        const modal = document.getElementById('modalConfirmarSolicitudRecibida');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        } else {
            console.error('Modal no encontrado');
            showNotification('error', 'Error: No se pudo abrir el modal de confirmación.');
        }
    }
    
    // Función para cerrar el modal de confirmación
    function cerrarModalConfirmarSolicitudRecibida() {
        document.getElementById('modalConfirmarSolicitudRecibida').classList.remove('show');
        solicitudIdPendiente = null;
        botonSolicitudOriginal = null;
    }
    
    // Función para confirmar y procesar la solicitud
    function confirmarMarcarSolicitudRecibida() {
        // Guardar el ID en una variable local ANTES de cerrar el modal
        const solicitudId = solicitudIdPendiente;
        const botonOriginal = botonSolicitudOriginal;
        
        // Validar que el ID no sea null
        if (!solicitudId || solicitudId === 'null' || solicitudId === null) {
            console.error('Error: solicitudId es null o inválido', solicitudId);
            showNotification('error', 'Error: ID de solicitud inválido. Por favor, recarga la página.');
            cerrarModalConfirmarSolicitudRecibida();
            return;
        }
        
        // Cerrar el modal
        cerrarModalConfirmarSolicitudRecibida();
        
        // Mostrar indicador de carga en el botón
        if (botonOriginal && botonOriginal.element) {
            const button = botonOriginal.element;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
        }
        
        // Realizar petición AJAX usando la variable local
        fetch(`/trabajadores/solicitudes/${solicitudId}/marcar-recibida/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => {
            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Si no es JSON, probablemente es un error 404 HTML
                return response.text().then(text => {
                    console.error('Respuesta no JSON recibida:', text.substring(0, 200));
                    throw new Error(`Error del servidor (${response.status}): La solicitud no fue encontrada.`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification('success', data.message);
                // Recargar la página después de 1.5 segundos para actualizar la lista
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification('error', data.message || 'Error al marcar la solicitud como recibida.');
                if (botonOriginal && botonOriginal.element) {
                    const button = botonOriginal.element;
                    button.disabled = botonOriginal.disabled;
                    button.innerHTML = botonOriginal.html;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', error.message || 'Error de conexión al procesar la solicitud.');
            if (botonOriginal && botonOriginal.element) {
                const button = botonOriginal.element;
                button.disabled = botonOriginal.disabled;
                button.innerHTML = botonOriginal.html;
            }
        });
    }
    
    // Función auxiliar para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Mostrar notificaciones de Django messages
    document.addEventListener('DOMContentLoaded', function() {
        const messagesDataEl = document.getElementById('django-messages-data');
        if (messagesDataEl) {
            try {
                const messages = JSON.parse(messagesDataEl.textContent);
                messages.forEach(function(msg) {
                    const type = msg.type === 'error' ? 'error' : 
                                msg.type === 'warning' ? 'warning' : 
                                msg.type === 'success' ? 'success' : 'info';
                    showNotification(type, msg.text);
                });
            } catch (e) {
                console.error('Error al parsear mensajes Django:', e);
            }
        }
    });
</script>
{% endblock %}
