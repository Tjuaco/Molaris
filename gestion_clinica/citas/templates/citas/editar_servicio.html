{% extends 'citas/base.html' %}

{% block title %}Editar Servicio - Clínica Dental{% endblock %}

{% block page_title %}<i class="fas fa-edit"></i> Editar Servicio: {{ servicio.nombre }}{% endblock %}
{% block page_subtitle %}Modifica la información y precio del servicio{% endblock %}

{% block content %}
<div class="section">
    <form method="post" class="form-section">
        {% csrf_token %}
        
        <div class="form-grid">
            <div class="form-group full-width">
                <label><i class="fas fa-tasks"></i> Nombre del Servicio *</label>
                <input type="text" name="nombre" value="{{ servicio.nombre }}" required placeholder="Ej: Limpieza Dental, Extracción, Empaste..." class="form-control">
                <small style="color: #64748b;">Nombre descriptivo del servicio dental</small>
            </div>

            <div class="form-group full-width">
                <label><i class="fas fa-align-left"></i> Descripción</label>
                <textarea name="descripcion" rows="4" placeholder="Descripción detallada del servicio..." class="form-control">{{ servicio.descripcion|default:'' }}</textarea>
                <small style="color: #64748b;">Opcional: Descripción del servicio</small>
            </div>

            <div class="form-group">
                <label><i class="fas fa-tags"></i> Categoría *</label>
                <select name="categoria" required class="form-control">
                    {% for cat_code, cat_name in categorias %}
                    <option value="{{ cat_code }}" {% if servicio.categoria == cat_code %}selected{% endif %}>{{ cat_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label><i class="fas fa-dollar-sign"></i> Precio Base *</label>
                <input type="text" inputmode="numeric" pattern="[0-9.,]*" name="precio_base" value="{% if servicio.precio_base %}{{ servicio.precio_base|floatformat:0|stringformat:"d" }}{% endif %}" required placeholder="60.000" class="form-control formato-numero">
                <small style="color: #64748b;">Precio estándar del servicio</small>
            </div>

            <div class="form-group">
                <label><i class="fas fa-clock"></i> Duración Estimada (minutos)</label>
                <input type="number" name="duracion_estimada" min="0" value="{{ servicio.duracion_estimada|default:'' }}" placeholder="Ej: 30, 60..." class="form-control">
                <small style="color: #64748b;">Opcional: Duración estimada del servicio</small>
            </div>

            <div class="form-group full-width">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="requiere_dentista" {% if servicio.requiere_dentista %}checked{% endif %}>
                        <span><i class="fas fa-user-md"></i> Requiere Dentista</span>
                    </label>
                    <small style="color: #64748b; margin-left: 28px;">Si este servicio requiere un dentista específico</small>

                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="activo" {% if servicio.activo %}checked{% endif %}>
                        <span><i class="fas fa-toggle-on"></i> Servicio Activo</span>
                    </label>
                    <small style="color: #64748b; margin-left: 28px;">Los servicios inactivos no aparecerán al crear citas</small>
                </div>
            </div>

            <div class="form-group full-width">
                <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <strong><i class="fas fa-info-circle"></i> Información del Sistema</strong>
                    <div style="margin-top: 12px; font-size: 0.875rem; color: #64748b;">
                        <div><strong>Creado:</strong> {{ servicio.creado_el|date:"d/m/Y H:i" }}</div>
                        {% if servicio.creado_por %}
                        <div><strong>Creado por:</strong> {{ servicio.creado_por.nombre_completo }}</div>
                        {% endif %}
                        <div><strong>Última actualización:</strong> {{ servicio.actualizado_el|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
            <a href="{% url 'gestor_servicios' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<script>
// Función para formatear número con separadores de miles
function formatearNumero(numero) {
    if (!numero) return '';
    let numeroLimpio = numero.toString().replace(/[^\d]/g, '');
    if (!numeroLimpio) return '';
    return numeroLimpio.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Función para limpiar formato (remover puntos) antes de enviar
function limpiarFormatoNumero(numero) {
    if (!numero) return '';
    return numero.toString().replace(/\./g, '');
}

// Aplicar formato a todos los campos con clase formato-numero
document.addEventListener('DOMContentLoaded', function() {
    const camposNumeros = document.querySelectorAll('.formato-numero');
    
    camposNumeros.forEach(function(campo) {
        // Formatear valor inicial
        if (campo.value) {
            campo.value = formatearNumero(campo.value);
        }
        
        // Formatear mientras se escribe
        campo.addEventListener('input', function(e) {
            const cursorPos = e.target.selectionStart;
            const valorOriginal = e.target.value;
            const valorFormateado = formatearNumero(valorOriginal);
            
            e.target.value = valorFormateado;
            
            const diferencia = valorFormateado.length - valorOriginal.length;
            const nuevaPos = cursorPos + diferencia;
            e.target.setSelectionRange(nuevaPos, nuevaPos);
        });
        
        // Formatear al perder el foco
        campo.addEventListener('blur', function(e) {
            if (e.target.value) {
                e.target.value = formatearNumero(e.target.value);
            }
        });
    });
    
    // Limpiar formato antes de enviar formularios
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const camposNumerosEnForm = form.querySelectorAll('.formato-numero');
            camposNumerosEnForm.forEach(function(campo) {
                if (campo.value) {
                    campo.value = limpiarFormatoNumero(campo.value);
                }
            });
        });
    });
});
</script>
{% endblock %}


















