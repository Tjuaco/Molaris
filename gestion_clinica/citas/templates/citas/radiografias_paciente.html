{% extends 'citas/base.html' %}

{% block title %}Radiografías de {{ paciente.nombre_completo }} - Clínica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav">
    <a href="{% url 'radiografias_listar' %}" class="breadcrumb-link">
        <i class="fas fa-x-ray"></i> Radiografías
    </a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">
        <i class="fas fa-user"></i> {{ paciente.nombre_completo }}
    </span>
</div>

<!-- Header -->
<div class="header-with-stats">
    <div class="page-header">
        <div class="patient-profile-header">
            <div class="patient-avatar-large">
                <i class="fas fa-user"></i>
            </div>
            <div class="patient-header-info">
                <h1 class="page-title">
                    <i class="fas fa-user-circle"></i> {{ paciente.nombre_completo }}
                </h1>
                <p class="page-subtitle">Historial completo de radiografías del paciente</p>
            </div>
        </div>
    </div>
    <div class="header-actions">
        <a href="{% url 'radiografias_listar' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            <span>Volver a Lista</span>
        </a>
        <a href="{% url 'agregar_radiografia' paciente.id %}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span>Agregar Radiografía</span>
        </a>
    </div>
</div>

<!-- Información del Paciente -->
<div class="section">
    <div class="patient-info-card">
        <div class="patient-info-header">
            <h3><i class="fas fa-info-circle"></i> Información del Paciente</h3>
        </div>
        <div class="patient-info-content">
            <div class="info-item-large">
                <div class="info-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Nombre Completo</div>
                    <div class="info-value">{{ paciente.nombre_completo }}</div>
                </div>
            </div>
            <div class="info-item-large">
                <div class="info-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Email</div>
                    <div class="info-value">{{ paciente.email }}</div>
                </div>
            </div>
            <div class="info-item-large">
                <div class="info-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Teléfono</div>
                    <div class="info-value">{{ paciente.telefono|default:"Sin teléfono" }}</div>
                </div>
            </div>
            <div class="info-item-large">
                <div class="info-icon">
                    <i class="fas fa-x-ray"></i>
                </div>
                <div class="info-content">
                    <div class="info-label">Total de Radiografías</div>
                    <div class="info-value">{{ radiografias.count }} radiografía{{ radiografias.count|pluralize }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.breadcrumb-nav {
    background: var(--card-bg);
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.breadcrumb-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.breadcrumb-link:hover {
    color: var(--primary-color-dark);
    text-decoration: underline;
}

.breadcrumb-separator {
    color: #999;
}

.breadcrumb-current {
    color: #333;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.patient-profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
}

.patient-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2em;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.patient-header-info {
    flex: 1;
}

.patient-info-card {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.patient-info-header {
    background: transparent;
    border-bottom: 2px solid var(--primary-light);
    padding: 20px;
    margin-bottom: 20px;
}

.patient-info-header h3 {
    margin: 0;
    font-size: 1.3em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #1e293b;
    text-shadow: none;
}

.patient-info-content {
    padding: 25px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
}

.info-item-large {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.info-icon {
    width: 45px;
    height: 45px;
    border-radius: 8px;
    background: #f0f4f8;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 1.2em;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
}

.info-label {
    font-size: 0.85em;
    color: #666;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1.1em;
    color: #333;
    font-weight: 600;
}

@media (max-width: 768px) {
    .patient-profile-header {
        flex-direction: column;
        text-align: center;
    }
    
    .patient-info-content {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Lista de Radiografías -->
<div class="section">
    <div class="patients-header">
        <h2><i class="fas fa-images"></i> Historial de Radiografías ({{ radiografias.count }})</h2>
    </div>
    
    {% if radiografias %}
    <div class="radiografias-grid">
        {% for radiografia in radiografias %}
        <div class="radiografia-card">
            <div class="radiografia-image">
                <img src="{{ radiografia.imagen.url }}" alt="Radiografía {{ radiografia.get_tipo_display }}" onclick="window.open('{{ radiografia.imagen.url }}', '_blank')">
            </div>
            <div class="radiografia-info">
                <h3>{{ radiografia.get_tipo_display }}</h3>
                <div class="info-row">
                    <div class="info-item-small">
                        <i class="fas fa-upload"></i>
                        <span class="info-label-small">Cargada:</span>
                        <span class="info-value-small">{{ radiografia.fecha_carga|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% if radiografia.fecha_tomada %}
                    <div class="info-item-small">
                        <i class="fas fa-camera"></i>
                        <span class="info-label-small">Tomada:</span>
                        <span class="info-value-small">{{ radiografia.fecha_tomada|date:"d/m/Y" }}</span>
                    </div>
                    {% endif %}
                    {% if radiografia.cita %}
                    <div class="info-item-small">
                        <i class="fas fa-calendar-check"></i>
                        <span class="info-label-small">Cita:</span>
                        <span class="info-value-small">{{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}</span>
                    </div>
                    {% endif %}
                </div>
                {% if radiografia.descripcion %}
                <p class="descripcion-text">{{ radiografia.descripcion|truncatewords:20 }}</p>
                {% endif %}
            </div>
            <div class="radiografia-actions">
                <button class="btn btn-sm btn-info" onclick="abrirModalVisualizador({{ radiografia.id }})">
                    <i class="fas fa-eye"></i>
                    Ver
                </button>
                <a href="{% url 'editar_radiografia' radiografia.id %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit"></i>
                    Editar
                </a>
                <a href="{% url 'eliminar_radiografia' radiografia.id %}" class="btn btn-sm btn-danger" onclick="return confirm('¿Estás seguro de eliminar esta radiografía?');">
                    <i class="fas fa-trash"></i>
                    Eliminar
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-x-ray"></i>
        <h3>No hay radiografías registradas</h3>
        <p>Este paciente aún no tiene radiografías en su historial.</p>
        <a href="{% url 'agregar_radiografia' paciente.id %}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span>Agregar Primera Radiografía</span>
        </a>
    </div>
    {% endif %}
</div>

<style>
.radiografias-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.radiografia-card {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.radiografia-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.radiografia-image {
    width: 100%;
    height: 250px;
    overflow: hidden;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.radiografia-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    cursor: pointer;
    transition: transform 0.3s;
}

.radiografia-image img:hover {
    transform: scale(1.1);
}

.radiografia-info {
    padding: 15px;
}

.radiografia-info h3 {
    margin: 0 0 10px 0;
    color: var(--text-primary);
    font-size: 1.1em;
}

.info-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.info-item-small {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85em;
    padding: 6px 10px;
    background: var(--primary-bg);
    border-radius: 6px;
    border: 1px solid var(--primary-light);
    flex-wrap: wrap;
}

.info-item-small i {
    color: var(--primary-color);
    font-size: 0.9em;
}

.info-label-small {
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.9em;
}

.info-value-small {
    color: var(--primary-text);
    font-weight: 600;
    font-size: 0.95em;
}

.descripcion-text {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin: 10px 0 0 0;
}

.radiografia-actions {
    padding: 15px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* Modal del Visualizador */
.visualizador-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.95);
    overflow: hidden;
}

.visualizador-modal.active {
    display: flex;
    flex-direction: column;
}

.modal-content-visualizador {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0.5em;
    box-sizing: border-box;
    background: white;
}

.modal-header-visualizador {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5em 0.75em;
    background: white;
    border-radius: 0.375em;
    margin-bottom: 0.5em;
    color: var(--primary-text);
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--primary-light);
}

.modal-header-visualizador h2 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 0.375em;
    font-weight: 600;
}

.modal-close-visualizador {
    background: var(--primary-color);
    border: 1px solid var(--primary-dark);
    color: white;
    padding: 0.375em 0.75em;
    border-radius: 0.25em;
    cursor: pointer;
    font-size: 0.875em;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.375em;
    font-weight: 500;
}

.modal-close-visualizador:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.modal-controls-visualizador {
    background: white;
    padding: 0.5em 0.75em;
    border-radius: 0.375em;
    margin-bottom: 0.5em;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(9.375em, 1fr));
    gap: 0.5em;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--primary-light);
}

.modal-controls-visualizador .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5em;
}

.modal-controls-visualizador label {
    color: #333;
    font-weight: 500;
    font-size: 0.8125em;
}

.modal-controls-visualizador .form-control,
.modal-controls-visualizador select,
.modal-controls-visualizador input[type="color"],
.modal-controls-visualizador input[type="range"] {
    background: white;
    border: 1px solid var(--primary-light);
    color: var(--primary-text);
    padding: 0.25em 0.375em;
    border-radius: 0.25em;
    transition: all 0.2s;
    font-size: 0.875em;
}

.modal-controls-visualizador .form-control:focus,
.modal-controls-visualizador select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
}

.modal-controls-visualizador .tool-buttons {
    display: flex;
    gap: 0.5em;
    flex-wrap: wrap;
}

.modal-controls-visualizador .tool-btn {
    padding: 0.25em 0.5em;
    border: 1px solid var(--primary-light);
    background: white;
    border-radius: 0.25em;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.25em;
    color: var(--primary-text);
    font-size: 0.8125em;
    font-weight: 500;
}

.modal-controls-visualizador .tool-btn:hover {
    background: var(--primary-bg);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.modal-controls-visualizador .tool-btn.active {
    background: var(--primary-color);
    border-color: var(--primary-dark);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.modal-canvas-container {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5em;
    overflow: hidden;
    min-height: 0;
}

.modal-canvas-wrapper {
    position: relative;
    background: white;
    border-radius: 0.375em;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 0;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--primary-light);
}

.modal-canvas-wrapper canvas {
    display: block;
    cursor: crosshair;
    touch-action: none;
    max-width: none;
    max-height: none;
}

.modal-canvas-info {
    position: absolute;
    top: 0.375em;
    left: 0.375em;
    right: 0.375em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.95);
    color: var(--primary-text);
    padding: 0.25em 0.5em;
    border-radius: 0.25em;
    font-size: 0.8125em;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--primary-light);
    z-index: 10;
}

.modal-canvas-info span {
    color: var(--primary-color);
    font-weight: 600;
}

.color-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.color-btn {
    padding: 10px 16px;
    border: 2px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9em;
    font-weight: 600;
    flex: 1;
    min-width: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.color-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.color-btn.active {
    border-width: 3px;
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.btn-danger {
    background: #ef4444;
    color: white;
    border: 2px solid #dc2626;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.reset-zoom-btn {
    padding: 0.25em 0.5em;
    background: white;
    border: 1px solid var(--primary-light);
    color: var(--primary-color);
    border-radius: 0.25em;
    cursor: pointer;
    font-size: 0.75em;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.25em;
}

.reset-zoom-btn:hover {
    background: var(--primary-bg);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}


.btn-download {
    padding: 0.25em 0.5em;
    background: #10b981;
    border: 1px solid #059669;
    color: white;
    border-radius: 0.25em;
    cursor: pointer;
    font-size: 0.75em;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.25em;
    margin-left: 0.375em;
}

.btn-download:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}


@media (max-width: 768px) {
    .modal-canvas-container {
        grid-template-columns: 1fr;
    }
    
    .modal-controls-visualizador {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Modal del Visualizador -->
<div id="visualizadorModal" class="visualizador-modal">
    <div class="modal-content-visualizador">
        <div class="modal-header-visualizador">
            <h2><i class="fas fa-eye"></i> Visualizador de Radiografías - {{ paciente.nombre_completo }}</h2>
            <button class="modal-close-visualizador" onclick="cerrarModalVisualizador()">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
        
        <div class="modal-controls-visualizador">
            <div class="control-group">
                <label for="modal-radio1-select">
                    <i class="fas fa-image"></i> Radiografía 1
                </label>
                <select id="modal-radio1-select" class="form-control">
                    <option value="">Seleccionar...</option>
                    {% for radiografia in radiografias %}
                    <option value="{{ radiografia.id }}" data-url="{{ radiografia.imagen.url }}" data-label="{% if radiografia.fecha_tomada %}{{ radiografia.fecha_tomada|date:"d/m/Y" }}{% else %}{{ radiografia.fecha_carga|date:"d/m/Y" }}{% endif %}">
                        {{ radiografia.get_tipo_display }}
                        {% if radiografia.fecha_tomada %}
                        - Tomada: {{ radiografia.fecha_tomada|date:"d/m/Y" }}
                        {% else %}
                        - Cargada: {{ radiografia.fecha_carga|date:"d/m/Y" }}
                        {% endif %}
                        {% if radiografia.cita %}
                        - Cita: {{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}
                        {% endif %}
                        {% if radiografia.descripcion %}
                        - {{ radiografia.descripcion|truncatewords:5 }}
                        {% endif %}
                        {% if radiografia.imagen_anotada %} (con anotaciones){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label for="modal-radio2-select">
                    <i class="fas fa-image"></i> Radiografía 2
                </label>
                <select id="modal-radio2-select" class="form-control">
                    <option value="">Seleccionar...</option>
                    {% for radiografia in radiografias %}
                    <option value="{{ radiografia.id }}" data-url="{{ radiografia.imagen.url }}" data-label="{% if radiografia.fecha_tomada %}{{ radiografia.fecha_tomada|date:"d/m/Y" }}{% else %}{{ radiografia.fecha_carga|date:"d/m/Y" }}{% endif %}" data-has-annotations="{% if radiografia.imagen_anotada %}true{% else %}false{% endif %}">
                        {{ radiografia.get_tipo_display }}
                        {% if radiografia.fecha_tomada %}
                        - Tomada: {{ radiografia.fecha_tomada|date:"d/m/Y" }}
                        {% else %}
                        - Cargada: {{ radiografia.fecha_carga|date:"d/m/Y" }}
                        {% endif %}
                        {% if radiografia.cita %}
                        - Cita: {{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}
                        {% endif %}
                        {% if radiografia.descripcion %}
                        - {{ radiografia.descripcion|truncatewords:5 }}
                        {% endif %}
                        {% if radiografia.imagen_anotada %} (con anotaciones){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-pencil-alt"></i> Color del Lápiz
                </label>
                <div class="color-buttons">
                    <button class="color-btn active" data-color="#ff0000" style="background: #ff0000; color: white;" onclick="seleccionarColorModal('#ff0000')">
                        <i class="fas fa-circle"></i> Rojo
                    </button>
                    <button class="color-btn" data-color="#00ff00" style="background: #00ff00; color: #333;" onclick="seleccionarColorModal('#00ff00')">
                        <i class="fas fa-circle"></i> Verde
                    </button>
                    <button class="color-btn" data-color="#0000ff" style="background: #0000ff; color: white;" onclick="seleccionarColorModal('#0000ff')">
                        <i class="fas fa-circle"></i> Azul
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-sliders-h"></i> Ajustes
                </label>
                <div class="tool-buttons">
                    <input type="range" id="brightness-slider" min="0" max="200" value="100" oninput="adjustBrightness(this.value)" style="width: 100%; margin-bottom: 8px;">
                    <label style="font-size: 0.8em; color: var(--text-secondary);">Brillo: <span id="brightness-value">100</span>%</label>
                    <input type="range" id="contrast-slider" min="0" max="200" value="100" oninput="adjustContrast(this.value)" style="width: 100%; margin-top: 8px;">
                    <label style="font-size: 0.8em; color: var(--text-secondary);">Contraste: <span id="contrast-value">100</span>%</label>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-tools"></i> Herramientas
                </label>
                <div class="tool-buttons">
                    <button class="tool-btn" onclick="rotateImage(1, 90)" title="Rotar 90°">
                        <i class="fas fa-redo"></i> Rotar 1
                    </button>
                    <button class="tool-btn" onclick="rotateImage(2, 90)" title="Rotar 90°">
                        <i class="fas fa-redo"></i> Rotar 2
                    </button>
                    <button id="modal-clear-btn" class="tool-btn btn-danger" title="Limpiar todo" onclick="limpiarTodoModal()">
                        <i class="fas fa-broom"></i> Limpiar Todo
                    </button>
                </div>
            </div>
        </div>
        
        <div class="modal-canvas-container">
            <div class="modal-canvas-wrapper" id="modal-canvas-container-1">
                <canvas id="modal-canvas1"></canvas>
                <div class="modal-canvas-info">
                    <span id="modal-canvas1-label">Radiografía 1</span>
                    <div style="display: flex; gap: 0.5em;">
                        <button class="reset-zoom-btn" onclick="resetModalZoom(1)">
                            <i class="fas fa-search-minus"></i> Restablecer Zoom
                        </button>
                        <button class="btn-download" onclick="downloadCanvas(1)">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-canvas-wrapper" id="modal-canvas-container-2">
                <canvas id="modal-canvas2"></canvas>
                <div class="modal-canvas-info">
                    <span id="modal-canvas2-label">Radiografía 2</span>
                    <div style="display: flex; gap: 0.5em;">
                        <button class="reset-zoom-btn" onclick="resetModalZoom(2)">
                            <i class="fas fa-search-minus"></i> Restablecer Zoom
                        </button>
                        <button class="btn-download" onclick="downloadCanvas(2)">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales del modal
let modalCanvas1, modalCtx1, modalImg1 = null;
let modalCanvas2, modalCtx2, modalImg2 = null;
let modalIsDrawing = false;
let modalCurrentColor = '#ff0000';
let modalBrushSize = 3;
let modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
let modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };

// Datos de las radiografías
const radiografiasData = {
    {% for radiografia in radiografias %}
    {{ radiografia.id }}: {
        url: '{{ radiografia.imagen.url }}',
        label: '{{ radiografia.get_tipo_display }}{% if radiografia.fecha_tomada %} - Tomada: {{ radiografia.fecha_tomada|date:"d/m/Y" }}{% else %} - Cargada: {{ radiografia.fecha_carga|date:"d/m/Y" }}{% endif %}{% if radiografia.cita %} - Cita: {{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}{% endif %}{% if radiografia.descripcion %} - {{ radiografia.descripcion|truncatewords:5|escapejs }}{% endif %}',
        hasAnnotations: {% if radiografia.imagen_anotada %}true{% else %}false{% endif %},
        annotatedUrl: {% if radiografia.imagen_anotada %}'{{ radiografia.imagen_anotada.url }}'{% else %}null{% endif %}
    },
    {% endfor %}
};

let modalEventListenersSetup = false;

function abrirModalVisualizador(radiografiaId) {
    const modal = document.getElementById('visualizadorModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Inicializar canvas
    modalCanvas1 = document.getElementById('modal-canvas1');
    modalCtx1 = modalCanvas1.getContext('2d');
    modalCanvas2 = document.getElementById('modal-canvas2');
    modalCtx2 = modalCanvas2.getContext('2d');
    
    // Seleccionar la radiografía
    document.getElementById('modal-radio1-select').value = radiografiaId;
    if (radiografiasData[radiografiaId]) {
        loadModalImage(1, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label, radiografiaId);
    }
    
    // Event listeners solo una vez
    if (!modalEventListenersSetup) {
        setupModalEventListeners();
        modalEventListenersSetup = true;
    }
}

function cerrarModalVisualizador() {
    const modal = document.getElementById('visualizadorModal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    
    // Limpiar canvas
    if (modalCtx1) modalCtx1.clearRect(0, 0, modalCanvas1.width, modalCanvas1.height);
    if (modalCtx2) modalCtx2.clearRect(0, 0, modalCanvas2.width, modalCanvas2.height);
    modalImg1 = null;
    modalImg2 = null;
    modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
    modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };
}

function setupModalEventListeners() {
    // Selectores de radiografías
    document.getElementById('modal-radio1-select').addEventListener('change', function() {
        const radiografiaId = this.value;
        const option = this.options[this.selectedIndex];
        if (radiografiaId && radiografiasData[radiografiaId]) {
            loadModalImage(1, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label, parseInt(radiografiaId));
        }
    });
    
    document.getElementById('modal-radio2-select').addEventListener('change', function() {
        const radiografiaId = this.value;
        const option = this.options[this.selectedIndex];
        if (radiografiaId && radiografiasData[radiografiaId]) {
            loadModalImage(2, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label, parseInt(radiografiaId));
        }
    });
    
    
    // Eventos de dibujo
    setupModalDrawingCanvas(modalCanvas1, modalCtx1, 1);
    setupModalDrawingCanvas(modalCanvas2, modalCtx2, 2);
    
    // Zoom con rueda del mouse
    setupModalZoom(modalCanvas1, 1);
    setupModalZoom(modalCanvas2, 2);
}

function loadModalImage(canvasNum, url, label) {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = function() {
        const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
        const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
        const container = canvasNum === 1 ? document.getElementById('modal-canvas-container-1') : document.getElementById('modal-canvas-container-2');
        
        // Establecer el tamaño del canvas basado en el contenedor
        const containerRect = container.getBoundingClientRect();
        const maxWidth = containerRect.width - 40; // Margen
        const maxHeight = containerRect.height - 100; // Espacio para controles
        
        // Calcular tamaño manteniendo la proporción
        let canvasWidth = img.width;
        let canvasHeight = img.height;
        
        if (canvasWidth > maxWidth) {
            canvasHeight = (canvasHeight * maxWidth) / canvasWidth;
            canvasWidth = maxWidth;
        }
        if (canvasHeight > maxHeight) {
            canvasWidth = (canvasWidth * maxHeight) / canvasHeight;
            canvasHeight = maxHeight;
        }
        
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.style.width = canvasWidth + 'px';
        canvas.style.height = canvasHeight + 'px';
        
        // Guardar imagen
        if (canvasNum === 1) modalImg1 = img;
        else modalImg2 = img;
        
        // Resetear zoom
        if (canvasNum === 1) modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
        else modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };
        
        // Actualizar label
        if (canvasNum === 1) {
            document.getElementById('modal-canvas1-label').textContent = label;
        } else {
            document.getElementById('modal-canvas2-label').textContent = label;
        }
        
        drawModalImageOnCanvasWithFilters(canvasNum);
    };
    img.src = url;
}

function drawModalImageOnCanvas(canvasNum) {
    const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
    const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
    const img = canvasNum === 1 ? modalImg1 : modalImg2;
    const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
    
    if (!img) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(zoom.offsetX, zoom.offsetY);
    ctx.scale(zoom.scale, zoom.scale);
    ctx.drawImage(img, 0, 0);
    ctx.restore();
}

function setupModalDrawingCanvas(canvas, ctx, canvasNum) {
    let lastX, lastY;
    
    function getCanvasCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / canvas.offsetWidth;
        const scaleY = canvas.height / canvas.offsetHeight;
        
        let clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
        let clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
        
        const x = (clientX - rect.left) * scaleX;
        const y = (clientY - rect.top) * scaleY;
        
        const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
        
        // Ajustar por zoom y pan
        const adjustedX = (x - zoom.offsetX * scaleX) / zoom.scale;
        const adjustedY = (y - zoom.offsetY * scaleY) / zoom.scale;
        
        return { x: adjustedX, y: adjustedY };
    }
    
    function startDraw(e) {
        // No dibujar si es pan
        if (e.button === 2 || e.ctrlKey) return;
        
        e.preventDefault();
        modalIsDrawing = true;
        
        const coords = getCanvasCoordinates(e);
        lastX = coords.x;
        lastY = coords.y;
    }
    
    function draw(e) {
        if (!modalIsDrawing) return;
        e.preventDefault();
        
        const coords = getCanvasCoordinates(e);
        const currentX = coords.x;
        const currentY = coords.y;
        const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
        
        ctx.save();
        ctx.translate(zoom.offsetX * (canvas.width / canvas.offsetWidth), zoom.offsetY * (canvas.height / canvas.offsetHeight));
        ctx.scale(zoom.scale, zoom.scale);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.lineWidth = modalBrushSize / zoom.scale;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = modalCurrentColor;
        ctx.globalCompositeOperation = 'source-over';
        
        ctx.stroke();
        ctx.restore();
        
        lastX = currentX;
        lastY = currentY;
    }
    
    function stopDraw() {
        modalIsDrawing = false;
    }
    
    // Mouse events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    
    // Touch events
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDraw);
    canvas.addEventListener('touchcancel', stopDraw);
}

function setupModalZoom(canvas, canvasNum) {
    canvas.addEventListener('wheel', function(e) {
        e.preventDefault();
        
        const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
        const newScale = Math.max(0.5, Math.min(5, zoom.scale * zoomFactor));
        
        // Ajustar offset para mantener el punto del mouse en su posición
        zoom.offsetX = mouseX - (mouseX - zoom.offsetX) * (newScale / zoom.scale);
        zoom.offsetY = mouseY - (mouseY - zoom.offsetY) * (newScale / zoom.scale);
        zoom.scale = newScale;
        
        drawModalImageOnCanvasWithFilters(canvasNum);
    });
    
    // Pan con click derecho arrastrado o Ctrl+click
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    
    canvas.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });
    
    canvas.addEventListener('mousedown', function(e) {
        if (e.button === 2 || e.ctrlKey) {
            isPanning = true;
            const rect = canvas.getBoundingClientRect();
            panStart.x = e.clientX - rect.left;
            panStart.y = e.clientY - rect.top;
            canvas.style.cursor = 'grabbing';
        }
    });
    
    canvas.addEventListener('mousemove', function(e) {
        if (isPanning) {
            const rect = canvas.getBoundingClientRect();
            const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
            
            zoom.offsetX += (e.clientX - rect.left) - panStart.x;
            zoom.offsetY += (e.clientY - rect.top) - panStart.y;
            
            panStart.x = e.clientX - rect.left;
            panStart.y = e.clientY - rect.top;
            
            drawModalImageOnCanvasWithFilters(canvasNum);
        }
    });
    
    canvas.addEventListener('mouseup', function() {
        if (isPanning) {
            isPanning = false;
            canvas.style.cursor = 'crosshair';
        }
    });
}

function resetModalZoom(canvasNum) {
    if (canvasNum === 1) {
        modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
        drawModalImageOnCanvas(1);
    } else {
        modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };
        drawModalImageOnCanvas(2);
    }
}

function clearModalCanvas(canvasNum) {
    const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
    const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawModalImageOnCanvasWithFilters(canvasNum);
}

function seleccionarColorModal(color) {
    modalCurrentColor = color;
    document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.color-btn[data-color="${color}"]`).classList.add('active');
}

function limpiarTodoModal() {
    if (confirm('¿Estás seguro de limpiar todos los dibujos?')) {
        clearModalCanvas(1);
        clearModalCanvas(2);
    }
}

// Variables para ajustes de imagen
let brightness = 100;
let contrast = 100;
let rotation1 = 0;
let rotation2 = 0;

// Función para ajustar brillo
function adjustBrightness(value) {
    brightness = value;
    document.getElementById('brightness-value').textContent = value;
    applyImageFilters();
}

// Función para ajustar contraste
function adjustContrast(value) {
    contrast = value;
    document.getElementById('contrast-value').textContent = value;
    applyImageFilters();
}

// Aplicar filtros a ambas imágenes
function applyImageFilters() {
    if (modalImg1) drawModalImageOnCanvasWithFilters(1);
    if (modalImg2) drawModalImageOnCanvasWithFilters(2);
}

// Función para rotar imagen
function rotateImage(canvasNum, degrees) {
    if (canvasNum === 1) {
        rotation1 = (rotation1 + degrees) % 360;
        drawModalImageOnCanvasWithFilters(1);
    } else {
        rotation2 = (rotation2 + degrees) % 360;
        drawModalImageOnCanvasWithFilters(2);
    }
}



function downloadCanvas(canvasNum) {
    const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
    downloadCanvasElement(canvas);
}

function downloadCanvasElement(canvas) {
    const link = document.createElement('a');
    link.download = 'radiografia-' + new Date().getTime() + '.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}


// Guardar función original y crear nueva que aplica filtros
function drawModalImageOnCanvasWithFilters(canvasNum) {
    const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
    const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
    const img = canvasNum === 1 ? modalImg1 : modalImg2;
    const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
    const rotation = canvasNum === 1 ? rotation1 : rotation2;
    
    if (!img) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    
    // Aplicar filtros
    ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
    
    // Aplicar rotación
    if (rotation !== 0) {
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate((rotation * Math.PI) / 180);
        ctx.translate(-canvas.width / 2, -canvas.height / 2);
    }
    
    // Aplicar zoom y pan
    ctx.translate(zoom.offsetX, zoom.offsetY);
    ctx.scale(zoom.scale, zoom.scale);
    
    ctx.drawImage(img, 0, 0);
    ctx.restore();
};


// Cerrar modal con Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarModalVisualizador();
    }
});
</script>
{% endblock %}

