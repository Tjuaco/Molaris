{% extends 'citas/base.html' %}

{% block title %}{{ consentimiento.titulo }} - Consentimiento Informado{% endblock %}

{% block page_title %}<i class="fas fa-file-signature"></i> {{ consentimiento.titulo }}{% endblock %}
{% block page_subtitle %}Detalle del consentimiento informado{% endblock %}

{% block content %}
<div class="section">
    <!-- Header con acciones -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
        <div>
            <span class="badge-estado badge-{{ consentimiento.estado }}" style="padding: 8px 16px; font-size: 0.875rem;">
                {% if consentimiento.estado == 'firmado' %}
                <i class="fas fa-check-circle"></i>
                {% elif consentimiento.estado == 'pendiente' %}
                <i class="fas fa-clock"></i>
                {% elif consentimiento.estado == 'rechazado' %}
                <i class="fas fa-times-circle"></i>
                {% else %}
                <i class="fas fa-exclamation-triangle"></i>
                {% endif %}
                {{ consentimiento.get_estado_display }}
            </span>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <a href="{% url 'gestor_consentimientos' %}" class="btn" style="background: #6b7280; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px;">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            {% if puede_editar %}
            <a href="{% url 'editar_consentimiento' consentimiento.id %}" class="btn" style="background: #f59e0b; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px;">
                <i class="fas fa-edit"></i> Editar
            </a>
            {% endif %}
            {% if puede_firmar %}
            <button onclick="abrirModalFirmar({{ consentimiento.id }}, '{{ consentimiento.cliente.nombre_completo }}', '{{ consentimiento.cliente.rut|default:"" }}')" 
                    class="btn" style="background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">
                <i class="fas fa-signature"></i> Firmar Presencial
            </button>
            <button onclick="abrirModalEnviarCorreo({{ consentimiento.id }}, '{{ consentimiento.cliente.email }}')" 
                    class="btn" style="background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">
                <i class="fas fa-envelope"></i> Enviar por Correo
            </button>
            {% endif %}
            <a href="{% url 'exportar_consentimiento_pdf' consentimiento.id %}" class="btn" style="background: #dc2626; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px;" target="_blank">
                <i class="fas fa-file-pdf"></i> Exportar PDF
            </a>
        </div>
    </div>
    
    <!-- Información General -->
    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1.25rem; font-weight: 600;">
            <i class="fas fa-info-circle"></i> Información General
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Cliente</strong>
                <span style="color: #1e293b; font-size: 1rem; font-weight: 600;">{{ consentimiento.cliente.nombre_completo }}</span>
            </div>
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Tipo de Procedimiento</strong>
                <span style="color: #1e293b; font-size: 1rem; font-weight: 600;">{{ consentimiento.get_tipo_procedimiento_display }}</span>
            </div>
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Dentista Responsable</strong>
                <span style="color: #1e293b; font-size: 1rem;">{{ consentimiento.dentista.nombre_completo|default:"No asignado" }}</span>
            </div>
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Fecha de Creación</strong>
                <span style="color: #1e293b; font-size: 1rem;">{{ consentimiento.fecha_creacion|date:"d/m/Y H:i" }}</span>
            </div>
            {% if consentimiento.fecha_firma %}
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Fecha de Firma</strong>
                <span style="color: #10b981; font-size: 1rem; font-weight: 600;">{{ consentimiento.fecha_firma|date:"d/m/Y H:i" }}</span>
            </div>
            {% endif %}
            {% if consentimiento.fecha_vencimiento %}
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Válido hasta</strong>
                <span style="color: {% if consentimiento.esta_vencido %}#ef4444{% else %}#1e293b{% endif %}; font-size: 1rem;">
                    {{ consentimiento.fecha_vencimiento|date:"d/m/Y" }}
                </span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Contenido del Consentimiento -->
    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 20px 0; color: #1e293b; font-size: 1.25rem; font-weight: 600;">
            <i class="fas fa-file-alt"></i> Contenido del Consentimiento
        </h3>
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <p style="color: #1e293b; margin: 0; line-height: 1.8; white-space: pre-wrap;">{{ consentimiento.contenido }}</p>
        </div>
    </div>
    
    <!-- Riesgos, Beneficios y Alternativas -->
    {% if consentimiento.riesgos or consentimiento.beneficios or consentimiento.alternativas %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
        {% if consentimiento.riesgos %}
        <div style="background: white; border: 1px solid #fee2e2; border-radius: 12px; padding: 20px;">
            <h4 style="margin: 0 0 12px 0; color: #ef4444; font-size: 1rem; font-weight: 600;">
                <i class="fas fa-exclamation-triangle"></i> Riesgos
            </h4>
            <p style="color: #374151; margin: 0; line-height: 1.6; white-space: pre-wrap; font-size: 0.875rem;">{{ consentimiento.riesgos }}</p>
        </div>
        {% endif %}
        
        {% if consentimiento.beneficios %}
        <div style="background: white; border: 1px solid #d1fae5; border-radius: 12px; padding: 20px;">
            <h4 style="margin: 0 0 12px 0; color: #10b981; font-size: 1rem; font-weight: 600;">
                <i class="fas fa-check-circle"></i> Beneficios
            </h4>
            <p style="color: #374151; margin: 0; line-height: 1.6; white-space: pre-wrap; font-size: 0.875rem;">{{ consentimiento.beneficios }}</p>
        </div>
        {% endif %}
        
        {% if consentimiento.alternativas %}
        <div style="background: white; border: 1px solid #dbeafe; border-radius: 12px; padding: 20px;">
            <h4 style="margin: 0 0 12px 0; color: #3b82f6; font-size: 1rem; font-weight: 600;">
                <i class="fas fa-list"></i> Alternativas
            </h4>
            <p style="color: #374151; margin: 0; line-height: 1.6; white-space: pre-wrap; font-size: 0.875rem;">{{ consentimiento.alternativas }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Información de Firma -->
    {% if consentimiento.esta_firmado %}
    <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 20px 0; color: #10b981; font-size: 1.25rem; font-weight: 600;">
            <i class="fas fa-check-circle"></i> Información de Firma
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Firmante</strong>
                <span style="color: #1e293b; font-size: 1rem; font-weight: 600;">{{ consentimiento.nombre_firmante|default:consentimiento.cliente.nombre_completo }}</span>
            </div>
            {% if consentimiento.rut_firmante %}
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">RUT</strong>
                <span style="color: #1e293b; font-size: 1rem;">{{ consentimiento.rut_firmante }}</span>
            </div>
            {% endif %}
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Firma</strong>
                <span style="color: #1e293b; font-size: 1rem; font-style: italic;">{{ consentimiento.firma_paciente }}</span>
            </div>
            {% if consentimiento.nombre_testigo %}
            <div>
                <strong style="color: #64748b; font-size: 0.875rem; display: block; margin-bottom: 4px;">Testigo</strong>
                <span style="color: #1e293b; font-size: 1rem;">{{ consentimiento.nombre_testigo }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para firmar (mismo que en gestor_consentimientos.html) -->
<div id="modalFirmar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px); overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 16px; max-width: 700px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); margin: auto; max-height: 90vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 24px 20px; border-bottom: 1px solid #e2e8f0; flex-shrink: 0;">
            <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem; font-weight: 700;">
                <i class="fas fa-signature" style="color: var(--primary-color); margin-right: 8px;"></i>
                Firmar Consentimiento
            </h3>
            <button onclick="cerrarModalFirmar()" style="background: none; border: none; font-size: 1.5rem; color: #64748b; cursor: pointer; padding: 4px 8px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#64748b'">&times;</button>
        </div>
        <div style="overflow-y: auto; flex: 1; padding: 0 24px;">
        <form id="formFirmar" onsubmit="firmarConsentimientoSubmit(event)">
            <input type="hidden" id="consentimientoIdFirmar" name="consentimiento_id">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 0.875rem;">Nombre del Firmante:</label>
                <input type="text" id="nombreFirmante" name="nombre_firmante" required
                       style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 0.875rem;">RUT del Firmante:</label>
                <input type="text" id="rutFirmante" name="rut_firmante"
                       style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem;">
            </div>
            <input type="hidden" id="consentimientoIdFirmar" name="consentimiento_id">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
                        <i class="fas fa-user" style="color: var(--primary-color); margin-right: 6px;"></i>Nombre del Firmante <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="nombreFirmante" name="nombre_firmante" required
                           style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; transition: border-color 0.2s;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                           onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
                        <i class="fas fa-id-card" style="color: var(--primary-color); margin-right: 6px;"></i>RUT del Firmante
                    </label>
                    <input type="text" id="rutFirmante" name="rut_firmante" placeholder="12.345.678-9"
                           style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; transition: border-color 0.2s;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                           onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                </div>
            </div>
            
            <!-- Declaraciones Legales (Ley 20.584) -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);">
                <h4 style="margin: 0 0 16px 0; color: #1e40af; font-size: 0.9375rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-gavel" style="font-size: 1rem;"></i> Declaraciones Legales (Ley 20.584)
                </h4>
                <div style="margin-bottom: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #3b82f6;">
                    <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="declaracionComprension" name="declaracion_comprension" required
                               style="margin-top: 2px; flex-shrink: 0; width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                        <span style="font-size: 0.8125rem; color: #374151; line-height: 1.6; flex: 1;">
                            <strong style="color: #1e40af;">Declaración de Comprensión:</strong> Declaro que he sido informado de forma clara, comprensible y oportuna 
                            sobre mi diagnóstico, los riesgos, beneficios y alternativas del procedimiento propuesto, de acuerdo con la 
                            <strong>Ley N° 20.584</strong> sobre Derechos y Deberes de las Personas en relación con las Acciones vinculadas 
                            a su Atención en Salud.
                        </span>
                    </label>
                </div>
                <div style="padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #10b981;">
                    <label style="display: flex; align-items: start; gap: 10px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="derechoRevocacion" name="derecho_revocacion" required
                               style="margin-top: 2px; flex-shrink: 0; width: 18px; height: 18px; cursor: pointer; accent-color: #10b981;">
                        <span style="font-size: 0.8125rem; color: #374151; line-height: 1.6; flex: 1;">
                            <strong style="color: #059669;">Derecho de Revocación:</strong> Conozco que tengo el derecho a revocar libremente este consentimiento 
                            en cualquier momento previo al inicio del tratamiento.
                        </span>
                    </label>
                </div>
            </div>
            
            <div style="margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <label style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 0.875rem;">
                    <i class="fas fa-signature" style="color: #10b981; margin-right: 6px;"></i>Firma del Paciente (Texto) <span style="color: #ef4444;">*</span>
                </label>
                <input type="text" id="firmaPaciente" name="firma_paciente" required
                       placeholder="Escriba su nombre completo como firma"
                       style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; transition: border-color 0.2s;"
                       onfocus="this.style.borderColor='#10b981'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'"
                       onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 8px; margin-bottom: 0; display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i> Escriba su nombre completo para firmar digitalmente
                </p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; margin-bottom: 24px; flex-wrap: wrap;">
                <button type="button" onclick="cerrarModalFirmar()" class="btn" style="background: #6b7280; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn" style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                    <i class="fas fa-check"></i> Firmar
                </button>
            </div>
        </form>
        </div>
    </div>
</div>

<script>
function abrirModalFirmar(consentimientoId, nombreCliente, rutCliente) {
    document.getElementById('consentimientoIdFirmar').value = consentimientoId;
    document.getElementById('nombreFirmante').value = nombreCliente;
    document.getElementById('rutFirmante').value = rutCliente || '';
    document.getElementById('modalFirmar').style.display = 'flex';
}

function cerrarModalFirmar() {
    document.getElementById('modalFirmar').style.display = 'none';
}

function firmarConsentimientoSubmit(event) {
    event.preventDefault();
    const consentimientoId = document.getElementById('consentimientoIdFirmar').value;
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Firmando...';
    
    const formData = new FormData();
    formData.append('firma_paciente', document.getElementById('firmaPaciente').value);
    formData.append('nombre_firmante', document.getElementById('nombreFirmante').value);
    formData.append('rut_firmante', document.getElementById('rutFirmante').value);
    formData.append('declaracion_comprension', document.getElementById('declaracionComprension').checked ? 'on' : '');
    formData.append('derecho_revocacion', document.getElementById('derechoRevocacion').checked ? 'on' : '');
    
    fetch(`/trabajadores/consentimientos/${consentimientoId}/firmar/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            cerrarModalFirmar();
            location.reload();
        } else {
            alert('✗ Error: ' + (data.error || 'No se pudo firmar el consentimiento'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('✗ Error al firmar el consentimiento.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

document.getElementById('modalFirmar').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalFirmar();
    }
});

// Modal para enviar por correo
function abrirModalEnviarCorreo(consentimientoId, emailCliente) {
    document.getElementById('consentimientoIdEnviar').value = consentimientoId;
    document.getElementById('emailDestino').value = emailCliente || '';
    document.getElementById('modalEnviarCorreo').style.display = 'flex';
}

function cerrarModalEnviarCorreo() {
    document.getElementById('modalEnviarCorreo').style.display = 'none';
}

function enviarCorreoSubmit(event) {
    event.preventDefault();
    const consentimientoId = document.getElementById('consentimientoIdEnviar').value;
    const emailDestino = document.getElementById('emailDestino').value;
    
    if (!emailDestino) {
        alert('✗ Por favor, ingrese un email de destino.');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    const formData = new FormData();
    formData.append('email', emailDestino);
    
    fetch(`/trabajadores/consentimientos/${consentimientoId}/enviar-correo/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ ' + data.message);
            cerrarModalEnviarCorreo();
        } else {
            alert('✗ Error: ' + (data.error || 'No se pudo enviar el correo'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('✗ Error al enviar el correo.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

document.getElementById('modalEnviarCorreo').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalEnviarCorreo();
    }
});
</script>

<!-- Modal para Enviar por Correo -->
<div id="modalEnviarCorreo" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation();">
        <div class="modal-header">
            <h3><i class="fas fa-envelope"></i> Enviar Consentimiento por Correo</h3>
            <button class="modal-close" onclick="cerrarModalEnviarCorreo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formEnviarCorreo" onsubmit="enviarCorreoSubmit(event)">
                <input type="hidden" id="consentimientoIdEnviar" value="">
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-envelope"></i> Email de Destino
                        <span class="required-badge">*</span>
                    </label>
                    <input type="email" id="emailDestino" required class="form-control-modal" placeholder="correo@ejemplo.com">
                    <small style="color: #64748b; font-size: 0.75rem; margin-top: 4px; display: block;">
                        Se enviará el PDF del consentimiento y un enlace para firmarlo en línea.
                    </small>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button type="button" onclick="cerrarModalEnviarCorreo()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

