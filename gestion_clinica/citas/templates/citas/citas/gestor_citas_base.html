{% extends 'citas/base.html' %}
{% load custom_filters %}

{% block title %}Gestor de Citas - Clínica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<style>
    /* Clase para labels accesibles pero ocultos visualmente */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    
    /* Layout con navbar lateral */
    .citas-layout-container {
        display: flex;
        gap: 0;
        margin-top: 0;
        margin-left: 0;
        margin-right: 0;
        padding: 0;
        align-items: flex-start;
        width: 100%;
        position: relative;
    }

    /* Navbar lateral - pegado a la izquierda, más pequeño y desde arriba */
    .citas-sidebar {
        width: 260px;
        flex-shrink: 0;
        background: white;
        border-radius: 0;
        box-shadow: 2px 0 12px rgba(0,0,0,0.1);
        padding: 20px 0;
        min-height: calc(100vh - 99px);
        position: fixed;
        top: 99px;
        left: 0;
        margin-left: 0;
        border-left: none;
        border-right: 2px solid #e5e7eb;
        z-index: 100;
        overflow-y: auto;
        max-height: calc(100vh - 99px);
    }

    .sidebar-header {
        padding: 0 20px 20px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
        padding-top: 12px;
        background: #f0fdfa;
        border-radius: 0;
    }

    .sidebar-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-header h3 i {
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 0 12px;
        margin-top: 8px;
    }

    .sidebar-nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        border-radius: 6px;
        text-decoration: none;
        color: #64748b;
        font-weight: 500;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    .sidebar-nav-item:hover {
        background: #f8fafc;
        color: var(--primary-color);
    }

    .sidebar-nav-item.active {
        background: var(--primary-color);
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
    }

    .sidebar-nav-item.active i {
        color: white;
    }

    .sidebar-nav-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        transition: color 0.2s ease;
        font-size: 1rem;
    }

    .sidebar-nav-item:hover i {
        color: var(--primary-color);
    }

    .sidebar-nav-item.active i {
        color: white;
    }
    
    /* Sección de alertas de citas pasadas en el sidebar */
    .sidebar-alerts {
        margin-top: auto;
        padding: 16px 12px;
        border-top: 2px solid #e5e7eb;
        background: #fff;
    }
    
    .sidebar-alerts-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #fee2e2, #fef2f2);
        border-radius: 8px;
        border-left: 4px solid #dc2626;
    }
    
    .sidebar-alerts-header h4 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 700;
        color: #991b1b;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sidebar-alerts-header .alert-count {
        background: #dc2626;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 700;
        min-width: 28px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    }
    
    .sidebar-alerts-list {
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .sidebar-alert-item {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-left: 3px solid #dc2626;
        border-radius: 6px;
        padding: 10px 12px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .sidebar-alert-item:hover {
        background: #fee2e2;
        transform: translateX(2px);
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.2);
    }
    
    .sidebar-alert-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    
    .sidebar-alert-time {
        font-weight: 700;
        color: #dc2626;
        font-size: 0.9rem;
    }
    
    .sidebar-alert-estado {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: #dc2626;
        color: white;
        font-weight: 600;
    }
    
    .sidebar-alert-info {
        font-size: 0.8rem;
        color: #991b1b;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .sidebar-alert-info strong {
        color: #7f1d1d;
    }
    
    .sidebar-alert-empty {
        text-align: center;
        padding: 20px;
        color: #64748b;
        font-size: 0.85rem;
    }
    
    .sidebar-alert-empty i {
        font-size: 2rem;
        color: #cbd5e1;
        margin-bottom: 8px;
        display: block;
    }

    /* Contenido principal */
    .citas-content {
        flex: 1;
        min-width: 0;
        margin-left: 260px; /* Ancho del sidebar */
        margin-right: 0;
        margin-top: 0;
        padding: 4px 24px;
        padding-top: 4px;
        box-sizing: border-box;
        width: calc(100% - 260px);
        max-width: calc(100vw - 260px);
        position: relative;
    }
    
    /* Reducir espacio del content-wrapper dentro de citas */
    .citas-content .content-wrapper {
        gap: 8px !important;
    }
    
    /* Reducir espacio del breadcrumb */
    .citas-content .breadcrumbs {
        margin-bottom: 4px !important;
        margin-top: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 2px !important;
    }
    
    /* Reducir espacio del header */
    .citas-content .header-with-stats {
        margin-bottom: 12px !important;
        margin-top: 0 !important;
    }
    
    /* Ocultar breadcrumb si no es necesario o reducir aún más */
    .citas-content .breadcrumbs {
        min-height: 0 !important;
    }

    /* Header con estadísticas */
    .header-with-stats {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        margin-top: 0;
        gap: 24px;
        width: 100%;
        max-width: 100%;
        padding: 0;
    }

    .page-header {
        flex: 1;
        min-width: 0;
        padding: 0;
    }

    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        line-height: 1.2;
    }

    .page-subtitle {
        color: #64748b;
        font-size: 15px;
        margin: 0;
        line-height: 1.4;
    }

    .dashboard-compact {
        flex-shrink: 0;
        padding: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        min-width: fit-content;
        width: 100%;
    }

    .stat-card {
        background: white;
        padding: 16px 18px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 140px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: white;
        flex-shrink: 0;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    }

    .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }

    /* Botón agregar cita */
    .btn-add-cita-header {
        margin-bottom: 24px;
        margin-top: 0;
        display: flex;
        justify-content: flex-end;
        width: 100%;
        padding: 0;
    }

    .btn-add-cita {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .btn-add-cita:hover {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .citas-layout-container {
            flex-direction: column;
            margin-left: 0;
        }

        .citas-sidebar {
            width: 100%;
            position: static;
            border-radius: 12px;
            margin-bottom: 24px;
            min-height: auto;
            max-height: none;
            top: auto;
            left: auto;
        }

        .citas-content {
            margin-left: 0;
            padding: 16px;
            width: 100%;
            max-width: 100%;
        }
        
        .header-with-stats {
            flex-direction: column;
            gap: 16px;
        }

        .sidebar-nav {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
        }

        .sidebar-nav-item {
            flex: 1;
            min-width: 150px;
            justify-content: center;
        }

        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .header-with-stats {
            flex-direction: column;
            gap: 16px;
        }

        .dashboard-compact {
            width: 100%;
        }

        .page-title {
            font-size: 24px;
        }

        .stat-card {
            min-width: 100%;
        }
    }
    
    /* Ajustes para pantallas grandes */
    @media (min-width: 1400px) {
        .citas-content {
            margin-left: 276px;
            max-width: calc(100vw - 276px - 80px);
            padding-right: 40px;
            padding-left: 0;
        }
        
        .tabla-citas {
            min-width: 100%;
        }
    }
    
    /* Asegurar que el contenido no se desborde */
    .citas-content * {
        box-sizing: border-box;
    }
    
    /* Override del padding del main-content del base.html */
    .main-content {
        padding: 0 !important;
        margin: 0 !important;
        max-width: 100% !important;
    }
    
    .content-wrapper {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Estilos para modales */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
    }
    
    .modal-overlay.show {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: visible;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
        position: relative;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .modal-header {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }
    
    .modal-header h3 {
        margin: 0;
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-body {
        padding: 24px;
        overflow: visible !important;
        position: relative;
    }
    
    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: #f8fafc;
    }
    
    .form-group-modal {
        margin-bottom: 20px;
        position: relative;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }
    
    .form-control-modal {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .form-control-modal:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .btn-primary, .btn-secondary {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    .checkbox-label-modern {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 0.875rem;
        color: #374151;
    }
    
    .checkbox-label-modern input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .cliente-search-wrapper {
        position: relative;
        z-index: 1;
    }
    
    .cliente-search-wrapper .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
        z-index: 2;
    }
    
    .cliente-results-list {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10001 !important;
        display: none !important;
        margin-top: 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 100%;
        box-sizing: border-box;
    }
    
    .cliente-results-list.show {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Asegurar que el modal-body no corte los resultados */
    .modal-body {
        overflow: visible !important;
    }
    
    /* Asegurar que el form-group no corte los resultados */
    .form-group-modal {
        overflow: visible !important;
    }
    
    .cliente-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
        display: block;
        width: 100%;
        box-sizing: border-box;
    }
    
    .cliente-result-item:hover {
        background: #f8fafc;
    }
    
    .cliente-result-item:last-child {
        border-bottom: none;
    }
    
    .cliente-result-item strong {
        display: block;
        margin-bottom: 4px;
    }
    
    .cliente-result-item small {
        display: block;
        font-size: 0.75rem;
    }
    
    .required-badge {
        color: #ef4444;
        margin-left: 4px;
    }
    
    /* Estilos para modal de información de cita */
    .modal-container-simple {
        max-width: 500px;
    }
    
    .cita-info-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item:last-child {
        border-bottom: none;
    }
    
    .cita-info-card .info-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 140px;
    }
    
    .cita-info-card .info-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 500;
        text-align: right;
        flex: 1;
    }
    
    .badge-estado {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .badge-estado.completada {
        background: #dcfce7;
        color: #166534;
    }
    
    .badge-estado.cancelada {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .badge-estado.no_show {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-estado.reservada,
    .badge-estado.confirmada {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .badge-estado.disponible {
        background: #f3f4f6;
        color: #374151;
    }
    
    /* Sistema de Notificaciones Moderno */
    .notification-container {
        position: fixed;
        top: 90px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
        pointer-events: none;
    }
    
    .notification {
        background: white;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        pointer-events: auto;
        border-left: 4px solid;
        min-width: 320px;
        max-width: 400px;
    }
    
    .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(to right, #f0fdf4 0%, white 8%);
    }
    
    .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(to right, #fef2f2 0%, white 8%);
    }
    
    .notification.warning {
        border-left-color: #f59e0b;
        background: linear-gradient(to right, #fffbeb 0%, white 8%);
    }
    
    .notification.info {
        border-left-color: var(--primary-color);
        background: linear-gradient(to right, #eff6ff 0%, white 8%);
    }
    
    .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
    }
    
    .notification.success .notification-icon {
        background: #10b981;
        color: white;
    }
    
    .notification.error .notification-icon {
        background: #ef4444;
        color: white;
    }
    
    .notification.warning .notification-icon {
        background: #f59e0b;
        color: white;
    }
    
    .notification.info .notification-icon {
        background: var(--primary-color);
        color: white;
    }
    
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    
    .notification-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .notification-message {
        font-size: 0.875rem;
        color: #64748b;
        line-height: 1.5;
        word-wrap: break-word;
    }
    
    .notification-close {
        background: transparent;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
    }
    
    .notification-close:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .notification.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
    }
</style>

<!-- Layout con Navbar Lateral -->
<div class="citas-layout-container">
    <!-- Navbar Lateral -->
    <nav class="citas-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-calendar-alt"></i> Citas</h3>
        </div>
        <div class="sidebar-nav">
            <a href="{% url 'citas_dia' %}" class="sidebar-nav-item {% if seccion_activa == 'dia' %}active{% endif %}">
                <i class="fas fa-calendar-day"></i>
                <span>Citas del Día</span>
            </a>
            <a href="{% url 'citas_disponibles' %}" class="sidebar-nav-item {% if seccion_activa == 'disponibles' %}active{% endif %}">
                <i class="fas fa-calendar-plus"></i>
                <span>Citas Disponibles</span>
            </a>
            <a href="{% url 'citas_tomadas' %}" class="sidebar-nav-item {% if seccion_activa == 'tomadas' %}active{% endif %}">
                <i class="fas fa-calendar-check"></i>
                <span>Citas Tomadas</span>
            </a>
            <a href="{% url 'citas_completadas' %}" class="sidebar-nav-item {% if seccion_activa == 'completadas' %}active{% endif %}">
                <i class="fas fa-check-circle"></i>
                <span>Citas Completadas</span>
            </a>
            <a href="{% url 'calendario_citas' %}" class="sidebar-nav-item {% if seccion_activa == 'calendario' %}active{% endif %}">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendario General</span>
            </a>
        </div>
        
        <!-- Sección de Alertas de Citas Pasadas -->
        <div class="sidebar-alerts">
            <div class="sidebar-alerts-header">
                <h4>
                    <i class="fas fa-exclamation-triangle"></i>
                    Citas Pasadas
                </h4>
                <span class="alert-count">{{ citas_pasadas|length|default:0 }}</span>
            </div>
            <div class="sidebar-alerts-list">
                {% if citas_pasadas %}
                    {% for cita in citas_pasadas|slice:":5" %}
                    <div class="sidebar-alert-item" onclick="scrollToCita({{ cita.id }})" title="Haz clic para ver detalles">
                        <div class="sidebar-alert-item-header">
                            <span class="sidebar-alert-time">
                                <i class="fas fa-clock"></i> {{ cita.fecha_hora|time:"H:i" }}
                            </span>
                            <span class="sidebar-alert-estado">{{ cita.get_estado_display }}</span>
                        </div>
                        <div class="sidebar-alert-info">
                            {% if cita.cliente %}
                                <strong><i class="fas fa-user"></i> {{ cita.cliente.nombre_completo|truncatewords:2 }}</strong>
                            {% elif cita.paciente_nombre %}
                                <strong><i class="fas fa-user"></i> {{ cita.paciente_nombre|truncatewords:2 }}</strong>
                            {% else %}
                                <strong><i class="fas fa-user"></i> Sin asignar</strong>
                            {% endif %}
                            {% if cita.tipo_servicio %}
                                <span><i class="fas fa-tooth"></i> {{ cita.tipo_servicio.nombre|truncatewords:3 }}</span>
                            {% elif cita.tipo_consulta %}
                                <span><i class="fas fa-tooth"></i> {{ cita.tipo_consulta|truncatewords:3 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% if citas_pasadas|length > 5 %}
                        <div class="sidebar-alert-empty" style="padding: 10px; font-size: 0.8rem; color: #64748b; text-align: center;">
                            <i class="fas fa-ellipsis-h"></i>
                            Y {{ citas_pasadas|length|add:"-5" }} más...
                        </div>
                    {% endif %}
                {% else %}
                    <div class="sidebar-alert-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>No hay citas pasadas</p>
                        <p style="font-size: 0.75rem; margin-top: 4px;">Todo está al día</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="citas-content">
        <!-- Header con Stats a la Derecha -->
        <div class="header-with-stats">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-calendar-alt"></i> Gestor de Citas</h1>
                <p class="page-subtitle">Administra las citas y horarios de la clínica dental</p>
            </div>
            <div class="dashboard-compact">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ estadisticas.citas_hoy }}</div>
                            <div class="stat-label">Citas de Hoy</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ estadisticas.disponibles }}</div>
                            <div class="stat-label">Disponibles</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ estadisticas.realizadas }}</div>
                            <div class="stat-label">Realizadas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if perfil.es_administrativo %}
        <div class="btn-add-cita-header">
            <button class="btn-add-cita" onclick="openAddCitaModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Agregar Nueva Cita</span>
            </button>
        </div>
        {% endif %}

        {% if seccion_activa == 'dia' %}
            <!-- Citas del Día -->
            <div class="citas-results">
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-day"></i> Citas del Día - {% now "d/m/Y" %}</h3>
                        <p>{{ citas.paginator.count }} cita(s) programada(s) para hoy</p>
                    </div>
                </div>
                
                <!-- Filtro de búsqueda -->
                <div class="search-filter-container">
                    <form method="get" action="{% url 'citas_dia' %}" class="search-form">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <label for="search-input-dia" class="sr-only">Buscar citas del día</label>
                            <input type="text" name="search" id="search-input-dia" value="{{ search_query|default:'' }}" placeholder="Buscar por cliente, servicio, dentista, teléfono..." class="search-input" autocomplete="off" aria-label="Buscar por cliente, servicio, dentista, teléfono">
                            {% if search_query %}
                                <a href="{% url 'citas_dia' %}" class="clear-search" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                {% if citas %}
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-phone"></i> Teléfono</th>
                                <th><i class="fas fa-user-md"></i> Dentista</th>
                                <th style="text-align: right;"><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr class="fila-cita {% if cita.estado == 'completada' %}completada{% elif cita.estado == 'no_show' %}cita-no-llego-fila{% elif cita.estado == 'en_espera' %}en-espera{% elif cita.estado == 'en_progreso' %}en-progreso{% else %}pendiente{% endif %} {% if cita.requiere_atencion %}alert-row-cita{% endif %}">
                                <td class="col-hora">
                                    {% if cita.requiere_atencion %}
                                        <span class="alert-icon-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span class="tooltip-warning">Esta cita está pasada de su horario</span>
                                        </span>
                                    {% endif %}
                                    {{ cita.fecha_hora|time:"H:i" }}
                                </td>
                                <td class="col-tipo">
                                    {% if cita.plan_tratamiento %}
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span class="badge" style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap;">
                                                <i class="fas fa-clipboard-list"></i> Tratamiento
                                            </span>
                                            {% if cita.tipo_servicio %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                            {% elif cita.tipo_consulta %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                            {% endif %}
                                        </div>
                                        {% if cita.plan_tratamiento.nombre %}
                                        <small style="color: #64748b; font-size: 0.75rem;">
                                            <i class="fas fa-file-medical"></i> {{ cita.plan_tratamiento.nombre|truncatewords:5 }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                    {% else %}
                                        <span class="text-muted">Sin servicio</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    {% if cita.requiere_atencion %}
                                        <span class="badge-estado" style="background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;">
                                            {% if cita.estado == 'disponible' %}
                                                Disponible
                                            {% elif cita.estado == 'reservada' %}
                                                Reservada
                                            {% elif cita.estado == 'confirmada' %}
                                                Confirmada
                                            {% else %}
                                                {{ cita.get_estado_display }}
                                            {% endif %}
                                        </span>
                                    {% elif cita.estado == 'completada' %}
                                        <span class="badge-estado badge-completada-estado">Completada</span>
                                    {% elif cita.estado == 'no_show' %}
                                        <span class="badge-estado badge-no-asistida">No asistida</span>
                                    {% elif cita.estado == 'en_espera' %}
                                        <span class="badge-estado" style="background: #fef3c7; color: #92400e;">En Espera</span>
                                    {% elif cita.estado == 'en_progreso' %}
                                        <span class="badge-estado" style="background: #dbeafe; color: #1e40af;">En Progreso</span>
                                    {% elif cita.estado == 'reservada' %}
                                        <span class="badge-estado reservada">Reservada</span>
                                    {% elif cita.estado == 'disponible' %}
                                        <span class="badge-estado disponible">Disponible</span>
                                    {% else %}
                                        <span class="badge-estado reservada">{{ cita.get_estado_display }}</span>
                                    {% endif %}
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {% if cita.cliente %}
                                            {{ cita.cliente.nombre_completo }}
                                        {% elif cita.paciente_nombre %}
                                            {{ cita.paciente_nombre }}
                                        {% else %}
                                            Sin asignar
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="col-telefono">
                                    <div class="telefono-info-compact">
                                        <i class="fas fa-phone"></i>
                                        {% if cita.cliente and cita.cliente.telefono %}
                                            {{ cita.cliente.telefono }}
                                        {% elif cita.paciente_telefono %}
                                            {{ cita.paciente_telefono }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="col-dentista">
                                    {% if cita.dentista %}
                                        <div class="dentista-info-compact">
                                            <i class="fas fa-user-md"></i>
                                            {{ cita.dentista.nombre_completo }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <div style="display: flex !important; gap: 6px; align-items: center; justify-content: flex-end !important; width: 100%; margin-left: auto;">
                                        {% if perfil.es_administrativo %}
                                            {% if cita.estado == 'reservada' or cita.estado == 'confirmada' %}
                                                <button onclick="marcarLlegada({{ cita.id }})" class="btn-accion btn-llego" title="Marcar como llegó" aria-label="Marcar como llegó" style="background: #10b981; color: white; border-color: #10b981; flex-shrink: 0;">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button onclick="marcarNoLlego({{ cita.id }})" class="btn-accion btn-no-llego" title="Marcar como No Llegó" aria-label="Marcar como No Llegó" style="background: #ef4444; color: white; border-color: #ef4444; flex-shrink: 0;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                        <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion" title="Ver opciones" aria-label="Ver opciones de la cita" style="flex-shrink: 0;">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                {% if citas.paginator.count >= 6 %}
                <div class="pagination" style="margin-top: 24px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="pagination-info">
                        Mostrando {{ citas.start_index }} - {{ citas.end_index }} de {{ citas.paginator.count }} citas
                    </div>
                    <div class="pagination-controls">
                        {% if citas.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ citas.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas.number }} de {{ citas.paginator.num_pages }}
                        </span>
                        
                        {% if citas.has_next %}
                            <a href="?page={{ citas.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ citas.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <h3>No hay citas programadas para hoy</h3>
                    <p>Las citas del día aparecerán aquí</p>
                </div>
                {% endif %}
            </div>
        {% elif seccion_activa == 'disponibles' %}
            <!-- Citas Disponibles -->
            <div class="citas-results">
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-check"></i> Citas Disponibles</h3>
                        <p>{{ citas.paginator.count }} cita(s) disponible(s)</p>
                    </div>
                </div>
                
                <!-- Filtro de búsqueda -->
                <div class="search-filter-container">
                    <form method="get" action="{% url 'citas_disponibles' %}" class="search-form">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <label for="search-input-disponibles" class="sr-only">Buscar citas disponibles</label>
                            <input type="text" name="search" id="search-input-disponibles" value="{{ search_query|default:'' }}" placeholder="Buscar por servicio, dentista, fecha..." class="search-input" autocomplete="off" aria-label="Buscar por servicio, dentista, fecha">
                            {% if search_query %}
                                <a href="{% url 'citas_disponibles' %}" class="clear-search" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                {% if citas %}
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-hourglass-half"></i> Duración</th>
                                <th><i class="fas fa-dollar-sign"></i> Precio</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user-md"></i> Dentista</th>
                                <th style="text-align: right;"><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr class="fila-cita disponible {% if cita.requiere_atencion %}alert-row-cita{% endif %}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">
                                    {% if cita.requiere_atencion %}
                                        <span class="alert-icon-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span class="tooltip-warning">Esta cita está pasada de su horario</span>
                                        </span>
                                    {% endif %}
                                    {{ cita.fecha_hora|time:"H:i" }}
                                </td>
                                <td class="col-tipo">
                                    {% if cita.plan_tratamiento %}
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span class="badge" style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap;">
                                                <i class="fas fa-clipboard-list"></i> Tratamiento
                                            </span>
                                            {% if cita.tipo_servicio %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                            {% elif cita.tipo_consulta %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                            {% endif %}
                                        </div>
                                        {% if cita.plan_tratamiento.nombre %}
                                        <small style="color: #64748b; font-size: 0.75rem;">
                                            <i class="fas fa-file-medical"></i> {{ cita.plan_tratamiento.nombre|truncatewords:5 }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                    {% else %}
                                        <span class="text-muted">Sin servicio</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="col-duracion">
                                    {% if cita.tipo_servicio and cita.tipo_servicio.duracion_estimada %}
                                        <span class="duracion-badge">{{ cita.tipo_servicio.duracion_estimada }} min</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="col-precio">
                                    {% if cita.precio_cobrado %}
                                        <span class="precio-badge">${{ cita.precio_cobrado|floatformat:0 }}</span>
                                    {% elif cita.tipo_servicio %}
                                        <span class="precio-badge">${{ cita.tipo_servicio.precio_base|floatformat:0 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    {% if cita.requiere_atencion %}
                                        <span class="badge-estado" style="background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;">Disponible</span>
                                    {% else %}
                                        <span class="badge-estado disponible">Disponible</span>
                                    {% endif %}
                                </td>
                                <td class="col-dentista">
                                    {% if cita.dentista %}
                                        {{ cita.dentista.nombre_completo }}
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <div style="display: flex !important; gap: 6px; align-items: center; justify-content: flex-end !important; width: 100%; margin-left: auto;">
                                        <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion" aria-label="Ver opciones de la cita" style="flex-shrink: 0;">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                {% if citas.paginator.count >= 6 %}
                <div class="pagination" style="margin-top: 24px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="pagination-info">
                        Mostrando {{ citas.start_index }} - {{ citas.end_index }} de {{ citas.paginator.count }} citas
                        {% if search_query %}
                            <span style="color: var(--primary-color); margin-left: 8px;">
                                <i class="fas fa-filter"></i> Filtrado: "{{ search_query }}"
                            </span>
                        {% endif %}
                    </div>
                    <div class="pagination-controls">
                        {% if citas.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ citas.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas.number }} de {{ citas.paginator.num_pages }}
                        </span>
                        
                        {% if citas.has_next %}
                            <a href="?page={{ citas.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ citas.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3>No hay citas disponibles</h3>
                    <p>{% if search_query %}No se encontraron citas con "{{ search_query }}"{% else %}Haz clic en el botón "Agregar Nueva Cita" para crear una nueva cita{% endif %}</p>
                </div>
                {% endif %}
            </div>
        {% elif seccion_activa == 'tomadas' %}
            <!-- Citas Tomadas -->
            <div class="citas-results">
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-check"></i> Citas Reservadas</h3>
                        <p>{{ citas.paginator.count }} cita(s) reservada(s)</p>
                    </div>
                </div>
                
                <!-- Filtro de búsqueda -->
                <div class="search-filter-container">
                    <form method="get" action="{% url 'citas_tomadas' %}" class="search-form">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <label for="search-input-tomadas" class="sr-only">Buscar citas tomadas</label>
                            <input type="text" name="search" id="search-input-tomadas" value="{{ search_query|default:'' }}" placeholder="Buscar por cliente, servicio, dentista, teléfono..." class="search-input" autocomplete="off" aria-label="Buscar por cliente, servicio, dentista, teléfono">
                            {% if search_query %}
                                <a href="{% url 'citas_tomadas' %}" class="clear-search" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                {% if citas %}
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th style="text-align: right;"><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr class="fila-cita reservada {% if cita.requiere_atencion %}alert-row-cita{% endif %}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">
                                    {% if cita.requiere_atencion %}
                                        <span class="alert-icon-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span class="tooltip-warning">Esta cita está pasada de su horario</span>
                                        </span>
                                    {% endif %}
                                    {{ cita.fecha_hora|time:"H:i" }}
                                </td>
                                <td class="col-tipo">
                                    {% if cita.plan_tratamiento %}
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span class="badge" style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                                <i class="fas fa-clipboard-list"></i> Tratamiento
                                            </span>
                                            {% if cita.tipo_servicio %}
                                            <span>{{ cita.tipo_servicio.nombre }}</span>
                                            {% elif cita.tipo_consulta %}
                                            <span>{{ cita.tipo_consulta }}</span>
                                            {% endif %}
                                        </div>
                                        {% if cita.plan_tratamiento.nombre %}
                                        <small style="color: #64748b; font-size: 0.75rem;">
                                            <i class="fas fa-file-medical"></i> {{ cita.plan_tratamiento.nombre|truncatewords:5 }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                    {% else %}
                                        <span class="text-muted">Sin servicio</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    {% if cita.requiere_atencion %}
                                        <span class="badge-estado" style="background: #fee2e2; color: #991b1b; border: 1px solid #fecaca;">{{ cita.get_estado_display }}</span>
                                    {% else %}
                                        <span class="badge-estado reservada">{{ cita.get_estado_display }}</span>
                                    {% endif %}
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {{ cita.nombre_paciente|default:"Sin asignar" }}
                                    </div>
                                </td>
                                <td class="col-acciones">
                                    <div style="display: flex !important; gap: 6px; align-items: center; justify-content: flex-end !important; width: 100%; margin-left: auto;">
                                        <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion" aria-label="Ver opciones de la cita" style="flex-shrink: 0;">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                {% if citas.paginator.count >= 6 %}
                <div class="pagination" style="margin-top: 24px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="pagination-info">
                        Mostrando {{ citas.start_index }} - {{ citas.end_index }} de {{ citas.paginator.count }} citas
                        {% if search_query %}
                            <span style="color: var(--primary-color); margin-left: 8px;">
                                <i class="fas fa-filter"></i> Filtrado: "{{ search_query }}"
                            </span>
                        {% endif %}
                    </div>
                    <div class="pagination-controls">
                        {% if citas.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ citas.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas.number }} de {{ citas.paginator.num_pages }}
                        </span>
                        
                        {% if citas.has_next %}
                            <a href="?page={{ citas.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ citas.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3>No hay citas reservadas</h3>
                    <p>{% if search_query %}No se encontraron citas con "{{ search_query }}"{% else %}Las citas reservadas aparecerán en este listado{% endif %}</p>
                </div>
                {% endif %}
            </div>
        {% elif seccion_activa == 'completadas' %}
            <!-- Citas Completadas -->
            <div class="citas-results">
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-check-circle"></i> Citas Completadas</h3>
                        <p>{{ citas.paginator.count }} cita(s) completada(s)</p>
                    </div>
                </div>
                
                <!-- Filtro de búsqueda -->
                <div class="search-filter-container">
                    <form method="get" action="{% url 'citas_completadas' %}" class="search-form">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <label for="search-input-completadas" class="sr-only">Buscar citas completadas</label>
                            <input type="text" name="search" id="search-input-completadas" value="{{ search_query|default:'' }}" placeholder="Buscar por cliente, servicio, dentista, fecha..." class="search-input" autocomplete="off" aria-label="Buscar por cliente, servicio, dentista, fecha">
                            {% if search_query %}
                                <a href="{% url 'citas_completadas' %}" class="clear-search" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                {% if citas %}
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-user-md"></i> Dentista</th>
                                <th><i class="fas fa-eye"></i> Ver</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas %}
                            <tr class="fila-cita {% if cita.estado == 'no_show' %}cita-no-llego-fila{% elif cita.estado == 'cancelada' %}cita-cancelada-fila{% else %}completada{% endif %} {% if cita.requiere_atencion %}alert-row-cita{% endif %}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">
                                    {% if cita.requiere_atencion %}
                                        <span class="alert-icon-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span class="tooltip-warning">Esta cita está pasada de su horario</span>
                                        </span>
                                    {% endif %}
                                    {{ cita.fecha_hora|time:"H:i" }}
                                </td>
                                <td class="col-tipo">
                                    {% if cita.plan_tratamiento %}
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                            <span class="badge" style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; white-space: nowrap;">
                                                <i class="fas fa-clipboard-list"></i> Tratamiento
                                            </span>
                                            {% if cita.tipo_servicio %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                            {% elif cita.tipo_consulta %}
                                            <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                            {% endif %}
                                        </div>
                                        {% if cita.plan_tratamiento.nombre %}
                                        <small style="color: #64748b; font-size: 0.75rem;">
                                            <i class="fas fa-file-medical"></i> {{ cita.plan_tratamiento.nombre|truncatewords:5 }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_servicio.nombre }}</span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge">{{ cita.tipo_consulta }}</span>
                                    {% else %}
                                        <span class="text-muted">Sin servicio</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    {% if cita.estado == 'no_show' %}
                                        <span class="badge-estado badge-no-asistida">No asistida</span>
                                    {% elif cita.estado == 'cancelada' %}
                                        <span class="badge-estado badge-cancelada-estado">Cancelada</span>
                                    {% else %}
                                        <span class="badge-estado badge-completada-estado">Completada</span>
                                    {% endif %}
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {% if cita.cliente %}
                                            {{ cita.cliente.nombre_completo }}
                                        {% elif cita.paciente_nombre %}
                                            {{ cita.paciente_nombre }}
                                        {% else %}
                                            Sin asignar
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="col-dentista">
                                    {% if cita.dentista %}
                                        <div class="dentista-info-compact">
                                            <i class="fas fa-user-md"></i>
                                            {{ cita.dentista.nombre_completo }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <div style="display: flex !important; gap: 6px; align-items: center; justify-content: flex-end !important; width: 100%; margin-left: auto;">
                                        <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion" title="Ver detalles" style="flex-shrink: 0;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación -->
                {% if citas.paginator.count >= 6 %}
                <div class="pagination" style="margin-top: 24px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="pagination-info">
                        Mostrando {{ citas.start_index }} - {{ citas.end_index }} de {{ citas.paginator.count }} citas
                        {% if search_query %}
                            <span style="color: var(--primary-color); margin-left: 8px;">
                                <i class="fas fa-filter"></i> Filtrado: "{{ search_query }}"
                            </span>
                        {% endif %}
                    </div>
                    <div class="pagination-controls">
                        {% if citas.has_previous %}
                            <a href="?page=1{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page={{ citas.previous_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas.number }} de {{ citas.paginator.num_pages }}
                        </span>
                        
                        {% if citas.has_next %}
                            <a href="?page={{ citas.next_page_number }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ citas.paginator.num_pages }}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>No hay citas completadas</h3>
                    <p>{% if search_query %}No se encontraron citas con "{{ search_query }}"{% else %}Las citas completadas aparecerán en este listado{% endif %}</p>
                </div>
                {% endif %}
            </div>
        {% elif seccion_activa == 'calendario' %}
            <!-- Calendario General -->
            <div class="citas-results">
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-alt"></i> Calendario General</h3>
                        <p>Vista de calendario de todas las citas</p>
                    </div>
                </div>
                
                <!-- Filtro de búsqueda para calendario -->
                <div class="search-filter-container">
                    <form method="get" action="{% url 'calendario_citas' %}" class="search-form">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <label for="calendar-search-input" class="sr-only">Buscar en calendario</label>
                            <input type="text" name="search" value="{{ search_query|default:'' }}" placeholder="Buscar por cliente, servicio, dentista..." class="search-input" autocomplete="off" id="calendar-search-input" aria-label="Buscar por cliente, servicio, dentista">
                            {% if search_query %}
                                <a href="{% url 'calendario_citas' %}" class="clear-search" title="Limpiar búsqueda" aria-label="Limpiar búsqueda">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </div>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </form>
                </div>
                
                <div id="calendar" style="width: 100%; max-width: 100%; margin: 0; padding: 24px; background: white; border-radius: 12px; box-sizing: border-box; min-height: 600px;"></div>
                
                <!-- Leyenda de colores del calendario -->
                <div class="calendar-legend" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                    <div style="font-weight: 600; color: #1e293b; margin-right: 8px;">Leyenda:</div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #10b981; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">Disponible</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #3b82f6; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">Reservada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #f59e0b; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">En Espera</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #8b5cf6; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">En Progreso</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #14b8a6; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">Completada</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #ef4444; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">No Llegó</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="display: inline-block; width: 16px; height: 16px; background: #9ca3af; border-radius: 3px;"></span>
                        <span style="color: #64748b; font-size: 0.875rem;">Cancelada</span>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Estilos adicionales para las tablas -->
<style>
    .citas-results {
        background: white;
        border-radius: 12px;
        padding: 20px 24px 20px 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        margin: 0;
        margin-left: 0;
        margin-right: 0;
        animation: fadeIn 0.4s ease;
    }

    .section-title-modern {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        margin-top: 0;
        margin-left: 0;
        padding-bottom: 16px;
        padding-left: 8px;
        border-bottom: 2px solid #e5e7eb;
        width: 100%;
    }

    .section-title-modern h3 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title-modern h3 i {
        color: var(--primary-color);
    }

    .section-title-modern p {
        margin: 4px 0 0 0;
        color: #64748b;
        font-size: 0.95rem;
    }

    /* Estilos para filtros de búsqueda */
    .search-filter-container {
        margin-bottom: 20px;
        padding: 0 8px;
    }

    .search-form {
        display: flex;
        gap: 12px;
        align-items: center;
        max-width: 600px;
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 14px;
        color: #94a3b8;
        font-size: 0.9rem;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 10px 14px 10px 40px;
        border: 1.5px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #1e293b;
        background: #f8fafc;
        transition: all 0.2s ease;
        outline: none;
    }

    .search-input:focus {
        border-color: var(--primary-color);
        background: white;
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .search-input::placeholder {
        color: #94a3b8;
    }

    .clear-search {
        position: absolute;
        right: 10px;
        color: #94a3b8;
        text-decoration: none;
        padding: 4px 6px;
        border-radius: 4px;
        transition: all 0.2s ease;
        z-index: 1;
    }

    .clear-search:hover {
        color: var(--primary-color);
        background: rgba(20, 184, 166, 0.1);
    }

    .search-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .search-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(20, 184, 166, 0.2);
    }

    .search-btn:active {
        transform: translateY(0);
    }

    .tabla-citas-wrapper {
        overflow-x: auto;
        width: 100%;
        max-width: 100%;
        -webkit-overflow-scrolling: touch;
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 0;
    }

    .tabla-citas {
        width: 100%;
        min-width: 100%;
        border-collapse: collapse;
        background: white;
        table-layout: fixed;
        margin: 0;
    }

    .tabla-citas thead {
        background: linear-gradient(135deg, #1f2937, #111827);
        color: white;
    }

    .tabla-citas th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .tabla-citas th:last-child {
        text-align: right !important;
    }

    .tabla-citas th i {
        margin-right: 8px;
    }

    .tabla-citas tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.2s ease;
    }

    .tabla-citas tbody tr:hover {
        background: #f8fafc;
    }
    
    /* Alerta para citas pasadas sin iniciar/tomar - Mejorado */
    .tabla-citas tbody tr.alert-row-cita {
        background: linear-gradient(90deg, #fee2e2 0%, #fef2f2 100%) !important;
        border-left: 5px solid #dc2626;
        position: relative;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
        animation: pulse-alert 2s ease-in-out infinite;
    }
    
    @keyframes pulse-alert {
        0%, 100% {
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
        }
        50% {
            box-shadow: 0 2px 12px rgba(220, 38, 38, 0.25);
        }
    }
    
    .tabla-citas tbody tr.alert-row-cita:hover {
        background: linear-gradient(90deg, #fecaca 0%, #fee2e2 100%) !important;
        transform: translateX(2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    
    .tabla-citas tbody tr.alert-row-cita td {
        color: #991b1b;
        font-weight: 600;
    }
    
    .tabla-citas tbody tr.alert-row-cita td {
        position: relative;
    }
    
    .alert-icon-warning {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #dc2626;
        font-size: 1rem;
        margin-right: 6px;
        cursor: help;
        position: relative;
        vertical-align: middle;
    }
    
    .alert-icon-warning:hover {
        color: #b91c1c;
        transform: scale(1.15);
    }
    
    .alert-icon-warning i {
        display: inline-block;
    }
    
    .tooltip-warning {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transform: translateX(-50%) translateY(-4px);
    }
    
    .tooltip-warning::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1e293b;
    }
    
    .alert-icon-warning:hover .tooltip-warning {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    
    .tabla-citas tbody tr.alert-row-cita .badge-estado {
        background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
        color: white !important;
        border: 2px solid #991b1b;
        position: relative;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(153, 27, 27, 0.3);
    }
    
    .tabla-citas tbody tr.alert-row-cita .col-hora {
        color: #dc2626;
        font-weight: 700;
        font-size: 1.05rem;
    }

    .tabla-citas td {
        padding: 16px 12px;
        color: #1e293b;
        font-size: 0.95rem;
        vertical-align: middle;
        word-wrap: break-word;
        overflow: hidden;
    }
    
    .tabla-citas td.col-hora,
    .tabla-citas td.col-telefono,
    .tabla-citas td.col-acciones {
        overflow: visible;
    }
    
    .tabla-citas td.col-acciones {
        text-align: right !important;
        padding-right: 16px;
    }
    
    .tabla-citas th {
        padding: 16px 12px;
    }

    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-estado.disponible {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-estado.reservada {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado.badge-completada-estado {
        background: #10b981;
        color: white;
    }

    .badge-estado.badge-no-asistida {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-estado.badge-cancelada-estado {
        background: #f3f4f6;
        color: #6b7280;
    }

    .tipo-servicio-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #eff6ff;
        color: #1e40af;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .btn-accion {
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        border-radius: 8px;
        border: 2px solid #cbd5e1;
        background: #f1f5f9;
        color: #475569;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        margin: 0;
        padding: 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-accion:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(20, 184, 166, 0.3);
    }
    
    .btn-accion:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .btn-accion.btn-llego,
    .btn-accion.btn-no-llego {
        border-width: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .btn-accion.btn-llego:hover,
    .btn-accion.btn-no-llego:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .cliente-info-compact, .dentista-info-compact {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .empty-results-modern {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: #f3f4f6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #9ca3af;
    }

    .empty-results-modern h3 {
        font-size: 1.25rem;
        color: #374151;
        margin-bottom: 8px;
    }

    .empty-results-modern p {
        font-size: 0.95rem;
    }

    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .pagination-info {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .page-btn {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        font-size: 0.875rem;
    }

    .page-btn:hover:not(.disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .page-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f9fafb;
    }

    .page-current {
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
    }

    .text-muted {
        color: #9ca3af;
    }

    /* Estilos adicionales de panel_trabajador */
    .tabla-citas-wrapper {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .tabla-citas .col-fecha { 
        width: 11%; 
        font-weight: 600;
        color: #1e293b;
        white-space: nowrap;
        padding: 16px 12px;
    }

    .tabla-citas .col-hora { 
        width: 8%; 
        min-width: 80px;
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
        padding: 16px 12px;
        vertical-align: middle;
    }

    .tabla-citas .col-tipo { 
        width: 16%; 
        min-width: 150px;
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-estado { 
        width: 10%; 
        min-width: 100px;
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-cliente { 
        width: 20%; 
        min-width: 180px;
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-telefono { 
        width: 12%; 
        min-width: 120px;
        padding: 16px 12px;
        vertical-align: middle;
        white-space: nowrap;
    }
    .tabla-citas .col-duracion { 
        width: 10%; 
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-precio { 
        width: 10%; 
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-dentista { 
        width: 18%; 
        min-width: 160px;
        padding: 16px 12px;
        vertical-align: middle;
    }
    .tabla-citas .col-acciones { 
        width: 10%; 
        min-width: 120px;
        padding: 16px 12px;
        text-align: right !important;
        vertical-align: middle;
    }
    
    .tabla-citas th:last-child {
        text-align: right !important;
    }
    
    .tabla-citas .col-acciones > div {
        display: flex !important;
        gap: 6px;
        align-items: center;
        justify-content: flex-end !important;
        width: 100%;
        margin-left: auto;
    }
    
    .tabla-citas .col-acciones .btn-accion {
        flex-shrink: 0;
        margin: 0;
    }
    
    .telefono-info-compact {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #1e293b;
    }
    
    .telefono-info-compact i {
        color: var(--primary-color);
        font-size: 0.8rem;
    }
    
    .duracion-badge {
        display: inline-block;
        padding: 4px 8px;
        background: #f0f9ff;
        color: #0369a1;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .precio-badge {
        display: inline-block;
        padding: 4px 8px;
        background: #f0fdfa;
        color: var(--primary-color);
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    /* Estilos responsive para calendario */
    @media (max-width: 768px) {
        .calendar-legend {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .calendar-legend > div {
            width: 100%;
        }
        
        #calendar {
            padding: 12px !important;
        }
        
        .fc-header-toolbar {
            flex-direction: column;
            gap: 8px;
        }
        
        .fc-toolbar-chunk {
            width: 100%;
            text-align: center;
        }
    }

    .cita-no-llego-fila {
        background: #fef2f2 !important;
        border-left: 4px solid #dc2626;
    }

    .cita-cancelada-fila {
        background: #f9fafb !important;
        border-left: 4px solid #9ca3af;
    }
    
    /* Estilos para el modal de detalles de cita */
    .cita-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
    }
    
    .cita-modal-container {
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .cita-modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
        overflow: hidden;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .cita-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 2px solid #e5e7eb;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }
    
    .cita-modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .cita-modal-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 1.1rem;
    }
    
    .cita-modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }
    
    .cita-modal-body {
        padding: 24px;
        max-height: calc(90vh - 200px);
        overflow-y: auto;
    }
    
    .cita-detalle-item {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .cita-detalle-item:last-child {
        border-bottom: none;
    }
    
    .cita-detalle-label {
        font-weight: 600;
        color: #64748b;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .cita-detalle-label i {
        color: var(--primary-color);
        width: 18px;
    }
    
    .cita-detalle-value {
        color: #1e293b;
        font-size: 0.95rem;
    }
    
    .precio-destacado {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-color);
    }
    
    /* Badge de estado en el modal */
    .badge-estado-modal {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .badge-estado-modal i {
        font-size: 0.75rem;
    }
    
    .cita-modal-footer {
        padding: 20px 24px;
        border-top: 2px solid #e5e7eb;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: #f8fafc;
    }
    
    .cita-modal-btn-primary,
    .cita-modal-btn-secondary {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        border: none;
        font-size: 0.9rem;
    }
    
    .cita-modal-btn-primary {
        background: var(--primary-color);
        color: white;
    }
    
    .cita-modal-btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
    }
    
    .cita-modal-btn-secondary {
        background: white;
        color: #64748b;
        border: 1.5px solid #e2e8f0;
    }
    
    .cita-modal-btn-secondary:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    /* Mejorar diseño de eventos en el calendario */
    .cita-calendario-event {
        border-radius: 6px !important;
        padding: 4px 6px !important;
        font-size: 0.85rem !important;
        font-weight: 500 !important;
        border: none !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        transition: all 0.2s ease !important;
    }
    
    .cita-calendario-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        z-index: 10 !important;
    }
    
    .fc-event-title {
        font-weight: 500 !important;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Mejorar diseño cuando hay muchas citas */
    .fc-more-link {
        background: var(--primary-color) !important;
        color: white !important;
        border-radius: 4px !important;
        padding: 4px 8px !important;
        font-weight: 500 !important;
        font-size: 0.85rem !important;
    }
    
    .fc-more-link:hover {
        background: var(--primary-dark) !important;
    }
    
    @media (max-width: 768px) {
        .cita-modal-container {
            max-width: 100%;
            padding: 0;
        }
        
        .cita-modal-content {
            border-radius: 0;
            max-height: 100vh;
        }
        
        .cita-modal-body {
            max-height: calc(100vh - 180px);
        }
        
        .cita-detalle-item {
            grid-template-columns: 1fr;
            gap: 6px;
        }
        
        .cita-modal-footer {
            flex-direction: column;
        }
        
        .cita-modal-btn-primary,
        .cita-modal-btn-secondary {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<!-- FullCalendar CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/locales/es.global.min.js"></script>

<!-- Contenedor de Notificaciones -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Scripts necesarios (simplificados) -->
<script>
// Función helper para obtener el token CSRF de forma segura
function getCSRFToken() {
    var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    // Intentar obtener del cookie
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
            return cookie.substring('csrftoken='.length);
        }
    }
    return null;
}

// Sistema de Notificaciones Moderno
function showNotification(type, message, duration = 5000) {
    // Tipos válidos: success, error, warning, info
    const validTypes = ['success', 'error', 'warning', 'info'];
    type = validTypes.includes(type) ? type : 'info';
    
    // Obtener o crear contenedor
    let container = document.getElementById('notificationContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.className = 'notification-container';
        document.body.appendChild(container);
    }
    
    // Crear notificación
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // Iconos según tipo
    const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error: '<i class="fas fa-exclamation-circle"></i>',
        warning: '<i class="fas fa-exclamation-triangle"></i>',
        info: '<i class="fas fa-info-circle"></i>'
    };
    
    // Títulos según tipo
    const titles = {
        success: 'Éxito',
        error: 'Error',
        warning: 'Advertencia',
        info: 'Información'
    };
    
    notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
            <div class="notification-title">${titles[type]}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.closest('.notification').remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Agregar al contenedor
    container.appendChild(notification);
    
    // Auto-remover después de la duración
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, duration);
    }
    
    return notification;
}

// Función para abrir modal de agregar cita
function openAddCitaModal() {
    // Verificar si el modal existe en la página actual
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        // Si el modal existe, intentar abrirlo
        try {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Limpiar el formulario
            var form = document.getElementById('formAgregarCitaModal');
            if (form) {
                form.reset();
            }
            
            // Establecer fecha mínima (hoy)
            var fechaInput = document.getElementById('addCitaFechaHora');
            if (fechaInput) {
                var ahora = new Date();
                var año = ahora.getFullYear();
                var mes = String(ahora.getMonth() + 1).padStart(2, '0');
                var dia = String(ahora.getDate()).padStart(2, '0');
                var hora = String(ahora.getHours()).padStart(2, '0');
                var minuto = String(ahora.getMinutes()).padStart(2, '0');
                var fechaMinima = año + '-' + mes + '-' + dia + 'T' + hora + ':' + minuto;
                fechaInput.setAttribute('min', fechaMinima);
            }
            
            // Resetear campos de cliente
            var clienteFields = document.getElementById('clienteFieldsContainer');
            var clienteCheck = document.getElementById('asignarClienteCheck');
            if (clienteFields) {
                clienteFields.style.display = 'none';
            }
            if (clienteCheck) {
                clienteCheck.checked = false;
            }
            var searchInput = document.getElementById('clienteSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            return;
        } catch(e) {
            console.error('Error al abrir modal:', e);
        }
    }
    // Si no existe o hay error, redirigir al panel principal donde están los modales
    window.location.href = '{% url "panel_trabajador" %}?tab=list';
}

// Función para cerrar modal de agregar cita
function closeAddCitaModal() {
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Función para abrir modal de opciones de cita
function openOptionsModalForCita(citaId) {
    // Verificar si el modal de información existe
    var infoModal = document.getElementById('citaInfoModal');
    var optionsModal = document.getElementById('optionsModal');
    
    // Si el modal de información existe, cargar los datos y mostrarlo
    if (infoModal) {
        // Mostrar loading - verificar que los elementos existan antes de acceder
        var modalFecha = document.getElementById('modalCitaFecha');
        var modalHora = document.getElementById('modalCitaHora');
        var modalPaciente = document.getElementById('modalCitaPaciente');
        var modalTipo = document.getElementById('modalCitaTipo');
        var modalDentista = document.getElementById('modalCitaDentista');
        var modalEstado = document.getElementById('modalCitaEstado');
        
        if (modalFecha) modalFecha.textContent = 'Cargando...';
        if (modalHora) modalHora.textContent = '';
        if (modalPaciente) modalPaciente.textContent = '';
        if (modalTipo) modalTipo.textContent = '';
        if (modalDentista) modalDentista.textContent = '';
        if (modalEstado) modalEstado.textContent = '';
        
        // Ocultar campos opcionales - verificar que existan
        var precioContainer = document.getElementById('modalCitaPrecioContainer');
        var motivoContainer = document.getElementById('modalCitaMotivoContainer');
        
        if (precioContainer) precioContainer.style.display = 'none';
        if (motivoContainer) motivoContainer.style.display = 'none';
        
        // Ocultar todos los botones inicialmente
        var btnAjustarPrecio = document.getElementById('btnAjustarPrecioModal');
        var btnCancelarCita = document.getElementById('btnCancelarCitaModal');
        var btnEliminarCita = document.getElementById('btnEliminarCitaModal');
        var btnCompletarCita = document.getElementById('btnCompletarCitaModal');
        
        if (btnAjustarPrecio) btnAjustarPrecio.style.display = 'none';
        if (btnCancelarCita) btnCancelarCita.style.display = 'none';
        if (btnEliminarCita) btnEliminarCita.style.display = 'none';
        if (btnCompletarCita) btnCompletarCita.style.display = 'none';
        
        // Limpiar variables globales
        window.currentCitaId = null;
        window.currentCitaEstado = null;
        
        // Abrir modal
        infoModal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Cargar datos de la cita vía AJAX
        fetch('/trabajadores/obtener_cita/' + citaId + '/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var cita = data.cita;
                    
                    // Llenar datos básicos - verificar que los elementos existan
                    var modalFecha = document.getElementById('modalCitaFecha');
                    var modalHora = document.getElementById('modalCitaHora');
                    var modalPaciente = document.getElementById('modalCitaPaciente');
                    var modalTipo = document.getElementById('modalCitaTipo');
                    var modalDentista = document.getElementById('modalCitaDentista');
                    
                    if (modalFecha) modalFecha.textContent = cita.fecha;
                    if (modalHora) modalHora.textContent = cita.hora;
                    if (modalPaciente) modalPaciente.textContent = cita.paciente || 'Sin asignar';
                    if (modalTipo) modalTipo.textContent = cita.tipo_consulta || 'Sin especificar';
                    if (modalDentista) modalDentista.textContent = cita.dentista || 'Sin asignar';
                    
                    // Estado - verificar que el elemento exista
                    var estadoElement = document.getElementById('modalCitaEstado');
                    if (estadoElement) {
                        estadoElement.textContent = cita.estado_display;
                        estadoElement.className = 'badge-estado ' + cita.estado;
                    }
                    
                    // Precio (si existe) - verificar que los elementos existan
                    if (cita.precio_cobrado) {
                        var precioElement = document.getElementById('modalCitaPrecio');
                        var precioContainer = document.getElementById('modalCitaPrecioContainer');
                        if (precioElement) precioElement.textContent = '$' + cita.precio_cobrado.toLocaleString('es-CL');
                        if (precioContainer) precioContainer.style.display = 'flex';
                    }
                    
                    // Motivo de no asistencia (si existe) - verificar que los elementos existan
                    if (cita.motivo_no_asistencia) {
                        var motivoElement = document.getElementById('modalCitaMotivo');
                        var motivoContainer = document.getElementById('modalCitaMotivoContainer');
                        if (motivoElement) motivoElement.textContent = cita.motivo_no_asistencia;
                        if (motivoContainer) motivoContainer.style.display = 'flex';
                    }
                    
                    // Guardar ID de la cita para usar en acciones
                    window.currentCitaId = cita.id;
                    window.currentCitaEstado = cita.estado;
                    
                    console.log('=== Información de la cita cargada ===');
                    console.log('ID:', cita.id);
                    console.log('Estado:', cita.estado);
                    console.log('Estado Display:', cita.estado_display);
                    
                    // Obtener referencias a los botones
                    var btnEliminarCita = document.getElementById('btnEliminarCitaModal');
                    var btnCancelarCita = document.getElementById('btnCancelarCitaModal');
                    var btnAjustarPrecio = document.getElementById('btnAjustarPrecioModal');
                    var btnCompletarCita = document.getElementById('btnCompletarCitaModal');
                    
                    console.log('Botones encontrados:', {
                        btnEliminarCita: !!btnEliminarCita,
                        btnCancelarCita: !!btnCancelarCita,
                        btnAjustarPrecio: !!btnAjustarPrecio,
                        btnCompletarCita: !!btnCompletarCita
                    });
                    
                    // Ocultar todos los botones primero
                    if (btnEliminarCita) {
                        btnEliminarCita.style.display = 'none';
                    }
                    if (btnCancelarCita) {
                        btnCancelarCita.style.display = 'none';
                    }
                    if (btnAjustarPrecio) {
                        btnAjustarPrecio.style.display = 'none';
                    }
                    if (btnCompletarCita) {
                        btnCompletarCita.style.display = 'none';
                    }
                    
                    // Mostrar botón de Eliminar Cita solo para citas disponibles
                    if (btnEliminarCita && cita.estado === 'disponible') {
                        console.log('✓ Mostrando botón Eliminar para cita disponible');
                        btnEliminarCita.style.display = 'inline-flex';
                    }
                    
                    // Mostrar botón de Cancelar Cita para citas reservadas, confirmadas, en_espera, listo_para_atender, en_progreso
                    // (cualquier estado que tenga un cliente asignado excepto completadas, canceladas, no_show, disponible)
                    var estadosCancelables = ['reservada', 'confirmada', 'en_espera', 'listo_para_atender', 'en_progreso'];
                    var estadosNoCancelables = ['completada', 'cancelada', 'no_show', 'disponible'];
                    
                    if (btnCancelarCita) {
                        if (estadosCancelables.includes(cita.estado)) {
                            console.log('✓ Mostrando botón Cancelar para cita con estado:', cita.estado);
                            btnCancelarCita.style.display = 'inline-flex';
                            // Asegurar que el botón sea visible
                            setTimeout(function() {
                                if (btnCancelarCita) {
                                    btnCancelarCita.style.display = 'inline-flex';
                                    btnCancelarCita.style.visibility = 'visible';
                                    btnCancelarCita.style.opacity = '1';
                                }
                            }, 100);
                        } else if (!estadosNoCancelables.includes(cita.estado)) {
                            // Si el estado no está en la lista de no cancelables, también mostrar el botón
                            console.log('✓ Mostrando botón Cancelar para estado no listado:', cita.estado);
                            btnCancelarCita.style.display = 'inline-flex';
                            setTimeout(function() {
                                if (btnCancelarCita) {
                                    btnCancelarCita.style.display = 'inline-flex';
                                    btnCancelarCita.style.visibility = 'visible';
                                    btnCancelarCita.style.opacity = '1';
                                }
                            }, 100);
                        } else {
                            console.log('✗ NO mostrando botón Cancelar. Estado:', cita.estado, 'Estados permitidos:', estadosCancelables);
                        }
                    }
                    
                    // Mostrar botón de Completar Cita solo para citas finalizadas
                    if (btnCompletarCita && cita.estado === 'finalizada') {
                        btnCompletarCita.style.display = 'inline-flex';
                        console.log('✓ Mostrando botón Completar Cita para cita finalizada');
                    }
                    
                    // Mostrar botón de Ajustar Precio solo para citas completadas
                    if (btnAjustarPrecio && cita.estado === 'completada') {
                        btnAjustarPrecio.href = '{% url "ajustar_precio_cita" 0 %}'.replace('0', cita.id);
                        btnAjustarPrecio.style.display = 'inline-flex';
                        console.log('✓ Mostrando botón Ajustar Precio para cita completada');
                    }
                } else {
                    showNotification('error', data.error || 'Error desconocido al cargar los datos de la cita');
                    closeCitaInfoModal();
                }
            })
            .catch(error => {
                console.error('Error al cargar datos de la cita:', error);
                showNotification('error', 'Error al cargar los datos de la cita. Por favor, intenta nuevamente.');
                closeCitaInfoModal();
            });
        
        return;
    }
    
    // Si el modal de opciones existe (para editar), redirigir al panel
    if (optionsModal) {
        var seccionActiva = '{{ seccion_activa }}';
        var tab = 'taken';
        if (seccionActiva === 'dia') {
            tab = 'today';
        } else if (seccionActiva === 'disponibles') {
            tab = 'list';
        } else if (seccionActiva === 'tomadas') {
            tab = 'taken';
        } else if (seccionActiva === 'completadas') {
            tab = 'completed';
        }
        window.location.href = '{% url "panel_trabajador" %}?tab=' + tab + '&cita_id=' + citaId;
        return;
    }
    
    // Si no existen modales, redirigir
    var seccionActiva = '{{ seccion_activa }}';
    var tab = 'taken';
    if (seccionActiva === 'dia') {
        tab = 'today';
    } else if (seccionActiva === 'disponibles') {
        tab = 'list';
    } else if (seccionActiva === 'tomadas') {
        tab = 'taken';
    } else if (seccionActiva === 'completadas') {
        tab = 'completed';
    }
    window.location.href = '{% url "panel_trabajador" %}?tab=' + tab + '&cita_id=' + citaId;
}

// Función para cerrar modal de opciones
function closeOptionsModal() {
    var modal = document.getElementById('optionsModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Función para cerrar modal de información de cita
function closeCitaInfoModal() {
    var modal = document.getElementById('citaInfoModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Función para mostrar/ocultar campos de cliente
function toggleClienteFields() {
    console.log('=== toggleClienteFields llamado ===');
    var check = document.getElementById('asignarClienteCheck');
    var container = document.getElementById('clienteFieldsContainer');
    
    console.log('Checkbox y container:', {
        check: !!check,
        container: !!container,
        checked: check ? check.checked : false
    });
    
    if (check && container) {
        if (check.checked) {
            console.log('Mostrando campos de cliente');
            container.style.display = 'block';
            // Inicializar búsqueda después de que el contenedor sea visible
            setTimeout(function() {
                console.log('Inicializando búsqueda después de mostrar contenedor');
                var success = initClienteSearch();
                if (success) {
                    var searchInput = document.getElementById('clienteSearchInput');
                    if (searchInput) {
                        searchInput.focus();
                        console.log('Focus aplicado al input de búsqueda');
                    }
                } else {
                    console.error('ERROR: No se pudo inicializar la búsqueda');
                }
            }, 150);
        } else {
            console.log('Ocultando campos de cliente');
            container.style.display = 'none';
            var searchInput = document.getElementById('clienteSearchInput');
            var clienteSelect = document.getElementById('clienteSelect');
            var clienteIdInput = document.getElementById('clienteIdInput');
            var resultsList = document.getElementById('clienteResults');
            if (searchInput) {
                searchInput.value = '';
            }
            if (clienteSelect) clienteSelect.value = '';
            if (clienteIdInput) clienteIdInput.value = '';
            if (resultsList) {
                resultsList.innerHTML = '';
                resultsList.classList.remove('show');
            }
        }
    }
}

// Función para manejar selección de cliente
function handleClienteSelect() {
    var clienteSelect = document.getElementById('clienteSelect');
    var clienteIdInput = document.getElementById('clienteIdInput');
    
    if (clienteSelect && clienteIdInput) {
        if (clienteSelect.value && clienteSelect.value !== '') {
            clienteIdInput.value = clienteSelect.value;
            console.log('Cliente seleccionado - ID:', clienteSelect.value);
            var selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            var searchInput = document.getElementById('clienteSearchInput');
            if (searchInput && selectedOption) {
                searchInput.value = selectedOption.getAttribute('data-nombre');
            }
            var resultsList = document.getElementById('clienteResults');
            if (resultsList) {
                resultsList.classList.remove('show');
            }
        } else {
            clienteIdInput.value = '';
            console.log('Cliente deseleccionado');
        }
    } else {
        console.error('No se encontraron los elementos clienteSelect o clienteIdInput');
    }
}

// Variable global para guardar el handler de búsqueda
var clienteSearchHandler = null;
var clienteClickHandler = null;

// Función para inicializar búsqueda de clientes
function initClienteSearch() {
    console.log('=== Inicializando búsqueda de clientes ===');
    
    var searchInput = document.getElementById('clienteSearchInput');
    var clienteSelect = document.getElementById('clienteSelect');
    var resultsList = document.getElementById('clienteResults');
    
    console.log('Elementos encontrados:', {
        searchInput: !!searchInput,
        clienteSelect: !!clienteSelect,
        resultsList: !!resultsList
    });
    
    if (!searchInput || !clienteSelect || !resultsList) {
        console.error('ERROR: Elementos de búsqueda de cliente no encontrados');
        return false;
    }
    
    // Verificar que el select tenga opciones
    var options = clienteSelect.querySelectorAll('option');
    console.log('Opciones encontradas en select:', options.length);
    
    if (options.length <= 1) {
        console.warn('ADVERTENCIA: No hay clientes en el select (solo la opción vacía)');
    }
    
    // Remover listeners anteriores si existen
    if (clienteSearchHandler && searchInput) {
        try {
            searchInput.removeEventListener('input', clienteSearchHandler);
        } catch(e) {
            console.warn('No se pudo remover listener anterior:', e);
        }
        clienteSearchHandler = null;
    }
    
    if (clienteClickHandler) {
        try {
            document.removeEventListener('click', clienteClickHandler);
        } catch(e) {
            console.warn('No se pudo remover click handler anterior:', e);
        }
        clienteClickHandler = null;
    }
    
    // Crear nuevo handler de búsqueda
    clienteSearchHandler = function(e) {
        console.log('Evento input disparado, valor:', this.value);
        var query = this.value.toLowerCase().trim();
        
        if (query.length < 1) {
            console.log('Query vacío, ocultando resultados');
            resultsList.classList.remove('show');
            resultsList.innerHTML = '';
            return;
        }
        
        console.log('Buscando con query:', query);
        
        // Filtrar clientes por nombre o email
        var allOptions = clienteSelect.querySelectorAll('option');
        var matches = [];
        
        console.log('Total de opciones a revisar:', allOptions.length);
        
        allOptions.forEach(function(option) {
            if (option.value === '') return;
            var nombre = (option.getAttribute('data-nombre') || option.textContent || '').toLowerCase();
            var email = (option.getAttribute('data-email') || '').toLowerCase();
            
            if (nombre.includes(query) || email.includes(query)) {
                matches.push(option);
            }
        });
        
        console.log('Coincidencias encontradas:', matches.length);
        
        // Mostrar resultados
        if (matches.length > 0) {
            resultsList.innerHTML = '';
            matches.slice(0, 10).forEach(function(option) {
                var item = document.createElement('div');
                item.className = 'cliente-result-item';
                var nombre = option.getAttribute('data-nombre') || option.textContent;
                var email = option.getAttribute('data-email') || '';
                item.innerHTML = '<strong>' + nombre + '</strong>' + (email ? '<br><small style="color: #64748b;">' + email + '</small>' : '');
                item.style.cursor = 'pointer';
                item.onclick = function() {
                    console.log('Cliente seleccionado desde resultados:', nombre, 'ID:', option.value);
                    if (option.value && option.value !== '') {
                        clienteSelect.value = option.value;
                        handleClienteSelect();
                        searchInput.value = nombre;
                        resultsList.classList.remove('show');
                        
                        // Verificar que el valor se estableció correctamente
                        var clienteIdInput = document.getElementById('clienteIdInput');
                        if (clienteIdInput) {
                            console.log('clienteIdInput establecido a:', clienteIdInput.value);
                        }
                    } else {
                        console.error('El valor de la opción está vacío');
                        alert('Error: No se pudo seleccionar el cliente. Por favor, intente nuevamente.');
                    }
                };
                resultsList.appendChild(item);
            });
            resultsList.classList.add('show');
            console.log('Resultados mostrados, clase show agregada');
        } else {
            resultsList.innerHTML = '<div class="cliente-result-item" style="color: #9ca3af; padding: 12px; text-align: center;">No se encontraron clientes</div>';
            resultsList.classList.add('show');
            console.log('Sin resultados, mostrando mensaje');
        }
    };
    
    // Agregar listener de búsqueda
    searchInput.addEventListener('input', clienteSearchHandler);
    console.log('Listener de input agregado');
    
    // Crear handler para cerrar resultados al hacer clic fuera
    clienteClickHandler = function(e) {
        if (searchInput && resultsList && 
            !searchInput.contains(e.target) && 
            !resultsList.contains(e.target)) {
            resultsList.classList.remove('show');
        }
    };
    
    // Agregar listener de click fuera
    document.addEventListener('click', clienteClickHandler);
    console.log('Listener de click fuera agregado');
    
    console.log('=== Búsqueda de clientes inicializada correctamente ===');
    return true;
}

// Manejar envío del formulario de agregar cita
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('formAgregarCitaModal');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validar que si el checkbox está marcado, se haya seleccionado un cliente
            var asignarClienteCheck = document.getElementById('asignarClienteCheck');
            var clienteIdInput = document.getElementById('clienteIdInput');
            
            if (asignarClienteCheck && asignarClienteCheck.checked) {
                if (!clienteIdInput || !clienteIdInput.value || clienteIdInput.value.trim() === '') {
                    alert('Por favor, seleccione un cliente de la lista o desmarque la opción "Asignar Cliente a esta Cita".');
                    return;
                }
            }
            
            var formData = new FormData(this);
            var actionUrl = this.getAttribute('data-action');
            var submitBtn = this.querySelector('button[type="submit"]');
            var originalText = submitBtn.innerHTML;
            
            // Log para debugging
            console.log('Enviando formulario:', {
                asignar_cliente: asignarClienteCheck ? asignarClienteCheck.checked : false,
                cliente_id: clienteIdInput ? clienteIdInput.value : 'no encontrado'
            });
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            submitBtn.disabled = true;
            
            // Obtener token CSRF de forma segura
            var csrfToken = getCSRFToken();
            var headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            
            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: headers
            })
            .then(async response => {
                // Intentar parsear el JSON siempre, incluso si hay error
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // Si no se puede parsear JSON, crear un objeto con el mensaje de error
                    data = {
                        success: false,
                        error: response.statusText || 'Error al procesar la respuesta del servidor'
                    };
                }
                
                // Si la respuesta no es OK o si success es false, lanzar error
                if (!response.ok || !data.success) {
                    const errorMessage = data.error || data.message || 'Error al crear la cita';
                    throw new Error(errorMessage);
                }
                
                return data;
            })
            .then(data => {
                showNotification('success', data.message || 'Cita creada correctamente');
                submitBtn.innerHTML = '<i class="fas fa-check"></i> ¡Creada!';
                submitBtn.style.background = '#10b981';
                setTimeout(() => {
                    closeAddCitaModal();
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error al crear cita:', error);
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                submitBtn.style.background = '#ef4444';
                // Mostrar el mensaje de error específico
                const errorMessage = error.message || 'Error al crear la cita. Por favor, verifique todos los campos e intente nuevamente.';
                showNotification('error', errorMessage);
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.style.background = '';
                    submitBtn.disabled = false;
                }, 2000);
            });
        });
    }
    
    // No inicializar automáticamente aquí, se inicializará cuando se active el checkbox
    // La inicialización se hace en toggleClienteFields() cuando se marca el checkbox
});

// Inicializar calendario si está en la sección de calendario
{% if seccion_activa == 'calendario' %}
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
        console.error('No se encontró el elemento del calendario');
        return;
    }
    
    try {
        // Construir eventos desde las citas del servidor
        const events = [];
        {% for cita in citas_calendario %}
        events.push({
            id: '{{ cita.id }}',
            title: '{% if cita.cliente %}{{ cita.cliente.nombre_completo|escapejs }}{% elif cita.paciente_nombre %}{{ cita.paciente_nombre|escapejs }}{% else %}Disponible{% endif %}{% if cita.tipo_servicio %} - {{ cita.tipo_servicio.nombre|escapejs }}{% elif cita.tipo_consulta %} - {{ cita.tipo_consulta|escapejs }}{% endif %}',
            start: '{{ cita.fecha_hora|date:"Y-m-d\TH:i:s" }}',
            {% if cita.tipo_servicio and cita.tipo_servicio.duracion_estimada %}
            end: '{{ cita.fecha_hora|date:"Y-m-d\TH:i:s" }}',
            {% endif %}
            extendedProps: {
                estado: '{{ cita.estado|escapejs }}',
                paciente: '{% if cita.cliente %}{{ cita.cliente.nombre_completo|escapejs }}{% elif cita.paciente_nombre %}{{ cita.paciente_nombre|escapejs }}{% else %}Sin asignar{% endif %}',
                telefono: '{% if cita.cliente %}{{ cita.cliente.telefono|default:""|escapejs }}{% elif cita.paciente_telefono %}{{ cita.paciente_telefono|escapejs }}{% else %}{% endif %}',
                servicio: '{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre|escapejs }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta|escapejs }}{% else %}Sin servicio{% endif %}',
                dentista: '{% if cita.dentista %}{{ cita.dentista.nombre_completo|escapejs }}{% else %}Sin asignar{% endif %}',
                precio: {% if cita.precio_cobrado %}{{ cita.precio_cobrado|floatformat:0 }}{% elif cita.tipo_servicio and cita.tipo_servicio.precio_base %}{{ cita.tipo_servicio.precio_base|floatformat:0 }}{% else %}null{% endif %},
                duracion: '{% if cita.tipo_servicio and cita.tipo_servicio.duracion_estimada %}{{ cita.tipo_servicio.duracion_estimada }} min{% else %}{% endif %}',
                notas: '{{ cita.notas|default_if_none:""|escapejs }}',
                cita_id: {{ cita.id }}
            },
            {% if cita.estado == 'disponible' %}
            color: '#10b981',
            textColor: '#ffffff',
            {% elif cita.estado == 'reservada' or cita.estado == 'confirmada' %}
            color: '#3b82f6',
            textColor: '#ffffff',
            {% elif cita.estado == 'en_espera' %}
            color: '#f59e0b',
            textColor: '#ffffff',
            {% elif cita.estado == 'en_progreso' %}
            color: '#8b5cf6',
            textColor: '#ffffff',
            {% elif cita.estado == 'completada' %}
            color: '#14b8a6',
            textColor: '#ffffff',
            {% elif cita.estado == 'no_show' %}
            color: '#ef4444',
            textColor: '#ffffff',
            {% elif cita.estado == 'cancelada' %}
            color: '#9ca3af',
            textColor: '#ffffff',
            {% else %}
            color: '#6b7280',
            textColor: '#ffffff',
            {% endif %}
            classNames: ['cita-calendario', 'estado-{{ cita.estado }}']
        });
        {% endfor %}

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'Día',
                list: 'Lista'
            },
            navLinks: true,
            editable: false,
            selectable: false,
            height: 'auto',
            contentHeight: 'auto',
            aspectRatio: 1.8,
            events: events,
            eventLimit: true, // Limitar número de eventos visibles por día
            eventLimitText: 'más',
            eventLimitClick: 'popover', // Mostrar popover con más eventos
            dayMaxEvents: 3, // Máximo de eventos visibles antes de mostrar "más"
            eventClick: function(info) {
                // Abrir modal con detalles de la cita
                const props = info.event.extendedProps;
                const estadoLabels = {
                    'disponible': 'Disponible',
                    'reservada': 'Reservada',
                    'en_espera': 'En Espera',
                    'en_progreso': 'En Progreso',
                    'completada': 'Completada',
                    'no_show': 'No Llegó',
                    'cancelada': 'Cancelada'
                };
                
                // Función para formatear precio chileno
                function formatearPrecioChileno(precio) {
                    if (!precio && precio !== 0) return '';
                    // Si es string, convertir a número
                    let precioNum = typeof precio === 'string' ? parseFloat(precio.replace(/[^0-9.,]/g, '').replace(/\./g, '').replace(',', '.')) : precio;
                    if (isNaN(precioNum)) return '';
                    // Formatear sin decimales, con punto como separador de miles (formato chileno)
                    return '$' + precioNum.toLocaleString('es-CL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
                
                // Función para obtener badge de estado con color
                function getEstadoBadge(estado, label) {
                    const estados = {
                        'disponible': { bg: '#dcfce7', color: '#166534', icon: 'fa-circle' },
                        'reservada': { bg: '#dbeafe', color: '#1e40af', icon: 'fa-calendar-check' },
                        'confirmada': { bg: '#dbeafe', color: '#1e40af', icon: 'fa-check-circle' },
                        'en_espera': { bg: '#fef3c7', color: '#92400e', icon: 'fa-clock' },
                        'en_progreso': { bg: '#e9d5ff', color: '#6b21a8', icon: 'fa-spinner' },
                        'completada': { bg: '#ccfbf1', color: '#0f766e', icon: 'fa-check-circle' },
                        'no_show': { bg: '#fee2e2', color: '#991b1b', icon: 'fa-times-circle' },
                        'cancelada': { bg: '#f3f4f6', color: '#374151', icon: 'fa-ban' }
                    };
                    
                    const estilo = estados[estado] || { bg: '#f3f4f6', color: '#374151', icon: 'fa-info-circle' };
                    return `<span class="badge-estado-modal" style="background: ${estilo.bg}; color: ${estilo.color};">
                        <i class="fas ${estilo.icon}"></i> ${label}
                    </span>`;
                }
                
                // Obtener fecha y hora formateada
                const fechaHora = new Date(info.event.start);
                const fechaFormateada = fechaHora.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const horaFormateada = fechaHora.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let detalles = `
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-calendar-alt"></i> Fecha y Hora
                        </div>
                        <div class="cita-detalle-value">
                            ${fechaFormateada}<br>
                            <strong style="color: var(--primary-color);">${horaFormateada}</strong>
                        </div>
                    </div>
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-user"></i> Paciente
                        </div>
                        <div class="cita-detalle-value">${props.paciente || 'Sin asignar'}</div>
                    </div>
                    ${props.telefono ? `
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-phone"></i> Teléfono
                        </div>
                        <div class="cita-detalle-value">
                            <a href="tel:${props.telefono}" style="color: var(--primary-color); text-decoration: none;">${props.telefono}</a>
                        </div>
                    </div>
                    ` : ''}
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-tooth"></i> Servicio
                        </div>
                        <div class="cita-detalle-value">${props.servicio || 'Sin servicio'}</div>
                    </div>
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-user-md"></i> Dentista
                        </div>
                        <div class="cita-detalle-value">${props.dentista || 'Sin asignar'}</div>
                    </div>
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-info-circle"></i> Estado
                        </div>
                        <div class="cita-detalle-value">
                            ${getEstadoBadge(props.estado, estadoLabels[props.estado] || props.estado)}
                        </div>
                    </div>
                    ${props.precio ? `
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-dollar-sign"></i> Precio
                        </div>
                        <div class="cita-detalle-value precio-destacado">${formatearPrecioChileno(props.precio)}</div>
                    </div>
                    ` : ''}
                    ${props.duracion ? `
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-hourglass-half"></i> Duración
                        </div>
                        <div class="cita-detalle-value">${props.duracion}</div>
                    </div>
                    ` : ''}
                    ${props.notas ? `
                    <div class="cita-detalle-item">
                        <div class="cita-detalle-label">
                            <i class="fas fa-sticky-note"></i> Notas
                        </div>
                        <div class="cita-detalle-value" style="white-space: pre-wrap; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 3px solid var(--primary-color);">${props.notas}</div>
                    </div>
                    ` : ''}
                `;
                
                // Crear modal personalizado
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'cita-modal-overlay';
                modalOverlay.innerHTML = `
                    <div class="cita-modal-container">
                        <div class="cita-modal-content">
                            <div class="cita-modal-header">
                                <h3 class="cita-modal-title">
                                    <i class="fas fa-calendar-check"></i> Detalles de la Cita
                                </h3>
                                <button type="button" class="cita-modal-close" onclick="this.closest('.cita-modal-overlay').remove(); document.body.style.overflow = '';">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="cita-modal-body">
                                ${detalles}
                            </div>
                            <div class="cita-modal-footer">
                                <button onclick="openOptionsModalForCita(${props.cita_id}); this.closest('.cita-modal-overlay').remove(); document.body.style.overflow = '';" 
                                        class="cita-modal-btn-primary">
                                    <i class="fas fa-cog"></i> Ver Opciones
                                </button>
                                <button onclick="this.closest('.cita-modal-overlay').remove(); document.body.style.overflow = '';" 
                                        class="cita-modal-btn-secondary">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalOverlay);
                document.body.style.overflow = 'hidden';
                
                // Cerrar al hacer clic fuera del modal
                modalOverlay.addEventListener('click', function(e) {
                    if (e.target === modalOverlay) {
                        modalOverlay.remove();
                        document.body.style.overflow = '';
                    }
                });
                
                // Cerrar con ESC
                const closeModal = function(e) {
                    if (e.key === 'Escape') {
                        modalOverlay.remove();
                        document.body.style.overflow = '';
                        document.removeEventListener('keydown', closeModal);
                    }
                };
                document.addEventListener('keydown', closeModal);
                
                info.jsEvent.preventDefault();
            },
            eventDidMount: function(info) {
                // Mejorar diseño de eventos en el calendario
                const props = info.event.extendedProps;
                
                // Agregar tooltip con información
                const hora = new Date(info.event.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const title = `${hora} - ${props.paciente || 'Disponible'}\n${props.servicio || 'Sin servicio'}\n${props.dentista || 'Sin dentista'}`;
                info.el.setAttribute('title', title);
                
                // Mejorar el texto del evento para que sea más legible
                if (info.event.title.length > 30) {
                    info.el.querySelector('.fc-event-title')?.setAttribute('title', info.event.title);
                }
                
                // Agregar clase para estilos personalizados
                info.el.classList.add('cita-calendario-event');
            }
        });
        calendar.render();
        
        // Ajustar el calendario al contenedor
        setTimeout(function() {
            calendar.updateSize();
        }, 100);
        
        // Ajustar tamaño cuando cambia el tamaño de la ventana
        window.addEventListener('resize', function() {
            calendar.updateSize();
        });
        
        console.log('Calendario inicializado correctamente con', events.length, 'eventos');
    } catch (error) {
        console.error('Error al inicializar el calendario:', error);
        calendarEl.innerHTML = '<div style="padding: 40px; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Error al cargar el calendario. Por favor, recarga la página.</div>';
    }
});
{% endif %}

// Funciones para marcar llegada y no llegada
function marcarLlegada(citaId) {
    const url = `{% url 'marcar_llegada' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: (function() {
            var headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            var csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            return headers;
        })()
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = {
                success: false,
                error: response.statusText || 'Error al procesar la respuesta del servidor'
            };
        }
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Error al marcar la llegada.');
        }
        
        return data;
    })
    .then(data => {
        showNotification('success', data.message || 'Paciente marcado como "En Espera".');
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', error.message || 'Error al marcar la llegada.');
    });
}

// Abrir modal de motivo de no asistencia
function marcarNoLlego(citaId) {
    const modal = document.getElementById('modalNoAsistencia');
    const citaIdInput = document.getElementById('citaIdNoAsistencia');
    
    if (modal && citaIdInput) {
        citaIdInput.value = citaId;
        citaIdInput.dataset.endpoint = 'marcar_no_llego';
        var motivoInput = document.getElementById('motivoNoAsistencia');
        if (motivoInput) motivoInput.value = '';
        if (modal) {
            modal.style.display = 'flex';
            modal.classList.add('show');
        }
        document.body.style.overflow = 'hidden';
    } else {
        showNotification('error', 'Error: No se pudo abrir el modal de no asistencia.');
    }
}

// Cerrar modal de motivo de no asistencia
function cerrarModalNoAsistencia() {
    const modal = document.getElementById('modalNoAsistencia');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
        var motivoInput = document.getElementById('motivoNoAsistencia');
        var citaIdInput = document.getElementById('citaIdNoAsistencia');
        if (motivoInput) motivoInput.value = '';
        if (citaIdInput) citaIdInput.value = '';
    }
}

// Manejar envío del formulario de no asistencia
document.addEventListener('DOMContentLoaded', function() {
    const formNoAsistencia = document.getElementById('formNoAsistencia');
    if (formNoAsistencia) {
        formNoAsistencia.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const citaIdInput = document.getElementById('citaIdNoAsistencia');
            const motivoInput = document.getElementById('motivoNoAsistencia');
            if (!citaIdInput || !motivoInput) {
                showNotification('error', 'Error: No se encontraron los campos necesarios.');
                return;
            }
            const citaId = citaIdInput.value;
            const motivo = motivoInput.value.trim();
            
            if (!motivo) {
                showNotification('error', 'Por favor, ingrese el motivo de no asistencia.');
                return;
            }
            
            const endpointType = document.getElementById('citaIdNoAsistencia').dataset.endpoint || 'marcar_no_llego';
            const url = `{% url 'marcar_no_llego' 0 %}`.replace('0', citaId);
            const formData = new FormData();
            formData.append('motivo_no_asistencia', motivo);
            var csrfToken = getCSRFToken();
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken);
            }
            
            const btnConfirmar = document.getElementById('btnConfirmarNoAsistencia');
            if (btnConfirmar) {
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            }
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(async response => {
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    data = {
                        success: false,
                        error: response.statusText || 'Error al procesar la respuesta del servidor'
                    };
                }
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Error al marcar la cita como "No Llegó".');
                }
                
                return data;
            })
            .then(data => {
                showNotification('success', data.message || 'Cita marcada como "No Llegó".');
                cerrarModalNoAsistencia();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('error', error.message || 'Error al marcar la cita como "No Llegó".');
                if (btnConfirmar) {
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar';
                }
            });
        });
    }
});

// Funciones para cancelar cita
function abrirModalConfirmarCancelacion() {
    const modal = document.getElementById('modalConfirmarCancelacion');
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        return;
    }
    
    // Obtener información de la cita directamente del servidor para asegurar hora correcta
    fetch('/trabajadores/obtener_cita/' + citaId + '/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.cita) {
                const cita = data.cita;
                
                // Llenar información en el modal de confirmación - verificar que los elementos existan
                var pacienteEl = document.getElementById('cancelCitaPaciente');
                var fechaEl = document.getElementById('cancelCitaFecha');
                var horaEl = document.getElementById('cancelCitaHora');
                
                // Usar paciente del objeto cita (puede ser paciente o paciente_nombre)
                const pacienteNombre = cita.paciente || cita.paciente_nombre || 'Sin asignar';
                if (pacienteEl) pacienteEl.textContent = pacienteNombre;
                if (fechaEl) fechaEl.textContent = cita.fecha || '';
                if (horaEl) horaEl.textContent = cita.hora || '';
                
                // Mostrar modal
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            } else {
                // Fallback: obtener información del modal actual si falla la petición
                const paciente = document.getElementById('modalCitaPaciente')?.textContent || 'Sin asignar';
                const fecha = document.getElementById('modalCitaFecha')?.textContent || '';
                const hora = document.getElementById('modalCitaHora')?.textContent || '';
                
                var pacienteEl = document.getElementById('cancelCitaPaciente');
                var fechaEl = document.getElementById('cancelCitaFecha');
                var horaEl = document.getElementById('cancelCitaHora');
                if (pacienteEl) pacienteEl.textContent = paciente;
                if (fechaEl) fechaEl.textContent = fecha;
                if (horaEl) horaEl.textContent = hora;
                
                if (modal) {
                    modal.style.display = 'flex';
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }
        })
        .catch(error => {
            console.error('Error al obtener información de la cita:', error);
            // Fallback: obtener información del modal actual
            const paciente = document.getElementById('modalCitaPaciente')?.textContent || 'Sin asignar';
            const fecha = document.getElementById('modalCitaFecha')?.textContent || '';
            const hora = document.getElementById('modalCitaHora')?.textContent || '';
            
            var pacienteEl = document.getElementById('cancelCitaPaciente');
            var fechaEl = document.getElementById('cancelCitaFecha');
            var horaEl = document.getElementById('cancelCitaHora');
            if (pacienteEl) pacienteEl.textContent = paciente;
            if (fechaEl) fechaEl.textContent = fecha;
            if (horaEl) horaEl.textContent = hora;
            
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        });
}

function cerrarModalConfirmarCancelacion() {
    const modal = document.getElementById('modalConfirmarCancelacion');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function confirmarCancelarCita() {
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        cerrarModalConfirmarCancelacion();
        return;
    }
    
    const btnConfirmar = document.getElementById('btnConfirmarCancelacion');
    if (btnConfirmar) {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelando...';
    }
    
    const url = `{% url 'cancelar_cita_admin' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: (function() {
            var headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            var csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            return headers;
        })()
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = {
                success: false,
                error: response.statusText || 'Error al procesar la respuesta del servidor'
            };
        }
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Error al cancelar la cita.');
        }
        
        return data;
    })
    .then(data => {
        showNotification('success', data.message || 'Cita cancelada exitosamente.');
        cerrarModalConfirmarCancelacion();
        closeCitaInfoModal();
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', error.message || 'Error al cancelar la cita.');
        if (btnConfirmar) {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Sí, cancelar cita';
        }
    });
}

// Funciones para eliminar cita
function abrirModalConfirmarEliminacion() {
    const modal = document.getElementById('modalConfirmarEliminacion');
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        return;
    }
    
    // Obtener información de la cita del modal actual
    const fecha = document.getElementById('modalCitaFecha')?.textContent || '';
    const hora = document.getElementById('modalCitaHora')?.textContent || '';
    const dentista = document.getElementById('modalCitaDentista')?.textContent || 'Sin asignar';
    
    // Llenar información en el modal de confirmación
    document.getElementById('eliminarCitaFecha').textContent = fecha;
    document.getElementById('eliminarCitaHora').textContent = hora;
    document.getElementById('eliminarCitaDentista').textContent = dentista;
    
    // Mostrar modal
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function cerrarModalConfirmarEliminacion() {
    const modal = document.getElementById('modalConfirmarEliminacion');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function abrirModalCompletarCita() {
    const modal = document.getElementById('modalCompletarCita');
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        return;
    }
    
    // Obtener información de la cita del modal actual
    const fecha = document.getElementById('modalCitaFecha')?.textContent || '';
    const hora = document.getElementById('modalCitaHora')?.textContent || '';
    const paciente = document.getElementById('modalCitaPaciente')?.textContent || 'Sin asignar';
    
    // Llenar información en el modal de completar
    document.getElementById('completarCitaFecha').textContent = fecha;
    document.getElementById('completarCitaHora').textContent = hora;
    document.getElementById('completarCitaPaciente').textContent = paciente;
    
    // Limpiar campo de precio
    const precioInput = document.getElementById('precioCobrado');
    if (precioInput) {
        precioInput.value = '';
    }
    
    // Mostrar modal
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function cerrarModalCompletarCita() {
    const modal = document.getElementById('modalCompletarCita');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function confirmarCompletarCita() {
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        cerrarModalCompletarCita();
        return;
    }
    
    const precioInput = document.getElementById('precioCobrado');
    const precioCobrado = precioInput ? parseFloat(precioInput.value) : null;
    
    if (!precioCobrado || precioCobrado <= 0) {
        showNotification('error', 'Por favor, ingrese un precio válido mayor a 0.');
        if (precioInput) precioInput.focus();
        return;
    }
    
    // Deshabilitar botón mientras se procesa
    const btnConfirmar = document.querySelector('#modalCompletarCita .btn-primary');
    if (btnConfirmar) {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    }
    
    // Enviar petición AJAX
    fetch(`/trabajadores/completar_cita_recepcion/${citaId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            precio_cobrado: precioCobrado
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', data.message || 'Cita completada exitosamente.');
            cerrarModalCompletarCita();
            closeCitaInfoModal();
            // Recargar la página para actualizar la lista
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification('error', data.error || 'Error al completar la cita.');
            if (btnConfirmar) {
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Completar Cita';
            }
        }
    })
    .catch(error => {
        console.error('Error al completar cita:', error);
        showNotification('error', 'Error al completar la cita. Por favor, intenta nuevamente.');
        if (btnConfirmar) {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Completar Cita';
        }
    });
}

function confirmarEliminarCita() {
    const citaId = window.currentCitaId;
    
    if (!citaId) {
        showNotification('error', 'Error: No se pudo obtener la información de la cita.');
        cerrarModalConfirmarEliminacion();
        return;
    }
    
    const btnConfirmar = document.getElementById('btnConfirmarEliminacion');
    if (btnConfirmar) {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
    }
    
    const url = `{% url 'eliminar_cita' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: (function() {
            var headers = {
                'X-Requested-With': 'XMLHttpRequest'
            };
            var csrfToken = getCSRFToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
            return headers;
        })()
    })
    .then(async response => {
        let data;
        try {
            data = await response.json();
        } catch (e) {
            data = {
                success: false,
                error: response.statusText || 'Error al procesar la respuesta del servidor'
            };
        }
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Error al eliminar la cita.');
        }
        
        return data;
    })
    .then(data => {
        showNotification('success', data.message || 'Cita eliminada exitosamente.');
        cerrarModalConfirmarEliminacion();
        closeCitaInfoModal();
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', error.message || 'Error al eliminar la cita.');
        if (btnConfirmar) {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-trash-alt"></i> Sí, eliminar cita';
        }
    });
}
</script>

<script>
    function scrollToCita(citaId) {
        // Buscar la fila de la cita en la tabla
        const citaRow = document.querySelector(`tr[data-cita-id="${citaId}"]`);
        if (citaRow) {
            citaRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Resaltar temporalmente la fila
            citaRow.style.animation = 'none';
            setTimeout(() => {
                citaRow.style.animation = 'highlight-cita 1s ease-in-out';
            }, 10);
        } else {
            // Si no se encuentra, abrir el modal de opciones
            if (typeof openOptionsModalForCita === 'function') {
                openOptionsModalForCita(citaId);
            }
        }
    }
    
    // Agregar data-cita-id a las filas para poder hacer scroll
    document.addEventListener('DOMContentLoaded', function() {
        const citaRows = document.querySelectorAll('.fila-cita');
        citaRows.forEach(row => {
            const onclickAttr = row.getAttribute('onclick');
            const buttonOnclick = row.querySelector('[onclick*="openOptionsModalForCita"]')?.getAttribute('onclick');
            const onclickValue = onclickAttr || buttonOnclick;
            const citaId = onclickValue?.match(/openOptionsModalForCita\((\d+)\)/)?.[1];
            if (citaId) {
                row.setAttribute('data-cita-id', citaId);
            }
        });
    });
</script>

<style>
    @keyframes highlight-cita {
        0%, 100% { background: inherit; }
        50% { background: #fef3c7 !important; }
    }
</style>

<!-- Modales necesarios para las funciones -->
{% if perfil.es_administrativo %}
<!-- Modal de Agregar Nueva Cita -->
<div id="addCitaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-plus"></i> Agregar Nueva Cita</h3>
            <button class="modal-close" onclick="closeAddCitaModal()" aria-label="Cerrar modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="javascript:void(0);" id="formAgregarCitaModal" data-action="{% url 'agregar_hora' %}">
                {% csrf_token %}
                <input type="hidden" name="tipo_servicio" id="tipoServicioIdInput" value="">

                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                        <span class="required-badge">*</span>
                    </label>
                    <input type="datetime-local" name="fecha_hora" id="addCitaFechaHora" required class="form-control-modal" min="">
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        Selecciona el día y hora del turno (solo fechas futuras)
                    </small>
                </div>

                <div class="form-group-modal">
                    <label for="addCitaTipo" class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select name="tipo_consulta" id="addCitaTipo" class="form-control-modal" required aria-label="Tipo de consulta">
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios_activos %}
                        {% regroup servicios_activos by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>

                <div class="form-group-modal">
                    <label for="addCitaDentista" class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                        <span class="required-badge">*</span>
                    </label>
                    <select name="dentista_id" id="addCitaDentista" class="form-control-modal" required aria-label="Dentista asignado">
                        <option value="">-- Seleccionar dentista --</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">
                            {{ dentista.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        {{ dentistas|length }} dentista(s) disponible(s)
                    </small>
                </div>

                <div class="form-group-modal">
                    <label class="checkbox-label-modern" for="asignarClienteCheck">
                        <input type="checkbox" id="asignarClienteCheck" name="asignar_cliente" onchange="toggleClienteFields()">
                        <span>
                            <i class="fas fa-user-plus"></i>
                            Asignar Cliente a esta Cita
                        </span>
                    </label>
                </div>

                <div id="clienteFieldsContainer" style="display: none;">
                    <div class="form-group-modal">
                        <label class="form-label">
                            <i class="fas fa-search"></i>
                            Buscar Cliente
                        </label>
                        <div class="cliente-search-wrapper">
                            <input type="text" id="clienteSearchInput" class="form-control-modal" placeholder="Buscar por nombre o email..." autocomplete="off">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <select id="clienteSelect" class="form-control-modal" style="display: none; visibility: hidden; position: absolute; width: 1px; height: 1px; opacity: 0;" onchange="handleClienteSelect()">
                            <option value="">-- Seleccionar cliente --</option>
                            {% if clientes %}
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" data-nombre="{{ cliente.nombre_completo }}" data-email="{{ cliente.email }}" data-telefono="{{ cliente.telefono }}">
                                {{ cliente.nombre_completo }}
                            </option>
                            {% endfor %}
                            {% endif %}
                        </select>
                        <input type="hidden" name="cliente_id" id="clienteIdInput" value="">
                        <div id="clienteResults" class="cliente-results-list"></div>
                    </div>
                </div>

                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea name="notas" id="addCitaNotas" placeholder="Información relevante sobre la cita..." rows="3" class="form-control-modal"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddCitaModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        Crear Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Información de Cita -->
<div id="citaInfoModal" class="modal-overlay">
    <div class="modal-content modal-container-simple">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Información de la Cita</h3>
            <button class="modal-close" onclick="closeCitaInfoModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="cita-info-card">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-day"></i> Fecha
                    </div>
                    <div class="info-value" id="modalCitaFecha"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-clock"></i> Hora
                    </div>
                    <div class="info-value" id="modalCitaHora"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user"></i> Paciente
                    </div>
                    <div class="info-value" id="modalCitaPaciente"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-tooth"></i> Tipo de Consulta
                    </div>
                    <div class="info-value" id="modalCitaTipo"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user-md"></i> Dentista
                    </div>
                    <div class="info-value" id="modalCitaDentista"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-info-circle"></i> Estado
                    </div>
                    <div class="info-value">
                        <span class="badge-estado" id="modalCitaEstado"></span>
                    </div>
                </div>
                
                <div class="info-item" id="modalCitaPrecioContainer" style="display: none;">
                    <div class="info-label">
                        <i class="fas fa-dollar-sign"></i> Precio Cobrado
                    </div>
                    <div class="info-value" id="modalCitaPrecio"></div>
                </div>
                
                
                <div class="info-item" id="modalCitaMotivoContainer" style="display: none;">
                    <div class="info-label">
                        <i class="fas fa-exclamation-triangle"></i> Motivo de No Asistencia
                    </div>
                    <div class="info-value" id="modalCitaMotivo"></div>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div class="modal-footer" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                <!-- Botón de Eliminar Cita (solo para citas disponibles) -->
                <button type="button" id="btnEliminarCitaModal" class="btn-secondary" style="display: none; background: #ef4444; color: white; border-color: #ef4444;" onclick="abrirModalConfirmarEliminacion()">
                    <i class="fas fa-trash-alt"></i>
                    <span>Eliminar Cita</span>
                </button>
                <!-- Botón de Cancelar Cita (para citas con estados cancelables) -->
                <button type="button" id="btnCancelarCitaModal" class="btn-secondary" style="display: none; background: #ef4444; color: white; border-color: #ef4444; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; align-items: center; gap: 8px;" onclick="abrirModalConfirmarCancelacion()">
                    <i class="fas fa-times-circle"></i>
                    <span>Cancelar Cita</span>
                </button>
                <!-- Botón de Completar Cita (solo para citas finalizadas) -->
                <button type="button" id="btnCompletarCitaModal" class="btn-primary" style="display: none; background: #10b981; color: white; border-color: #10b981; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; align-items: center; gap: 8px;" onclick="abrirModalCompletarCita()">
                    <i class="fas fa-check-circle"></i>
                    <span>Marcar como Completada</span>
                </button>
                <!-- Botón de Ajustar Precio (solo para citas completadas) -->
                <a href="#" id="btnAjustarPrecioModal" class="btn-primary" style="text-decoration: none; display: none;">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Ajustar Precio</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Cancelación -->
<div id="modalConfirmarCancelacion" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Cancelación</h3>
            <button class="modal-close" onclick="cerrarModalConfirmarCancelacion()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Estás seguro de cancelar esta cita?</h3>
                <p style="margin: 0; color: #64748b; line-height: 1.6;">
                    Esta acción cancelará la cita y liberará el horario. El paciente será notificado de la cancelación.
                </p>
                <div id="infoCitaCancelacion" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Paciente:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="cancelCitaPaciente"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Fecha:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="cancelCitaFecha"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b; font-weight: 500;">Hora:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="cancelCitaHora"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 24px;">
                <button type="button" class="btn-secondary" onclick="cerrarModalConfirmarCancelacion()">
                    <i class="fas fa-times"></i>
                    No, mantener cita
                </button>
                <button type="button" id="btnConfirmarCancelacion" class="btn-primary" style="background: #ef4444; border-color: #ef4444;" onclick="confirmarCancelarCita()">
                    <i class="fas fa-check"></i>
                    Sí, cancelar cita
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Completar Cita -->
<div id="modalCompletarCita" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
            <h3><i class="fas fa-check-circle"></i> Completar Cita</h3>
            <button class="modal-close" onclick="cerrarModalCompletarCita()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #d1fae5; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check-circle" style="font-size: 32px; color: #10b981;"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Marcar esta cita como completada?</h3>
                <p style="margin: 0 0 20px 0; color: #64748b; line-height: 1.6;">
                    Esta acción marcará la cita como completada y registrará el pago recibido.
                </p>
                <div id="infoCitaCompletar" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; text-align: left; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Paciente:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="completarCitaPaciente"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Fecha:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="completarCitaFecha"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b; font-weight: 500;">Hora:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="completarCitaHora"></span>
                    </div>
                </div>
                <div style="text-align: left; margin-bottom: 20px;">
                    <label for="precioCobrado" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 500;">
                        <i class="fas fa-dollar-sign"></i> Precio Cobrado *
                    </label>
                    <input type="number" id="precioCobrado" name="precio_cobrado" min="0" step="1000" required 
                           style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s;"
                           placeholder="Ingrese el monto cobrado">
                    <small style="display: block; margin-top: 4px; color: #64748b; font-size: 0.875rem;">
                        Ingrese el monto total cobrado por esta cita
                    </small>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 20px; border-top: 1px solid #e5e7eb;">
            <button type="button" onclick="cerrarModalCompletarCita()" class="btn-secondary" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                <i class="fas fa-times"></i>
                Cancelar
            </button>
            <button type="button" onclick="confirmarCompletarCita()" class="btn-primary" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                <i class="fas fa-check"></i>
                Completar Cita
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="modalConfirmarEliminacion" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
            <h3><i class="fas fa-trash-alt"></i> Confirmar Eliminación</h3>
            <button class="modal-close" onclick="cerrarModalConfirmarEliminacion()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px 0;">
                <div style="width: 64px; height: 64px; margin: 0 auto 20px; background: #fef2f2; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-trash-alt" style="font-size: 32px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; color: #1e293b; font-size: 1.25rem;">¿Estás seguro de eliminar esta cita?</h3>
                <p style="margin: 0; color: #64748b; line-height: 1.6;">
                    Esta acción eliminará permanentemente la cita disponible. Esta operación no se puede deshacer.
                </p>
                <div id="infoCitaEliminacion" style="margin-top: 20px; padding: 16px; background: #f8fafc; border-radius: 8px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Fecha:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="eliminarCitaFecha"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #64748b; font-weight: 500;">Hora:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="eliminarCitaHora"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748b; font-weight: 500;">Dentista:</span>
                        <span style="color: #1e293b; font-weight: 600;" id="eliminarCitaDentista"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="margin-top: 24px;">
                <button type="button" class="btn-secondary" onclick="cerrarModalConfirmarEliminacion()">
                    <i class="fas fa-times"></i>
                    No, mantener cita
                </button>
                <button type="button" id="btnConfirmarEliminacion" class="btn-primary" style="background: #ef4444; border-color: #ef4444;" onclick="confirmarEliminarCita()">
                    <i class="fas fa-trash-alt"></i>
                    Sí, eliminar cita
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de No Asistencia -->
<div id="modalNoAsistencia" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-times"></i> Marcar como "No Llegó"</h3>
            <button class="modal-close" onclick="cerrarModalNoAsistencia()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formNoAsistencia" method="post">
                {% csrf_token %}
                <input type="hidden" id="citaIdNoAsistencia" name="cita_id" value="">
                
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-exclamation-triangle"></i>
                        Motivo de No Asistencia
                        <span class="required-badge">*</span>
                    </label>
                    <textarea 
                        id="motivoNoAsistencia" 
                        name="motivo_no_asistencia" 
                        class="form-control-modal" 
                        rows="4" 
                        placeholder="Ingrese el motivo por el cual el paciente no asistió a la cita..."
                        required></textarea>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Este motivo es obligatorio y quedará registrado en el historial de la cita.
                    </small>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="cerrarModalNoAsistencia()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" id="btnConfirmarNoAsistencia" class="btn-primary">
                        <i class="fas fa-check"></i>
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
