{% extends 'citas/base.html' %}
{% load custom_filters %}

{% block title %}Gestor de Citas - Clínica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<!-- Contenedor de Notificaciones -->
<div id="notificationContainer" class="notification-container"></div>

<style>
    /* Sistema de Notificaciones Moderno */
    .notification-container {
        position: fixed;
        top: 90px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
        pointer-events: none;
    }
    
    .notification {
        background: white;
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 12px;
        animation: slideInRight 0.3s ease-out;
        pointer-events: auto;
        border-left: 4px solid;
        min-width: 320px;
        max-width: 400px;
    }
    
    .notification.success {
        border-left-color: #10b981;
        background: linear-gradient(to right, #f0fdf4 0%, white 8%);
    }
    
    .notification.error {
        border-left-color: #ef4444;
        background: linear-gradient(to right, #fef2f2 0%, white 8%);
    }
    
    .notification.warning {
        border-left-color: #f59e0b;
        background: linear-gradient(to right, #fffbeb 0%, white 8%);
    }
    
    .notification.info {
        border-left-color: #3b82f6;
        background: linear-gradient(to right, #eff6ff 0%, white 8%);
    }
    
    .notification-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
    }
    
    .notification.success .notification-icon {
        background: #10b981;
        color: white;
    }
    
    .notification.error .notification-icon {
        background: #ef4444;
        color: white;
    }
    
    .notification.warning .notification-icon {
        background: #f59e0b;
        color: white;
    }
    
    .notification.info .notification-icon {
        background: #3b82f6;
        color: white;
    }
    
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    
    .notification-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .notification-message {
        font-size: 0.875rem;
        color: #64748b;
        line-height: 1.5;
        word-wrap: break-word;
    }
    
    .notification-close {
        background: transparent;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
        flex-shrink: 0;
        width: 24px;
        height: 24px;
    }
    
    .notification-close:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .notification.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
    }
</style>

<!-- Header con Stats a la Derecha -->
<div class="header-with-stats">
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-calendar-alt"></i> Gestor de Citas</h1>
        <p class="page-subtitle">Administra las citas y horarios de la clínica dental</p>
    </div>
    <div class="dashboard-compact">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.citas_hoy }}</div>
                    <div class="stat-label">Citas de Hoy</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.disponibles }}</div>
                    <div class="stat-label">Disponibles</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.realizadas }}</div>
                    <div class="stat-label">Realizadas</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Layout Principal Estilo Despegar -->
{% if es_admin %}
<div class="layout-container">
    <div class="despegar-layout">
    <!-- Contenedor de Alertas -->
    <div id="alertas-container" style="position: fixed; top: 80px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; max-width: 400px;"></div>
    <!-- Contenido Principal -->
    <div class="main-content-area">
        <!-- Header con Botón de Agregar Cita -->
        <div class="content-header-actions">
            <div class="results-tabs">
                <button class="tab-btn active" data-tab="today"><i class="fas fa-calendar-day"></i> Citas del Día</button>
                <button class="tab-btn" data-tab="list">Citas disponibles</button>
                <button class="tab-btn" data-tab="taken">Citas tomadas</button>
                <button class="tab-btn" data-tab="completed">Citas completadas</button>
                <button class="tab-btn" data-tab="calendar">Calendario General</button>
            </div>
            {% if perfil.es_administrativo %}
            <button class="btn-add-cita" onclick="openAddCitaModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Agregar Nueva Cita</span>
            </button>
            {% endif %}
        </div>

        

        <!-- Contenido: Citas del Día -->
        <div id="tab-content-today" class="citas-results">
            <div class="citas-dia-header">
                <div class="citas-dia-title-section">
                    <h3><i class="fas fa-calendar-day"></i> Citas del Día - {% now "d/m/Y" %}</h3>
                    <p class="citas-dia-subtitle">
                        {% if perfil.es_administrativo %}
                            Gestiona las citas de hoy de forma rápida y eficiente
                        {% else %}
                            Tus citas del día - Gestiona el flujo de atención
                        {% endif %}
                    </p>
                </div>
                <div class="citas-dia-stats">
                    <div class="stat-mini">
                        <span class="stat-mini-label">Total</span>
                        <span class="stat-mini-value">{{ citas_hoy.paginator.count }}</span>
                    </div>
                    <div class="stat-mini stat-mini-pendientes">
                        <span class="stat-mini-label">Pendientes</span>
                        <span class="stat-mini-value" id="count-pendientes-hoy">0</span>
                    </div>
                    <div class="stat-mini stat-mini-completadas">
                        <span class="stat-mini-label">Completadas</span>
                        <span class="stat-mini-value" id="count-completadas-hoy">0</span>
                    </div>
                </div>
            </div>

            <!-- Filtros Rápidos -->
            <div class="filtros-rapidos-dia">
                <button class="filtro-rapido-btn active" data-filtro="todas">
                    <i class="fas fa-list"></i> Todas
                </button>
                <button class="filtro-rapido-btn" data-filtro="en-espera">
                    <i class="fas fa-hourglass-half"></i> En Espera
                </button>
                <button class="filtro-rapido-btn" data-filtro="en-progreso">
                    <i class="fas fa-user-md"></i> En Progreso
                </button>
                <button class="filtro-rapido-btn" data-filtro="finalizada">
                    <i class="fas fa-check-double"></i> Finalizada
                </button>
                <button class="filtro-rapido-btn" data-filtro="completadas">
                    <i class="fas fa-check-circle"></i> Completadas
                </button>
                <button class="filtro-rapido-btn" data-filtro="no-show">
                    <i class="fas fa-user-times"></i> No Llegó
                </button>
                <div class="filtro-dentista-dia">
                    <i class="fas fa-user-md"></i>
                    <select id="filtro-dentista-dia" class="filtro-select-dia">
                        <option value="">Todos los dentistas</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Lista de Citas del Día -->
            <div class="citas-dia-lista" id="citas-dia-lista">
                {% if citas_hoy %}
                    {% for cita in citas_hoy %}
                    <div class="cita-dia-card {% if cita.estado == 'completada' %}completada{% elif cita.estado == 'no_show' %}no-show{% elif cita.estado == 'en_espera' %}en-espera{% elif cita.estado == 'listo_para_atender' %}listo-para-atender{% elif cita.estado == 'en_progreso' %}en-progreso{% elif cita.estado == 'finalizada' %}finalizada{% else %}pendiente{% endif %}" 
                         data-cita-id="{{ cita.id }}"
                         data-estado="{{ cita.estado }}" 
                         data-dentista-id="{% if cita.dentista %}{{ cita.dentista.id }}{% else %}0{% endif %}"
                         data-fecha-hora="{{ cita.fecha_hora|date:'Y-m-d H:i' }}">
                        <div class="cita-dia-time">
                            <div class="cita-dia-hora">{{ cita.fecha_hora|time:"H:i" }}</div>
                            <div class="cita-dia-indicador">
                                {% if cita.estado == 'completada' %}
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                {% elif cita.estado == 'no_show' %}
                                    <i class="fas fa-user-times" style="color: #ef4444;"></i>
                                {% elif cita.estado == 'en_espera' %}
                                    <i class="fas fa-hourglass-half" style="color: #f59e0b;"></i>
                                {% elif cita.estado == 'listo_para_atender' %}
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                {% elif cita.estado == 'en_progreso' %}
                                    <i class="fas fa-user-md" style="color: #3b82f6;"></i>
                                {% elif cita.estado == 'finalizada' %}
                                    <i class="fas fa-check-double" style="color: #f59e0b;"></i>
                                {% else %}
                                    <i class="fas fa-clock" style="color: #3b82f6;"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="cita-dia-info">
                            {% if cita.estado == 'listo_para_atender' %}
                                {% if perfil.es_administrativo %}
                                    <div class="mensaje-destacado mensaje-listo">
                                        <i class="fas fa-bell"></i>
                                        <strong>Dr. {{ cita.dentista.nombre_completo }} está listo para atender - Pasar al paciente</strong>
                                    </div>
                                {% elif perfil.es_dentista and cita.dentista and cita.dentista.id == perfil.id %}
                                    <div class="mensaje-destacado mensaje-listo">
                                        <i class="fas fa-check-circle"></i>
                                        <strong>Estás listo para atender - Cuando el paciente entre, marca "Iniciar Atención"</strong>
                                    </div>
                                {% endif %}
                            {% elif cita.estado == 'finalizada' and perfil.es_administrativo %}
                                <div class="mensaje-destacado mensaje-finalizada">
                                    <i class="fas fa-arrow-right"></i>
                                    <strong>Cliente viene a recepción para pagar</strong>
                                </div>
                            {% endif %}
                            <div class="cita-dia-paciente">
                                <strong>
                                    {% if cita.paciente_nombre %}
                                        {{ cita.paciente_nombre }}
                                    {% elif cita.cliente %}
                                        {{ cita.cliente.nombre_completo }}
                                    {% else %}
                                        Sin asignar
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="cita-dia-detalles">
                                <span class="cita-dia-dentista">
                                    <i class="fas fa-user-md"></i>
                                    {% if cita.dentista %}
                                        {{ cita.dentista.nombre_completo }}
                                    {% else %}
                                        Sin asignar
                                    {% endif %}
                                </span>
                                <span class="cita-dia-servicio">
                                    <i class="fas fa-stethoscope"></i>
                                    {% if cita.tipo_servicio %}
                                        {{ cita.tipo_servicio.nombre }}
                                    {% elif cita.tipo_consulta %}
                                        {{ cita.tipo_consulta }}
                                    {% else %}
                                        Sin servicio
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="cita-dia-estado">
                            <span class="badge-estado-dia {{ cita.estado }}">
                                {% if cita.estado == 'disponible' %}
                                    <i class="fas fa-circle"></i> Disponible
                                {% elif cita.estado == 'reservada' %}
                                    <i class="fas fa-calendar-check"></i> Reservada
                                {% elif cita.estado == 'confirmada' %}
                                    <i class="fas fa-check"></i> Confirmada
                                {% elif cita.estado == 'en_espera' %}
                                    <i class="fas fa-hourglass-half"></i> En Espera
                                {% elif cita.estado == 'listo_para_atender' %}
                                    <i class="fas fa-check-circle"></i> Listo para Atender
                                {% elif cita.estado == 'en_progreso' %}
                                    <i class="fas fa-user-md"></i> En Progreso
                                {% elif cita.estado == 'finalizada' %}
                                    <i class="fas fa-check-double"></i> Finalizada
                                {% elif cita.estado == 'completada' %}
                                    <i class="fas fa-check-double"></i> Completada
                                {% elif cita.estado == 'no_show' %}
                                    <i class="fas fa-user-times"></i> No Llegó
                                {% else %}
                                    {{ cita.get_estado_display }}
                                {% endif %}
                            </span>
                        </div>
                        <div class="cita-dia-acciones">
                            {% if cita.estado == 'reservada' or cita.estado == 'confirmada' or cita.estado == 'disponible' %}
                                <button class="btn-accion-rapida btn-reagendar" onclick="abrirModalReagendar({{ cita.id }})" title="Reagendar cita">
                                    <i class="fas fa-calendar-alt"></i>
                                </button>
                            {% endif %}
                            {% if perfil.es_administrativo %}
                                {% if cita.estado == 'reservada' or cita.estado == 'confirmada' %}
                                    <button class="btn-accion-rapida btn-llego" onclick="marcarLlegada({{ cita.id }})" title="Marcar como llegó">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-accion-rapida btn-no-llego" onclick="marcarNoLlego({{ cita.id }})" title="Marcar como No Llegó">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% elif cita.estado != 'completada' and cita.estado != 'no_show' and cita.estado != 'cancelada' and cita.estado != 'disponible' and cita.estado != 'listo_para_atender' and cita.estado != 'en_progreso' and cita.estado != 'finalizada' %}
                                    <button class="btn-accion-rapida btn-llego" onclick="marcarLlegada({{ cita.id }})" title="Marcar como llegó">
                                        <i class="fas fa-check"></i>
                                    </button>
                                {% endif %}
                            {% endif %}
                            {% if perfil.es_dentista and cita.dentista and cita.dentista.id == perfil.id %}
                                {% if cita.estado == 'en_espera' %}
                                    <button class="btn-accion-rapida btn-listo" onclick="marcarListoParaAtender({{ cita.id }})" title="Marcar como listo para atender">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                {% elif cita.estado == 'listo_para_atender' %}
                                    <button class="btn-accion-rapida btn-iniciar" onclick="iniciarAtencion({{ cita.id }})" title="Iniciar atención">
                                        <i class="fas fa-play"></i>
                                    </button>
                                {% elif cita.estado == 'en_progreso' %}
                                    <button class="btn-accion-rapida btn-finalizar" onclick="finalizarAtencion({{ cita.id }})" title="Finalizar atención (después de crear ficha)">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                {% endif %}
                            {% endif %}
                            {% if perfil.es_administrativo %}
                                {% if cita.estado == 'finalizada' %}
                                    {% if cita.tiene_ficha and cita.odontograma %}
                                        <a href="{% url 'exportar_odontograma_pdf' cita.odontograma.id %}" class="btn-accion-rapida btn-descargar-ficha" title="Descargar ficha odontológica (PDF)" target="_blank">
                                            <i class="fas fa-file-pdf"></i>
                                        </a>
                                    {% endif %}
                                    <button class="btn-accion-rapida btn-completar" onclick="completarCitaRecepcion({{ cita.id }})" title="Completar cita (después de recibir pago)">
                                        <i class="fas fa-check-double"></i>
                                    </button>
                                {% endif %}
                            {% endif %}
                            {% if cita.estado == 'disponible' %}
                                <button class="btn-accion-rapida btn-editar" onclick="openOptionsModalForCita({{ cita.id }})" title="Editar cita">
                                    <i class="fas fa-edit"></i>
                                </button>
                            {% else %}
                                <button class="btn-accion-rapida btn-ver" onclick="openOptionsModalForCita({{ cita.id }})" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="citas-dia-vacia">
                        <i class="fas fa-calendar-times"></i>
                        <h4>No hay citas programadas para hoy</h4>
                        <p>Puedes crear nuevas citas usando el botón "Agregar Nueva Cita"</p>
                    </div>
                {% endif %}
                
                <!-- Paginación Citas del Día -->
                {% if citas_hoy.has_other_pages %}
                <div class="pagination" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
                    <div class="pagination-info">
                        Mostrando {{ citas_hoy.start_index }} - {{ citas_hoy.end_index }} de {{ citas_hoy.paginator.count }} citas
                    </div>
                    <div class="pagination-controls">
                        {% if citas_hoy.has_previous %}
                            <a href="?page_hoy=1&tab=today{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page_hoy={{ citas_hoy.previous_page_number }}&tab=today{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas_hoy.number }} de {{ citas_hoy.paginator.num_pages }}
                        </span>
                        
                        {% if citas_hoy.has_next %}
                            <a href="?page_hoy={{ citas_hoy.next_page_number }}&tab=today{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page_hoy={{ citas_hoy.paginator.num_pages }}&tab=today{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contenido: Listado -->
        <div id="tab-content-list" class="citas-results" style="display: none;">
            <!-- Título: Citas Disponibles -->
            {% if citas_creadas %}
            <div class="section-title-modern">
                <div>
                    <h3><i class="fas fa-calendar-check"></i> Citas Disponibles</h3>
                    <p id="count-disponibles">{{ citas_creadas.paginator.count }} horario(s) libre(s)</p>
                </div>
            </div>

            <!-- Filtros de Búsqueda - Disponibles -->
            <div class="filtros-busqueda">
                <div class="filtro-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="filtro-disponibles-texto" placeholder="Búsqueda general (paciente, dentista, servicio...)" class="filtro-input">
                </div>
                <div class="filtro-group">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="filtro-disponibles-fecha" class="filtro-input">
                </div>
                <div class="filtro-group">
                    <i class="fas fa-user-md"></i>
                    <select id="filtro-disponibles-dentista" class="filtro-select">
                        <option value="">Todos los dentistas</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filtro-group">
                    <i class="fas fa-stethoscope"></i>
                    <select id="filtro-disponibles-servicio" class="filtro-select">
                        <option value="">Todos los servicios</option>
                        {% for servicio in servicios %}
                        <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button onclick="aplicarFiltrosDisponibles()" class="btn-aplicar-filtros" title="Aplicar filtros">
                    <i class="fas fa-filter"></i> Aplicar
                </button>
                <button onclick="limpiarFiltrosDisponibles()" class="btn-limpiar-filtros" title="Limpiar filtros">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>

            <!-- Tabla de Citas -->
            <div class="tabla-citas-wrapper">
                <table class="tabla-citas">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar-day"></i> Fecha</th>
                            <th><i class="fas fa-clock"></i> Hora</th>
                            <th><i class="fas fa-tooth"></i> Tipo</th>
                            <th><i class="fas fa-info-circle"></i> Estado</th>
                            <th class="col-cliente" style="display: none;"><i class="fas fa-user"></i> Cliente</th>
                            <th><i class="fas fa-user-md"></i> Dentista</th>
                            <th><i class="fas fa-cog"></i> Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cita in citas_creadas %}
                        <tr class="fila-cita disponible"
                            data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                            data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                            data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}">
                            <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                            <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                            <td class="col-tipo">
                                {% if cita.tipo_servicio %}
                                    <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                        <i class="fas fa-stethoscope"></i>
                                        {{ cita.tipo_servicio.nombre }}
                                    </span>
                                {% elif cita.tipo_consulta %}
                                    <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                        <i class="fas fa-stethoscope"></i>
                                        {{ cita.tipo_consulta }}
                                    </span>
                                {% else %}
                                    <span class="text-muted" title="Sin servicio asignado">
                                        <i class="fas fa-question-circle"></i>
                                        Sin servicio
                                    </span>
                                {% endif %}
                            </td>
                            <td class="col-estado">
                                <span class="badge-estado disponible">
                                    <i class="fas fa-circle"></i> Disponible
                                </span>
                            </td>
                            <td class="col-cliente" style="display: none;">
                                <span class="text-muted">Sin asignar</span>
                            </td>
                            <td class="col-dentista">
                                {% if cita.dentista %}
                                    <div class="dentista-info-compact">
                                        <i class="fas fa-user-md"></i>
                                        {{ cita.dentista.nombre_completo }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td class="col-acciones">
                                <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- Mensaje cuando no hay resultados después de filtrar -->
                <div id="mensaje-sin-resultados-disponibles" class="empty-results-modern" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 id="mensaje-titulo-disponibles">No se encontraron resultados</h3>
                    <p id="mensaje-descripcion-disponibles">Intenta ajustar los filtros de búsqueda</p>
                </div>
            </div>
            
            <!-- Paginación Citas Disponibles -->
            {% if citas_creadas.has_other_pages %}
            <div class="pagination" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
                <div class="pagination-info">
                    Mostrando {{ citas_creadas.start_index }} - {{ citas_creadas.end_index }} de {{ citas_creadas.paginator.count }} citas
                </div>
                <div class="pagination-controls">
                    {% if citas_creadas.has_previous %}
                        <a href="?page_disponibles=1&tab=list{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Primera página">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="?page_disponibles={{ citas_creadas.previous_page_number }}&tab=list{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Anterior">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    {% else %}
                        <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                        <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                    {% endif %}
                    
                    <span class="page-current">
                        Página {{ citas_creadas.number }} de {{ citas_creadas.paginator.num_pages }}
                    </span>
                    
                    {% if citas_creadas.has_next %}
                        <a href="?page_disponibles={{ citas_creadas.next_page_number }}&tab=list{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Siguiente">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?page_disponibles={{ citas_creadas.paginator.num_pages }}&tab=list{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Última página">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% else %}
                        <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                        <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="empty-results-modern">
                <div class="empty-icon">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <h3>No hay citas disponibles</h3>
                <p>Haz clic en el botón "Agregar Nueva Cita" para crear una nueva cita</p>
            </div>
            {% endif %}
        </div>

        <!-- Contenido: Citas Tomadas -->
        <div id="tab-content-taken" style="display: none;">
            <div class="citas-results">
                {% if citas_tomadas %}
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-check"></i> Citas Reservadas</h3>
                        <p id="count-tomadas">{{ citas_tomadas.paginator.count }} cita(s) reservada(s)</p>
                    </div>
                </div>

                <!-- Filtros de Búsqueda - Tomadas -->
                <div class="filtros-busqueda">
                    <div class="filtro-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="filtro-tomadas-texto" placeholder="Buscar por cliente, servicio, dentista..." class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtro-tomadas-fecha" class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-user-md"></i>
                        <select id="filtro-tomadas-dentista" class="filtro-select">
                            <option value="">Todos los dentistas</option>
                            {% for dentista in dentistas %}
                            <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-stethoscope"></i>
                        <select id="filtro-tomadas-servicio" class="filtro-select">
                            <option value="">Todos los servicios</option>
                            {% for servicio in servicios %}
                            <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button onclick="aplicarFiltrosTomadas()" class="btn-aplicar-filtros" title="Aplicar filtros">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                    <button onclick="limpiarFiltrosTomadas()" class="btn-limpiar-filtros" title="Limpiar filtros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>

                <!-- Tabla de Citas Tomadas -->
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas_tomadas %}
                            <tr class="fila-cita reservada"
                                data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                                data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                                data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}"
                                data-cliente="{{ cita.nombre_paciente }}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                                <td class="col-tipo">
                                    {% if cita.plan_tratamiento %}
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span class="badge" style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                                <i class="fas fa-clipboard-list"></i> Tratamiento
                                            </span>
                                            {% if cita.tipo_servicio %}
                                            <span>{{ cita.tipo_servicio.nombre }}</span>
                                            {% elif cita.tipo_consulta %}
                                            <span>{{ cita.tipo_consulta }}</span>
                                            {% endif %}
                                        </div>
                                        {% if cita.fase_tratamiento %}
                                        <small style="color: #64748b; font-size: 0.75rem;">
                                            <i class="fas fa-list-ol"></i> Fase: {{ cita.fase_tratamiento.nombre }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                            <i class="fas fa-stethoscope"></i>
                                            {{ cita.tipo_servicio.nombre }}
                                        </span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                            <i class="fas fa-file-medical"></i>
                                            {{ cita.tipo_consulta }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted" title="Sin servicio asignado">
                                            <i class="fas fa-question-circle"></i>
                                            Sin servicio
                                        </span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    <span class="badge-estado reservada">
                                        <i class="fas fa-circle"></i> {{ cita.get_estado_display }}
                                    </span>
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {{ cita.nombre_paciente }}
                                    </div>
                                    {% if cita.email_paciente %}
                                    <small class="text-muted">{{ cita.email_paciente }}</small>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- Mensaje cuando no hay resultados después de filtrar -->
                    <div id="mensaje-sin-resultados-tomadas" class="empty-results-modern" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 id="mensaje-titulo-tomadas">No se encontraron resultados</h3>
                        <p id="mensaje-descripcion-tomadas">Intenta ajustar los filtros de búsqueda</p>
                    </div>
                </div>
                
                <!-- Paginación Citas Tomadas -->
                {% if citas_tomadas.has_other_pages %}
                <div class="pagination" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
                    <div class="pagination-info">
                        Mostrando {{ citas_tomadas.start_index }} - {{ citas_tomadas.end_index }} de {{ citas_tomadas.paginator.count }} citas
                    </div>
                    <div class="pagination-controls">
                        {% if citas_tomadas.has_previous %}
                            <a href="?page_tomadas=1&tab=taken{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page_tomadas={{ citas_tomadas.previous_page_number }}&tab=taken{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas_tomadas.number }} de {{ citas_tomadas.paginator.num_pages }}
                        </span>
                        
                        {% if citas_tomadas.has_next %}
                            <a href="?page_tomadas={{ citas_tomadas.next_page_number }}&tab=taken{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page_tomadas={{ citas_tomadas.paginator.num_pages }}&tab=taken{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_completadas %}&page_completadas={{ request.GET.page_completadas }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3>No hay citas reservadas</h3>
                    <p>Las citas reservadas aparecerán en este listado</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contenido: Calendario -->
        <div id="tab-content-calendar" style="display: none;">
            <div id="calendar" style="max-width: 100%; margin: 0 auto;"></div>
        </div>

        <!-- Contenido: Citas Completadas -->
        <div id="tab-content-completed" style="display: none;">
            <div class="citas-results">
                {% if citas_completadas %}
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-check-circle"></i> Citas Completadas</h3>
                        <p id="count-completadas">{{ citas_completadas.paginator.count }} cita(s) completada(s)</p>
                    </div>
                </div>

                <!-- Filtros de Búsqueda - Completadas -->
                <div class="filtros-busqueda">
                    <div class="filtro-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="filtro-completadas-texto" placeholder="Buscar por cliente, servicio, dentista..." class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtro-completadas-fecha" class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-user-md"></i>
                        <select id="filtro-completadas-dentista" class="filtro-select">
                            <option value="">Todos los dentistas</option>
                            {% for dentista in dentistas %}
                            <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-stethoscope"></i>
                        <select id="filtro-completadas-servicio" class="filtro-select">
                            <option value="">Todos los servicios</option>
                            {% for servicio in servicios %}
                            <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button onclick="aplicarFiltrosCompletadas()" class="btn-aplicar-filtros" title="Aplicar filtros">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                    <button onclick="limpiarFiltrosCompletadas()" class="btn-limpiar-filtros" title="Limpiar filtros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>

                <!-- Tabla de Citas Completadas -->
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-user-md"></i> Dentista</th>
                                <th><i class="fas fa-eye"></i> Ver</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas_completadas %}
                            <tr class="fila-cita {% if cita.estado == 'no_show' %}cita-no-llego-fila{% elif cita.estado == 'cancelada' %}cita-cancelada-fila{% else %}completada{% endif %}"
                                data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                                data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                                data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}"
                                data-cliente="{{ cita.nombre_paciente|default:'Sin asignar' }}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                                <td class="col-tipo">
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                            <i class="fas fa-stethoscope"></i>
                                            {{ cita.tipo_servicio.nombre }}
                                        </span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                            <i class="fas fa-file-medical"></i>
                                            {{ cita.tipo_consulta }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted" title="Sin servicio asignado">
                                            <i class="fas fa-question-circle"></i>
                                            Sin servicio
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    {% if cita.estado == 'no_show' %}
                                        <span class="badge-estado badge-no-asistida">
                                            <i class="fas fa-user-times"></i> No asistida
                                        </span>
                                    {% elif cita.estado == 'cancelada' %}
                                        <span class="badge-estado badge-cancelada-estado">
                                            <i class="fas fa-times-circle"></i> Cancelada
                                        </span>
                                    {% else %}
                                        <span class="badge-estado badge-completada-estado">
                                            <i class="fas fa-check-circle"></i> Completada
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {% if cita.cliente %}
                                            {{ cita.cliente.nombre_completo }}
                                        {% elif cita.paciente_nombre %}
                                            {{ cita.paciente_nombre }}
                                        {% else %}
                                            Sin asignar
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="col-dentista">
                                    {% if cita.dentista %}
                                        <div class="dentista-info-compact">
                                            <i class="fas fa-user-md"></i>
                                            {{ cita.dentista.nombre_completo }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion" title="Ver detalles de la cita">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- Mensaje cuando no hay resultados después de filtrar -->
                    <div id="mensaje-sin-resultados-completadas" class="empty-results-modern" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 id="mensaje-titulo-completadas">No se encontraron resultados</h3>
                        <p id="mensaje-descripcion-completadas">Intenta ajustar los filtros de búsqueda</p>
                    </div>
                </div>
                
                <!-- Paginación Citas Completadas -->
                {% if citas_completadas.has_other_pages %}
                <div class="pagination" style="margin-top: 20px; padding: 20px; background: white; border-radius: 8px;">
                    <div class="pagination-info">
                        Mostrando {{ citas_completadas.start_index }} - {{ citas_completadas.end_index }} de {{ citas_completadas.paginator.count }} citas
                    </div>
                    <div class="pagination-controls">
                        {% if citas_completadas.has_previous %}
                            <a href="?page_completadas=1&tab=completed{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}" class="page-btn" title="Primera página">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="?page_completadas={{ citas_completadas.previous_page_number }}&tab=completed{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}" class="page-btn" title="Anterior">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-double-left"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-left"></i></span>
                        {% endif %}
                        
                        <span class="page-current">
                            Página {{ citas_completadas.number }} de {{ citas_completadas.paginator.num_pages }}
                        </span>
                        
                        {% if citas_completadas.has_next %}
                            <a href="?page_completadas={{ citas_completadas.next_page_number }}&tab=completed{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}" class="page-btn" title="Siguiente">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page_completadas={{ citas_completadas.paginator.num_pages }}&tab=completed{% if request.GET.page_hoy %}&page_hoy={{ request.GET.page_hoy }}{% endif %}{% if request.GET.page_disponibles %}&page_disponibles={{ request.GET.page_disponibles }}{% endif %}{% if request.GET.page_tomadas %}&page_tomadas={{ request.GET.page_tomadas }}{% endif %}" class="page-btn" title="Última página">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% else %}
                            <span class="page-btn disabled"><i class="fas fa-angle-right"></i></span>
                            <span class="page-btn disabled"><i class="fas fa-angle-double-right"></i></span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>No hay citas completadas</h3>
                    <p>Las citas completadas aparecerán en este listado</p>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
    </div>
</div>
{% endif %}

<!-- Modal de Agregar Nueva Cita -->
<div id="addCitaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-plus"></i> Agregar Nueva Cita</h3>
            <button class="modal-close" onclick="closeAddCitaModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="javascript:void(0);" id="formAgregarCitaModal" data-action="{% url 'agregar_hora' %}">
                {% csrf_token %}
                <!-- Campo hidden para enviar el ID del servicio -->
                <input type="hidden" name="tipo_servicio" id="tipoServicioIdInput" value="">

                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                        <span class="required-badge">*</span>
                    </label>
                    <input type="datetime-local" name="fecha_hora" id="addCitaFechaHora" required class="form-control-modal" min="">
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        Selecciona el día y hora del turno (solo fechas futuras)
                    </small>
                </div>

                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select name="tipo_consulta" id="addCitaTipo" class="form-control-modal" required>
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Selección de Dentista -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                        <span class="required-badge">*</span>
                    </label>
                    <select name="dentista_id" id="addCitaDentista" class="form-control-modal" required>
                        <option value="">-- Seleccionar dentista --</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">
                            {{ dentista.nombre_completo }}
                            {% if dentista.especialidad %} - {{ dentista.especialidad }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        {{ dentistas|length }} dentista(s) disponible(s)
                    </small>
                </div>

                <!-- Asignar Cliente (Checkbox) -->
                <div class="form-group-modal">
                    <label class="checkbox-label-modern" for="asignarClienteCheck">
                        <input type="checkbox" id="asignarClienteCheck" name="asignar_cliente" onchange="toggleClienteFields()">
                        <span>
                            <i class="fas fa-user-plus"></i>
                            Asignar Cliente a esta Cita
                        </span>
                    </label>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        Marca esta opción si el cliente está presente y necesita crear la cita inmediatamente
                    </small>
                </div>

                <!-- Campos de Cliente (Ocultos por defecto) -->
                <div id="clienteFieldsContainer" style="display: none;">
                    <div class="cliente-options-section">
                        <h4 style="margin: 0 0 16px 0; font-size: 1rem; font-weight: 600; color: #374151;">
                            <i class="fas fa-user"></i> Seleccionar Cliente
                        </h4>
                        
                        <!-- Búsqueda de Cliente -->
                        <div class="form-group-modal">
                            <label class="form-label">
                                <i class="fas fa-search"></i>
                                Buscar Cliente
                            </label>
                            <div class="cliente-search-wrapper">
                                <input type="text" id="clienteSearchInput" class="form-control-modal" placeholder="Buscar por nombre o email..." autocomplete="off">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <select id="clienteSelect" class="form-control-modal" style="display: none; visibility: hidden; position: absolute; width: 1px; height: 1px; opacity: 0;" onchange="handleClienteSelect()">
                                <option value="">-- Seleccionar cliente --</option>
                                {% if clientes %}
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" data-nombre="{{ cliente.nombre_completo }}" data-email="{{ cliente.email }}" data-telefono="{{ cliente.telefono }}">
                                    {{ cliente.nombre_completo }} - {{ cliente.email }}
                                </option>
                                {% endfor %}
                                {% else %}
                                <option value="" disabled>No hay clientes disponibles</option>
                                {% endif %}
                            </select>
                            <input type="hidden" name="cliente_id" id="clienteIdInput" value="">
                            <div id="clienteResults" class="cliente-results-list"></div>
                            <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                                <i class="fas fa-info-circle"></i> Escribe el nombre o email del cliente para buscar
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Notas -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea name="notas" id="addCitaNotas" placeholder="Información relevante sobre la cita..." rows="3" class="form-control-modal"></textarea>
                </div>

                <!-- Botones de Acción -->
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddCitaModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        Crear Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Simple para Citas Tomadas -->
<div id="citaInfoModal" class="modal-overlay">
    <div class="modal-content modal-container-simple">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Información de la Cita</h3>
            <button class="modal-close" onclick="closeCitaInfoModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Información de la Cita -->
            <div class="cita-info-card">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-day"></i> Fecha
                    </div>
                    <div class="info-value" id="modalCitaFecha"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-clock"></i> Hora
                    </div>
                    <div class="info-value" id="modalCitaHora"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user"></i> Paciente
                    </div>
                    <div class="info-value" id="modalCitaPaciente"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-tooth"></i> Tipo de Consulta
                    </div>
                    <div class="info-value" id="modalCitaTipo"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user-md"></i> Dentista
                    </div>
                    <div class="info-value" id="modalCitaDentista"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-info-circle"></i> Estado
                    </div>
                    <div class="info-value">
                        <span class="badge-estado" id="modalCitaEstado"></span>
                    </div>
                </div>
                
                <div class="info-item" id="infoFichaContainer" style="display: none;">
                    <div class="info-label">
                        <i class="fas fa-file-medical"></i> Ficha Odontológica
                    </div>
                    <div class="info-value" id="modalCitaFicha">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div class="modal-actions-simple">
                <a href="#" id="btnCompletarCita" class="btn-action-completar" onclick="return validarCompletarCita()">
                    <i class="fas fa-check-double"></i>
                    <span>Completar Cita</span>
                </a>
                <a href="#" id="btnCancelarCita" class="btn-action-cancelar" onclick="return confirm('¿Cancelar esta cita?')">
                    <i class="fas fa-times-circle"></i>
                    <span>Cancelar Cita</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Motivo de No Asistencia -->
<div id="modalNoAsistencia" class="modal-overlay">
    <div class="modal-content modal-container-simple">
        <div class="modal-header">
            <h3><i class="fas fa-user-times"></i> Marcar como "No Llegó"</h3>
            <button class="modal-close" onclick="cerrarModalNoAsistencia()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <p style="color: #64748b; font-size: 14px; line-height: 1.6;">
                    <i class="fas fa-info-circle" style="color: #f59e0b;"></i>
                    Por favor, indique el motivo por el cual el paciente no asistió a la cita. 
                    Esta información quedará registrada en el historial del cliente.
                </p>
            </div>
            <form id="formNoAsistencia" onsubmit="return false;">
                {% csrf_token %}
                <input type="hidden" id="citaIdNoAsistencia" name="cita_id" value="" data-endpoint="marcar_no_llego">
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-comment-alt"></i>
                        Motivo de No Asistencia
                        <span class="required-badge">*</span>
                    </label>
                    <textarea 
                        id="motivoNoAsistencia" 
                        name="motivo_no_asistencia" 
                        rows="4" 
                        class="form-control-modal" 
                        placeholder="Ej: Cliente no se presentó, canceló a último momento, no respondió llamadas, etc."
                        required
                        style="resize: vertical; min-height: 100px;"></textarea>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Este motivo quedará registrado en el historial del cliente
                    </small>
                </div>
                <div class="modal-footer" style="margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="cerrarModalNoAsistencia()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary" id="btnConfirmarNoAsistencia">
                        <i class="fas fa-check"></i>
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Editar Cita -->
<div id="optionsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="optionsModalTitle"><i class="fas fa-edit"></i> Editar Cita</h3>
            <button class="modal-close" onclick="closeOptionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Contenedor para información de solo lectura (citas completadas) -->
            <div id="optionsInfoReadonly" style="display: none;">
                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                    </label>
                    <input type="text" id="optionsFechaHoraReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>
                
                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <input type="text" id="optionsTipoReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>
                
                <!-- Dentista Asignado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                    </label>
                    <input type="text" id="optionsDentistaReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>

                <!-- Paciente -->
                <div class="form-group-modal" id="pacienteInfoReadonly">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        Paciente
                    </label>
                    <input type="text" id="optionsPacienteReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>

                <!-- Precio Actual -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-dollar-sign"></i>
                        Precio Actual
                    </label>
                    <input type="text" id="optionsPrecioReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed; font-weight: 600; color: var(--primary-color);">
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Precio final cobrado por este servicio
                    </small>
                </div>

                <!-- Motivo de No Asistencia (solo para citas no_show) -->
                <div class="form-group-modal" id="motivoNoAsistenciaReadonly" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                        Motivo de No Asistencia
                    </label>
                    <div id="optionsMotivoNoAsistenciaReadonly" style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 12px; border-radius: 6px; color: #7f1d1d; line-height: 1.5; min-height: 60px;">
                    </div>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Motivo registrado cuando se marcó la cita como "No Llegó"
                    </small>
                </div>

                <!-- Botones de acción según el estado -->
                <div class="modal-footer" style="margin-top: 24px;">
                    <!-- Botón para ajustar precio (solo para completadas) -->
                    <a href="#" id="btnAjustarPrecio" class="btn-save-edit" style="text-decoration: none; display: none; align-items: center; justify-content: center;">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Ajustar Precio</span>
                    </a>
                    <!-- Botón para eliminar cita (para canceladas y no asistidas) -->
                    <button type="button" id="btnEliminarCitaCancelada" class="btn-delete-edit" style="display: none;" onclick="confirmarEliminarCita(event)">
                        <i class="fas fa-trash-alt"></i>
                        <span>Eliminar Cita</span>
                    </button>
                </div>
            </div>

            <!-- Formulario para editar (citas disponibles) -->
            <form id="optionsForm" method="post" action="" style="display: none;">
                {% csrf_token %}
                
                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                    </label>
                    <input type="datetime-local" id="optionsFechaHora" name="fecha_hora" required class="form-control-modal">
                </div>
                
                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select id="optionsTipo" name="tipo_consulta" class="form-control-modal">
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>
                
                <!-- Dentista Asignado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                    </label>
                    <select id="optionsDentista" name="dentista_id" class="form-control-modal">
                        <option value="">Sin dentista asignado</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Estado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-info-circle"></i>
                        Estado
                    </label>
                    <div id="optionsEstadoBadge" class="badge-estado-modal">
                        <!-- Se llenará dinámicamente con JavaScript -->
                    </div>
                    <input type="hidden" id="optionsEstado" name="estado" value="">
                </div>

                <!-- Seleccionar Cliente (para citas disponibles o para asignar cliente a cita existente) -->
                <div class="form-group-modal" id="clienteSelectContainer">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        Seleccionar Cliente
                        <span class="required-badge" id="clienteRequiredBadge" style="display: none;">*</span>
                    </label>
                    <div class="cliente-search-wrapper">
                        <input type="text" id="optionsClienteSearch" class="form-control-modal" placeholder="Buscar cliente por nombre o email..." autocomplete="off">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <select id="optionsClienteSelect" name="cliente_id" class="form-control-modal" style="display: none; visibility: hidden; position: absolute; width: 1px; height: 1px; opacity: 0;">
                        <option value="">-- Seleccionar cliente --</option>
                        {% if clientes %}
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" data-nombre="{{ cliente.nombre_completo }}" data-email="{{ cliente.email }}" data-telefono="{{ cliente.telefono }}">
                            {{ cliente.nombre_completo }} - {{ cliente.email }}
                        </option>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay clientes disponibles</option>
                        {% endif %}
                    </select>
                    <div id="optionsClienteResults" class="cliente-results" style="display: none;"></div>
                    <input type="hidden" id="optionsClienteId" name="cliente_id" value="">
                    <div id="optionsClienteSelected" style="display: none; margin-top: 8px; padding: 12px; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: #065f46; margin-bottom: 4px;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <span id="optionsClienteSelectedName"></span>
                                </div>
                                <div style="font-size: 0.85rem; color: #047857;">
                                    <span id="optionsClienteSelectedEmail"></span>
                                </div>
                            </div>
                            <button type="button" onclick="clearClienteSelection()" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 4px 8px; border-radius: 4px;" title="Quitar cliente">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <small style="color: #64748b; font-size: 0.875rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Busque y seleccione un cliente para asignar a esta cita
                    </small>
                </div>
                
                <!-- Información del Paciente (solo lectura si existe y está reservada) -->
                <div class="form-group-modal" id="pacienteInfo" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        Paciente (Solo Lectura)
                    </label>
                    <input type="text" id="optionsPaciente" name="paciente" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                    <small style="color: #64748b; font-size: 0.875rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Esta cita ya está reservada por este cliente
                    </small>
                </div>
                
                <!-- Notas Adicionales -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea id="optionsNotas" name="notas" rows="3" class="form-control-modal" placeholder="Información adicional sobre la cita..."></textarea>
                </div>
                
                <!-- Botones de Acción -->
                <div class="modal-footer">
                    <button type="button" class="btn-delete-edit" onclick="confirmarEliminarCita(event)">
                        <i class="fas fa-trash-alt"></i>
                        <span>Eliminar Cita</span>
                    </button>
                    <button type="submit" class="btn-save-edit">
                        <i class="fas fa-save"></i>
                        <span>Guardar Cambios</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-content modal-confirm">
        <div class="modal-header modal-header-warning">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
            <button class="modal-close" onclick="closeConfirmDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Estado de la Cita -->
            <div class="confirm-status-box" id="confirmStatusBox">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Estado de la cita:</strong>
                    <span id="confirmEstadoText"></span>
                </div>
            </div>

            <!-- Mensaje de advertencia si está tomada -->
            <div class="confirm-warning-box" id="confirmWarningBox" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>⚠️ IMPORTANTE:</strong>
                    <p>Esta cita está <strong>RESERVADA</strong> por un cliente.</p>
                    <p><strong>Datos del cliente:</strong></p>
                    <ul>
                        <li><strong>Nombre:</strong> <span id="confirmClienteNombre"></span></li>
                        <li><strong>Email:</strong> <span id="confirmClienteEmail"></span></li>
                        <li><strong>Teléfono:</strong> <span id="confirmClienteTelefono"></span></li>
                    </ul>
                    <p style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                        <i class="fas fa-phone"></i> 
                        <strong>Por favor, contacte al cliente antes de eliminar esta cita</strong> para informarle sobre la cancelación y, si es posible, ofrecerle una alternativa.
                    </p>
                </div>
            </div>

            <!-- Mensaje para citas disponibles -->
            <div class="confirm-info-box" id="confirmInfoBox" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <p>Esta cita está disponible y puede ser eliminada sin inconvenientes.</p>
            </div>

            <!-- Pregunta de confirmación -->
            <div class="confirm-question">
                <p><strong>¿Está seguro de que desea eliminar esta cita?</strong></p>
                <p style="color: #64748b; font-size: 0.875rem;">Esta acción no se puede deshacer.</p>
            </div>

            <!-- Botones de Acción -->
            <div class="modal-actions-confirm">
                <button type="button" class="btn-cancel-confirm" onclick="closeConfirmDeleteModal()">
                    <i class="fas fa-times"></i>
                    <span>Cancelar</span>
                </button>
                <button type="button" class="btn-confirm-delete" onclick="ejecutarEliminarCita()">
                    <i class="fas fa-trash"></i>
                    <span>Sí, Eliminar Cita</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Reagendar Cita -->
<div id="reagendarModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> Reagendar Cita</h3>
            <button class="modal-close" onclick="cerrarModalReagendar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Información de la Cita Actual -->
            <div class="reagendar-info-actual">
                <h4><i class="fas fa-info-circle"></i> Cita Actual</h4>
                <div class="info-actual-grid">
                    <div class="info-actual-item">
                        <span class="info-actual-label">Paciente:</span>
                        <span class="info-actual-value" id="reagendarPacienteNombre">-</span>
                    </div>
                    <div class="info-actual-item">
                        <span class="info-actual-label">Fecha/Hora Actual:</span>
                        <span class="info-actual-value" id="reagendarFechaHoraActual">-</span>
                    </div>
                    <div class="info-actual-item">
                        <span class="info-actual-label">Dentista:</span>
                        <span class="info-actual-value" id="reagendarDentistaActual">-</span>
                    </div>
                </div>
            </div>

            <form id="reagendarForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="reagendarCitaId" name="cita_id">
                
                <!-- Nueva Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label" for="reagendarNuevaFechaHora">
                        <i class="fas fa-calendar-day"></i>
                        Nueva Fecha y Hora <span style="color: #ef4444;">*</span>
                    </label>
                    <input type="datetime-local" 
                           id="reagendarNuevaFechaHora" 
                           name="nueva_fecha_hora" 
                           class="form-control-modal" 
                           required>
                    <small class="form-help-text">Seleccione la nueva fecha y hora para la cita</small>
                </div>

                <!-- Nuevo Dentista (Opcional) -->
                <div class="form-group-modal">
                    <label class="form-label" for="reagendarNuevoDentista">
                        <i class="fas fa-user-md"></i>
                        Cambiar Dentista (Opcional)
                    </label>
                    <select id="reagendarNuevoDentista" name="nuevo_dentista" class="form-control-modal">
                        <option value="">Mantener dentista actual</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-help-text">Deje en blanco para mantener el dentista actual</small>
                </div>

                <!-- Botones de Acción -->
                <div class="modal-actions">
                    <button type="submit" class="btn-modal-primary">
                        <i class="fas fa-check"></i>
                        Confirmar Reagendamiento
                    </button>
                    <button type="button" class="btn-modal-secondary" onclick="cerrarModalReagendar()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Editar Cita -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Cita</h3>
            <button class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editForm" method="post" action="">
                {% csrf_token %}
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Fecha y Hora
                    </label>
                    <input type="datetime-local" name="fecha_hora" id="editFechaHora" required class="form-control-modal">
                </div>
                
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select name="tipo_consulta" id="editTipoConsulta" class="form-control-modal">
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea name="notas" id="editNotas" rows="3" class="form-control-modal" placeholder="Información adicional sobre la consulta..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalles de Cita -->
<div id="appointmentModal" class="modal-overlay">
    <div class="modal-content appointment-details-modal">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Detalles de la Cita</h3>
            <button class="modal-close" onclick="closeAppointmentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="appointment-details">
                <div class="detail-section">
                    <div class="detail-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div class="detail-content">
                            <label>Fecha y Hora</label>
                            <span id="appointmentDateTime"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-tooth"></i>
                        <div class="detail-content">
                            <label>Tipo de Consulta</label>
                            <span id="appointmentType"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-user"></i>
                        <div class="detail-content">
                            <label>Paciente</label>
                            <span id="appointmentPatient"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="detail-content">
                            <label>Estado</label>
                            <span id="appointmentStatus" class="status-badge"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item full-width">
                        <i class="fas fa-sticky-note"></i>
                        <div class="detail-content">
                            <label>Notas</label>
                            <span id="appointmentNotes"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeAppointmentModal()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
                <button type="button" class="btn-primary" id="editAppointmentBtn" onclick="editAppointmentFromCalendar()">
                    <i class="fas fa-edit"></i>
                    Editar Cita
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Contenedor Principal */
    .layout-container {
        width: 100%;
        overflow-x: hidden;
    }

    /* Layout Estilo Despegar */
    .despegar-layout {
        display: flex;
        gap: 0;
        min-height: calc(100vh - 140px);
        background: #f8fafc;
        width: 100%;
        position: relative;
    }

    /* Header con acciones (tabs + botón agregar) */
    .content-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .btn-add-cita {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        white-space: nowrap;
    }

    .btn-add-cita:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
    }

    .btn-add-cita:active {
        transform: translateY(0);
    }

    .btn-add-cita i {
        font-size: 1rem;
    }

    /* Estilos para checkbox moderno */
    .checkbox-label-modern {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        color: #374151;
        font-size: 0.9375rem;
    }

    .checkbox-label-modern:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .checkbox-label-modern input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .checkbox-label-modern span {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-label-modern i {
        color: var(--primary-color);
    }

    /* Sección de cliente */
    .cliente-options-section {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-top: 12px;
    }

    .cliente-options-section h4 {
        margin: 0 0 16px 0;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .cliente-options-section h4 i {
        color: var(--primary-color);
    }

    .divider-option {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }

    .divider-option::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background: #e2e8f0;
    }

    .divider-option span {
        background: #f8fafc;
        padding: 0 16px;
        color: #6b7280;
        font-weight: 600;
        font-size: 0.875rem;
        position: relative;
    }

    /* Búsqueda de Cliente */
    .cliente-search-wrapper {
        position: relative;
    }

    .cliente-search-wrapper .search-icon {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .cliente-results-list {
        margin-top: 8px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        display: none;
    }

    .cliente-results-list.show {
        display: block;
    }

    .cliente-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .cliente-result-item:last-child {
        border-bottom: none;
    }

    .cliente-result-item:hover {
        background: var(--primary-bg);
        border-left: 3px solid var(--primary-color);
    }

    .cliente-result-item.selected {
        background: var(--primary-bg);
        border-left: 3px solid var(--primary-color);
    }

    .cliente-result-nombre {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.875rem;
    }

    .cliente-result-email {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .cliente-results-list.empty {
        padding: 20px;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .sidebar-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .section-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    /* Botones de Tipo de Cita */
    .trip-type-buttons {
        display: flex;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        overflow: hidden;
    }

    .trip-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: white;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .trip-btn:hover {
        background: #f3f4f6;
    }

    .trip-btn.active {
        background: var(--primary-color);
        color: white;
    }

    /* Form Info */
    .form-info {
        padding: 12px 16px;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }

    .form-info p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
        font-style: italic;
    }

    /* Inputs de Fecha */
    .date-input {
        position: relative;
        display: flex;
        align-items: center;
    }

    .date-input i {
        position: absolute;
        left: 12px;
        color: #6b7280;
        z-index: 1;
    }

    .date-input input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
    }

    .date-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Select Personalizado */
    .select-wrapper {
        position: relative;
    }

    .custom-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    .custom-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Textarea */
    textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        resize: vertical;
        font-family: inherit;
    }

    textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Botón de Búsqueda */
    .search-btn {
        width: 100%;
        padding: 16px 24px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .search-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Contenido Principal */
    .main-content-area {
        flex: 1;
        background: white;
        padding: 24px;
        min-width: 0;
        overflow-x: auto;
        position: relative;
        width: 100%;
    }

    /* Tabs de Resultados */
    .results-tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid #e2e8f0;
        flex: 1;
    }

    .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .tab-btn:hover {
        color: var(--primary-color);
    }

    .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* Filtros de Resultados */
    .results-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .alert-btn {
        padding: 8px 16px;
        border: 1px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .alert-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Tarjetas de Resultados */
    .citas-results {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        max-width: 100%;
    }

    /* ============================================
       ESTILOS PARA "CITAS DEL DÍA"
       ============================================ */
    
    /* Header de Citas del Día */
    .citas-dia-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
        flex-wrap: wrap;
        gap: 20px;
    }

    .citas-dia-title-section h3 {
        margin: 0 0 8px 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .citas-dia-title-section h3 i {
        color: var(--primary-color);
    }

    .citas-dia-subtitle {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
    }

    /* Estadísticas Mini */
    .citas-dia-stats {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }

    .stat-mini {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 20px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        min-width: 80px;
    }

    .stat-mini-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .stat-mini-pendientes .stat-mini-value {
        color: #f59e0b;
    }

    .stat-mini-completadas .stat-mini-value {
        color: #10b981;
    }

    /* Filtros Rápidos */
    .filtros-rapidos-dia {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        align-items: center;
        flex-wrap: nowrap;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        overflow-x: auto;
    }

    .filtro-rapido-btn {
        padding: 6px 12px;
        border: 2px solid #e2e8f0;
        background: white;
        color: #64748b;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .filtro-rapido-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: #eff6ff;
    }

    .filtro-rapido-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .filtro-dentista-dia {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        margin-left: auto;
    }

    .filtro-dentista-dia i {
        color: var(--primary-color);
    }

    .filtro-select-dia {
        border: none;
        background: transparent;
        color: #1e293b;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        outline: none;
    }

    /* Lista de Citas del Día */
    .citas-dia-lista {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* Tarjeta de Cita del Día */
    .cita-dia-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.2s ease;
        position: relative;
    }

    .cita-dia-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        transform: translateY(-2px);
    }

    /* Estados visuales de las tarjetas */
    .cita-dia-card.completada {
        background: #f0fdf4;
        border-color: #86efac;
    }

    .cita-dia-card.no-show {
        background: #fef2f2;
        border-color: #fecaca;
    }

    .cita-dia-card.pasada {
        background: #fffbeb;
        border-left: 4px solid #f59e0b;
    }

    .cita-dia-card.proxima {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
    }

    /* Hora de la Cita */
    .cita-dia-time {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 80px;
        gap: 8px;
    }

    .cita-dia-hora {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .cita-dia-indicador {
        font-size: 1.25rem;
    }

    /* Información de la Cita */
    .cita-dia-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cita-dia-paciente {
        font-size: 1rem;
        color: #1e293b;
    }

    .cita-dia-detalles {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #64748b;
    }

    .cita-dia-dentista,
    .cita-dia-servicio {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .cita-dia-dentista i,
    .cita-dia-servicio i {
        color: var(--primary-color);
    }

    /* Estado de la Cita */
    .cita-dia-estado {
        min-width: 120px;
    }

    .badge-estado-dia {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-estado-dia.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .badge-estado-dia.reservada {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado-dia.confirmada {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-estado-dia.completada {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-estado-dia.no-show {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Acciones Rápidas */
    .cita-dia-acciones {
        display: flex;
        gap: 8px;
        min-width: 120px;
        justify-content: flex-end;
    }

    .btn-accion-rapida {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: all 0.2s ease;
        color: white;
    }

    .btn-accion-rapida:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-accion-rapida.btn-completar {
        background: #10b981;
    }

    .btn-accion-rapida.btn-completar:hover {
        background: #059669;
    }

    .btn-accion-rapida.btn-no-show {
        background: #ef4444;
    }

    .btn-accion-rapida.btn-no-show:hover {
        background: #dc2626;
    }

    .btn-accion-rapida.btn-editar {
        background: var(--primary-color);
    }

    .btn-accion-rapida.btn-editar:hover {
        background: var(--primary-dark);
    }

    .btn-accion-rapida.btn-ver {
        background: #64748b;
    }

    .btn-accion-rapida.btn-ver:hover {
        background: #475569;
    }

    .btn-accion-rapida.btn-reagendar {
        background: #f59e0b;
    }

    .btn-accion-rapida.btn-reagendar:hover {
        background: #d97706;
    }

    .btn-accion-rapida.btn-llego {
        background: #10b981;
    }

    .btn-accion-rapida.btn-llego:hover {
        background: #059669;
    }

    .btn-accion-rapida.btn-no-llego {
        background: #ef4444;
    }

    .btn-accion-rapida.btn-no-llego:hover {
        background: #dc2626;
    }

    .cita-dia-card.en-espera {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
    }

    .cita-dia-card.listo-para-atender {
        border-left: 4px solid #10b981;
        background: linear-gradient(to right, #d1fae5 0%, #ffffff 10%);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .cita-dia-card.en-progreso {
        border-left: 4px solid #3b82f6;
        background: linear-gradient(to right, #dbeafe 0%, #ffffff 10%);
    }

    .cita-dia-card.finalizada {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(to right, #fef3c7 0%, #ffffff 10%);
    }

    .badge-estado-dia.en_espera {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }

    .badge-estado-dia.listo_para_atender {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
        font-weight: 600;
    }

    .badge-estado-dia.en_progreso {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
    }

    .badge-estado-dia.finalizada {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
        font-weight: 600;
    }

    .mensaje-destacado {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.875rem;
        animation: pulse 2s infinite;
    }

    .mensaje-listo {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
    }

    .mensaje-finalizada {
        background: #fef3c7;
        color: #92400e;
        border: 2px solid #f59e0b;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.8;
        }
    }

    .btn-accion-rapida.btn-listo {
        background: #10b981;
    }

    .btn-accion-rapida.btn-listo:hover {
        background: #059669;
    }

    .btn-accion-rapida.btn-iniciar {
        background: #3b82f6;
    }

    .btn-accion-rapida.btn-iniciar:hover {
        background: #2563eb;
    }

    .btn-accion-rapida.btn-finalizar {
        background: #f59e0b;
    }

    .btn-accion-rapida.btn-finalizar:hover {
        background: #d97706;
    }

    .btn-accion-rapida.btn-descargar-ficha {
        background: #dc2626;
    }

    .btn-accion-rapida.btn-descargar-ficha:hover {
        background: #b91c1c;
    }

    .btn-accion-rapida.btn-completar {
        background: #10b981;
    }

    .btn-accion-rapida.btn-completar:hover {
        background: #059669;
    }

    /* Estilos para Modal de Reagendar */
    .reagendar-info-actual {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
    }

    .reagendar-info-actual h4 {
        margin: 0 0 12px 0;
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reagendar-info-actual h4 i {
        color: var(--primary-color);
    }

    .info-actual-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .info-actual-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-actual-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-actual-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 600;
    }

    /* Estado Vacío */
    .citas-dia-vacia {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }

    .citas-dia-vacia i {
        font-size: 4rem;
        color: #cbd5e1;
        margin-bottom: 16px;
    }

    .citas-dia-vacia h4 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 1.25rem;
    }

    .citas-dia-vacia p {
        margin: 0;
        font-size: 0.875rem;
    }

    /* Alertas */
    .alerta {
        padding: 16px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideInRight 0.3s ease;
    }

    .alerta-success {
        background: #d1fae5;
        border: 2px solid #10b981;
        color: #065f46;
    }

    .alerta-error {
        background: #fee2e2;
        border: 2px solid #ef4444;
        color: #991b1b;
    }

    .alerta i {
        font-size: 1.25rem;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .citas-dia-header {
            flex-direction: column;
        }

        .cita-dia-card {
            flex-wrap: wrap;
        }

        .cita-dia-acciones {
            width: 100%;
            justify-content: flex-start;
        }

        #alertas-container {
            left: 10px;
            right: 10px;
            max-width: none;
        }
    }

    .cita-result-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.2s ease;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .cita-result-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .cita-result-card.disponible {
        border-left: 4px solid #10b981;
    }

    .cita-result-card.tomada {
        border-left: 4px solid #f59e0b;
    }

    /* Nueva estructura de citas */
    .cita-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cita-fecha-hora {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .cita-fecha,
    .cita-hora {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .cita-tipo {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #374151;
        font-weight: 500;
    }

    .cita-estado {
        min-width: 120px;
        display: flex;
        justify-content: center;
    }

    .estado-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .estado-badge.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .estado-badge.reservada {
        background: #dbeafe;
        color: #1e40af;
    }


    .estado-badge.completada {
        background: #fef3c7;
        color: #92400e;
    }

    .cita-paciente {
        min-width: 150px;
        display: flex;
        justify-content: center;
    }

    .paciente-info {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .paciente-info span {
        font-weight: 500;
        color: #374151;
    }

    /* Información de Aerolínea/Clínica */
    .cita-airline {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 200px;
    }

    .airline-logo {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .airline-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .airline-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.875rem;
    }

    .rating-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .rating-badge.good {
        background: #dcfce7;
        color: #166534;
    }

    .rating-badge.excellent {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Detalles de la Cita */
    .cita-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cita-route {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .route-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .time {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .date {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .route-line {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        flex: 1;
    }

    .line {
        width: 100%;
        height: 2px;
        background: #d1d5db;
        position: relative;
    }

    .line::after {
        content: '';
        position: absolute;
        right: 0;
        top: -3px;
        width: 0;
        height: 0;
        border-left: 6px solid #d1d5db;
        border-top: 4px solid transparent;
        border-bottom: 4px solid transparent;
    }

    .duration {
        font-size: 0.75rem;
        color: #6b7280;
        background: #f8fafc;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .cita-type {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .cita-patient {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* Precio y Acciones */
    .cita-price {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-width: 120px;
    }

    .price-main {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .price-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .cita-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 120px;
    }

    /* Títulos de sección */
    .section-title {
        margin: 24px 0 16px 0;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .section-title h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
    }

    /* Información del dentista */
    .dentista-info {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 6px 12px;
        background: #f1f5f9;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #475569;
    }

    .dentista-info i {
        color: var(--primary-color);
        font-size: 0.875rem;
    }

    /* Modal de Opciones - Usar mismo estilo que modal de editar */
    .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }

    .form-actions .btn {
        flex: 1;
        min-width: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .form-actions .btn i {
        font-size: 1rem;
    }

    .form-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .form-actions .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .form-actions .btn-primary:hover {
        background: var(--primary-dark);
    }

    .form-actions .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .form-actions .btn-secondary:hover {
        background: #4b5563;
    }

    .form-actions .btn-success {
        background: #10b981;
        color: white;
    }

    .form-actions .btn-success:hover {
        background: #059669;
    }

    .form-actions .btn-info {
        background: #06b6d4;
        color: white;
    }

    .form-actions .btn-info:hover {
        background: #0891b2;
    }

    .form-actions .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .form-actions .btn-warning:hover {
        background: #d97706;
    }

    .form-actions .btn-danger {
        background: #ef4444;
        color: white;
    }

    .form-actions .btn-danger:hover {
        background: #dc2626;
    }


    .option-btn.info {
        color: #0891b2;
        border-color: #cffafe;
    }

    .option-btn.info:hover {
        background: #f0f9ff;
        border-color: #0891b2;
    }

    .option-btn.danger {
        color: #dc2626;
        border-color: #fee2e2;
    }

    .option-btn.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
    }

    .action-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .action-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.primary:hover {
        background: var(--primary-dark);
    }

    .action-btn.success {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.success:hover {
        background: var(--primary-dark);
    }

    .action-btn.danger {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.danger:hover {
        background: var(--primary-dark);
    }

    .action-btn.secondary {
        background: #f8fafc;
        color: #6b7280;
        border-color: #e2e8f0;
    }

    /* Estado Vacío */
    .empty-results {
        text-align: center;
        padding: 48px 24px;
        color: #6b7280;
    }

    .empty-results i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-results h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
    }

    .empty-results p {
        font-size: 0.875rem;
        margin: 0;
    }

    /* Stats */
    .stats { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 15px 0; 
    }

    .stats-horizontal {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    
    .stat-box { 
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white; 
        padding: 16px; 
        border-radius: 8px; 
        text-align: center; 
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }
    
    .stat-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    
    .stat-box h3 { 
        margin: 0 0 4px 0; 
        font-size: 1.8rem; 
        font-weight: 700;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-box p { 
        margin: 0; 
        font-size: 0.75rem; 
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-container,
    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }
    
    /* Modal Simple Styles */
    .modal-container-simple {
        background: white;
        border-radius: 16px;
        max-width: 450px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }
    
    .modal-large {
        max-width: 900px;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cita-info-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 500;
        text-align: right;
    }
    
    .modal-actions-simple {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    .btn-action-completar,
    .btn-action-cancelar {
        flex: 1;
        padding: 14px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        text-decoration: none;
        color: white;
    }
    
    .btn-action-completar {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .btn-action-completar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-action-cancelar {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .btn-action-cancelar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .modal-body {
        padding: 24px;
    }

    .form-group,
    .form-group-modal {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group-modal label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea,
    .form-control-modal {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus,
    .form-control-modal:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    select.form-control-modal,
    select.form-select {
        cursor: pointer;
    }

    .modal-actions,
    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-secondary {
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary:hover {
        background: #f1f5f9;
        color: #475569;
        border-color: #cbd5e1;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        background: var(--primary-darker, #2563eb);
        border-color: var(--primary-darker, #2563eb);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }


    /* Appointment Details Modal */
    .appointment-details-modal {
        max-width: 600px;
    }

    .appointment-details {
        margin-bottom: 20px;
    }

    .detail-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }

    .detail-item.full-width {
        flex-direction: column;
        gap: 8px;
    }

    .detail-item i {
        color: #3b82f6;
        font-size: 1.1rem;
        margin-top: 2px;
        min-width: 20px;
    }

    .detail-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-content label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-content span {
        color: #1f2937;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.reservada {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-badge.confirmada {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-badge.completada {
        background: #fef3c7;
        color: #92400e;
    }

    /* Calendar Event Styling */
    .fc-event {
        border-radius: 6px !important;
        border: none !important;
        font-weight: 500 !important;
        font-size: 0.8rem !important;
        padding: 2px 6px !important;
    }

    .fc-event-title {
        font-weight: 600 !important;
    }

    .fc-daygrid-event {
        margin: 1px 0 !important;
    }

    .fc-timegrid-event {
        border-radius: 4px !important;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .content-header-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .results-tabs {
            width: 100%;
        }

        .btn-add-cita {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .cita-result-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        
        .cita-airline {
            min-width: auto;
            width: 100%;
        }
        
        .cita-route {
            width: 100%;
            justify-content: space-between;
        }
        
        .cita-actions {
            width: 100%;
            flex-direction: row;
        }
        
        .results-filters {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .modal-container {
            width: 95%;
            max-width: 400px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-actions {
            flex-direction: column;
            gap: 8px;
        }
        
        .modal-actions .btn {
            width: 100%;
        }
    }

    /* ========== ESTILOS MODERNOS - FORMULARIO ========== */
    .sidebar-header-modern {
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f1f5f9;
    }

    .header-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .header-icon i {
        font-size: 1.5rem;
        color: white;
    }

    .header-text h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .header-text p {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }

    .search-form-modern {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .form-group-modern {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .label-modern {
        font-size: 0.875rem;
        font-weight: 600;
        color: #334155;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .label-modern i {
        color: var(--primary-color);
        font-size: 1rem;
    }

    .required-badge {
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
    }

    .input-wrapper-modern {
        position: relative;
    }

    .input-modern,
    .select-modern,
    .textarea-modern {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        color: #334155;
        background: white;
        transition: all 0.2s ease;
    }

    .input-modern:focus,
    .select-modern:focus,
    .textarea-modern:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .select-modern {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 40px;
    }

    .textarea-modern {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }

    .hint-text {
        font-size: 0.75rem;
        color: #94a3b8;
        font-style: italic;
    }

    .btn-submit-modern {
        width: 100%;
        padding: 14px 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        margin-top: 8px;
    }

    .btn-submit-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-submit-modern:active {
        transform: translateY(0);
    }

    /* ========== ESTILOS MODERNOS - TABLA DE CITAS ========== */
    .section-title-modern {
        margin-bottom: 20px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-left: 4px solid var(--primary-color);
        border-radius: 8px;
    }

    .section-title-modern h3 {
        margin: 0 0 4px 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title-modern h3 i {
        color: var(--primary-color);
    }

    .section-title-modern p {
        margin: 0;
        font-size: 0.875rem;
        color: #64748b;
    }

    /* Estilos para Filtros de Búsqueda */
    .filtros-busqueda {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
        padding: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        align-items: center;
    }

    .filtro-group {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .filtro-group i {
        color: #64748b;
        font-size: 0.875rem;
        position: absolute;
        left: 12px;
        z-index: 1;
    }

    .filtro-input,
    .filtro-select {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s ease;
    }

    .filtro-input:focus,
    .filtro-select:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-aplicar-filtros {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: var(--primary-color);
        color: white;
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-aplicar-filtros:hover {
        background: var(--primary-dark, var(--primary-color));
        border-color: var(--primary-dark, var(--primary-color));
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .btn-aplicar-filtros:active {
        transform: translateY(0);
    }

    .btn-limpiar-filtros {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: #f1f5f9;
        color: #475569;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-limpiar-filtros:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: #334155;
    }

    .fila-cita[style*="display: none"] {
        display: none !important;
    }

    .cita-result-card[style*="display: none"] {
        display: none !important;
    }

    .tabla-citas-wrapper {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .tabla-citas {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    
    /* Anchos específicos para cada columna */
    .tabla-citas .col-fecha { width: 12%; }
    .tabla-citas .col-hora { width: 10%; }
    .tabla-citas .col-tipo { width: 15%; }
    .tabla-citas .col-estado { width: 13%; }
    .tabla-citas .col-cliente { width: 20%; }
    .tabla-citas .col-dentista { width: 20%; }
    .tabla-citas .col-acciones { width: 10%; min-width: 80px; }

    .tabla-citas thead {
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
    }

    .tabla-citas thead th {
        padding: 16px 14px;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .tabla-citas thead th i {
        margin-right: 6px;
        opacity: 0.9;
    }

    .tabla-citas tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .tabla-citas tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.005);
    }

    .tabla-citas tbody td {
        padding: 16px 14px;
        font-size: 0.875rem;
        color: #334155;
        vertical-align: middle;
    }

    .col-fecha {
        font-weight: 600;
        color: #1e293b;
        white-space: nowrap;
    }

    .col-hora {
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    .col-tipo {
        color: #64748b;
    }

    .tipo-servicio-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #eff6ff;
        color: #1e40af;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .tipo-servicio-badge i {
        color: #3b82f6;
        font-size: 0.875rem;
    }

    .tipo-consulta-text {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #475569;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .tipo-consulta-text i {
        color: #64748b;
        font-size: 0.875rem;
    }

    .col-tipo .text-muted {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .col-tipo .text-muted i {
        color: #94a3b8;
        font-size: 0.875rem;
    }

    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .badge-estado.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .badge-estado.disponible i {
        color: #16a34a;
    }

    .badge-estado.reservada {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-estado.reservada i {
        color: #3b82f6;
    }

    .badge-estado.completada {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado.completada i {
        color: #f59e0b;
    }

    /* Badge para citas completadas (amarillo) */
    .badge-completada-estado {
        background: #fef3c7 !important;
        color: #92400e !important;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }

    .badge-completada-estado i {
        color: #f59e0b !important;
    }

    /* Badge para citas no asistidas (rojo) */
    .badge-no-asistida {
        background: #dc2626 !important;
        color: white !important;
        border: 2px solid #b91c1c;
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.4);
        font-weight: 700;
    }

    .badge-no-asistida i {
        color: white !important;
    }

    /* Badge para citas canceladas (gris) */
    .badge-cancelada-estado {
        background: #e5e7eb !important;
        color: #6b7280 !important;
        border: 2px solid #d1d5db;
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2);
        font-weight: 600;
    }

    .badge-cancelada-estado i {
        color: #6b7280 !important;
    }

    /* Estilo para fila de cita cancelada */
    .cita-cancelada-fila {
        opacity: 0.7;
        background: #f9fafb !important;
    }

    .cita-cancelada-fila:hover {
        background: #f3f4f6 !important;
    }

    /* Badge de estado en modal de editar */
    .badge-estado-modal {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-estado-modal.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .badge-estado-modal.disponible i {
        color: #16a34a;
    }

    .badge-estado-modal.reservada {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-estado-modal.reservada i {
        color: #3b82f6;
    }

    .badge-estado-modal.confirmada {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-estado-modal.confirmada i {
        color: #3b82f6;
    }

    .badge-estado-modal.en_espera {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }

    .badge-estado-modal.en_espera i {
        color: #f59e0b;
    }

    .badge-estado-modal.listo_para_atender {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .badge-estado-modal.listo_para_atender i {
        color: #10b981;
    }

    .badge-estado-modal.en_progreso {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
    }

    .badge-estado-modal.en_progreso i {
        color: #3b82f6;
    }

    .badge-estado-modal.finalizada {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }

    .badge-estado-modal.finalizada i {
        color: #f59e0b;
    }

    .badge-estado-modal.completada {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado-modal.completada i {
        color: #f59e0b;
    }

    .badge-estado-modal.no_show {
        background: #dc2626;
        color: white;
        border: 2px solid #b91c1c;
    }

    .badge-estado-modal.no_show i {
        color: white;
    }

    .badge-estado-modal.cancelada {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #cbd5e1;
    }

    .badge-estado-modal.cancelada i {
        color: #94a3b8;
    }

    /* Estilos para filas de citas no asistidas */
    .cita-no-llego-fila {
        background: #fef2f2 !important;
        border-left: 4px solid #dc2626;
    }

    .cita-no-llego-fila:hover {
        background: #fee2e2 !important;
    }

    .cita-no-llego-fila td {
        color: #991b1b;
        font-weight: 500;
    }

    .col-cliente,
    .col-dentista {
        max-width: 200px;
    }

    .cliente-info-compact,
    .dentista-info-compact {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .cliente-info-compact i,
    .dentista-info-compact i {
        color: #3b82f6;
        font-size: 0.875rem;
    }

    .text-muted {
        color: #94a3b8;
        font-style: italic;
        font-size: 0.75rem;
    }

    .col-acciones {
        text-align: center;
        padding: 8px !important;
    }

    .btn-accion {
        padding: 8px 12px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        min-width: 40px;
        min-height: 40px;
    }

    .btn-accion:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .empty-results-modern {
        text-align: center;
        padding: 60px 24px;
        background: white;
        border-radius: 12px;
        border: 2px dashed #e2e8f0;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .empty-icon i {
        font-size: 2.5rem;
        color: #94a3b8;
    }

    .empty-results-modern h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #334155;
        margin: 0 0 8px 0;
    }

    .empty-results-modern p {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }

    /* Responsive para tabla */
    @media (max-width: 1200px) {
        .tabla-citas {
            font-size: 0.8rem;
        }

        .tabla-citas thead th,
        .tabla-citas tbody td {
            padding: 12px 10px;
        }
    }

    /* ========== MODAL DE EDICIÓN MEJORADO ========== */
    .modal-actions-edit {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-save-edit {
        flex: 1;
        padding: 12px 20px;
        background: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-save-edit:hover {
        background: var(--primary-darker, #2563eb);
        border-color: var(--primary-darker, #2563eb);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-save-edit:active {
        transform: translateY(0);
    }

    .btn-delete-edit {
        padding: 12px 20px;
        background: white;
        color: #ef4444;
        border: 1px solid #ef4444;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-delete-edit:hover {
        background: #ef4444;
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        transform: translateY(-1px);
    }

    .btn-delete-edit:active {
        transform: translateY(0);
    }

    /* ========== MODAL DE CONFIRMACIÓN DE ELIMINACIÓN ========== */
    .modal-confirm {
        max-width: 600px;
    }

    .modal-header-warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-bottom: 2px solid #f59e0b;
    }

    .modal-header-warning h3 {
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-header-warning h3 i {
        color: #f59e0b;
        font-size: 1.5rem;
    }

    .confirm-status-box {
        background: #f1f5f9;
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .confirm-status-box i {
        color: #3b82f6;
        font-size: 1.25rem;
        margin-top: 2px;
    }

    .confirm-status-box strong {
        color: #1e293b;
        font-weight: 600;
    }

    .confirm-status-box span {
        color: #64748b;
        font-weight: 500;
    }

    .confirm-warning-box {
        background: #fef2f2;
        border: 2px solid #fca5a5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
    }

    .confirm-warning-box i {
        color: #dc2626;
        font-size: 1.5rem;
        margin-right: 12px;
        float: left;
    }

    .confirm-warning-box strong {
        color: #991b1b;
        font-size: 1rem;
    }

    .confirm-warning-box p {
        color: #7f1d1d;
        margin: 8px 0;
        line-height: 1.6;
    }

    .confirm-warning-box ul {
        margin: 12px 0;
        padding-left: 20px;
        color: #7f1d1d;
    }

    .confirm-warning-box li {
        margin: 6px 0;
    }

    .confirm-info-box {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .confirm-info-box i {
        color: #10b981;
        font-size: 1.25rem;
    }

    .confirm-info-box p {
        color: #166534;
        margin: 0;
        font-weight: 500;
    }

    .confirm-question {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
        text-align: center;
    }

    .confirm-question p:first-child {
        color: #1e293b;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .modal-actions-confirm {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-cancel-confirm {
        padding: 12px 24px;
        background: white;
        color: #64748b;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-cancel-confirm:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #475569;
    }

    .btn-confirm-delete {
        padding: 12px 24px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-confirm-delete:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        transform: translateY(-1px);
    }

    .btn-confirm-delete:active {
        transform: translateY(0);
    }
    /* Estilos de Paginación */
    .pagination {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .pagination-info {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }
    
    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .page-btn {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        font-size: 0.875rem;
    }
    
    .page-btn:hover:not(.disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .page-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f9fafb;
    }
    
    .page-current {
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
    }
    
    @media (max-width: 768px) {
        .pagination {
            flex-direction: column;
            text-align: center;
        }
        
        .pagination-info {
            width: 100%;
        }
    }
</style>

<!-- FullCalendar CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/locales/es.global.min.js"></script>

<script>
// Sistema de Notificaciones Moderno
function showNotification(type, message, duration = 5000) {
    // Tipos válidos: success, error, warning, info
    const validTypes = ['success', 'error', 'warning', 'info'];
    type = validTypes.includes(type) ? type : 'info';
    
    // Obtener o crear contenedor
    let container = document.getElementById('notificationContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.className = 'notification-container';
        document.body.appendChild(container);
    }
    
    // Crear notificación
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // Iconos según tipo
    const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error: '<i class="fas fa-exclamation-circle"></i>',
        warning: '<i class="fas fa-exclamation-triangle"></i>',
        info: '<i class="fas fa-info-circle"></i>'
    };
    
    // Títulos según tipo
    const titles = {
        success: 'Éxito',
        error: 'Error',
        warning: 'Advertencia',
        info: 'Información'
    };
    
    notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
            <div class="notification-title">${titles[type]}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.closest('.notification').remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Agregar al contenedor
    container.appendChild(notification);
    
    // Auto-remover después de la duración
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('hiding');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, duration);
    }
    
    return notification;
}

// Variables globales
var citasDataMap = {};
var currentCitaData = null;

// Función para búsqueda de clientes en el formulario de editar cita
window.searchClientesForEdit = function(searchTerm, clienteSelect, clienteResults, clienteIdInput, clienteSelectedDiv, clienteSelectedName, clienteSelectedEmail) {
    if (!clienteSelect || !clienteResults) return;
    
    searchTerm = (searchTerm || '').toLowerCase().trim();
    clienteResults.innerHTML = '';
    
    if (searchTerm.length === 0) {
        clienteResults.style.display = 'none';
        if (clienteIdInput) clienteIdInput.value = '';
        return;
    }
    
    var matches = [];
    var options = clienteSelect.getElementsByTagName('option');
    
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (!option.value || option.value === '' || option.disabled) continue;
        
        var nombre = option.getAttribute('data-nombre') || '';
        var email = option.getAttribute('data-email') || '';
        
        if (!nombre && !email) {
            var optionText = option.textContent || option.innerText || '';
            var parts = optionText.split(' - ');
            if (parts.length >= 2) {
                nombre = parts[0].trim();
                email = parts[1].trim();
            } else if (parts.length === 1) {
                nombre = parts[0].trim();
            }
        }
        
        var nombreMatch = nombre && nombre.toLowerCase().includes(searchTerm);
        var emailMatch = email && email.toLowerCase().includes(searchTerm);
        
        if (nombreMatch || emailMatch) {
            matches.push({
                id: option.value,
                nombre: nombre || 'Sin nombre',
                email: email || 'Sin email',
                telefono: option.getAttribute('data-telefono') || ''
            });
        }
    }
    
    if (matches.length === 0) {
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'cliente-results-list empty';
        emptyDiv.textContent = 'No se encontraron clientes';
        clienteResults.appendChild(emptyDiv);
        clienteResults.style.display = 'block';
        return;
    }
    
    var maxResults = Math.min(matches.length, 8);
    for (var j = 0; j < maxResults; j++) {
        var match = matches[j];
        var item = document.createElement('div');
        item.className = 'cliente-result-item';
        item.setAttribute('data-id', match.id);
        item.innerHTML = '<div class="cliente-result-nombre">' + match.nombre + '</div>' +
                        '<div class="cliente-result-email">' + match.email + '</div>';
        
        item.addEventListener('click', function() {
            var clienteId = this.getAttribute('data-id');
            if (clienteIdInput) clienteIdInput.value = clienteId;
            
            var nombre = this.querySelector('.cliente-result-nombre').textContent;
            var email = this.querySelector('.cliente-result-email').textContent;
            
            if (clienteSelectedName) clienteSelectedName.textContent = nombre;
            if (clienteSelectedEmail) clienteSelectedEmail.textContent = email;
            if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'block';
            
            var searchInput = document.getElementById('optionsClienteSearch');
            if (searchInput) {
                searchInput.value = '';
                searchInput.style.display = 'none';
            }
            
            clienteResults.style.display = 'none';
        });
        
        clienteResults.appendChild(item);
    }
    
    clienteResults.style.display = 'block';
};

// Función para actualizar el badge de estado
function updateEstadoBadge(badgeElement, estado) {
    if (!badgeElement) return;
    
    // Mapeo de estados a iconos y textos
    var estadoConfig = {
        'disponible': { icon: 'fa-circle', text: 'Disponible', class: 'disponible' },
        'reservada': { icon: 'fa-calendar-check', text: 'Reservada', class: 'reservada' },
        'confirmada': { icon: 'fa-check', text: 'Confirmada', class: 'confirmada' },
        'en_espera': { icon: 'fa-hourglass-half', text: 'En Espera', class: 'en_espera' },
        'listo_para_atender': { icon: 'fa-check-circle', text: 'Listo para Atender', class: 'listo_para_atender' },
        'en_progreso': { icon: 'fa-user-md', text: 'En Progreso', class: 'en_progreso' },
        'finalizada': { icon: 'fa-check-double', text: 'Finalizada', class: 'finalizada' },
        'completada': { icon: 'fa-check-double', text: 'Completada', class: 'completada' },
        'no_show': { icon: 'fa-user-times', text: 'No Llegó', class: 'no_show' },
        'cancelada': { icon: 'fa-times-circle', text: 'Cancelada', class: 'cancelada' }
    };
    
    var config = estadoConfig[estado] || { icon: 'fa-circle', text: estado, class: estado };
    
    // Limpiar clases anteriores
    badgeElement.className = 'badge-estado-modal ' + config.class;
    
    // Actualizar contenido
    badgeElement.innerHTML = '<i class="fas ' + config.icon + '"></i> ' + config.text;
}

// Función para limpiar la selección de cliente
window.clearClienteSelection = function() {
    var clienteIdInput = document.getElementById('optionsClienteId');
    var clienteSelectedDiv = document.getElementById('optionsClienteSelected');
    var clienteSearchInput = document.getElementById('optionsClienteSearch');
    var clienteResults = document.getElementById('optionsClienteResults');
    
    if (clienteIdInput) clienteIdInput.value = '';
    if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'none';
    if (clienteSearchInput) {
        clienteSearchInput.value = '';
        clienteSearchInput.style.display = 'block';
    }
    if (clienteResults) clienteResults.style.display = 'none';
};

// Funciones globales para búsqueda de clientes (definidas antes de DOMContentLoaded)
window.searchClientes = function() {
    var searchInput = document.getElementById('clienteSearchInput');
    var clienteSelect = document.getElementById('clienteSelect');
    var resultsList = document.getElementById('clienteResults');
    var clienteIdInput = document.getElementById('clienteIdInput');
    
    if (!searchInput || !clienteSelect || !resultsList) {
        console.error('Elementos de búsqueda no encontrados:', {
            searchInput: !!searchInput,
            clienteSelect: !!clienteSelect,
            resultsList: !!resultsList
        });
        return;
    }
    
    var searchTerm = searchInput.value.toLowerCase().trim();
    resultsList.innerHTML = '';
    
    if (searchTerm.length === 0) {
        resultsList.classList.remove('show');
        if (clienteIdInput) clienteIdInput.value = '';
        return;
    }
    
    var matches = [];
    var options = clienteSelect.getElementsByTagName('option');
    
    console.log('Buscando "' + searchTerm + '" en', options.length, 'opciones');
    
    // Verificar que hay opciones
    if (options.length === 0 || (options.length === 1 && options[0].value === '')) {
        console.warn('No hay opciones de clientes disponibles en el select');
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'cliente-results-list empty';
        emptyDiv.textContent = 'No hay clientes disponibles';
        resultsList.appendChild(emptyDiv);
        resultsList.classList.add('show');
        return;
    }
    
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (!option.value || option.value === '' || option.disabled) continue;
        
        var nombre = option.getAttribute('data-nombre') || '';
        var email = option.getAttribute('data-email') || '';
        
        // Si no hay data attributes, intentar extraer del texto del option
        if (!nombre && !email) {
            var optionText = option.textContent || option.innerText || '';
            var parts = optionText.split(' - ');
            if (parts.length >= 2) {
                nombre = parts[0].trim();
                email = parts[1].trim();
            } else if (parts.length === 1) {
                nombre = parts[0].trim();
            }
        }
        
        // Buscar en nombre o email
        var nombreMatch = nombre && nombre.toLowerCase().includes(searchTerm);
        var emailMatch = email && email.toLowerCase().includes(searchTerm);
        
        if (nombreMatch || emailMatch) {
            matches.push({
                id: option.value,
                nombre: nombre || 'Sin nombre',
                email: email || 'Sin email',
                telefono: option.getAttribute('data-telefono') || ''
            });
        }
    }
    
    console.log('Encontrados', matches.length, 'coincidencias');
    
    if (matches.length === 0) {
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'cliente-results-list empty';
        emptyDiv.textContent = 'No se encontraron clientes';
        resultsList.appendChild(emptyDiv);
        resultsList.classList.add('show');
        return;
    }
    
    // Mostrar máximo 8 resultados
    var maxResults = Math.min(matches.length, 8);
    for (var j = 0; j < maxResults; j++) {
        var match = matches[j];
        var item = document.createElement('div');
        item.className = 'cliente-result-item';
        item.setAttribute('data-id', match.id);
        item.innerHTML = '<div class="cliente-result-nombre">' + match.nombre + '</div>' +
                        '<div class="cliente-result-email">' + match.email + '</div>';
        
        item.addEventListener('click', function() {
            var clienteId = this.getAttribute('data-id');
            if (clienteIdInput) clienteIdInput.value = clienteId;
            
            // Actualizar input con el nombre seleccionado
            var nombre = this.querySelector('.cliente-result-nombre').textContent;
            var email = this.querySelector('.cliente-result-email').textContent;
            if (searchInput) {
                searchInput.value = nombre + ' - ' + email;
            }
            
            // Marcar como seleccionado
            var items = resultsList.querySelectorAll('.cliente-result-item');
            items.forEach(function(item) {
                item.classList.remove('selected');
            });
            this.classList.add('selected');
            
            // Ocultar resultados después de un breve delay
            setTimeout(function() {
                resultsList.classList.remove('show');
            }, 200);
        });
        
        resultsList.appendChild(item);
    }
    
    resultsList.classList.add('show');
};

window.initClienteSearch = function() {
    var searchInput = document.getElementById('clienteSearchInput');
    if (!searchInput) {
        console.log('clienteSearchInput no encontrado al inicializar');
        return;
    }
    
    // Remover event listeners anteriores usando un flag
    if (searchInput.hasAttribute('data-search-initialized')) {
        return; // Ya está inicializado
    }
    
    searchInput.setAttribute('data-search-initialized', 'true');
    
    // Agregar event listener para búsqueda en tiempo real
    searchInput.addEventListener('input', function(e) {
        e.stopPropagation();
        // Llamar después de un pequeño delay para evitar búsquedas mientras se escribe
        var input = this;
        clearTimeout(input.searchTimeout);
        input.searchTimeout = setTimeout(function() {
            searchClientes();
        }, 150);
    }, false);
    
    // Manejar teclas especiales
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var resultsList = document.getElementById('clienteResults');
            if (resultsList) {
                resultsList.classList.remove('show');
            }
        }
    }, false);
    
    // Ocultar resultados al hacer clic fuera (solo una vez)
    if (!window.clienteSearchClickHandler) {
        window.clienteSearchClickHandler = function(e) {
            var resultsList = document.getElementById('clienteResults');
            var searchInput = document.getElementById('clienteSearchInput');
            if (resultsList && searchInput && !resultsList.contains(e.target) && e.target !== searchInput && !searchInput.contains(e.target)) {
                resultsList.classList.remove('show');
            }
        };
        document.addEventListener('click', window.clienteSearchClickHandler, true);
    }
};

// Funciones globales para el modal de agregar cita (definidas antes de DOMContentLoaded)
window.openAddCitaModal = function() {
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Limpiar el formulario
        var form = document.getElementById('formAgregarCitaModal');
        if (form) {
            form.reset();
        }
        
        // Establecer fecha mínima (hoy) en el campo de fecha
        var fechaInput = document.getElementById('addCitaFechaHora');
        if (fechaInput) {
            var ahora = new Date();
            // Ajustar al timezone local y formatear para datetime-local (YYYY-MM-DDTHH:mm)
            var año = ahora.getFullYear();
            var mes = String(ahora.getMonth() + 1).padStart(2, '0');
            var dia = String(ahora.getDate()).padStart(2, '0');
            var hora = String(ahora.getHours()).padStart(2, '0');
            var minuto = String(ahora.getMinutes()).padStart(2, '0');
            var fechaMinima = año + '-' + mes + '-' + dia + 'T' + hora + ':' + minuto;
            fechaInput.setAttribute('min', fechaMinima);
        }
        
        // Limpiar validación de horario cuando se abre el modal
        var dentistaSelect = document.getElementById('addCitaDentista');
        if (dentistaSelect) {
            dentistaSelect.value = '';
        }
        
        // Ocultar campos de cliente por defecto
        var clienteFields = document.getElementById('clienteFieldsContainer');
        var clienteCheck = document.getElementById('asignarClienteCheck');
        if (clienteFields) {
            clienteFields.style.display = 'none';
        }
        if (clienteCheck) {
            clienteCheck.checked = false;
        }
        
        // Resetear campos de cliente
        var searchInput = document.getElementById('clienteSearchInput');
        var clienteSelect = document.getElementById('clienteSelect');
        var clienteIdInput = document.getElementById('clienteIdInput');
        var resultsList = document.getElementById('clienteResults');
        if (searchInput) {
            searchInput.value = '';
            searchInput.removeAttribute('data-search-initialized');
        }
        if (clienteSelect) {
            clienteSelect.value = '';
        }
        if (clienteIdInput) {
            clienteIdInput.value = '';
        }
        if (resultsList) {
            resultsList.innerHTML = '';
            resultsList.classList.remove('show');
        }
        
        // Inicializar búsqueda de clientes si el checkbox está marcado
        var clienteCheck = document.getElementById('asignarClienteCheck');
        if (clienteCheck && clienteCheck.checked) {
            setTimeout(function() {
                initClienteSearch();
            }, 100);
        }
        
        // Enfocar en el primer campo después de un pequeño delay
        setTimeout(function() {
            var fechaInput = document.getElementById('addCitaFechaHora');
            if (fechaInput) {
                fechaInput.focus();
            }
        }, 100);
    }
}

window.closeAddCitaModal = function() {
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        
        // Limpiar el formulario
        var form = document.getElementById('formAgregarCitaModal');
        if (form) {
            form.reset();
        }
        
        // Ocultar campos de cliente
        var clienteFields = document.getElementById('clienteFieldsContainer');
        var clienteCheck = document.getElementById('asignarClienteCheck');
        var searchInput = document.getElementById('clienteSearchInput');
        var clienteSelect = document.getElementById('clienteSelect');
        var clienteIdInput = document.getElementById('clienteIdInput');
        var resultsList = document.getElementById('clienteResults');
        if (clienteFields) {
            clienteFields.style.display = 'none';
        }
        if (clienteCheck) {
            clienteCheck.checked = false;
        }
        if (searchInput) {
            searchInput.value = '';
            searchInput.removeAttribute('data-search-initialized');
        }
        if (clienteSelect) {
            clienteSelect.value = '';
        }
        if (clienteIdInput) {
            clienteIdInput.value = '';
        }
        if (resultsList) {
            resultsList.innerHTML = '';
            resultsList.classList.remove('show');
        }
    }
}

// Función para mostrar/ocultar campos de cliente
window.toggleClienteFields = function() {
    var check = document.getElementById('asignarClienteCheck');
    var container = document.getElementById('clienteFieldsContainer');
    
    if (check && container) {
        if (check.checked) {
            container.style.display = 'block';
            // Inicializar búsqueda de clientes
            setTimeout(function() {
                initClienteSearch();
                var searchInput = document.getElementById('clienteSearchInput');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 100);
        } else {
            container.style.display = 'none';
            // Limpiar campos cuando se oculta
            var searchInput = document.getElementById('clienteSearchInput');
            var clienteSelect = document.getElementById('clienteSelect');
            var clienteIdInput = document.getElementById('clienteIdInput');
            var resultsList = document.getElementById('clienteResults');
            if (searchInput) searchInput.value = '';
            if (clienteSelect) clienteSelect.value = '';
            if (clienteIdInput) clienteIdInput.value = '';
            if (resultsList) {
                resultsList.innerHTML = '';
                resultsList.classList.remove('show');
            }
        }
    }
}

// Función para manejar selección de cliente
window.handleClienteSelect = function() {
    var clienteSelect = document.getElementById('clienteSelect');
    var clienteIdInput = document.getElementById('clienteIdInput');
    
    if (clienteSelect && clienteIdInput) {
        if (clienteSelect.value) {
            clienteIdInput.value = clienteSelect.value;
            // Actualizar el input de búsqueda con el nombre seleccionado
            var selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            var searchInput = document.getElementById('clienteSearchInput');
            if (searchInput && selectedOption) {
                searchInput.value = selectedOption.getAttribute('data-nombre') + ' - ' + selectedOption.getAttribute('data-email');
            }
            // Ocultar resultados
            var resultsList = document.getElementById('clienteResults');
            if (resultsList) {
                resultsList.classList.remove('show');
            }
        } else {
            clienteIdInput.value = '';
        }
    }
}


// Construir el mapa de datos de citas
{% for cita in citas_creadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{{ cita.tipo_consulta|default:""|escapejs }}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '',
    pacienteEmail: '',
    pacienteTelefono: '',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    precioCobrado: null,
    tipoServicioId: null,
    tipoServicioNombre: '',
    tipoServicioPrecio: null
};
{% endfor %}

{% for cita in citas_tomadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{{ cita.tipo_consulta|default:""|escapejs }}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '{{ cita.nombre_paciente|escapejs }}',
    pacienteEmail: '{{ cita.email_paciente|default:""|escapejs }}',
    pacienteTelefono: '{{ cita.telefono_paciente|default:""|escapejs }}',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    dentistaNombre: {% if cita.dentista %}'{{ cita.dentista.nombre_completo|escapejs }}'{% else %}''{% endif %},
    tieneFicha: {% if cita.tiene_ficha %}true{% else %}false{% endif %},
    odontogramaId: {% if cita.tiene_ficha and cita.odontograma %}{{ cita.odontograma.id }}{% else %}null{% endif %},
    motivoNoAsistencia: {% if cita.motivo_no_asistencia %}'{{ cita.motivo_no_asistencia|escapejs }}'{% else %}null{% endif %}
};
{% endfor %}

{% for cita in citas_completadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre|escapejs }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta|escapejs }}{% else %}No especificado{% endif %}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '{% if cita.cliente %}{{ cita.cliente.nombre_completo|escapejs }}{% elif cita.paciente_nombre %}{{ cita.paciente_nombre|escapejs }}{% else %}Sin asignar{% endif %}',
    pacienteEmail: '{% if cita.cliente and cita.cliente.email %}{{ cita.cliente.email|escapejs }}{% elif cita.paciente_email %}{{ cita.paciente_email|escapejs }}{% else %}{% endif %}',
    pacienteTelefono: '{% if cita.cliente and cita.cliente.telefono %}{{ cita.cliente.telefono|escapejs }}{% elif cita.paciente_telefono %}{{ cita.paciente_telefono|escapejs }}{% else %}{% endif %}',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    dentistaNombre: {% if cita.dentista %}'{{ cita.dentista.nombre_completo|escapejs }}'{% else %}''{% endif %},
    precioCobrado: {% if cita.precio_cobrado %}{{ cita.precio_cobrado|stringformat:"f" }}{% else %}null{% endif %},
    tipoServicioId: {% if cita.tipo_servicio %}{{ cita.tipo_servicio.id }}{% else %}null{% endif %},
    tipoServicioNombre: {% if cita.tipo_servicio %}'{{ cita.tipo_servicio.nombre|escapejs }}'{% else %}''{% endif %},
    tipoServicioPrecio: {% if cita.tipo_servicio %}{{ cita.tipo_servicio.precio_base|stringformat:"f" }}{% else %}null{% endif %},
    tieneFicha: {% if cita.tiene_ficha %}true{% else %}false{% endif %},
    odontogramaId: {% if cita.tiene_ficha and cita.odontograma %}{{ cita.odontograma.id }}{% else %}null{% endif %},
    motivoNoAsistencia: {% if cita.motivo_no_asistencia %}'{{ cita.motivo_no_asistencia|escapejs }}'{% else %}null{% endif %}
};
{% endfor %}

// Función global para abrir el modal de opciones
window.openOptionsModal = function(citaData) {
    try {
        console.log('openOptionsModal - Datos recibidos:', citaData);
        currentCitaData = citaData;
        
        var modal = document.getElementById('optionsModal');
        var form = document.getElementById('optionsForm');
        var infoReadonly = document.getElementById('optionsInfoReadonly');
        var modalTitle = document.getElementById('optionsModalTitle');
        
        if (!modal) {
            console.error('Modal #optionsModal no encontrado en el DOM');
            alert('Error: No se encontró el modal de edición');
            return;
        }
        
        // Si es una cita completada, no_show o cancelada, mostrar solo información y ajuste de precio
        if (citaData.estado === 'completada' || citaData.estado === 'no_show' || citaData.estado === 'cancelada') {
            if (!infoReadonly) {
                console.error('Div #optionsInfoReadonly no encontrado');
                return;
            }
            
            // Ocultar formulario de edición
            if (form) form.style.display = 'none';
            
            // Mostrar información de solo lectura
            infoReadonly.style.display = 'block';
            
            // Actualizar título del modal
            if (modalTitle) {
                if (citaData.estado === 'no_show') {
                    modalTitle.innerHTML = '<i class="fas fa-user-times"></i> Información de Cita - No Asistida';
                } else if (citaData.estado === 'cancelada') {
                    modalTitle.innerHTML = '<i class="fas fa-times-circle"></i> Información de Cita Cancelada';
                } else {
                    modalTitle.innerHTML = '<i class="fas fa-check-circle"></i> Información de Cita Completada';
                }
            }
            
            // Formatear fecha y hora
            var fecha = new Date(citaData.fechaHora);
            var fechaStr = fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            var horaStr = fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Llenar campos de solo lectura
            var fechaHoraReadonly = document.getElementById('optionsFechaHoraReadonly');
            var tipoReadonly = document.getElementById('optionsTipoReadonly');
            var dentistaReadonly = document.getElementById('optionsDentistaReadonly');
            var pacienteReadonly = document.getElementById('optionsPacienteReadonly');
            var precioReadonly = document.getElementById('optionsPrecioReadonly');
            var pacienteInfoReadonly = document.getElementById('pacienteInfoReadonly');
            var btnAjustarPrecio = document.getElementById('btnAjustarPrecio');
            
            if (fechaHoraReadonly) {
                fechaHoraReadonly.value = fechaStr + ' a las ' + horaStr;
            }
            
            if (tipoReadonly) {
                tipoReadonly.value = citaData.tipoConsulta || citaData.tipoServicioNombre || 'No especificado';
            }
            
            if (dentistaReadonly) {
                dentistaReadonly.value = citaData.dentistaNombre || 'Sin dentista asignado';
            }
            
            if (pacienteReadonly) {
                pacienteReadonly.value = citaData.paciente || 'Sin asignar';
            }
            
            if (pacienteInfoReadonly) {
                if (citaData.paciente && citaData.paciente !== '') {
                    pacienteInfoReadonly.style.display = 'block';
                } else {
                    pacienteInfoReadonly.style.display = 'none';
                }
            }
            
            // Mostrar motivo de no asistencia si existe
            var motivoNoAsistenciaReadonly = document.getElementById('motivoNoAsistenciaReadonly');
            var motivoNoAsistenciaContent = document.getElementById('optionsMotivoNoAsistenciaReadonly');
            if (citaData.estado === 'no_show' && citaData.motivoNoAsistencia) {
                if (motivoNoAsistenciaReadonly) motivoNoAsistenciaReadonly.style.display = 'block';
                if (motivoNoAsistenciaContent) {
                    motivoNoAsistenciaContent.textContent = citaData.motivoNoAsistencia;
                }
            } else {
                if (motivoNoAsistenciaReadonly) motivoNoAsistenciaReadonly.style.display = 'none';
            }
            
            // Mostrar precio con formato chileno
            if (precioReadonly) {
                var precio = citaData.precioCobrado;
                if (!precio && citaData.tipoServicioPrecio) {
                    precio = citaData.tipoServicioPrecio;
                }
                
                if (precio && precio !== null && precio !== 'null' && precio !== '') {
                    // Asegurar que precio sea un número válido
                    var precioNum = parseFloat(precio);
                    if (isNaN(precioNum) || precioNum <= 0) {
                        precioReadonly.value = 'No asignado';
                    } else {
                        // Formatear como pesos chilenos ($1.000)
                        var precioStr = Math.round(precioNum).toString();
                        var precioFormateado = '$' + precioStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        precioReadonly.value = precioFormateado;
                    }
                } else {
                    precioReadonly.value = 'No asignado';
                }
            }
            
            // Configurar botones según el estado
            var btnEliminarCancelada = document.getElementById('btnEliminarCitaCancelada');
            
            if (citaData.estado === 'cancelada' || citaData.estado === 'no_show') {
                // Para citas canceladas y no asistidas: mostrar botón eliminar, ocultar ajustar precio
                if (btnAjustarPrecio) {
                    btnAjustarPrecio.style.display = 'none';
                }
                if (btnEliminarCancelada) {
                    btnEliminarCancelada.style.display = 'inline-flex';
                }
            } else {
                // Para completadas: mostrar ajustar precio, ocultar eliminar
                if (btnAjustarPrecio) {
                    btnAjustarPrecio.href = '{% url "ajustar_precio_cita" 0 %}'.replace('0', citaData.id);
                    btnAjustarPrecio.style.display = 'inline-flex';
                }
                if (btnEliminarCancelada) {
                    btnEliminarCancelada.style.display = 'none';
                }
            }
            
        } else {
            // Para citas disponibles, mostrar formulario de edición
            if (!form) {
                console.error('Form #optionsForm no encontrado en el DOM');
                alert('Error: No se encontró el formulario');
                return;
            }
            
            // Ocultar información de solo lectura
            if (infoReadonly) infoReadonly.style.display = 'none';
            
            // Mostrar formulario de edición
            form.style.display = 'block';
            
            // Actualizar título del modal
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Cita';
            }
            
            console.log('Modal y formulario encontrados correctamente');
            
            // Configurar la acción del formulario
            form.action = '{% url 'editar_cita' 0 %}'.replace('0', citaData.id);
            
            // Llenar los campos del formulario
            var fechaHoraInput = document.getElementById('optionsFechaHora');
            var tipoInput = document.getElementById('optionsTipo');
            var dentistaInput = document.getElementById('optionsDentista');
            var estadoInput = document.getElementById('optionsEstado');
            var estadoBadge = document.getElementById('optionsEstadoBadge');
            var notasInput = document.getElementById('optionsNotas');
            
            if (fechaHoraInput) fechaHoraInput.value = citaData.fechaHora;
            if (tipoInput) tipoInput.value = citaData.tipoConsulta || '';
            if (dentistaInput) dentistaInput.value = citaData.dentistaId || '';
            
            // Actualizar badge de estado
            if (estadoInput) estadoInput.value = citaData.estado;
            if (estadoBadge) {
                updateEstadoBadge(estadoBadge, citaData.estado);
            }
            
            if (notasInput) notasInput.value = citaData.notas || '';
            
            // Configurar búsqueda de clientes
            var clienteSearchInput = document.getElementById('optionsClienteSearch');
            var clienteSelect = document.getElementById('optionsClienteSelect');
            var clienteResults = document.getElementById('optionsClienteResults');
            var clienteIdInput = document.getElementById('optionsClienteId');
            var clienteSelectedDiv = document.getElementById('optionsClienteSelected');
            var clienteSelectedName = document.getElementById('optionsClienteSelectedName');
            var clienteSelectedEmail = document.getElementById('optionsClienteSelectedEmail');
            var clienteSelectContainer = document.getElementById('clienteSelectContainer');
            var pacienteInfo = document.getElementById('pacienteInfo');
            
            // Mostrar/ocultar selector de cliente según el estado de la cita
            if (clienteSelectContainer && pacienteInfo) {
                if (citaData.estado === 'disponible') {
                    // Para citas disponibles, mostrar selector de cliente
                    clienteSelectContainer.style.display = 'block';
                    pacienteInfo.style.display = 'none';
                    
                    // Si ya hay un cliente asignado, mostrarlo
                    if (citaData.paciente && citaData.paciente !== '') {
                        // Buscar el cliente en el select
                        var clienteOption = Array.from(clienteSelect.options).find(opt => 
                            opt.getAttribute('data-nombre') === citaData.paciente || 
                            opt.textContent.includes(citaData.paciente)
                        );
                        if (clienteOption && clienteOption.value) {
                            if (clienteIdInput) clienteIdInput.value = clienteOption.value;
                            if (clienteSelectedName) clienteSelectedName.textContent = clienteOption.getAttribute('data-nombre') || citaData.paciente;
                            if (clienteSelectedEmail) clienteSelectedEmail.textContent = clienteOption.getAttribute('data-email') || citaData.pacienteEmail || '';
                            if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'block';
                            if (clienteSearchInput) clienteSearchInput.style.display = 'none';
                        } else {
                            // Si no se encuentra en el select, mostrar el nombre pero permitir cambiar
                            if (clienteSearchInput) clienteSearchInput.style.display = 'block';
                            if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'none';
                        }
                    } else {
                        // No hay cliente, mostrar campo de búsqueda
                        if (clienteSearchInput) clienteSearchInput.style.display = 'block';
                        if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'none';
                    }
                } else if (citaData.estado === 'reservada' || citaData.estado === 'confirmada') {
                    // Para citas reservadas, mostrar selector para cambiar cliente
                    clienteSelectContainer.style.display = 'block';
                    pacienteInfo.style.display = 'none';
                    
                    // Si hay cliente, mostrarlo pero permitir cambiarlo
                    if (citaData.paciente && citaData.paciente !== '') {
                        var clienteOption = Array.from(clienteSelect.options).find(opt => 
                            opt.getAttribute('data-nombre') === citaData.paciente || 
                            opt.textContent.includes(citaData.paciente)
                        );
                        if (clienteOption && clienteOption.value) {
                            if (clienteIdInput) clienteIdInput.value = clienteOption.value;
                            if (clienteSelectedName) clienteSelectedName.textContent = clienteOption.getAttribute('data-nombre') || citaData.paciente;
                            if (clienteSelectedEmail) clienteSelectedEmail.textContent = clienteOption.getAttribute('data-email') || citaData.pacienteEmail || '';
                            if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'block';
                            if (clienteSearchInput) clienteSearchInput.style.display = 'none';
                        } else {
                            // Si no se encuentra, mostrar el nombre pero permitir cambiar
                            if (clienteSearchInput) clienteSearchInput.style.display = 'block';
                            if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'none';
                        }
                    } else {
                        // No hay cliente, mostrar campo de búsqueda
                        if (clienteSearchInput) clienteSearchInput.style.display = 'block';
                        if (clienteSelectedDiv) clienteSelectedDiv.style.display = 'none';
                    }
                } else {
                    // Para otros estados, ocultar selector
                    clienteSelectContainer.style.display = 'none';
                    pacienteInfo.style.display = 'none';
                }
            }
            
            // Configurar búsqueda de clientes para el formulario de editar
            if (clienteSearchInput && clienteSelect && clienteResults) {
                clienteSearchInput.addEventListener('input', function() {
                    searchClientesForEdit(this.value, clienteSelect, clienteResults, clienteIdInput, clienteSelectedDiv, clienteSelectedName, clienteSelectedEmail);
                });
                
                // Cerrar resultados al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!clienteSelectContainer.contains(e.target)) {
                        clienteResults.style.display = 'none';
                    }
                });
            }
            
            // Mostrar información del paciente si existe
            var pacienteInput = document.getElementById('optionsPaciente');
            
            if (pacienteInfo && pacienteInput) {
                if (citaData.paciente && citaData.paciente !== '') {
                    pacienteInfo.style.display = 'block';
                    pacienteInput.value = citaData.paciente;
                } else {
                    pacienteInfo.style.display = 'none';
                }
            }
        }
        
        console.log('Mostrando modal...');
        // Mostrar modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        console.log('Modal visible');
        
    } catch (error) {
        console.error('Error en openOptionsModal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Función global para cerrar el modal de opciones
window.closeOptionsModal = function() {
    var modal = document.getElementById('optionsModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
    currentCitaData = null;
}

// Función global para confirmar eliminación de cita
window.confirmarEliminarCita = function(event) {
    try {
        if (event) event.preventDefault();
        
        if (!currentCitaData) {
            alert('Error: No hay datos de cita disponibles');
            return;
        }
        
        var confirmModal = document.getElementById('confirmDeleteModal');
        var confirmWarningBox = document.getElementById('confirmWarningBox');
        var confirmInfoBox = document.getElementById('confirmInfoBox');
        
        if (!confirmModal) {
            alert('Error: Modal de confirmación no encontrado');
            return;
        }
        
        // Mostrar estado de la cita
        var estadoTexto = '';
        switch(currentCitaData.estado) {
            case 'disponible':
                estadoTexto = '📅 Disponible';
                break;
            case 'reservada':
                estadoTexto = '✅ Reservada';
                break;
            case 'completada':
                estadoTexto = '✔️ Completada';
                break;
            case 'cancelada':
                estadoTexto = '❌ Cancelada';
                break;
            default:
                estadoTexto = currentCitaData.estado;
        }
        
        var estadoTextElement = document.getElementById('confirmEstadoText');
        if (estadoTextElement) {
            estadoTextElement.textContent = estadoTexto;
        }
        
        // Mostrar advertencia si la cita está reservada
        if (currentCitaData.estado === 'reservada' && currentCitaData.paciente) {
            if (confirmWarningBox) confirmWarningBox.style.display = 'block';
            if (confirmInfoBox) confirmInfoBox.style.display = 'none';
            
            var nombreEl = document.getElementById('confirmClienteNombre');
            var emailEl = document.getElementById('confirmClienteEmail');
            var telefonoEl = document.getElementById('confirmClienteTelefono');
            
            if (nombreEl) nombreEl.textContent = currentCitaData.paciente;
            if (emailEl) emailEl.textContent = currentCitaData.pacienteEmail || 'No disponible';
            if (telefonoEl) telefonoEl.textContent = currentCitaData.pacienteTelefono || 'No disponible';
        } else {
            if (confirmWarningBox) confirmWarningBox.style.display = 'none';
            if (confirmInfoBox) confirmInfoBox.style.display = 'block';
        }
        
        // Mostrar modal de confirmación
        confirmModal.classList.add('show');
        
    } catch (error) {
        console.error('Error en confirmarEliminarCita:', error);
        alert('Error: ' + error.message);
    }
}

// Función global para cerrar el modal de confirmación
window.closeConfirmDeleteModal = function() {
    var modal = document.getElementById('confirmDeleteModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Función global para ejecutar la eliminación
window.ejecutarEliminarCita = function() {
    try {
        if (!currentCitaData) {
            alert('Error: No hay datos de cita');
            return;
        }
        
        // Crear formulario para eliminar
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url 'eliminar_cita' 0 %}'.replace('0', currentCitaData.id);
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            var csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
        
    } catch (error) {
        console.error('Error en ejecutarEliminarCita:', error);
        alert('Error al eliminar: ' + error.message);
    }
}

// Función global para abrir modal de opciones (punto de entrada)
window.openOptionsModalForCita = function(citaId) {
    try {
        console.log('Click en botón de opciones - ID:', citaId);
        
        var citaData = citasDataMap[citaId];
        
        if (!citaData) {
            console.error('No se encontraron datos para la cita ID:', citaId);
            alert('Error: No se pudieron cargar los datos de la cita.');
            return;
        }
        
        console.log('Datos de cita encontrados:', citaData);
        
        // Si es una cita tomada (reservada o confirmada), abrir modal simple
        if (citaData.estado === 'reservada' || citaData.estado === 'confirmada') {
            window.openCitaInfoModal(citaData);
        } else {
            // Si es disponible o completada, abrir modal de edición
            window.openOptionsModal(citaData);
        }
        
    } catch (error) {
        console.error('Error al abrir modal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Función para abrir el modal simple de información de citas tomadas
window.openCitaInfoModal = function(citaData) {
    try {
        var modal = document.getElementById('citaInfoModal');
        
        if (!modal) {
            console.error('Modal #citaInfoModal no encontrado');
            return;
        }
        
        // Formatear fecha y hora
        var fecha = new Date(citaData.fechaHora);
        var fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        var horaStr = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        // Llenar la información
        document.getElementById('modalCitaFecha').textContent = fechaStr;
        document.getElementById('modalCitaHora').textContent = horaStr;
        // Usar nombre_paciente que ya viene del servidor con el nombre completo correcto
        document.getElementById('modalCitaPaciente').textContent = citaData.paciente || 'Sin información';
        document.getElementById('modalCitaTipo').textContent = citaData.tipoConsulta || 'No especificado';
        
        // Obtener nombre del dentista
        var dentistaSelect = document.getElementById('optionsDentista');
        var dentistaNombre = 'Sin asignar';
        if (citaData.dentistaId && dentistaSelect) {
            var option = dentistaSelect.querySelector('option[value="' + citaData.dentistaId + '"]');
            if (option) {
                dentistaNombre = option.textContent;
            }
        }
        document.getElementById('modalCitaDentista').textContent = dentistaNombre;
        
        // Estado con badge
        var estadoSpan = document.getElementById('modalCitaEstado');
        estadoSpan.textContent = citaData.estado === 'reservada' ? 'Reservada' : 'Confirmada';
        estadoSpan.className = 'badge-estado ' + citaData.estado;
        
        // Mostrar información de ficha odontológica
        var fichaContainer = document.getElementById('infoFichaContainer');
        var fichaValue = document.getElementById('modalCitaFicha');
        if (fichaContainer && fichaValue) {
            if (citaData.tieneFicha) {
                fichaContainer.style.display = 'flex';
                fichaValue.innerHTML = '<span style="color: #10b981; font-weight: 600;"><i class="fas fa-check-circle"></i> Ficha creada</span>';
            } else {
                fichaContainer.style.display = 'flex';
                fichaValue.innerHTML = '<span style="color: #ef4444; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Ficha no creada</span>';
            }
        }
        
        // Configurar botones de acción
        var btnCompletar = document.getElementById('btnCompletarCita');
        if (btnCompletar) {
            btnCompletar.href = '{% url "completar_cita" 0 %}'.replace('0', citaData.id);
            // Guardar información de ficha en el botón para validación
            btnCompletar.setAttribute('data-tiene-ficha', citaData.tieneFicha ? 'true' : 'false');
        }
        document.getElementById('btnCancelarCita').href = '{% url "cancelar_cita_admin" 0 %}'.replace('0', citaData.id);
        
        // Mostrar modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
    } catch (error) {
        console.error('Error en openCitaInfoModal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Función para validar antes de completar cita
window.validarCompletarCita = function() {
    var btnCompletar = document.getElementById('btnCompletarCita');
    if (!btnCompletar) return false;
    
    var tieneFicha = btnCompletar.getAttribute('data-tiene-ficha') === 'true';
    
    if (!tieneFicha) {
        alert('⚠️ No se puede completar la cita sin crear la ficha odontológica.\n\nPor favor, asegúrate de que el dentista haya creado la ficha antes de marcar la cita como completada.');
        return false;
    }
    
    return confirm('¿Marcar esta cita como completada?');
}

// Función para cerrar el modal simple
window.closeCitaInfoModal = function() {
    var modal = document.getElementById('citaInfoModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

// Variables globales para tabs
let tabSections = {};
let tabButtons = [];

// Función global para cambiar de tab
window.showTab = function(name) {
    if (!tabSections[name]) return;
    
    // Ocultar todos los tabs
    Object.keys(tabSections).forEach(key => {
        if (tabSections[key]) {
            tabSections[key].style.display = 'none';
        }
    });
    
    // Mostrar el tab seleccionado
    tabSections[name].style.display = '';
    
    // Actualizar botones de tab
    tabButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === name);
    });
    
    // Renderizar calendario si es necesario
    if (name === 'calendar' && window.calendarInstance) {
        window.calendarInstance.render();
    }
    
    // Actualizar URL sin recargar la página
    const url = new URL(window.location);
    url.searchParams.set('tab', name);
    window.history.pushState({}, '', url);
};

// Función para inicializar tabs - se ejecuta inmediatamente
(function initTabs() {
    // Activar tab según parámetro de URL al cargar la página
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    const defaultTab = tabParam || 'today';
    
    // Ocultar todos los tabs inicialmente
    tabSections = {
        today: document.getElementById('tab-content-today'),
        list: document.getElementById('tab-content-list'),
        taken: document.getElementById('tab-content-taken'),
        completed: document.getElementById('tab-content-completed'),
        calendar: document.getElementById('tab-content-calendar')
    };
    
    // Ocultar todos los tabs primero
    Object.keys(tabSections).forEach(key => {
        if (tabSections[key]) {
            tabSections[key].style.display = 'none';
        }
    });
    
    // Mostrar el tab correcto
    if (tabSections[defaultTab]) {
        tabSections[defaultTab].style.display = '';
    }
    
    // Actualizar botones de tab
    tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === defaultTab);
    });
})();

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM Cargado completamente ===');
    console.log('Total de citas en el mapa:', Object.keys(citasDataMap).length);
    console.log('Función openOptionsModalForCita:', typeof window.openOptionsModalForCita);
    
    // Verificar que los modales existen
    var optionsModal = document.getElementById('optionsModal');
    var confirmModal = document.getElementById('confirmDeleteModal');
    
    console.log('Modal de opciones existe:', !!optionsModal);
    console.log('Modal de confirmación existe:', !!confirmModal);
    
    // Event listeners para cerrar modales DESHABILITADOS
    // Los modales solo se pueden cerrar con el botón X para evitar pérdida de datos
    console.log('Modales configurados para cerrarse solo con el botón X');
    
    // Re-inicializar tabs si es necesario
    tabSections = {
        today: document.getElementById('tab-content-today'),
        list: document.getElementById('tab-content-list'),
        taken: document.getElementById('tab-content-taken'),
        completed: document.getElementById('tab-content-completed'),
        calendar: document.getElementById('tab-content-calendar')
    };
    
    tabButtons = document.querySelectorAll('.tab-btn');
    
    // Configurar event listeners para los tabs
    tabButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = btn.getAttribute('data-tab');
            if (tabName && window.showTab) {
                window.showTab(tabName);
            }
        });
    });
    
    // Activar tab según parámetro de URL al cargar la página (por si acaso)
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    if (tabParam && tabSections[tabParam] && window.showTab) {
        window.showTab(tabParam);
    }

    // Calendar initialization
    const calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        // Build events from server-rendered citas
        const events = [];
        {% for c in citas_creadas %}
        events.push({
            id: '{{ c.id }}',
            title: '{{ c.tipo_consulta|default:"Disponible"|escapejs }}',
            start: '{{ c.fecha_hora|date:"Y-m-d\\TH:i:s" }}',
            extendedProps: {
                estado: 'disponible',
                paciente: 'Sin asignar',
                notas: '{{ c.notas|default_if_none:""|escapejs }}'
            },
            color: '#10b981'
        });
        {% endfor %}
        {% for c in citas_tomadas %}
        events.push({
            id: '{{ c.id }}',
            title: '{{ c.tipo_consulta|default:"Cita"|escapejs }} - {{ c.paciente_nombre|default:""|escapejs }}',
            start: '{{ c.fecha_hora|date:"Y-m-d\\TH:i:s" }}',
            extendedProps: {
                estado: '{{ c.estado|escapejs }}',
                paciente: '{{ c.paciente_nombre|default:""|escapejs }}',
                notas: '{{ c.notas|default_if_none:""|escapejs }}'
            },
            color: '#f59e0b'
        });
        {% endfor %}

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'Día',
                list: 'Lista'
            },
            navLinks: true,
            editable: false,
            selectable: false,
            events: events,
            eventClick: function(info) {
                showAppointmentDetails(info.event);
            },
            eventDisplay: 'block',
            eventTextColor: '#ffffff',
            eventBackgroundColor: '#3b82f6',
            eventBorderColor: '#2563eb'
        });
        window.calendarInstance = calendar;
        // Do not render until the calendar tab is opened to avoid layout issues
    }

    // Default to show "Citas del Día" tab
    showTab('today');
    
    // Inicializar contadores de citas del día
    actualizarContadoresCitasDia();
    
    // Inicializar filtros de citas del día
    inicializarFiltrosCitasDia();
});

// Modal functionality
function openEditModal(citaId, fechaHora, tipoConsulta, notas) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');
    
    // Set form action URL using Django URL pattern
    form.action = `{% url 'editar_cita' 0 %}`.replace('0', citaId);
    
    // Populate form fields
    document.getElementById('editFechaHora').value = fechaHora;
    document.getElementById('editTipoConsulta').value = tipoConsulta;
    document.getElementById('editNotas').value = notas;
    
    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Focus on first input
    setTimeout(() => {
        document.getElementById('editFechaHora').focus();
    }, 100);
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Close modal when clicking outside
var editModal = document.getElementById('editModal');
if (editModal) {
    editModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
}

// Código duplicado eliminado - las funciones ya están definidas arriba


// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeOptionsModal();
        closeConfirmDeleteModal();
    }
});

// Form submission handling para el modal de opciones
var optionsForm = document.getElementById('optionsForm');
if (optionsForm) {
    optionsForm.addEventListener('submit', function(e) {
        e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('.btn-save-edit');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    submitBtn.disabled = true;
    
    // Submit form
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check"></i> ¡Guardado!';
            submitBtn.style.background = '#10b981';
            
            // Close modal and reload page after a short delay
            setTimeout(() => {
                closeOptionsModal();
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    })
    .catch(error => {
        // Show error state
        submitBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al guardar';
        submitBtn.style.background = '#ef4444';
        
        // Reset after a delay
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.style.background = '';
            submitBtn.disabled = false;
        }, 2000);
        
        console.error('Error:', error);
    });
    });
}

// Form submission handling
var editForm = document.getElementById('editForm');
if (editForm) {
    editForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    submitBtn.disabled = true;
    
    // Submit form
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check"></i> ¡Guardado!';
            submitBtn.style.background = '#10b981';
            
            // Close modal and reload page after a short delay
            setTimeout(() => {
                closeEditModal();
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    })
    .catch(error => {
        // Show error state
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        submitBtn.style.background = '#ef4444';
        
        // Reset button after delay
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.style.background = '';
            submitBtn.disabled = false;
        }, 2000);
    });
    });
}

// Appointment Details Modal Functions
function showAppointmentDetails(event) {
    const modal = document.getElementById('appointmentModal');
    const props = event.extendedProps || {};
    
    // Format date and time
    const startDate = new Date(event.start);
    const formattedDateTime = startDate.toLocaleString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Populate modal with appointment data
    document.getElementById('appointmentDateTime').textContent = formattedDateTime;
    document.getElementById('appointmentType').textContent = event.title || 'Sin especificar';
    document.getElementById('appointmentPatient').textContent = props.paciente || 'Sin asignar';
    document.getElementById('appointmentNotes').textContent = props.notas || 'Sin notas';
    
    // Set status badge
    const statusElement = document.getElementById('appointmentStatus');
    const estado = props.estado || 'disponible';
    statusElement.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
    statusElement.className = `status-badge ${estado}`;
    
    // Show/hide edit button based on appointment status
    const editBtn = document.getElementById('editAppointmentBtn');
    if (estado === 'disponible') {
        editBtn.style.display = 'inline-flex';
        editBtn.onclick = () => editAppointmentFromCalendar(event.id, startDate, event.title, props.notas);
    } else {
        editBtn.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeAppointmentModal() {
    const modal = document.getElementById('appointmentModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

function editAppointmentFromCalendar(citaId, fechaHora, tipoConsulta, notas) {
    // Close appointment modal
    closeAppointmentModal();
    
    // Format date for input
    const isoString = fechaHora.toISOString().slice(0, 16);
    
    // Open edit modal with appointment data
    openEditModal(citaId, isoString, tipoConsulta, notas || '');
}

// Close appointment modal when clicking outside
var appointmentModal = document.getElementById('appointmentModal');
if (appointmentModal) {
    appointmentModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeAppointmentModal();
        }
    });
}

// Close appointment modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const appointmentModal = document.getElementById('appointmentModal');
        if (appointmentModal && appointmentModal.classList.contains('show')) {
            closeAppointmentModal();
        }
        const addCitaModal = document.getElementById('addCitaModal');
        if (addCitaModal && addCitaModal.classList.contains('show')) {
            closeAddCitaModal();
        }
        const reagendarModal = document.getElementById('reagendarModal');
        if (reagendarModal && reagendarModal.classList.contains('show')) {
            cerrarModalReagendar();
        }
    }
});

// Manejar búsqueda de clientes en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    initClienteSearch();
});

// ============================================
// FUNCIONES PARA "CITAS DEL DÍA"
// ============================================

// Actualizar contadores de citas del día
function actualizarContadoresCitasDia() {
    const citas = document.querySelectorAll('.cita-dia-card');
    let pendientes = 0;
    let completadas = 0;
    
    citas.forEach(cita => {
        const estado = cita.getAttribute('data-estado');
        if (estado === 'reservada' || estado === 'confirmada' || estado === 'disponible') {
            pendientes++;
        } else if (estado === 'completada') {
            completadas++;
        }
    });
    
    const countPendientes = document.getElementById('count-pendientes-hoy');
    const countCompletadas = document.getElementById('count-completadas-hoy');
    
    if (countPendientes) countPendientes.textContent = pendientes;
    if (countCompletadas) countCompletadas.textContent = completadas;
}

// Inicializar filtros de citas del día
function inicializarFiltrosCitasDia() {
    // Filtros rápidos por estado
    const filtrosRapidos = document.querySelectorAll('.filtro-rapido-btn');
    filtrosRapidos.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remover active de todos
            filtrosRapidos.forEach(b => b.classList.remove('active'));
            // Agregar active al clickeado
            this.classList.add('active');
            
            const filtro = this.getAttribute('data-filtro');
            aplicarFiltroCitasDia(filtro);
        });
    });
    
    // Filtro por dentista
    const filtroDentista = document.getElementById('filtro-dentista-dia');
    if (filtroDentista) {
        filtroDentista.addEventListener('change', function() {
            aplicarFiltroCitasDia();
        });
    }
}

// Aplicar filtros a las citas del día
function aplicarFiltroCitasDia(filtroEstado = null) {
    const citas = document.querySelectorAll('.cita-dia-card');
    const filtroDentista = document.getElementById('filtro-dentista-dia');
    const dentistaId = filtroDentista ? filtroDentista.value : '';
    
    // Si no hay filtro de estado, obtener del botón activo
    if (!filtroEstado) {
        const btnActivo = document.querySelector('.filtro-rapido-btn.active');
        filtroEstado = btnActivo ? btnActivo.getAttribute('data-filtro') : 'todas';
    }
    
    citas.forEach(cita => {
        const estado = cita.getAttribute('data-estado');
        const citaDentistaId = cita.getAttribute('data-dentista-id');
        
        let mostrar = true;
        
        // Filtro por estado
        if (filtroEstado !== 'todas') {
            if (filtroEstado === 'pendientes') {
                mostrar = estado === 'reservada' || estado === 'confirmada' || estado === 'disponible';
            } else if (filtroEstado === 'en-espera') {
                mostrar = estado === 'en_espera';
            } else if (filtroEstado === 'listo-para-atender') {
                mostrar = estado === 'listo_para_atender';
            } else if (filtroEstado === 'en-progreso') {
                mostrar = estado === 'en_progreso';
            } else if (filtroEstado === 'finalizada') {
                mostrar = estado === 'finalizada';
            } else if (filtroEstado === 'completadas') {
                mostrar = estado === 'completada';
            } else if (filtroEstado === 'no-show') {
                mostrar = estado === 'no_show';
            }
        }
        
        // Filtro por dentista
        if (mostrar && dentistaId && citaDentistaId !== dentistaId) {
            mostrar = false;
        }
        
        // Mostrar/ocultar
        cita.style.display = mostrar ? 'flex' : 'none';
    });
    
    // Actualizar contadores después de filtrar
    actualizarContadoresCitasDia();
}

// Marcar cita como "No Show"
// Marcar Llegada
function marcarLlegada(citaId) {
    const url = `{% url 'marcar_llegada' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message || 'Paciente marcado como "En Espera".');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error al marcar la llegada.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al marcar la llegada.');
    });
}

// Abrir modal de motivo de no asistencia
function marcarNoLlego(citaId) {
    const citaIdInput = document.getElementById('citaIdNoAsistencia');
    citaIdInput.value = citaId;
    citaIdInput.dataset.endpoint = 'marcar_no_llego';
    document.getElementById('motivoNoAsistencia').value = '';
    document.getElementById('modalNoAsistencia').style.display = 'flex';
}

// Cerrar modal de motivo de no asistencia
function cerrarModalNoAsistencia() {
    document.getElementById('modalNoAsistencia').style.display = 'none';
    document.getElementById('motivoNoAsistencia').value = '';
    document.getElementById('citaIdNoAsistencia').value = '';
}

// Confirmar y enviar motivo de no asistencia
document.addEventListener('DOMContentLoaded', function() {
    const formNoAsistencia = document.getElementById('formNoAsistencia');
    if (formNoAsistencia) {
        formNoAsistencia.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const citaId = document.getElementById('citaIdNoAsistencia').value;
            const motivo = document.getElementById('motivoNoAsistencia').value.trim();
            
            if (!motivo) {
                mostrarAlerta('error', 'Por favor, ingrese el motivo de no asistencia.');
                return;
            }
            
            // Usar el endpoint correcto según la función que se llamó
            // Por defecto usar marcar_no_llego, pero también puede usar marcar_no_show
            const endpointType = document.getElementById('citaIdNoAsistencia').dataset.endpoint || 'marcar_no_llego';
            const url = endpointType === 'marcar_no_show' 
                ? `{% url 'marcar_no_show' 0 %}`.replace('0', citaId)
                : `{% url 'marcar_no_llego' 0 %}`.replace('0', citaId);
            const formData = new FormData();
            formData.append('motivo_no_asistencia', motivo);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Deshabilitar botón mientras se procesa
            const btnConfirmar = document.getElementById('btnConfirmarNoAsistencia');
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarAlerta('success', data.message || 'Cita marcada como "No Llegó".');
                    cerrarModalNoAsistencia();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Error al marcar la cita como "No Llegó".');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('error', error.message || 'Error al marcar la cita como "No Llegó".');
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar';
            });
        });
    }
    
    // Cerrar modal al hacer clic fuera
    const modalNoAsistencia = document.getElementById('modalNoAsistencia');
    if (modalNoAsistencia) {
        modalNoAsistencia.addEventListener('click', function(e) {
            if (e.target === modalNoAsistencia) {
                cerrarModalNoAsistencia();
            }
        });
    }
});

// Marcar No Show (usa el mismo modal que marcarNoLlego)
function marcarNoShow(citaId) {
    const citaIdInput = document.getElementById('citaIdNoAsistencia');
    citaIdInput.value = citaId;
    citaIdInput.dataset.endpoint = 'marcar_no_show';
    document.getElementById('motivoNoAsistencia').value = '';
    document.getElementById('modalNoAsistencia').style.display = 'flex';
}

// Completar cita rápidamente (redirige a la página de completar)
function completarCitaRapida(citaId) {
    const url = `{% url 'completar_cita' 0 %}`.replace('0', citaId);
    window.location.href = url;
}

// Marcar listo para atender (dentista)
function marcarListoParaAtender(citaId) {
    const url = `{% url 'marcar_listo_para_atender' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message || 'Cita marcada como "Listo para Atender".');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error al marcar la cita como lista.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al marcar la cita como lista.');
    });
}

// Iniciar atención (dentista)
function iniciarAtencion(citaId) {
    const url = `{% url 'iniciar_atencion' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message || 'Atención iniciada.');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error al iniciar la atención.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al iniciar la atención.');
    });
}

// Finalizar atención (dentista)
function finalizarAtencion(citaId) {
    if (!confirm('¿Finalizar la atención? Asegúrate de haber creado la ficha odontológica.')) {
        return;
    }
    
    const url = `{% url 'finalizar_atencion' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message || 'Atención finalizada.');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error al finalizar la atención.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al finalizar la atención.');
    });
}

// Completar cita en recepción (recepcionista)
function completarCitaRecepcion(citaId) {
    if (!confirm('¿Marcar la cita como completada? Asegúrate de haber recibido el pago.')) {
        return;
    }
    
    const url = `{% url 'completar_cita_recepcion' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarAlerta('success', data.message || 'Cita completada exitosamente.');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Error al completar la cita.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al completar la cita.');
    });
}

// Abrir modal de reagendamiento
function abrirModalReagendar(citaId) {
    const modal = document.getElementById('reagendarModal');
    const form = document.getElementById('reagendarForm');
    
    // Mostrar modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Obtener información de la cita
    const url = `{% url 'reagendar_cita' 0 %}`.replace('0', citaId);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.cita) {
            const cita = data.cita;
            
            // Llenar información actual
            document.getElementById('reagendarPacienteNombre').textContent = cita.paciente_nombre;
            document.getElementById('reagendarFechaHoraActual').textContent = formatearFechaHora(cita.fecha_hora_actual);
            document.getElementById('reagendarDentistaActual').textContent = cita.dentista_nombre;
            
            // Establecer ID de la cita
            document.getElementById('reagendarCitaId').value = cita.id;
            
            // Establecer fecha/hora actual como valor por defecto (mínimo)
            const fechaHoraInput = document.getElementById('reagendarNuevaFechaHora');
            fechaHoraInput.value = cita.fecha_hora_actual;
            
            // Establecer dentista actual si existe
            if (cita.dentista_id) {
                document.getElementById('reagendarNuevoDentista').value = cita.dentista_id;
            }
            
            // Establecer acción del formulario
            form.action = url;
            
            // Establecer mínimo como fecha/hora actual
            const ahora = new Date();
            ahora.setMinutes(ahora.getMinutes() + 1); // Mínimo 1 minuto en el futuro
            const fechaMinima = ahora.toISOString().slice(0, 16);
            fechaHoraInput.min = fechaMinima;
        } else {
            throw new Error(data.error || 'Error al cargar información de la cita');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('error', error.message || 'Error al cargar la información de la cita.');
        cerrarModalReagendar();
    });
}

// Cerrar modal de reagendamiento
function cerrarModalReagendar() {
    const modal = document.getElementById('reagendarModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
    
    // Limpiar formulario
    const form = document.getElementById('reagendarForm');
    if (form) {
        form.reset();
    }
}

// Formatear fecha/hora para mostrar
function formatearFechaHora(fechaHoraStr) {
    const fecha = new Date(fechaHoraStr);
    return fecha.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Manejar envío del formulario de reagendamiento
document.addEventListener('DOMContentLoaded', function() {
    const reagendarForm = document.getElementById('reagendarForm');
    if (reagendarForm) {
        reagendarForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reagendando...';
            submitBtn.disabled = true;
            
            // Enviar formulario
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de éxito
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> ¡Reagendada!';
                    submitBtn.style.background = '#10b981';
                    
                    // Mostrar alerta
                    mostrarAlerta('success', data.message || 'Cita reagendada exitosamente.');
                    
                    // Cerrar modal y recargar página después de un breve delay
                    setTimeout(() => {
                        cerrarModalReagendar();
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Error al reagendar la cita');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Mostrar error
                submitBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
                submitBtn.style.background = '#ef4444';
                
                mostrarAlerta('error', error.message || 'Error al reagendar la cita.');
                
                // Resetear botón después de un delay
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.style.background = '';
                    submitBtn.disabled = false;
                }, 2000);
            });
        });
    }
    
    // Cerrar modal al hacer clic fuera
    const reagendarModal = document.getElementById('reagendarModal');
    if (reagendarModal) {
        reagendarModal.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalReagendar();
            }
        });
    }
});

// Función auxiliar para mostrar alertas
// Función mostrarAlerta - ahora usa el sistema de notificaciones moderno
function mostrarAlerta(tipo, mensaje, duracion = 5000) {
    // Mapear tipos antiguos a nuevos si es necesario
    if (tipo === 'info') {
        showNotification('info', mensaje, duracion);
    } else {
        showNotification(tipo, mensaje, duracion);
    }
}

// Manejar el envío del formulario de agregar cita
document.addEventListener('DOMContentLoaded', function() {
    // Obtener datos de horarios desde el script tag generado por json_script
    var horariosDentistasScript = document.getElementById('horarios-dentistas-data');
    var horariosDentistas = horariosDentistasScript ? JSON.parse(horariosDentistasScript.textContent) : {};
    
    // Función para validar y ajustar la hora según el horario del dentista
    function validarHoraSegunHorarioDentista() {
        var dentistaSelect = document.getElementById('addCitaDentista');
        var fechaInput = document.getElementById('addCitaFechaHora');
        
        if (!dentistaSelect || !fechaInput || !dentistaSelect.value || !fechaInput.value) {
            return;
        }
        
        var dentistaId = parseInt(dentistaSelect.value);
        var horarios = horariosDentistas[dentistaId];
        
        if (!horarios || horarios.length === 0) {
            // Si el dentista no tiene horarios configurados, permitir cualquier hora
            return;
        }
        
        var fechaSeleccionada = new Date(fechaInput.value);
        var diaSemana = fechaSeleccionada.getDay(); // 0=Domingo, 1=Lunes, etc.
        // Ajustar: Django usa 0=Lunes, JavaScript usa 0=Domingo
        var diaSemanaDjango = diaSemana === 0 ? 6 : diaSemana - 1;
        
        var horaSeleccionada = fechaSeleccionada.getHours();
        var minutoSeleccionado = fechaSeleccionada.getMinutes();
        var horaCompleta = horaSeleccionada * 60 + minutoSeleccionado; // En minutos desde medianoche
        
        // Buscar horarios válidos para ese día
        var horariosValidos = horarios.filter(function(h) {
            return h.dia_semana === diaSemanaDjango;
        });
        
        if (horariosValidos.length === 0) {
            alert('El dentista seleccionado no trabaja ese día. Por favor, seleccione otro día.');
            fechaInput.value = '';
            return;
        }
        
        // Verificar si la hora está dentro de algún bloque
        var horaValida = false;
        for (var i = 0; i < horariosValidos.length; i++) {
            var horario = horariosValidos[i];
            var horaInicio = parseInt(horario.hora_inicio.split(':')[0]) * 60 + parseInt(horario.hora_inicio.split(':')[1]);
            var horaFin = parseInt(horario.hora_fin.split(':')[0]) * 60 + parseInt(horario.hora_fin.split(':')[1]);
            
            if (horaCompleta >= horaInicio && horaCompleta < horaFin) {
                horaValida = true;
                break;
            }
        }
        
        if (!horaValida) {
            var horariosStr = horariosValidos.map(function(h) {
                return h.hora_inicio + '-' + h.hora_fin;
            }).join(', ');
            alert('La hora seleccionada no está dentro del horario de trabajo del dentista.\nHorarios disponibles: ' + horariosStr);
            fechaInput.value = '';
        }
    }
    
    // Esperar a que el DOM esté completamente cargado
    var formAgregarCita = document.getElementById('formAgregarCitaModal');
    console.log('Formulario encontrado:', formAgregarCita);
    
    if (!formAgregarCita) {
        console.error('ERROR: No se encontró el formulario formAgregarCitaModal');
        return;
    }
    
    if (formAgregarCita) {
        // Actualizar campo hidden tipo_servicio cuando se selecciona un servicio
        var tipoSelect = document.getElementById('addCitaTipo');
        var tipoServicioIdInput = document.getElementById('tipoServicioIdInput');
        if (tipoSelect && tipoServicioIdInput) {
            tipoSelect.addEventListener('change', function() {
                var selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.hasAttribute('data-servicio-id')) {
                    tipoServicioIdInput.value = selectedOption.getAttribute('data-servicio-id');
                } else {
                    tipoServicioIdInput.value = '';
                }
            });
        }
        
        // Validar hora cuando cambia el dentista o la fecha
        var dentistaSelect = document.getElementById('addCitaDentista');
        var fechaInput = document.getElementById('addCitaFechaHora');
        
        if (dentistaSelect) {
            dentistaSelect.addEventListener('change', function() {
                if (fechaInput && fechaInput.value) {
                    validarHoraSegunHorarioDentista();
                }
            });
        }
        
        if (fechaInput) {
            fechaInput.addEventListener('change', function() {
                if (dentistaSelect && dentistaSelect.value) {
                    validarHoraSegunHorarioDentista();
                }
            });
        }
        
        // Agregar listener con capture para asegurar que se ejecute primero
        console.log('Agregando listener al formulario');
        formAgregarCita.addEventListener('submit', function(e) {
            // Prevenir el comportamiento por defecto inmediatamente
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log('Formulario interceptado, previniendo envío tradicional');
            
            var formData = new FormData(this);
            var submitBtn = this.querySelector('button[type="submit"]');
            var originalText = submitBtn.innerHTML;
            
            // Asegurar que tipo_servicio se envíe correctamente
            var tipoSelect = document.getElementById('addCitaTipo');
            var tipoServicioIdInput = document.getElementById('tipoServicioIdInput');
            if (tipoSelect && tipoServicioIdInput) {
                var selectedOption = tipoSelect.options[tipoSelect.selectedIndex];
                if (selectedOption && selectedOption.hasAttribute('data-servicio-id')) {
                    tipoServicioIdInput.value = selectedOption.getAttribute('data-servicio-id');
                    formData.set('tipo_servicio', tipoServicioIdInput.value);
                }
            }
            
            // Validar que la fecha no sea en el pasado
            var fechaInput = document.getElementById('addCitaFechaHora');
            if (fechaInput && fechaInput.value) {
                var fechaSeleccionada = new Date(fechaInput.value);
                var ahora = new Date();
                if (fechaSeleccionada < ahora) {
                    alert('No se pueden crear citas en fechas pasadas. Por favor, seleccione una fecha y hora futura.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    fechaInput.focus();
                    return false;
                }
            }
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            submitBtn.disabled = true;
            
            // Obtener la URL del atributo data-action
            var actionUrl = formAgregarCita.getAttribute('data-action');
            if (!actionUrl) {
                // Si no hay data-action, usar la URL directamente
                actionUrl = '{% url "agregar_hora" %}';
            }
            
            console.log('Enviando formulario a:', actionUrl);
            
            // Enviar formulario con fetch
            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                // Siempre intentar parsear como JSON
                return response.json().then(data => {
                    // Si la respuesta no fue exitosa, lanzar error con el mensaje
                    if (!response.ok || (data && !data.success)) {
                        var errorMsg = data && data.error ? data.error : 'Error al crear la cita';
                        throw new Error(errorMsg);
                    }
                    return data;
                }).catch(parseError => {
                    // Si no se puede parsear como JSON, puede ser una redirección
                    if (response.redirected) {
                        window.location.href = response.url;
                        return null;
                    }
                    // Si hay un error de parseo pero la respuesta fue exitosa, puede ser HTML
                    if (response.ok) {
                        // Recargar la página si recibimos HTML (redirección exitosa)
                        window.location.reload();
                        return null;
                    }
                    throw parseError;
                });
            })
            .then(data => {
                // Si data es null, ya se manejó (redirección o recarga)
                if (data === null) {
                    return;
                }
                
                if (data && data.success) {
                    // Mostrar mensaje de éxito
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> ¡Cita creada!';
                    submitBtn.style.background = '#10b981';
                    
                    // Mostrar mensaje de éxito
                    if (data.message) {
                        alert('✅ ' + data.message);
                    }
                    
                    // Cerrar modal y recargar página después de un breve delay
                    setTimeout(() => {
                        closeAddCitaModal();
                        window.location.reload();
                    }, 1000);
                } else {
                    // Mostrar error del servidor
                    var errorMsg = data && data.error ? data.error : 'Error al crear la cita';
                    throw new Error(errorMsg);
                }
            })
            .catch(error => {
                // Restaurar botón
                submitBtn.innerHTML = originalText;
                submitBtn.style.background = '';
                submitBtn.disabled = false;
                
                console.error('Error al procesar la respuesta:', error);
                // Mostrar alerta con el mensaje de error
                var errorMessage = error.message || 'Error al crear la cita';
                console.error('Mensaje de error:', errorMessage);
                alert('⚠️ ' + errorMessage);
            });
            
            return false;
        });
        
        console.log('Listener agregado correctamente al formulario');
    }
    
    // Cerrar modal al hacer clic fuera
    var addCitaModal = document.getElementById('addCitaModal');
    if (addCitaModal) {
        addCitaModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddCitaModal();
            }
        });
    } else {
        console.warn('Modal addCitaModal no encontrado');
    }
});

    // ========== FUNCIONES DE FILTRADO ==========
    
    // Función genérica para filtrar filas de tabla
    function filtrarTabla(tipo) {
        console.log(`Filtrando tabla: ${tipo}`);
        try {
            const textoInput = document.getElementById(`filtro-${tipo}-texto`);
            const fechaInput = document.getElementById(`filtro-${tipo}-fecha`);
            const dentistaInput = document.getElementById(`filtro-${tipo}-dentista`);
            const servicioInput = document.getElementById(`filtro-${tipo}-servicio`);
            
            console.log('Elementos encontrados:', {
                texto: !!textoInput,
                fecha: !!fechaInput,
                dentista: !!dentistaInput,
                servicio: !!servicioInput
            });
            
            if (!textoInput || !fechaInput || !dentistaInput || !servicioInput) {
                console.warn(`No se encontraron todos los elementos de filtro para ${tipo}`);
                return;
            }
            
            const texto = textoInput.value ? textoInput.value.toLowerCase() : '';
            const fecha = fechaInput.value || '';
            const dentista = dentistaInput.value || '';
            const servicio = servicioInput.value || '';
            
            console.log('Valores de filtros:', { texto, fecha, dentista, servicio });
            
            const tabContentId = tipo === 'disponibles' ? 'list' : tipo === 'tomadas' ? 'taken' : 'completed';
            const tabContent = document.getElementById(`tab-content-${tabContentId}`);
            
            console.log('Tab content ID:', tabContentId);
            console.log('Tab content encontrado:', !!tabContent);
            
            if (!tabContent) {
                console.warn(`No se encontró el contenedor de pestaña para ${tipo}`);
                return;
            }
            
            const filas = tabContent.querySelectorAll('.fila-cita');
            const tabla = tabContent.querySelector('.tabla-citas');
            const mensajeDiv = document.getElementById(`mensaje-sin-resultados-${tipo}`);
            const mensajeTitulo = document.getElementById(`mensaje-titulo-${tipo}`);
            const mensajeDescripcion = document.getElementById(`mensaje-descripcion-${tipo}`);
            
            console.log('Filas encontradas:', filas.length);
            console.log('Tabla encontrada:', !!tabla);
            console.log('Mensaje div encontrado:', !!mensajeDiv);
            
            let visible = 0;
            
            filas.forEach(elemento => {
                const dataFecha = elemento.getAttribute('data-fecha') || '';
                const dataDentista = elemento.getAttribute('data-dentista') || '';
                const dataServicio = elemento.getAttribute('data-servicio') || '';
                const dataCliente = elemento.getAttribute('data-cliente') || '';
                
                // Filtro por texto (busca en servicio, dentista, cliente)
                const matchTexto = !texto || 
                    dataServicio.toLowerCase().includes(texto) ||
                    dataDentista.toLowerCase().includes(texto) ||
                    dataCliente.toLowerCase().includes(texto);
                
                // Filtro por fecha
                const matchFecha = !fecha || dataFecha === fecha;
                
                // Filtro por dentista
                const matchDentista = !dentista || dataDentista === dentista;
                
                // Filtro por servicio
                const matchServicio = !servicio || dataServicio === servicio;
                
                if (matchTexto && matchFecha && matchDentista && matchServicio) {
                    elemento.style.display = '';
                    visible++;
                } else {
                    elemento.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const countElement = document.getElementById(`count-${tipo}`);
            if (countElement) {
                countElement.textContent = `${visible} ${tipo === 'disponibles' ? 'horario(s) libre(s)' : tipo === 'tomadas' ? 'cita(s) reservada(s)' : 'cita(s) completada(s)'}`;
            }
            
            console.log(`Filas visibles después de filtrar: ${visible} de ${filas.length}`);
            
            // Mostrar/ocultar mensaje cuando no hay resultados
            // Solo mostrar si hay citas pero no coinciden con los filtros
            const hayFiltrosActivos = texto || fecha || dentista || servicio;
            if (visible === 0 && filas.length > 0 && hayFiltrosActivos) {
                // Hay filtros aplicados pero no hay resultados
                if (tabla) tabla.style.display = 'none';
                if (mensajeDiv) {
                    mensajeDiv.style.display = 'block';
                    
                    // Generar mensaje específico según los filtros aplicados
                    let mensajeTituloTexto = 'No se encontraron resultados';
                    let mensajeDescripcionTexto = 'Intenta ajustar los filtros de búsqueda';
                    
                    const filtrosActivos = [];
                    if (fecha) {
                        // Formatear fecha de manera más legible
                        const fechaObj = new Date(fecha + 'T00:00:00');
                        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        // Capitalizar primera letra
                        const fechaCapitalizada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);
                        filtrosActivos.push(`fecha: ${fechaCapitalizada}`);
                        mensajeTituloTexto = 'No existen citas en la fecha seleccionada';
                        mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para el ${fechaCapitalizada}`;
                    }
                    if (dentista) {
                        filtrosActivos.push(`dentista: ${dentista}`);
                        if (!fecha) {
                            mensajeTituloTexto = 'No se encontraron citas para este dentista';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para ${dentista}`;
                        }
                    }
                    if (servicio) {
                        filtrosActivos.push(`servicio: ${servicio}`);
                        if (!fecha && !dentista) {
                            mensajeTituloTexto = 'No se encontraron citas para este servicio';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para ${servicio}`;
                        }
                    }
                    if (texto) {
                        filtrosActivos.push(`búsqueda: "${texto}"`);
                        if (!fecha && !dentista && !servicio) {
                            mensajeTituloTexto = 'No se encontraron resultados';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} que coincidan con "${texto}"`;
                        }
                    }
                    
                    // Si hay múltiples filtros, usar mensaje genérico
                    if (filtrosActivos.length > 1) {
                        mensajeTituloTexto = 'No se encontraron resultados';
                        mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} que coincidan con los filtros aplicados`;
                    }
                    
                    if (mensajeTitulo) mensajeTitulo.textContent = mensajeTituloTexto;
                    if (mensajeDescripcion) mensajeDescripcion.textContent = mensajeDescripcionTexto;
                }
            } else {
                // Hay resultados o no hay filtros aplicados
                if (tabla) tabla.style.display = '';
                if (mensajeDiv) mensajeDiv.style.display = 'none';
            }
        } catch (error) {
            console.error(`Error al filtrar tabla ${tipo}:`, error);
        }
    }
    
    // Funciones para aplicar filtros
    function aplicarFiltrosDisponibles() {
        console.log('Aplicando filtros para disponibles...');
        filtrarTabla('disponibles');
    }
    
    function aplicarFiltrosTomadas() {
        console.log('Aplicando filtros para tomadas...');
        filtrarTabla('tomadas');
    }
    
    function aplicarFiltrosCompletadas() {
        console.log('Aplicando filtros para completadas...');
        filtrarTabla('completadas');
    }
    
    // Función para limpiar filtros
    function limpiarFiltrosDisponibles() {
        document.getElementById('filtro-disponibles-texto').value = '';
        document.getElementById('filtro-disponibles-fecha').value = '';
        document.getElementById('filtro-disponibles-dentista').value = '';
        document.getElementById('filtro-disponibles-servicio').value = '';
        filtrarTabla('disponibles');
    }
    
    function limpiarFiltrosTomadas() {
        document.getElementById('filtro-tomadas-texto').value = '';
        document.getElementById('filtro-tomadas-fecha').value = '';
        document.getElementById('filtro-tomadas-dentista').value = '';
        document.getElementById('filtro-tomadas-servicio').value = '';
        filtrarTabla('tomadas');
    }
    
    function limpiarFiltrosCompletadas() {
        document.getElementById('filtro-completadas-texto').value = '';
        document.getElementById('filtro-completadas-fecha').value = '';
        document.getElementById('filtro-completadas-dentista').value = '';
        document.getElementById('filtro-completadas-servicio').value = '';
        filtrarTabla('completadas');
    }
    
    // Función para inicializar los event listeners de filtros
    function inicializarFiltros() {
        console.log('Inicializando filtros...');
        
        // Event listeners para filtros de Disponibles
        const filtroDisponiblesTexto = document.getElementById('filtro-disponibles-texto');
        const filtroDisponiblesFecha = document.getElementById('filtro-disponibles-fecha');
        const filtroDisponiblesDentista = document.getElementById('filtro-disponibles-dentista');
        const filtroDisponiblesServicio = document.getElementById('filtro-disponibles-servicio');
        
        console.log('Filtros disponibles encontrados:', {
            texto: !!filtroDisponiblesTexto,
            fecha: !!filtroDisponiblesFecha,
            dentista: !!filtroDisponiblesDentista,
            servicio: !!filtroDisponiblesServicio
        });
        
        if (filtroDisponiblesTexto) {
            filtroDisponiblesTexto.addEventListener('input', () => {
                console.log('Evento input en filtro texto disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesFecha) {
            filtroDisponiblesFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesDentista) {
            filtroDisponiblesDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesServicio) {
            filtroDisponiblesServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio disponibles');
                filtrarTabla('disponibles');
            });
        }
        
        // Event listeners para filtros de Tomadas
        const filtroTomadasTexto = document.getElementById('filtro-tomadas-texto');
        const filtroTomadasFecha = document.getElementById('filtro-tomadas-fecha');
        const filtroTomadasDentista = document.getElementById('filtro-tomadas-dentista');
        const filtroTomadasServicio = document.getElementById('filtro-tomadas-servicio');
        
        if (filtroTomadasTexto) {
            filtroTomadasTexto.addEventListener('input', () => filtrarTabla('tomadas'));
        }
        if (filtroTomadasFecha) {
            filtroTomadasFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha tomadas');
                filtrarTabla('tomadas');
            });
        }
        if (filtroTomadasDentista) {
            filtroTomadasDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista tomadas');
                filtrarTabla('tomadas');
            });
        }
        if (filtroTomadasServicio) {
            filtroTomadasServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio tomadas');
                filtrarTabla('tomadas');
            });
        }
        
        // Event listeners para filtros de Completadas
        const filtroCompletadasTexto = document.getElementById('filtro-completadas-texto');
        const filtroCompletadasFecha = document.getElementById('filtro-completadas-fecha');
        const filtroCompletadasDentista = document.getElementById('filtro-completadas-dentista');
        const filtroCompletadasServicio = document.getElementById('filtro-completadas-servicio');
        
        if (filtroCompletadasTexto) {
            filtroCompletadasTexto.addEventListener('input', () => {
                console.log('Evento input en filtro texto completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasFecha) {
            filtroCompletadasFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasDentista) {
            filtroCompletadasDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasServicio) {
            filtroCompletadasServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio completadas');
                filtrarTabla('completadas');
            });
        }
        
        console.log('Filtros inicializados correctamente');
    }
    
    // Inicializar filtros cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarFiltros);
    } else {
        // DOM ya está listo
        inicializarFiltros();
    }

// ============================================
// SISTEMA DE ACTUALIZACIÓN AUTOMÁTICA Y NOTIFICACIONES
// ============================================

// Estado de las citas para comparar cambios
let estadoCitasAnterior = {};
let intervaloActualizacion = null;
let tabActiva = null;

// Función para reproducir sonido de notificación
function reproducirNotificacion() {
    try {
        // Crear un audio context para generar un sonido
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Configurar el sonido (tono agradable)
        oscillator.frequency.value = 800; // Frecuencia en Hz
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
        console.log('No se pudo reproducir sonido:', e);
    }
}

// Función para obtener citas actualizadas del servidor
async function obtenerCitasActualizadas() {
    try {
        const response = await fetch('{% url "obtener_citas_dia_ajax" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error('Error al obtener citas');
        }
        
        const data = await response.json();
        return data.citas || [];
    } catch (error) {
        console.error('Error al obtener citas actualizadas:', error);
        return null;
    }
}

// Función para detectar cambios importantes y notificar
function detectarCambiosImportantes(citasNuevas) {
    const cambiosImportantes = [];
    
    citasNuevas.forEach(cita => {
        const citaId = cita.id;
        const estadoAnterior = estadoCitasAnterior[citaId];
        const estadoNuevo = cita.estado;
        
        // Detectar cambio a "listo_para_atender" (muy importante para recepcionista)
        if (estadoAnterior && estadoAnterior !== 'listo_para_atender' && estadoNuevo === 'listo_para_atender') {
            cambiosImportantes.push({
                tipo: 'listo_para_atender',
                cita: cita,
                mensaje: `Dr. ${cita.dentista_nombre} está listo para atender a ${cita.paciente_nombre}`
            });
        }
        
        // Detectar cambio a "finalizada" (importante para recepcionista)
        if (estadoAnterior && estadoAnterior !== 'finalizada' && estadoNuevo === 'finalizada') {
            cambiosImportantes.push({
                tipo: 'finalizada',
                cita: cita,
                mensaje: `${cita.paciente_nombre} ha finalizado su atención`
            });
        }
        
        // Actualizar estado anterior
        estadoCitasAnterior[citaId] = estadoNuevo;
    });
    
    return cambiosImportantes;
}

// Función para actualizar el DOM con las nuevas citas
function actualizarDOMCitas(citasNuevas) {
    const listaCitas = document.getElementById('citas-dia-lista');
    if (!listaCitas) return;
    
    // Guardar el filtro activo
    const filtroActivo = document.querySelector('.filtro-rapido-btn.active');
    const filtroActivoValue = filtroActivo ? filtroActivo.getAttribute('data-filtro') : 'todas';
    
    // Limpiar lista actual
    listaCitas.innerHTML = '';
    
    // Reconstruir las tarjetas de citas (simplificado - en producción se debería usar un template más completo)
    // Por ahora, recargamos la página para mantener la consistencia visual
    // En una versión más avanzada, se podría actualizar solo las tarjetas que cambiaron
    
    // Por simplicidad, recargamos solo si hay cambios significativos
    const hayCambios = Object.keys(estadoCitasAnterior).length > 0;
    if (hayCambios) {
        // Recargar suavemente solo la sección de citas
        location.reload();
    }
}

// Función principal de actualización
async function actualizarCitasDelDia() {
    // Solo actualizar si estamos en la pestaña "today"
    const tabToday = document.getElementById('tab-content-today');
    if (!tabToday || tabToday.style.display === 'none') {
        return;
    }
    
    const citasNuevas = await obtenerCitasActualizadas();
    if (!citasNuevas) return;
    
    // Detectar cambios importantes
    const cambios = detectarCambiosImportantes(citasNuevas);
    
    // Si hay cambios importantes, reproducir sonido y mostrar notificación
    if (cambios.length > 0) {
        cambios.forEach(cambio => {
            reproducirNotificacion();
            
            // Mostrar notificación visual
            if (cambio.tipo === 'listo_para_atender') {
                mostrarAlerta('info', cambio.mensaje, 5000);
            } else if (cambio.tipo === 'finalizada') {
                mostrarAlerta('success', cambio.mensaje, 3000);
            }
        });
        
        // Actualizar el DOM
        actualizarDOMCitas(citasNuevas);
    } else {
        // Actualizar estados sin notificar (cambios menores)
        citasNuevas.forEach(cita => {
            estadoCitasAnterior[cita.id] = cita.estado;
        });
    }
}

// Inicializar el estado de las citas al cargar la página
function inicializarEstadoCitas() {
    const citas = document.querySelectorAll('.cita-dia-card');
    citas.forEach(cita => {
        const citaId = parseInt(cita.getAttribute('data-cita-id') || '0');
        if (citaId > 0) {
            const estado = cita.getAttribute('data-estado');
            estadoCitasAnterior[citaId] = estado;
        }
    });
}

// Iniciar sistema de actualización automática
function iniciarActualizacionAutomatica() {
    // Inicializar estado actual
    inicializarEstadoCitas();
    
    // Actualizar cada 5 segundos
    intervaloActualizacion = setInterval(() => {
        actualizarCitasDelDia();
    }, 5000);
    
    // Actualizar inmediatamente al iniciar
    setTimeout(() => {
        actualizarCitasDelDia();
    }, 2000);
}

// Detener actualización automática
function detenerActualizacionAutomatica() {
    if (intervaloActualizacion) {
        clearInterval(intervaloActualizacion);
        intervaloActualizacion = null;
    }
}

// Iniciar cuando se carga la página y se muestra la pestaña "today"
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si estamos en la pestaña "today" al cargar
    const tabToday = document.getElementById('tab-content-today');
    if (tabToday && tabToday.style.display !== 'none') {
        iniciarActualizacionAutomatica();
    }
    
    // Observar cambios de pestaña
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const tabToday = document.getElementById('tab-content-today');
                if (tabToday) {
                    if (tabToday.style.display !== 'none' && !intervaloActualizacion) {
                        iniciarActualizacionAutomatica();
                    } else if (tabToday.style.display === 'none' && intervaloActualizacion) {
                        detenerActualizacionAutomatica();
                    }
                }
            }
        });
    });
    
    if (tabToday) {
        observer.observe(tabToday, { attributes: true, attributeFilter: ['style'] });
    }
});

// Detener cuando se sale de la página
window.addEventListener('beforeunload', function() {
    detenerActualizacionAutomatica();
});
</script>

{# Script tag para horarios de dentistas (generado por json_script) - debe estar fuera del script principal #}
{{ horarios_dentistas|json_script:"horarios-dentistas-data" }}

{% endblock %}
