{% extends 'citas/base.html' %}

{% block title %}Perfil de {{ cliente.nombre_completo }} - Clínica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav">
    <a href="{% url 'gestor_clientes' %}" class="breadcrumb-link">
        <i class="fas fa-users"></i> Gestor de Clientes
    </a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">
        <i class="fas fa-user"></i> {{ cliente.nombre_completo }}
    </span>
</div>

<!-- Header -->
<div class="header-with-stats">
    <div class="page-header">
        <div class="client-profile-header">
            <div class="client-avatar-large">
                <i class="fas fa-user"></i>
            </div>
            <div class="client-header-info">
                <h1 class="page-title">
                    <i class="fas fa-user-circle"></i> {{ cliente.nombre_completo }}
                </h1>
                <p class="page-subtitle">Perfil completo del cliente con historiales médicos</p>
            </div>
        </div>
    </div>
    <div class="header-actions">
        <a href="{% url 'gestor_clientes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            <span>Volver a Lista</span>
        </a>
        <button class="btn btn-primary" onclick="editarCliente({{ cliente.id }})">
            <i class="fas fa-edit"></i>
            <span>Editar Cliente</span>
        </button>
    </div>
</div>

<!-- Información del Cliente - Perfil Compacto -->
<div class="section">
    <div class="client-profile-compact">
        <div class="profile-compact-content">
            <div class="profile-info-item">
                <i class="fas fa-user"></i>
                <span class="profile-label">Nombre:</span>
                <span class="profile-value">{{ cliente.nombre_completo }}</span>
            </div>
            {% if cliente.rut %}
            <div class="profile-info-item">
                <i class="fas fa-id-card"></i>
                <span class="profile-label">RUT:</span>
                <span class="profile-value">{{ cliente.rut }}</span>
            </div>
            {% endif %}
            <div class="profile-info-item">
                <i class="fas fa-envelope"></i>
                <span class="profile-label">Email:</span>
                <span class="profile-value">{{ cliente.email }}</span>
            </div>
            <div class="profile-info-item">
                <i class="fas fa-phone"></i>
                <span class="profile-label">Teléfono:</span>
                <span class="profile-value">{{ cliente.telefono|default:"Sin teléfono" }}</span>
            </div>
            {% if cliente.fecha_nacimiento %}
            <div class="profile-info-item">
                <i class="fas fa-birthday-cake"></i>
                <span class="profile-label">Fecha Nacimiento:</span>
                <span class="profile-value">
                    {{ cliente.fecha_nacimiento|date:"d/m/Y" }}
                    {% if cliente.edad %}
                        <span style="color: #6b7280; font-weight: normal;">({{ cliente.edad }} años)</span>
                    {% endif %}
                </span>
            </div>
            {% endif %}
            <div class="profile-info-item">
                <i class="fas fa-calendar"></i>
                <span class="profile-label">Registro:</span>
                <span class="profile-value">{{ cliente.fecha_registro|date:"d/m/Y" }}</span>
            </div>
            <div class="profile-info-item">
                <i class="fas fa-check-circle"></i>
                <span class="profile-label">Estado:</span>
                <span class="profile-value">
                    {% if cliente.activo %}
                    <span class="badge badge-success">Activo</span>
                    {% else %}
                    <span class="badge badge-secondary">Inactivo</span>
                    {% endif %}
                </span>
            </div>
            {% if cliente.dentista_asignado %}
            <div class="profile-info-item">
                <i class="fas fa-user-md"></i>
                <span class="profile-label">Dentista:</span>
                <span class="profile-value">{{ cliente.dentista_asignado.nombre_completo }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Alerta de Alergias (si tiene) -->
{% if cliente.tiene_alergias %}
<div class="section">
    <div class="alert alert-warning" style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
        <div style="display: flex; align-items: flex-start; gap: 15px;">
            <div style="font-size: 2rem; color: #f59e0b;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 10px 0; color: #92400e; font-size: 1.2rem;">
                    <i class="fas fa-allergy"></i> Alergias Registradas
                </h3>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #78350f; white-space: pre-line; font-weight: 500;">{{ cliente.alergias }}</p>
                </div>
                <p style="margin: 10px 0 0 0; color: #92400e; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Esta información es crítica para la seguridad del paciente durante los tratamientos.
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
    </div>
</div>

<!-- Estadísticas -->
<div class="section">
    <div class="stats-header">
        <h2><i class="fas fa-chart-bar"></i> Estadísticas</h2>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ estadisticas.total_citas }}</div>
                <div class="stat-label">Total Citas</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon completed">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ estadisticas.citas_completadas }}</div>
                <div class="stat-label">Citas Completadas</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ estadisticas.citas_pendientes }}</div>
                <div class="stat-label">Citas Pendientes</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tooth"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ estadisticas.total_odontogramas }}</div>
                <div class="stat-label">Odontogramas</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-x-ray"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ estadisticas.total_radiografias }}</div>
                <div class="stat-label">Radiografías</div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs para Historiales -->
<div class="section">
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="mostrarTab('odontogramas')">
                <i class="fas fa-tooth"></i> Odontogramas ({{ odontogramas.count }})
            </button>
            <button class="tab-btn" onclick="mostrarTab('radiografias')">
                <i class="fas fa-x-ray"></i> Radiografías ({{ radiografias.count }})
            </button>
            <button class="tab-btn" onclick="mostrarTab('citas')">
                <i class="fas fa-calendar"></i> Citas ({{ estadisticas.total_citas }})
            </button>
        </div>
        
        <!-- Tab Odontogramas -->
        <div id="tab-odontogramas" class="tab-content active">
            {% if odontogramas %}
            <div class="historial-grid">
                {% for odontograma in odontogramas %}
                <div class="historial-card">
                    <div class="historial-card-header">
                        <h4><i class="fas fa-tooth"></i> Odontograma</h4>
                        <span class="fecha-badge">{{ odontograma.fecha_creacion|date:"d/m/Y" }}</span>
                    </div>
                    <div class="historial-card-body">
                        <div class="info-item-small">
                            <i class="fas fa-user-md"></i>
                            <strong>Dentista:</strong> {{ odontograma.dentista.nombre_completo }}
                        </div>
                        <div class="info-item-small">
                            <i class="fas fa-file-medical"></i>
                            <strong>Motivo:</strong> {{ odontograma.motivo_consulta|truncatewords:15 }}
                        </div>
                        {% if odontograma.observaciones %}
                        <div class="info-item-small">
                            <i class="fas fa-comment"></i>
                            <strong>Observaciones:</strong> {{ odontograma.observaciones|truncatewords:15 }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="historial-card-actions">
                        <a href="{% url 'detalle_odontograma' odontograma.id %}?return={% url 'perfil_cliente' cliente.id %}" class="btn btn-sm btn-info">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-tooth"></i>
                <h3>No hay odontogramas registrados</h3>
                <p>Este cliente aún no tiene odontogramas en su historial.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Tab Radiografías -->
        <div id="tab-radiografias" class="tab-content">
            {% if radiografias %}
            <div class="historial-grid">
                {% for radiografia in radiografias %}
                <div class="historial-card">
                    <div class="historial-card-header">
                        <h4><i class="fas fa-x-ray"></i> {{ radiografia.get_tipo_display }}</h4>
                        <span class="fecha-badge">{{ radiografia.fecha_carga|date:"d/m/Y" }}</span>
                    </div>
                    <div class="historial-card-body">
                        <div class="radiografia-thumbnail">
                            <img src="{{ radiografia.imagen.url }}" alt="{{ radiografia.get_tipo_display }}" 
                                 onclick="window.open('{{ radiografia.imagen.url }}', '_blank')">
                        </div>
                        <div class="info-item-small">
                            <i class="fas fa-user-md"></i>
                            <strong>Dentista:</strong> {{ radiografia.dentista.nombre_completo }}
                        </div>
                        {% if radiografia.descripcion %}
                        <div class="info-item-small">
                            <i class="fas fa-comment"></i>
                            <strong>Descripción:</strong> {{ radiografia.descripcion|truncatewords:15 }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="historial-card-actions">
                        <button class="btn btn-sm btn-success" onclick="enviarRadiografiaPorCorreo({{ radiografia.id }}, '{{ cliente.email }}', '{{ cliente.nombre_completo }}')">
                            <i class="fas fa-envelope"></i> Enviar por Correo
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-x-ray"></i>
                <h3>No hay radiografías registradas</h3>
                <p>Este cliente aún no tiene radiografías en su historial.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Tab Citas -->
        <div id="tab-citas" class="tab-content">
            {% if citas %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Dentista</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cita in citas %}
                        <tr>
                            <td>{{ cita.fecha_hora|date:"d/m/Y H:i" }}</td>
                            <td>
                                <span class="badge badge-{{ cita.estado }}">
                                    {{ cita.get_estado_display }}
                                </span>
                            </td>
                            <td>{{ cita.tipo_consulta|default:"-" }}</td>
                            <td>{{ cita.dentista.nombre_completo|default:"Sin asignar" }}</td>
                            <td>
                                <a href="{% url 'editar_cita' cita.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i> Ver
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No hay citas registradas</h3>
                <p>Este cliente aún no tiene citas en el sistema.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.breadcrumb-nav {
    background: var(--card-bg);
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.breadcrumb-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.breadcrumb-link:hover {
    color: var(--primary-color-dark);
    text-decoration: underline;
}

.breadcrumb-separator {
    color: #999;
}

.breadcrumb-current {
    color: #333;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

.client-profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
}

.client-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2em;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.client-header-info {
    flex: 1;
}

/* Perfil compacto del cliente */
.client-profile-compact {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.profile-compact-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.profile-info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
    transition: all 0.2s;
}

.profile-info-item:hover {
    background: #f0f4f8;
    transform: translateX(4px);
}

.profile-info-item i {
    color: var(--primary-color);
    width: 20px;
    font-size: 1em;
    flex-shrink: 0;
}

.profile-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
    min-width: 80px;
}

.profile-value {
    font-size: 0.95rem;
    color: #1f2937;
    font-weight: 600;
    flex: 1;
}

.info-item-large {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

.info-icon {
    width: 45px;
    height: 45px;
    border-radius: 8px;
    background: #f0f4f8;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
    font-size: 1.2em;
    flex-shrink: 0;
}

.info-content {
    flex: 1;
}

.info-label {
    font-size: 0.85em;
    color: #666;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 1.1em;
    color: #333;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
}

.stat-icon.completed {
    background: #10b981;
}

.stat-icon.pending {
    background: #f59e0b;
}

.stat-number {
    font-size: 2em;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.stat-label {
    font-size: 0.9em;
    color: #6b7280;
    margin: 0;
}

.tabs-container {
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tabs-header {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
    gap: 0;
}

.tab-btn {
    flex: 1;
    padding: 15px 20px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: #6b7280;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-btn:hover {
    background: #e9ecef;
    color: #333;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: white;
}

.tab-content {
    display: none;
    padding: 25px;
}

.tab-content.active {
    display: block;
}

.historial-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.historial-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.historial-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.historial-card-header {
    background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
}

.historial-card-header h4 {
    margin: 0;
    color: #1e293b;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 8px;
}

.fecha-badge {
    background: #e9ecef;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85em;
    color: #495057;
    font-weight: 600;
}

.historial-card-body {
    padding: 15px;
}

.info-item-small {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 0.9em;
    color: #495057;
}

.info-item-small i {
    color: var(--primary-color);
    width: 16px;
}

.radiografia-thumbnail {
    width: 100%;
    height: 200px;
    overflow: hidden;
    background: #000;
    border-radius: 8px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.radiografia-thumbnail img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    cursor: pointer;
    transition: transform 0.3s;
}

.radiografia-thumbnail img:hover {
    transform: scale(1.1);
}

.historial-card-actions {
    padding: 15px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 10px;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
    display: inline-block;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-secondary {
    background: #e9ecef;
    color: #495057;
}

.badge.reservada {
    background: #fef3c7;
    color: #92400e;
}

.badge.completada {
    background: #d1fae5;
    color: #065f46;
}

.badge.cancelada {
    background: #fecaca;
    color: #991b1b;
}

@media (max-width: 768px) {
    .client-profile-header {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-compact-content {
        grid-template-columns: 1fr;
    }
    
    .tabs-header {
        flex-direction: column;
    }
    
    .tab-btn {
        border-bottom: 1px solid #e9ecef;
        border-right: none;
    }
    
    .tab-btn.active {
        border-bottom: 3px solid var(--primary-color);
    }
}
</style>

<script>
function mostrarTab(tabName) {
    // Ocultar todos los tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remover active de todos los botones
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar el tab seleccionado
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activar el botón correspondiente
    event.target.closest('.tab-btn').classList.add('active');
}

function enviarRadiografiaPorCorreo(radiografiaId, clienteEmail, clienteNombre) {
    if (confirm(`¿Está seguro de enviar esta radiografía al correo ${clienteEmail}?`)) {
        // Redirigir a la vista que envía el correo
        window.location.href = `/trabajadores/radiografias/${radiografiaId}/enviar-correo/`;
    }
}
</script>
{% endblock %}

