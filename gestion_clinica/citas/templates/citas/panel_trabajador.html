{% extends 'citas/base.html' %}
{% load custom_filters %}

{% block title %}Gestor de Citas - Cl√≠nica Dental{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<!-- Header con Stats a la Derecha -->
<div class="header-with-stats">
    <div class="page-header">
        <h1 class="page-title"><i class="fas fa-calendar-alt"></i> Gestor de Citas</h1>
        <p class="page-subtitle">Administra las citas y horarios de la cl√≠nica dental</p>
    </div>
    <div class="dashboard-compact">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.citas_hoy }}</div>
                    <div class="stat-label">Citas de Hoy</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.disponibles }}</div>
                    <div class="stat-label">Disponibles</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-color);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ estadisticas.realizadas }}</div>
                    <div class="stat-label">Realizadas</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Layout Principal Estilo Despegar -->
{% if es_admin %}
<div class="layout-container">
    <div class="despegar-layout">
    <!-- Contenido Principal -->
    <div class="main-content-area">
        <!-- Header con Bot√≥n de Agregar Cita -->
        <div class="content-header-actions">
            <div class="results-tabs">
                <button class="tab-btn active" data-tab="list">Citas disponibles</button>
                <button class="tab-btn" data-tab="taken">Citas tomadas</button>
                <button class="tab-btn" data-tab="completed">Citas completadas</button>
                <button class="tab-btn" data-tab="calendar">Calendario General</button>
            </div>
            <button class="btn-add-cita" onclick="openAddCitaModal()">
                <i class="fas fa-plus-circle"></i>
                <span>Agregar Nueva Cita</span>
            </button>
        </div>

        

        <!-- Contenido: Listado -->
        <div id="tab-content-list" class="citas-results">
            <!-- T√≠tulo: Citas Disponibles -->
            {% if citas_creadas %}
            <div class="section-title-modern">
                <div>
                    <h3><i class="fas fa-calendar-check"></i> Citas Disponibles</h3>
                    <p id="count-disponibles">{{ citas_creadas|length }} horario(s) libre(s)</p>
                </div>
            </div>

            <!-- Filtros de B√∫squeda - Disponibles -->
            <div class="filtros-busqueda">
                <div class="filtro-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="filtro-disponibles-texto" placeholder="B√∫squeda general (paciente, dentista, servicio...)" class="filtro-input">
                </div>
                <div class="filtro-group">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="filtro-disponibles-fecha" class="filtro-input">
                </div>
                <div class="filtro-group">
                    <i class="fas fa-user-md"></i>
                    <select id="filtro-disponibles-dentista" class="filtro-select">
                        <option value="">Todos los dentistas</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filtro-group">
                    <i class="fas fa-stethoscope"></i>
                    <select id="filtro-disponibles-servicio" class="filtro-select">
                        <option value="">Todos los servicios</option>
                        {% for servicio in servicios %}
                        <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button onclick="aplicarFiltrosDisponibles()" class="btn-aplicar-filtros" title="Aplicar filtros">
                    <i class="fas fa-filter"></i> Aplicar
                </button>
                <button onclick="limpiarFiltrosDisponibles()" class="btn-limpiar-filtros" title="Limpiar filtros">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>

            <!-- Tabla de Citas -->
            <div class="tabla-citas-wrapper">
                <table class="tabla-citas">
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar-day"></i> Fecha</th>
                            <th><i class="fas fa-clock"></i> Hora</th>
                            <th><i class="fas fa-tooth"></i> Tipo</th>
                            <th><i class="fas fa-info-circle"></i> Estado</th>
                            <th class="col-cliente" style="display: none;"><i class="fas fa-user"></i> Cliente</th>
                            <th><i class="fas fa-user-md"></i> Dentista</th>
                            <th><i class="fas fa-cog"></i> Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cita in citas_creadas %}
                        <tr class="fila-cita disponible"
                            data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                            data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                            data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}">
                            <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                            <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                            <td class="col-tipo">
                                {% if cita.tipo_servicio %}
                                    <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                        <i class="fas fa-stethoscope"></i>
                                        {{ cita.tipo_servicio.nombre }}
                                    </span>
                                {% elif cita.tipo_consulta %}
                                    <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                        <i class="fas fa-stethoscope"></i>
                                        {{ cita.tipo_consulta }}
                                    </span>
                                {% else %}
                                    <span class="text-muted" title="Sin servicio asignado">
                                        <i class="fas fa-question-circle"></i>
                                        Sin servicio
                                    </span>
                                {% endif %}
                            </td>
                            <td class="col-estado">
                                <span class="badge-estado disponible">
                                    <i class="fas fa-circle"></i> Disponible
                                </span>
                            </td>
                            <td class="col-cliente" style="display: none;">
                                <span class="text-muted">Sin asignar</span>
                            </td>
                            <td class="col-dentista">
                                {% if cita.dentista %}
                                    <div class="dentista-info-compact">
                                        <i class="fas fa-user-md"></i>
                                        {{ cita.dentista.nombre_completo }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td class="col-acciones">
                                <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- Mensaje cuando no hay resultados despu√©s de filtrar -->
                <div id="mensaje-sin-resultados-disponibles" class="empty-results-modern" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 id="mensaje-titulo-disponibles">No se encontraron resultados</h3>
                    <p id="mensaje-descripcion-disponibles">Intenta ajustar los filtros de b√∫squeda</p>
                </div>
            </div>
            {% else %}
            <div class="empty-results-modern">
                <div class="empty-icon">
                    <i class="fas fa-calendar-times"></i>
                </div>
                <h3>No hay citas disponibles</h3>
                <p>Haz clic en el bot√≥n "Agregar Nueva Cita" para crear una nueva cita</p>
            </div>
            {% endif %}
        </div>

        <!-- Contenido: Citas Tomadas -->
        <div id="tab-content-taken" style="display: none;">
            <div class="citas-results">
                {% if citas_tomadas %}
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-calendar-check"></i> Citas Reservadas</h3>
                        <p id="count-tomadas">{{ citas_tomadas|length }} cita(s) reservada(s)</p>
                    </div>
                </div>

                <!-- Filtros de B√∫squeda - Tomadas -->
                <div class="filtros-busqueda">
                    <div class="filtro-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="filtro-tomadas-texto" placeholder="Buscar por cliente, servicio, dentista..." class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtro-tomadas-fecha" class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-user-md"></i>
                        <select id="filtro-tomadas-dentista" class="filtro-select">
                            <option value="">Todos los dentistas</option>
                            {% for dentista in dentistas %}
                            <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-stethoscope"></i>
                        <select id="filtro-tomadas-servicio" class="filtro-select">
                            <option value="">Todos los servicios</option>
                            {% for servicio in servicios %}
                            <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button onclick="aplicarFiltrosTomadas()" class="btn-aplicar-filtros" title="Aplicar filtros">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                    <button onclick="limpiarFiltrosTomadas()" class="btn-limpiar-filtros" title="Limpiar filtros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>

                <!-- Tabla de Citas Tomadas -->
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas_tomadas %}
                            <tr class="fila-cita reservada"
                                data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                                data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                                data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}"
                                data-cliente="{{ cita.nombre_paciente }}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                                <td class="col-tipo">
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                            <i class="fas fa-stethoscope"></i>
                                            {{ cita.tipo_servicio.nombre }}
                                        </span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                            <i class="fas fa-file-medical"></i>
                                            {{ cita.tipo_consulta }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted" title="Sin servicio asignado">
                                            <i class="fas fa-question-circle"></i>
                                            Sin servicio
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    <span class="badge-estado reservada">
                                        <i class="fas fa-circle"></i> {{ cita.get_estado_display }}
                                    </span>
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {{ cita.nombre_paciente }}
                                    </div>
                                    {% if cita.email_paciente %}
                                    <small class="text-muted">{{ cita.email_paciente }}</small>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- Mensaje cuando no hay resultados despu√©s de filtrar -->
                    <div id="mensaje-sin-resultados-tomadas" class="empty-results-modern" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 id="mensaje-titulo-tomadas">No se encontraron resultados</h3>
                        <p id="mensaje-descripcion-tomadas">Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                </div>
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3>No hay citas reservadas</h3>
                    <p>Las citas reservadas aparecer√°n en este listado</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contenido: Calendario -->
        <div id="tab-content-calendar" style="display: none;">
            <div id="calendar" style="max-width: 100%; margin: 0 auto;"></div>
        </div>

        <!-- Contenido: Citas Completadas -->
        <div id="tab-content-completed" style="display: none;">
            <div class="citas-results">
                {% if citas_completadas %}
                <div class="section-title-modern">
                    <div>
                        <h3><i class="fas fa-check-circle"></i> Citas Completadas</h3>
                        <p id="count-completadas">{{ citas_completadas|length }} cita(s) completada(s)</p>
                    </div>
                </div>

                <!-- Filtros de B√∫squeda - Completadas -->
                <div class="filtros-busqueda">
                    <div class="filtro-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="filtro-completadas-texto" placeholder="Buscar por cliente, servicio, dentista..." class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtro-completadas-fecha" class="filtro-input">
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-user-md"></i>
                        <select id="filtro-completadas-dentista" class="filtro-select">
                            <option value="">Todos los dentistas</option>
                            {% for dentista in dentistas %}
                            <option value="{{ dentista.nombre_completo }}">{{ dentista.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filtro-group">
                        <i class="fas fa-stethoscope"></i>
                        <select id="filtro-completadas-servicio" class="filtro-select">
                            <option value="">Todos los servicios</option>
                            {% for servicio in servicios %}
                            <option value="{{ servicio.nombre }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button onclick="aplicarFiltrosCompletadas()" class="btn-aplicar-filtros" title="Aplicar filtros">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                    <button onclick="limpiarFiltrosCompletadas()" class="btn-limpiar-filtros" title="Limpiar filtros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>

                <!-- Tabla de Citas Completadas -->
                <div class="tabla-citas-wrapper">
                    <table class="tabla-citas">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-day"></i> Fecha</th>
                                <th><i class="fas fa-clock"></i> Hora</th>
                                <th><i class="fas fa-tooth"></i> Tipo</th>
                                <th><i class="fas fa-info-circle"></i> Estado</th>
                                <th><i class="fas fa-user"></i> Cliente</th>
                                <th><i class="fas fa-cog"></i> Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cita in citas_completadas %}
                            <tr class="fila-cita completada"
                                data-fecha="{{ cita.fecha_hora|date:'Y-m-d' }}"
                                data-dentista="{% if cita.dentista %}{{ cita.dentista.nombre_completo }}{% else %}Sin asignar{% endif %}"
                                data-servicio="{% if cita.tipo_servicio %}{{ cita.tipo_servicio.nombre }}{% elif cita.tipo_consulta %}{{ cita.tipo_consulta }}{% else %}Sin servicio{% endif %}"
                                data-cliente="{{ cita.nombre_paciente }}">
                                <td class="col-fecha">{{ cita.fecha_hora|date:"d/m/Y" }}</td>
                                <td class="col-hora">{{ cita.fecha_hora|time:"H:i" }}</td>
                                <td class="col-tipo">
                                    {% if cita.tipo_servicio %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_servicio.nombre }}">
                                            <i class="fas fa-stethoscope"></i>
                                            {{ cita.tipo_servicio.nombre }}
                                        </span>
                                    {% elif cita.tipo_consulta %}
                                        <span class="tipo-servicio-badge" title="Servicio: {{ cita.tipo_consulta }}">
                                            <i class="fas fa-file-medical"></i>
                                            {{ cita.tipo_consulta }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted" title="Sin servicio asignado">
                                            <i class="fas fa-question-circle"></i>
                                            Sin servicio
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="col-estado">
                                    <span class="badge-estado completada">
                                        <i class="fas fa-check-circle"></i> Completada
                                    </span>
                                </td>
                                <td class="col-cliente">
                                    <div class="cliente-info-compact">
                                        <i class="fas fa-user"></i>
                                        {{ cita.nombre_paciente }}
                                    </div>
                                    {% if cita.email_paciente %}
                                    <small class="text-muted">{{ cita.email_paciente }}</small>
                                    {% endif %}
                                </td>
                                <td class="col-acciones">
                                    <button onclick="openOptionsModalForCita({{ cita.id }})" class="btn-accion">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <!-- Mensaje cuando no hay resultados despu√©s de filtrar -->
                    <div id="mensaje-sin-resultados-completadas" class="empty-results-modern" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 id="mensaje-titulo-completadas">No se encontraron resultados</h3>
                        <p id="mensaje-descripcion-completadas">Intenta ajustar los filtros de b√∫squeda</p>
                    </div>
                </div>
                {% else %}
                <div class="empty-results-modern">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>No hay citas completadas</h3>
                    <p>Las citas completadas aparecer√°n en este listado</p>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
    </div>
</div>
{% endif %}

<!-- Modal de Agregar Nueva Cita -->
<div id="addCitaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-plus"></i> Agregar Nueva Cita</h3>
            <button class="modal-close" onclick="closeAddCitaModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="post" action="javascript:void(0);" id="formAgregarCitaModal" data-action="{% url 'agregar_hora' %}">
                {% csrf_token %}
                <!-- Campo hidden para enviar el ID del servicio -->
                <input type="hidden" name="tipo_servicio" id="tipoServicioIdInput" value="">

                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                        <span class="required-badge">*</span>
                    </label>
                    <input type="datetime-local" name="fecha_hora" id="addCitaFechaHora" required class="form-control-modal" min="">
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        Selecciona el d√≠a y hora del turno (solo fechas futuras)
                    </small>
                </div>

                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select name="tipo_consulta" id="addCitaTipo" class="form-control-modal" required>
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>

                <!-- Selecci√≥n de Dentista -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                        <span class="required-badge">*</span>
                    </label>
                    <select name="dentista_id" id="addCitaDentista" class="form-control-modal" required>
                        <option value="">-- Seleccionar dentista --</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">
                            {{ dentista.nombre_completo }}
                            {% if dentista.especialidad %} - {{ dentista.especialidad }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        {{ dentistas|length }} dentista(s) disponible(s)
                    </small>
                </div>

                <!-- Asignar Cliente (Checkbox) -->
                <div class="form-group-modal">
                    <label class="checkbox-label-modern" for="asignarClienteCheck">
                        <input type="checkbox" id="asignarClienteCheck" name="asignar_cliente" onchange="toggleClienteFields()">
                        <span>
                            <i class="fas fa-user-plus"></i>
                            Asignar Cliente a esta Cita
                        </span>
                    </label>
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        Marca esta opci√≥n si el cliente est√° presente y necesita crear la cita inmediatamente
                    </small>
                </div>

                <!-- Campos de Cliente (Ocultos por defecto) -->
                <div id="clienteFieldsContainer" style="display: none;">
                    <div class="cliente-options-section">
                        <h4 style="margin: 0 0 16px 0; font-size: 1rem; font-weight: 600; color: #374151;">
                            <i class="fas fa-user"></i> Seleccionar Cliente
                        </h4>
                        
                        <!-- B√∫squeda de Cliente -->
                        <div class="form-group-modal">
                            <label class="form-label">
                                <i class="fas fa-search"></i>
                                Buscar Cliente
                            </label>
                            <div class="cliente-search-wrapper">
                                <input type="text" id="clienteSearchInput" class="form-control-modal" placeholder="Buscar por nombre o email..." autocomplete="off">
                                <i class="fas fa-search search-icon"></i>
                            </div>
                            <select id="clienteSelect" class="form-control-modal" style="display: none; visibility: hidden; position: absolute; width: 1px; height: 1px; opacity: 0;" onchange="handleClienteSelect()">
                                <option value="">-- Seleccionar cliente --</option>
                                {% if clientes %}
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}" data-nombre="{{ cliente.nombre_completo }}" data-email="{{ cliente.email }}" data-telefono="{{ cliente.telefono }}">
                                    {{ cliente.nombre_completo }} - {{ cliente.email }}
                                </option>
                                {% endfor %}
                                {% else %}
                                <option value="" disabled>No hay clientes disponibles</option>
                                {% endif %}
                            </select>
                            <input type="hidden" name="cliente_id" id="clienteIdInput" value="">
                            <div id="clienteResults" class="cliente-results-list"></div>
                            <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                                <i class="fas fa-info-circle"></i> Escribe el nombre o email del cliente para buscar
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Notas -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea name="notas" id="addCitaNotas" placeholder="Informaci√≥n relevante sobre la cita..." rows="3" class="form-control-modal"></textarea>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddCitaModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        Crear Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Simple para Citas Tomadas -->
<div id="citaInfoModal" class="modal-overlay">
    <div class="modal-content modal-container-simple">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Informaci√≥n de la Cita</h3>
            <button class="modal-close" onclick="closeCitaInfoModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Informaci√≥n de la Cita -->
            <div class="cita-info-card">
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-calendar-day"></i> Fecha
                    </div>
                    <div class="info-value" id="modalCitaFecha"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-clock"></i> Hora
                    </div>
                    <div class="info-value" id="modalCitaHora"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user"></i> Paciente
                    </div>
                    <div class="info-value" id="modalCitaPaciente"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-tooth"></i> Tipo de Consulta
                    </div>
                    <div class="info-value" id="modalCitaTipo"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-user-md"></i> Dentista
                    </div>
                    <div class="info-value" id="modalCitaDentista"></div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">
                        <i class="fas fa-info-circle"></i> Estado
                    </div>
                    <div class="info-value">
                        <span class="badge-estado" id="modalCitaEstado"></span>
                    </div>
                </div>
                
                <div class="info-item" id="infoFichaContainer" style="display: none;">
                    <div class="info-label">
                        <i class="fas fa-file-medical"></i> Ficha Odontol√≥gica
                    </div>
                    <div class="info-value" id="modalCitaFicha">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acci√≥n -->
            <div class="modal-actions-simple">
                <a href="#" id="btnCompletarCita" class="btn-action-completar" onclick="return validarCompletarCita()">
                    <i class="fas fa-check-double"></i>
                    <span>Completar Cita</span>
                </a>
                <a href="#" id="btnCancelarCita" class="btn-action-cancelar" onclick="return confirm('¬øCancelar esta cita?')">
                    <i class="fas fa-times-circle"></i>
                    <span>Cancelar Cita</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Editar Cita -->
<div id="optionsModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="optionsModalTitle"><i class="fas fa-edit"></i> Editar Cita</h3>
            <button class="modal-close" onclick="closeOptionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Contenedor para informaci√≥n de solo lectura (citas completadas) -->
            <div id="optionsInfoReadonly" style="display: none;">
                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                    </label>
                    <input type="text" id="optionsFechaHoraReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>
                
                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <input type="text" id="optionsTipoReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>
                
                <!-- Dentista Asignado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                    </label>
                    <input type="text" id="optionsDentistaReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>

                <!-- Paciente -->
                <div class="form-group-modal" id="pacienteInfoReadonly">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        Paciente
                    </label>
                    <input type="text" id="optionsPacienteReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                </div>

                <!-- Precio Actual -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-dollar-sign"></i>
                        Precio Actual
                    </label>
                    <input type="text" id="optionsPrecioReadonly" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed; font-weight: 600; color: var(--primary-color);">
                    <small style="color: #64748b; font-size: 0.75rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> Precio final cobrado por este servicio
                    </small>
                </div>

                <!-- Bot√≥n para ajustar precio -->
                <div class="modal-footer" style="margin-top: 24px;">
                    <a href="#" id="btnAjustarPrecio" class="btn-save-edit" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Ajustar Precio</span>
                    </a>
                </div>
            </div>

            <!-- Formulario para editar (citas disponibles) -->
            <form id="optionsForm" method="post" action="" style="display: none;">
                {% csrf_token %}
                
                <!-- Fecha y Hora -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar-day"></i>
                        Fecha y Hora
                    </label>
                    <input type="datetime-local" id="optionsFechaHora" name="fecha_hora" required class="form-control-modal">
                </div>
                
                <!-- Tipo de Consulta -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select id="optionsTipo" name="tipo_consulta" class="form-control-modal">
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>
                
                <!-- Dentista Asignado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-user-md"></i>
                        Dentista Asignado
                    </label>
                    <select id="optionsDentista" name="dentista_id" class="form-control-modal">
                        <option value="">Sin dentista asignado</option>
                        {% for dentista in dentistas %}
                        <option value="{{ dentista.id }}">{{ dentista.nombre_completo }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Estado -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-info-circle"></i>
                        Estado
                    </label>
                    <select id="optionsEstado" name="estado" class="form-control-modal" disabled style="background: #f1f5f9; cursor: not-allowed;">
                        <option value="disponible">üìÖ Disponible</option>
                        <option value="reservada">‚úÖ Reservada</option>
                        <option value="completada">‚úîÔ∏è Completada</option>
                        <option value="cancelada">‚ùå Cancelada</option>
                    </select>
                    <small style="color: #64748b; font-size: 0.875rem; display: block; margin-top: 4px;">
                        <i class="fas fa-lock"></i> El estado no se puede modificar directamente. Usa las opciones de confirmar, completar o cancelar cita.
                    </small>
                </div>

                <!-- Informaci√≥n del Paciente (solo lectura si existe) -->
                <div class="form-group-modal" id="pacienteInfo" style="display: none;">
                    <label class="form-label">
                        <i class="fas fa-user"></i>
                        Paciente
                    </label>
                    <input type="text" id="optionsPaciente" name="paciente" readonly class="form-control-modal" style="background: #f1f5f9; cursor: not-allowed;">
                    <small style="color: #64748b; font-size: 0.875rem; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> No se puede modificar el paciente de una cita reservada
                    </small>
                </div>
                
                <!-- Notas Adicionales -->
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea id="optionsNotas" name="notas" rows="3" class="form-control-modal" placeholder="Informaci√≥n adicional sobre la cita..."></textarea>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="modal-footer">
                    <button type="button" class="btn-delete-edit" onclick="confirmarEliminarCita(event)">
                        <i class="fas fa-trash-alt"></i>
                        <span>Eliminar Cita</span>
                    </button>
                    <button type="submit" class="btn-save-edit">
                        <i class="fas fa-save"></i>
                        <span>Guardar Cambios</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
<div id="confirmDeleteModal" class="modal-overlay">
    <div class="modal-content modal-confirm">
        <div class="modal-header modal-header-warning">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminaci√≥n</h3>
            <button class="modal-close" onclick="closeConfirmDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Estado de la Cita -->
            <div class="confirm-status-box" id="confirmStatusBox">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Estado de la cita:</strong>
                    <span id="confirmEstadoText"></span>
                </div>
            </div>

            <!-- Mensaje de advertencia si est√° tomada -->
            <div class="confirm-warning-box" id="confirmWarningBox" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>‚ö†Ô∏è IMPORTANTE:</strong>
                    <p>Esta cita est√° <strong>RESERVADA</strong> por un cliente.</p>
                    <p><strong>Datos del cliente:</strong></p>
                    <ul>
                        <li><strong>Nombre:</strong> <span id="confirmClienteNombre"></span></li>
                        <li><strong>Email:</strong> <span id="confirmClienteEmail"></span></li>
                        <li><strong>Tel√©fono:</strong> <span id="confirmClienteTelefono"></span></li>
                    </ul>
                    <p style="margin-top: 12px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                        <i class="fas fa-phone"></i> 
                        <strong>Por favor, contacte al cliente antes de eliminar esta cita</strong> para informarle sobre la cancelaci√≥n y, si es posible, ofrecerle una alternativa.
                    </p>
                </div>
            </div>

            <!-- Mensaje para citas disponibles -->
            <div class="confirm-info-box" id="confirmInfoBox" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <p>Esta cita est√° disponible y puede ser eliminada sin inconvenientes.</p>
            </div>

            <!-- Pregunta de confirmaci√≥n -->
            <div class="confirm-question">
                <p><strong>¬øEst√° seguro de que desea eliminar esta cita?</strong></p>
                <p style="color: #64748b; font-size: 0.875rem;">Esta acci√≥n no se puede deshacer.</p>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="modal-actions-confirm">
                <button type="button" class="btn-cancel-confirm" onclick="closeConfirmDeleteModal()">
                    <i class="fas fa-times"></i>
                    <span>Cancelar</span>
                </button>
                <button type="button" class="btn-confirm-delete" onclick="ejecutarEliminarCita()">
                    <i class="fas fa-trash"></i>
                    <span>S√≠, Eliminar Cita</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Editar Cita -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Cita</h3>
            <button class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editForm" method="post" action="">
                {% csrf_token %}
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Fecha y Hora
                    </label>
                    <input type="datetime-local" name="fecha_hora" id="editFechaHora" required class="form-control-modal">
                </div>
                
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-tooth"></i>
                        Tipo de Consulta
                    </label>
                    <select name="tipo_consulta" id="editTipoConsulta" class="form-control-modal">
                        <option value="">-- Seleccionar Servicio --</option>
                        {% if servicios %}
                        {% regroup servicios by categoria as servicios_por_categoria %}
                        {% for categoria_group in servicios_por_categoria %}
                        <optgroup label="{{ categoria_group.grouper|title }}">
                            {% for servicio in categoria_group.list %}
                            <option value="{{ servicio.nombre }}" data-precio="{{ servicio.precio_base }}" data-servicio-id="{{ servicio.id }}">
                                {{ servicio.nombre }} - {{ servicio.precio_base|pesos_chilenos }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                        {% else %}
                        <option value="" disabled>No hay servicios disponibles</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group-modal">
                    <label class="form-label">
                        <i class="fas fa-sticky-note"></i>
                        Notas Adicionales
                    </label>
                    <textarea name="notas" id="editNotas" rows="3" class="form-control-modal" placeholder="Informaci√≥n adicional sobre la consulta..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalles de Cita -->
<div id="appointmentModal" class="modal-overlay">
    <div class="modal-content appointment-details-modal">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-check"></i> Detalles de la Cita</h3>
            <button class="modal-close" onclick="closeAppointmentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="appointment-details">
                <div class="detail-section">
                    <div class="detail-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div class="detail-content">
                            <label>Fecha y Hora</label>
                            <span id="appointmentDateTime"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-tooth"></i>
                        <div class="detail-content">
                            <label>Tipo de Consulta</label>
                            <span id="appointmentType"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-user"></i>
                        <div class="detail-content">
                            <label>Paciente</label>
                            <span id="appointmentPatient"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="detail-content">
                            <label>Estado</label>
                            <span id="appointmentStatus" class="status-badge"></span>
                        </div>
                    </div>
                    
                    <div class="detail-item full-width">
                        <i class="fas fa-sticky-note"></i>
                        <div class="detail-content">
                            <label>Notas</label>
                            <span id="appointmentNotes"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeAppointmentModal()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
                <button type="button" class="btn-primary" id="editAppointmentBtn" onclick="editAppointmentFromCalendar()">
                    <i class="fas fa-edit"></i>
                    Editar Cita
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Contenedor Principal */
    .layout-container {
        width: 100%;
        overflow-x: hidden;
    }

    /* Layout Estilo Despegar */
    .despegar-layout {
        display: flex;
        gap: 0;
        min-height: calc(100vh - 140px);
        background: #f8fafc;
        width: 100%;
        position: relative;
    }

    /* Header con acciones (tabs + bot√≥n agregar) */
    .content-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .btn-add-cita {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        white-space: nowrap;
    }

    .btn-add-cita:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-darker));
    }

    .btn-add-cita:active {
        transform: translateY(0);
    }

    .btn-add-cita i {
        font-size: 1rem;
    }

    /* Estilos para checkbox moderno */
    .checkbox-label-modern {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        color: #374151;
        font-size: 0.9375rem;
    }

    .checkbox-label-modern:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .checkbox-label-modern input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--primary-color);
    }

    .checkbox-label-modern span {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .checkbox-label-modern i {
        color: var(--primary-color);
    }

    /* Secci√≥n de cliente */
    .cliente-options-section {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-top: 12px;
    }

    .cliente-options-section h4 {
        margin: 0 0 16px 0;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .cliente-options-section h4 i {
        color: var(--primary-color);
    }

    .divider-option {
        text-align: center;
        margin: 20px 0;
        position: relative;
    }

    .divider-option::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background: #e2e8f0;
    }

    .divider-option span {
        background: #f8fafc;
        padding: 0 16px;
        color: #6b7280;
        font-weight: 600;
        font-size: 0.875rem;
        position: relative;
    }

    /* B√∫squeda de Cliente */
    .cliente-search-wrapper {
        position: relative;
    }

    .cliente-search-wrapper .search-icon {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }

    .cliente-results-list {
        margin-top: 8px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        display: none;
    }

    .cliente-results-list.show {
        display: block;
    }

    .cliente-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .cliente-result-item:last-child {
        border-bottom: none;
    }

    .cliente-result-item:hover {
        background: var(--primary-bg);
        border-left: 3px solid var(--primary-color);
    }

    .cliente-result-item.selected {
        background: var(--primary-bg);
        border-left: 3px solid var(--primary-color);
    }

    .cliente-result-nombre {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.875rem;
    }

    .cliente-result-email {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .cliente-results-list.empty {
        padding: 20px;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .sidebar-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .section-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    /* Botones de Tipo de Cita */
    .trip-type-buttons {
        display: flex;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        overflow: hidden;
    }

    .trip-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: white;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .trip-btn:hover {
        background: #f3f4f6;
    }

    .trip-btn.active {
        background: var(--primary-color);
        color: white;
    }

    /* Form Info */
    .form-info {
        padding: 12px 16px;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }

    .form-info p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
        font-style: italic;
    }

    /* Inputs de Fecha */
    .date-input {
        position: relative;
        display: flex;
        align-items: center;
    }

    .date-input i {
        position: absolute;
        left: 12px;
        color: #6b7280;
        z-index: 1;
    }

    .date-input input {
        width: 100%;
        padding: 12px 12px 12px 40px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
    }

    .date-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Select Personalizado */
    .select-wrapper {
        position: relative;
    }

    .custom-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
    }

    .custom-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Textarea */
    textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        resize: vertical;
        font-family: inherit;
    }

    textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Bot√≥n de B√∫squeda */
    .search-btn {
        width: 100%;
        padding: 16px 24px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .search-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Contenido Principal */
    .main-content-area {
        flex: 1;
        background: white;
        padding: 24px;
        min-width: 0;
        overflow-x: auto;
        position: relative;
        width: 100%;
    }

    /* Tabs de Resultados */
    .results-tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid #e2e8f0;
        flex: 1;
    }

    .tab-btn {
        padding: 12px 24px;
        border: none;
        background: none;
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .tab-btn:hover {
        color: var(--primary-color);
    }

    .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    /* Filtros de Resultados */
    .results-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        align-items: center;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .alert-btn {
        padding: 8px 16px;
        border: 1px solid var(--primary-color);
        background: white;
        color: var(--primary-color);
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .alert-btn:hover {
        background: var(--primary-color);
        color: white;
    }

    /* Tarjetas de Resultados */
    .citas-results {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        max-width: 100%;
    }

    .cita-result-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.2s ease;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    .cita-result-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .cita-result-card.disponible {
        border-left: 4px solid #10b981;
    }

    .cita-result-card.tomada {
        border-left: 4px solid #f59e0b;
    }

    /* Nueva estructura de citas */
    .cita-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cita-fecha-hora {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .cita-fecha,
    .cita-hora {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .cita-tipo {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #374151;
        font-weight: 500;
    }

    .cita-estado {
        min-width: 120px;
        display: flex;
        justify-content: center;
    }

    .estado-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .estado-badge.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .estado-badge.reservada {
        background: #dbeafe;
        color: #1e40af;
    }


    .estado-badge.completada {
        background: #fef3c7;
        color: #92400e;
    }

    .cita-paciente {
        min-width: 150px;
        display: flex;
        justify-content: center;
    }

    .paciente-info {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .paciente-info span {
        font-weight: 500;
        color: #374151;
    }

    /* Informaci√≥n de Aerol√≠nea/Cl√≠nica */
    .cita-airline {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 200px;
    }

    .airline-logo {
        width: 40px;
        height: 40px;
        background: var(--primary-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .airline-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .airline-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.875rem;
    }

    .rating-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .rating-badge.good {
        background: #dcfce7;
        color: #166534;
    }

    .rating-badge.excellent {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Detalles de la Cita */
    .cita-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .cita-route {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .route-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
    }

    .time {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }

    .date {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .route-line {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        flex: 1;
    }

    .line {
        width: 100%;
        height: 2px;
        background: #d1d5db;
        position: relative;
    }

    .line::after {
        content: '';
        position: absolute;
        right: 0;
        top: -3px;
        width: 0;
        height: 0;
        border-left: 6px solid #d1d5db;
        border-top: 4px solid transparent;
        border-bottom: 4px solid transparent;
    }

    .duration {
        font-size: 0.75rem;
        color: #6b7280;
        background: #f8fafc;
        padding: 2px 8px;
        border-radius: 4px;
    }

    .cita-type {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
    }

    .cita-patient {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* Precio y Acciones */
    .cita-price {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-width: 120px;
    }

    .price-main {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
    }

    .price-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .cita-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 120px;
    }

    /* T√≠tulos de secci√≥n */
    .section-title {
        margin: 24px 0 16px 0;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .section-title h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-title p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
    }

    /* Informaci√≥n del dentista */
    .dentista-info {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 6px 12px;
        background: #f1f5f9;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #475569;
    }

    .dentista-info i {
        color: var(--primary-color);
        font-size: 0.875rem;
    }

    /* Modal de Opciones - Usar mismo estilo que modal de editar */
    .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
    }

    .form-actions .btn {
        flex: 1;
        min-width: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .form-actions .btn i {
        font-size: 1rem;
    }

    .form-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .form-actions .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .form-actions .btn-primary:hover {
        background: var(--primary-dark);
    }

    .form-actions .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .form-actions .btn-secondary:hover {
        background: #4b5563;
    }

    .form-actions .btn-success {
        background: #10b981;
        color: white;
    }

    .form-actions .btn-success:hover {
        background: #059669;
    }

    .form-actions .btn-info {
        background: #06b6d4;
        color: white;
    }

    .form-actions .btn-info:hover {
        background: #0891b2;
    }

    .form-actions .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .form-actions .btn-warning:hover {
        background: #d97706;
    }

    .form-actions .btn-danger {
        background: #ef4444;
        color: white;
    }

    .form-actions .btn-danger:hover {
        background: #dc2626;
    }


    .option-btn.info {
        color: #0891b2;
        border-color: #cffafe;
    }

    .option-btn.info:hover {
        background: #f0f9ff;
        border-color: #0891b2;
    }

    .option-btn.danger {
        color: #dc2626;
        border-color: #fee2e2;
    }

    .option-btn.danger:hover {
        background: #fef2f2;
        border-color: #dc2626;
    }

    .action-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .action-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
    }

    .action-btn.primary {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.primary:hover {
        background: var(--primary-dark);
    }

    .action-btn.success {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.success:hover {
        background: var(--primary-dark);
    }

    .action-btn.danger {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .action-btn.danger:hover {
        background: var(--primary-dark);
    }

    .action-btn.secondary {
        background: #f8fafc;
        color: #6b7280;
        border-color: #e2e8f0;
    }

    /* Estado Vac√≠o */
    .empty-results {
        text-align: center;
        padding: 48px 24px;
        color: #6b7280;
    }

    .empty-results i {
        font-size: 3rem;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .empty-results h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #374151;
    }

    .empty-results p {
        font-size: 0.875rem;
        margin: 0;
    }

    /* Stats */
    .stats { 
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin: 15px 0; 
    }

    .stats-horizontal {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    
    .stat-box { 
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white; 
        padding: 16px; 
        border-radius: 8px; 
        text-align: center; 
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }
    
    .stat-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }
    
    .stat-box h3 { 
        margin: 0 0 4px 0; 
        font-size: 1.8rem; 
        font-weight: 700;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-box p { 
        margin: 0; 
        font-size: 0.75rem; 
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-container,
    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }
    
    /* Modal Simple Styles */
    .modal-container-simple {
        background: white;
        border-radius: 16px;
        max-width: 450px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
    }
    
    .modal-large {
        max-width: 900px;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cita-info-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .cita-info-card .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .info-value {
        font-size: 0.875rem;
        color: #1e293b;
        font-weight: 500;
        text-align: right;
    }
    
    .modal-actions-simple {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    
    .btn-action-completar,
    .btn-action-cancelar {
        flex: 1;
        padding: 14px 20px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
        text-decoration: none;
        color: white;
    }
    
    .btn-action-completar {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .btn-action-completar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-action-cancelar {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .btn-action-cancelar:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }

    .modal-header {
        padding: 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    }

    .modal-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: #ef4444;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .modal-body {
        padding: 24px;
    }

    .form-group,
    .form-group-modal {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group-modal label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-input,
    .form-select,
    .form-textarea,
    .form-control-modal {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus,
    .form-control-modal:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    select.form-control-modal,
    select.form-select {
        cursor: pointer;
    }

    .modal-actions,
    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-secondary {
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-secondary:hover {
        background: #f1f5f9;
        color: #475569;
        border-color: #cbd5e1;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary:hover {
        background: var(--primary-darker, #2563eb);
        border-color: var(--primary-darker, #2563eb);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }


    /* Appointment Details Modal */
    .appointment-details-modal {
        max-width: 600px;
    }

    .appointment-details {
        margin-bottom: 20px;
    }

    .detail-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }

    .detail-item.full-width {
        flex-direction: column;
        gap: 8px;
    }

    .detail-item i {
        color: #3b82f6;
        font-size: 1.1rem;
        margin-top: 2px;
        min-width: 20px;
    }

    .detail-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-content label {
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-content span {
        color: #1f2937;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.reservada {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-badge.confirmada {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-badge.completada {
        background: #fef3c7;
        color: #92400e;
    }

    /* Calendar Event Styling */
    .fc-event {
        border-radius: 6px !important;
        border: none !important;
        font-weight: 500 !important;
        font-size: 0.8rem !important;
        padding: 2px 6px !important;
    }

    .fc-event-title {
        font-weight: 600 !important;
    }

    .fc-daygrid-event {
        margin: 1px 0 !important;
    }

    .fc-timegrid-event {
        border-radius: 4px !important;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .content-header-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .results-tabs {
            width: 100%;
        }

        .btn-add-cita {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .cita-result-card {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        
        .cita-airline {
            min-width: auto;
            width: 100%;
        }
        
        .cita-route {
            width: 100%;
            justify-content: space-between;
        }
        
        .cita-actions {
            width: 100%;
            flex-direction: row;
        }
        
        .results-filters {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .modal-container {
            width: 95%;
            max-width: 400px;
        }
        
        .modal-body {
            padding: 16px;
        }
        
        .modal-actions {
            flex-direction: column;
            gap: 8px;
        }
        
        .modal-actions .btn {
            width: 100%;
        }
    }

    /* ========== ESTILOS MODERNOS - FORMULARIO ========== */
    .sidebar-header-modern {
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f1f5f9;
    }

    .header-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .header-icon i {
        font-size: 1.5rem;
        color: white;
    }

    .header-text h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .header-text p {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }

    .search-form-modern {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .form-group-modern {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .label-modern {
        font-size: 0.875rem;
        font-weight: 600;
        color: #334155;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .label-modern i {
        color: var(--primary-color);
        font-size: 1rem;
    }

    .required-badge {
        background: #ef4444;
        color: white;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
    }

    .input-wrapper-modern {
        position: relative;
    }

    .input-modern,
    .select-modern,
    .textarea-modern {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        color: #334155;
        background: white;
        transition: all 0.2s ease;
    }

    .input-modern:focus,
    .select-modern:focus,
    .textarea-modern:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .select-modern {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233b82f6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 40px;
    }

    .textarea-modern {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }

    .hint-text {
        font-size: 0.75rem;
        color: #94a3b8;
        font-style: italic;
    }

    .btn-submit-modern {
        width: 100%;
        padding: 14px 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        margin-top: 8px;
    }

    .btn-submit-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-submit-modern:active {
        transform: translateY(0);
    }

    /* ========== ESTILOS MODERNOS - TABLA DE CITAS ========== */
    .section-title-modern {
        margin-bottom: 20px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-left: 4px solid var(--primary-color);
        border-radius: 8px;
    }

    .section-title-modern h3 {
        margin: 0 0 4px 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title-modern h3 i {
        color: var(--primary-color);
    }

    .section-title-modern p {
        margin: 0;
        font-size: 0.875rem;
        color: #64748b;
    }

    /* Estilos para Filtros de B√∫squeda */
    .filtros-busqueda {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
        padding: 16px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        align-items: center;
    }

    .filtro-group {
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .filtro-group i {
        color: #64748b;
        font-size: 0.875rem;
        position: absolute;
        left: 12px;
        z-index: 1;
    }

    .filtro-input,
    .filtro-select {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s ease;
    }

    .filtro-input:focus,
    .filtro-select:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .btn-aplicar-filtros {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: #3b82f6;
        color: white;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-aplicar-filtros:hover {
        background: #2563eb;
        border-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
    }

    .btn-aplicar-filtros:active {
        transform: translateY(0);
    }

    .btn-limpiar-filtros {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        background: #f1f5f9;
        color: #475569;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-limpiar-filtros:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: #334155;
    }

    .fila-cita[style*="display: none"] {
        display: none !important;
    }

    .cita-result-card[style*="display: none"] {
        display: none !important;
    }

    .tabla-citas-wrapper {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .tabla-citas {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    
    /* Anchos espec√≠ficos para cada columna */
    .tabla-citas .col-fecha { width: 12%; }
    .tabla-citas .col-hora { width: 10%; }
    .tabla-citas .col-tipo { width: 15%; }
    .tabla-citas .col-estado { width: 13%; }
    .tabla-citas .col-cliente { width: 20%; }
    .tabla-citas .col-dentista { width: 20%; }
    .tabla-citas .col-acciones { width: 10%; min-width: 80px; }

    .tabla-citas thead {
        background: linear-gradient(135deg, #1e293b, #334155);
        color: white;
    }

    .tabla-citas thead th {
        padding: 16px 14px;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .tabla-citas thead th i {
        margin-right: 6px;
        opacity: 0.9;
    }

    .tabla-citas tbody tr {
        border-bottom: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }

    .tabla-citas tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.005);
    }

    .tabla-citas tbody td {
        padding: 16px 14px;
        font-size: 0.875rem;
        color: #334155;
        vertical-align: middle;
    }

    .col-fecha {
        font-weight: 600;
        color: #1e293b;
        white-space: nowrap;
    }

    .col-hora {
        font-weight: 600;
        color: var(--primary-color);
        white-space: nowrap;
    }

    .col-tipo {
        color: #64748b;
    }

    .tipo-servicio-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: #eff6ff;
        color: #1e40af;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .tipo-servicio-badge i {
        color: #3b82f6;
        font-size: 0.875rem;
    }

    .tipo-consulta-text {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #475569;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .tipo-consulta-text i {
        color: #64748b;
        font-size: 0.875rem;
    }

    .col-tipo .text-muted {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .col-tipo .text-muted i {
        color: #94a3b8;
        font-size: 0.875rem;
    }

    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .badge-estado.disponible {
        background: #dcfce7;
        color: #166534;
    }

    .badge-estado.disponible i {
        color: #16a34a;
    }

    .badge-estado.reservada {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-estado.reservada i {
        color: #3b82f6;
    }

    .badge-estado.completada {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado.completada i {
        color: #f59e0b;
    }

    .col-cliente,
    .col-dentista {
        max-width: 200px;
    }

    .cliente-info-compact,
    .dentista-info-compact {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .cliente-info-compact i,
    .dentista-info-compact i {
        color: #3b82f6;
        font-size: 0.875rem;
    }

    .text-muted {
        color: #94a3b8;
        font-style: italic;
        font-size: 0.75rem;
    }

    .col-acciones {
        text-align: center;
        padding: 8px !important;
    }

    .btn-accion {
        padding: 8px 12px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        min-width: 40px;
        min-height: 40px;
    }

    .btn-accion:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .empty-results-modern {
        text-align: center;
        padding: 60px 24px;
        background: white;
        border-radius: 12px;
        border: 2px dashed #e2e8f0;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .empty-icon i {
        font-size: 2.5rem;
        color: #94a3b8;
    }

    .empty-results-modern h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #334155;
        margin: 0 0 8px 0;
    }

    .empty-results-modern p {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }

    /* Responsive para tabla */
    @media (max-width: 1200px) {
        .tabla-citas {
            font-size: 0.8rem;
        }

        .tabla-citas thead th,
        .tabla-citas tbody td {
            padding: 12px 10px;
        }
    }

    /* ========== MODAL DE EDICI√ìN MEJORADO ========== */
    .modal-actions-edit {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .btn-save-edit {
        flex: 1;
        padding: 12px 20px;
        background: var(--primary-color);
        color: white;
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-save-edit:hover {
        background: var(--primary-darker, #2563eb);
        border-color: var(--primary-darker, #2563eb);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-save-edit:active {
        transform: translateY(0);
    }

    .btn-delete-edit {
        padding: 12px 20px;
        background: white;
        color: #ef4444;
        border: 1px solid #ef4444;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s ease;
    }

    .btn-delete-edit:hover {
        background: #ef4444;
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        transform: translateY(-1px);
    }

    .btn-delete-edit:active {
        transform: translateY(0);
    }

    /* ========== MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN ========== */
    .modal-confirm {
        max-width: 600px;
    }

    .modal-header-warning {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-bottom: 2px solid #f59e0b;
    }

    .modal-header-warning h3 {
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-header-warning h3 i {
        color: #f59e0b;
        font-size: 1.5rem;
    }

    .confirm-status-box {
        background: #f1f5f9;
        border-left: 4px solid #3b82f6;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .confirm-status-box i {
        color: #3b82f6;
        font-size: 1.25rem;
        margin-top: 2px;
    }

    .confirm-status-box strong {
        color: #1e293b;
        font-weight: 600;
    }

    .confirm-status-box span {
        color: #64748b;
        font-weight: 500;
    }

    .confirm-warning-box {
        background: #fef2f2;
        border: 2px solid #fca5a5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
    }

    .confirm-warning-box i {
        color: #dc2626;
        font-size: 1.5rem;
        margin-right: 12px;
        float: left;
    }

    .confirm-warning-box strong {
        color: #991b1b;
        font-size: 1rem;
    }

    .confirm-warning-box p {
        color: #7f1d1d;
        margin: 8px 0;
        line-height: 1.6;
    }

    .confirm-warning-box ul {
        margin: 12px 0;
        padding-left: 20px;
        color: #7f1d1d;
    }

    .confirm-warning-box li {
        margin: 6px 0;
    }

    .confirm-info-box {
        background: #f0fdf4;
        border-left: 4px solid #10b981;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .confirm-info-box i {
        color: #10b981;
        font-size: 1.25rem;
    }

    .confirm-info-box p {
        color: #166534;
        margin: 0;
        font-weight: 500;
    }

    .confirm-question {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
        text-align: center;
    }

    .confirm-question p:first-child {
        color: #1e293b;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .modal-actions-confirm {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-cancel-confirm {
        padding: 12px 24px;
        background: white;
        color: #64748b;
        border: 2px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-cancel-confirm:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #475569;
    }

    .btn-confirm-delete {
        padding: 12px 24px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-confirm-delete:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        transform: translateY(-1px);
    }

    .btn-confirm-delete:active {
        transform: translateY(0);
    }
</style>

<!-- FullCalendar CDN -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/locales/es.global.min.js"></script>

<script>
// Variables globales
var citasDataMap = {};
var currentCitaData = null;

// Funciones globales para b√∫squeda de clientes (definidas antes de DOMContentLoaded)
window.searchClientes = function() {
    var searchInput = document.getElementById('clienteSearchInput');
    var clienteSelect = document.getElementById('clienteSelect');
    var resultsList = document.getElementById('clienteResults');
    var clienteIdInput = document.getElementById('clienteIdInput');
    
    if (!searchInput || !clienteSelect || !resultsList) {
        console.error('Elementos de b√∫squeda no encontrados:', {
            searchInput: !!searchInput,
            clienteSelect: !!clienteSelect,
            resultsList: !!resultsList
        });
        return;
    }
    
    var searchTerm = searchInput.value.toLowerCase().trim();
    resultsList.innerHTML = '';
    
    if (searchTerm.length === 0) {
        resultsList.classList.remove('show');
        if (clienteIdInput) clienteIdInput.value = '';
        return;
    }
    
    var matches = [];
    var options = clienteSelect.getElementsByTagName('option');
    
    console.log('Buscando "' + searchTerm + '" en', options.length, 'opciones');
    
    // Verificar que hay opciones
    if (options.length === 0 || (options.length === 1 && options[0].value === '')) {
        console.warn('No hay opciones de clientes disponibles en el select');
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'cliente-results-list empty';
        emptyDiv.textContent = 'No hay clientes disponibles';
        resultsList.appendChild(emptyDiv);
        resultsList.classList.add('show');
        return;
    }
    
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (!option.value || option.value === '' || option.disabled) continue;
        
        var nombre = option.getAttribute('data-nombre') || '';
        var email = option.getAttribute('data-email') || '';
        
        // Si no hay data attributes, intentar extraer del texto del option
        if (!nombre && !email) {
            var optionText = option.textContent || option.innerText || '';
            var parts = optionText.split(' - ');
            if (parts.length >= 2) {
                nombre = parts[0].trim();
                email = parts[1].trim();
            } else if (parts.length === 1) {
                nombre = parts[0].trim();
            }
        }
        
        // Buscar en nombre o email
        var nombreMatch = nombre && nombre.toLowerCase().includes(searchTerm);
        var emailMatch = email && email.toLowerCase().includes(searchTerm);
        
        if (nombreMatch || emailMatch) {
            matches.push({
                id: option.value,
                nombre: nombre || 'Sin nombre',
                email: email || 'Sin email',
                telefono: option.getAttribute('data-telefono') || ''
            });
        }
    }
    
    console.log('Encontrados', matches.length, 'coincidencias');
    
    if (matches.length === 0) {
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'cliente-results-list empty';
        emptyDiv.textContent = 'No se encontraron clientes';
        resultsList.appendChild(emptyDiv);
        resultsList.classList.add('show');
        return;
    }
    
    // Mostrar m√°ximo 8 resultados
    var maxResults = Math.min(matches.length, 8);
    for (var j = 0; j < maxResults; j++) {
        var match = matches[j];
        var item = document.createElement('div');
        item.className = 'cliente-result-item';
        item.setAttribute('data-id', match.id);
        item.innerHTML = '<div class="cliente-result-nombre">' + match.nombre + '</div>' +
                        '<div class="cliente-result-email">' + match.email + '</div>';
        
        item.addEventListener('click', function() {
            var clienteId = this.getAttribute('data-id');
            if (clienteIdInput) clienteIdInput.value = clienteId;
            
            // Actualizar input con el nombre seleccionado
            var nombre = this.querySelector('.cliente-result-nombre').textContent;
            var email = this.querySelector('.cliente-result-email').textContent;
            if (searchInput) {
                searchInput.value = nombre + ' - ' + email;
            }
            
            // Marcar como seleccionado
            var items = resultsList.querySelectorAll('.cliente-result-item');
            items.forEach(function(item) {
                item.classList.remove('selected');
            });
            this.classList.add('selected');
            
            // Ocultar resultados despu√©s de un breve delay
            setTimeout(function() {
                resultsList.classList.remove('show');
            }, 200);
        });
        
        resultsList.appendChild(item);
    }
    
    resultsList.classList.add('show');
};

window.initClienteSearch = function() {
    var searchInput = document.getElementById('clienteSearchInput');
    if (!searchInput) {
        console.log('clienteSearchInput no encontrado al inicializar');
        return;
    }
    
    // Remover event listeners anteriores usando un flag
    if (searchInput.hasAttribute('data-search-initialized')) {
        return; // Ya est√° inicializado
    }
    
    searchInput.setAttribute('data-search-initialized', 'true');
    
    // Agregar event listener para b√∫squeda en tiempo real
    searchInput.addEventListener('input', function(e) {
        e.stopPropagation();
        // Llamar despu√©s de un peque√±o delay para evitar b√∫squedas mientras se escribe
        var input = this;
        clearTimeout(input.searchTimeout);
        input.searchTimeout = setTimeout(function() {
            searchClientes();
        }, 150);
    }, false);
    
    // Manejar teclas especiales
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var resultsList = document.getElementById('clienteResults');
            if (resultsList) {
                resultsList.classList.remove('show');
            }
        }
    }, false);
    
    // Ocultar resultados al hacer clic fuera (solo una vez)
    if (!window.clienteSearchClickHandler) {
        window.clienteSearchClickHandler = function(e) {
            var resultsList = document.getElementById('clienteResults');
            var searchInput = document.getElementById('clienteSearchInput');
            if (resultsList && searchInput && !resultsList.contains(e.target) && e.target !== searchInput && !searchInput.contains(e.target)) {
                resultsList.classList.remove('show');
            }
        };
        document.addEventListener('click', window.clienteSearchClickHandler, true);
    }
};

// Funciones globales para el modal de agregar cita (definidas antes de DOMContentLoaded)
window.openAddCitaModal = function() {
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Limpiar el formulario
        var form = document.getElementById('formAgregarCitaModal');
        if (form) {
            form.reset();
        }
        
        // Establecer fecha m√≠nima (hoy) en el campo de fecha
        var fechaInput = document.getElementById('addCitaFechaHora');
        if (fechaInput) {
            var ahora = new Date();
            // Ajustar al timezone local y formatear para datetime-local (YYYY-MM-DDTHH:mm)
            var a√±o = ahora.getFullYear();
            var mes = String(ahora.getMonth() + 1).padStart(2, '0');
            var dia = String(ahora.getDate()).padStart(2, '0');
            var hora = String(ahora.getHours()).padStart(2, '0');
            var minuto = String(ahora.getMinutes()).padStart(2, '0');
            var fechaMinima = a√±o + '-' + mes + '-' + dia + 'T' + hora + ':' + minuto;
            fechaInput.setAttribute('min', fechaMinima);
        }
        
        // Limpiar validaci√≥n de horario cuando se abre el modal
        var dentistaSelect = document.getElementById('addCitaDentista');
        if (dentistaSelect) {
            dentistaSelect.value = '';
        }
        
        // Ocultar campos de cliente por defecto
        var clienteFields = document.getElementById('clienteFieldsContainer');
        var clienteCheck = document.getElementById('asignarClienteCheck');
        if (clienteFields) {
            clienteFields.style.display = 'none';
        }
        if (clienteCheck) {
            clienteCheck.checked = false;
        }
        
        // Resetear campos de cliente
        var searchInput = document.getElementById('clienteSearchInput');
        var clienteSelect = document.getElementById('clienteSelect');
        var clienteIdInput = document.getElementById('clienteIdInput');
        var resultsList = document.getElementById('clienteResults');
        if (searchInput) {
            searchInput.value = '';
            searchInput.removeAttribute('data-search-initialized');
        }
        if (clienteSelect) {
            clienteSelect.value = '';
        }
        if (clienteIdInput) {
            clienteIdInput.value = '';
        }
        if (resultsList) {
            resultsList.innerHTML = '';
            resultsList.classList.remove('show');
        }
        
        // Inicializar b√∫squeda de clientes si el checkbox est√° marcado
        var clienteCheck = document.getElementById('asignarClienteCheck');
        if (clienteCheck && clienteCheck.checked) {
            setTimeout(function() {
                initClienteSearch();
            }, 100);
        }
        
        // Enfocar en el primer campo despu√©s de un peque√±o delay
        setTimeout(function() {
            var fechaInput = document.getElementById('addCitaFechaHora');
            if (fechaInput) {
                fechaInput.focus();
            }
        }, 100);
    }
}

window.closeAddCitaModal = function() {
    var modal = document.getElementById('addCitaModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        
        // Limpiar el formulario
        var form = document.getElementById('formAgregarCitaModal');
        if (form) {
            form.reset();
        }
        
        // Ocultar campos de cliente
        var clienteFields = document.getElementById('clienteFieldsContainer');
        var clienteCheck = document.getElementById('asignarClienteCheck');
        var searchInput = document.getElementById('clienteSearchInput');
        var clienteSelect = document.getElementById('clienteSelect');
        var clienteIdInput = document.getElementById('clienteIdInput');
        var resultsList = document.getElementById('clienteResults');
        if (clienteFields) {
            clienteFields.style.display = 'none';
        }
        if (clienteCheck) {
            clienteCheck.checked = false;
        }
        if (searchInput) {
            searchInput.value = '';
            searchInput.removeAttribute('data-search-initialized');
        }
        if (clienteSelect) {
            clienteSelect.value = '';
        }
        if (clienteIdInput) {
            clienteIdInput.value = '';
        }
        if (resultsList) {
            resultsList.innerHTML = '';
            resultsList.classList.remove('show');
        }
    }
}

// Funci√≥n para mostrar/ocultar campos de cliente
window.toggleClienteFields = function() {
    var check = document.getElementById('asignarClienteCheck');
    var container = document.getElementById('clienteFieldsContainer');
    
    if (check && container) {
        if (check.checked) {
            container.style.display = 'block';
            // Inicializar b√∫squeda de clientes
            setTimeout(function() {
                initClienteSearch();
                var searchInput = document.getElementById('clienteSearchInput');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 100);
        } else {
            container.style.display = 'none';
            // Limpiar campos cuando se oculta
            var searchInput = document.getElementById('clienteSearchInput');
            var clienteSelect = document.getElementById('clienteSelect');
            var clienteIdInput = document.getElementById('clienteIdInput');
            var resultsList = document.getElementById('clienteResults');
            if (searchInput) searchInput.value = '';
            if (clienteSelect) clienteSelect.value = '';
            if (clienteIdInput) clienteIdInput.value = '';
            if (resultsList) {
                resultsList.innerHTML = '';
                resultsList.classList.remove('show');
            }
        }
    }
}

// Funci√≥n para manejar selecci√≥n de cliente
window.handleClienteSelect = function() {
    var clienteSelect = document.getElementById('clienteSelect');
    var clienteIdInput = document.getElementById('clienteIdInput');
    
    if (clienteSelect && clienteIdInput) {
        if (clienteSelect.value) {
            clienteIdInput.value = clienteSelect.value;
            // Actualizar el input de b√∫squeda con el nombre seleccionado
            var selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            var searchInput = document.getElementById('clienteSearchInput');
            if (searchInput && selectedOption) {
                searchInput.value = selectedOption.getAttribute('data-nombre') + ' - ' + selectedOption.getAttribute('data-email');
            }
            // Ocultar resultados
            var resultsList = document.getElementById('clienteResults');
            if (resultsList) {
                resultsList.classList.remove('show');
            }
        } else {
            clienteIdInput.value = '';
        }
    }
}


// Construir el mapa de datos de citas
{% for cita in citas_creadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{{ cita.tipo_consulta|default:""|escapejs }}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '',
    pacienteEmail: '',
    pacienteTelefono: '',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    precioCobrado: null,
    tipoServicioId: null,
    tipoServicioNombre: '',
    tipoServicioPrecio: null
};
{% endfor %}

{% for cita in citas_tomadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{{ cita.tipo_consulta|default:""|escapejs }}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '{{ cita.nombre_paciente|escapejs }}',
    pacienteEmail: '{{ cita.email_paciente|default:""|escapejs }}',
    pacienteTelefono: '{{ cita.telefono_paciente|default:""|escapejs }}',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    dentistaNombre: {% if cita.dentista %}'{{ cita.dentista.nombre_completo|escapejs }}'{% else %}''{% endif %},
    tieneFicha: {% if cita.tiene_ficha %}true{% else %}false{% endif %},
    odontogramaId: {% if cita.tiene_ficha and cita.odontograma %}{{ cita.odontograma.id }}{% else %}null{% endif %}
};
{% endfor %}

{% for cita in citas_completadas %}
citasDataMap[{{ cita.id }}] = {
    id: {{ cita.id }},
    estado: '{{ cita.estado }}',
    fechaHora: '{{ cita.fecha_hora|date:"Y-m-d" }}T{{ cita.fecha_hora|time:"H:i" }}',
    tipoConsulta: '{{ cita.tipo_consulta|default:""|escapejs }}',
    notas: '{{ cita.notas|default:""|escapejs }}',
    paciente: '{{ cita.nombre_paciente|escapejs }}',
    pacienteEmail: '{{ cita.email_paciente|default:""|escapejs }}',
    pacienteTelefono: '{{ cita.telefono_paciente|default:""|escapejs }}',
    dentistaId: {% if cita.dentista %}'{{ cita.dentista.id }}'{% else %}''{% endif %},
    dentistaNombre: {% if cita.dentista %}'{{ cita.dentista.nombre_completo|escapejs }}'{% else %}''{% endif %},
    precioCobrado: {% if cita.precio_cobrado %}{{ cita.precio_cobrado|stringformat:"f" }}{% else %}null{% endif %},
    tipoServicioId: {% if cita.tipo_servicio %}{{ cita.tipo_servicio.id }}{% else %}null{% endif %},
    tipoServicioNombre: {% if cita.tipo_servicio %}'{{ cita.tipo_servicio.nombre|escapejs }}'{% else %}''{% endif %},
    tipoServicioPrecio: {% if cita.tipo_servicio %}{{ cita.tipo_servicio.precio_base|stringformat:"f" }}{% else %}null{% endif %},
    tieneFicha: {% if cita.tiene_ficha %}true{% else %}false{% endif %},
    odontogramaId: {% if cita.tiene_ficha and cita.odontograma %}{{ cita.odontograma.id }}{% else %}null{% endif %}
};
{% endfor %}

// Funci√≥n global para abrir el modal de opciones
window.openOptionsModal = function(citaData) {
    try {
        console.log('openOptionsModal - Datos recibidos:', citaData);
        currentCitaData = citaData;
        
        var modal = document.getElementById('optionsModal');
        var form = document.getElementById('optionsForm');
        var infoReadonly = document.getElementById('optionsInfoReadonly');
        var modalTitle = document.getElementById('optionsModalTitle');
        
        if (!modal) {
            console.error('Modal #optionsModal no encontrado en el DOM');
            alert('Error: No se encontr√≥ el modal de edici√≥n');
            return;
        }
        
        // Si es una cita completada, mostrar solo informaci√≥n y ajuste de precio
        if (citaData.estado === 'completada') {
            if (!infoReadonly) {
                console.error('Div #optionsInfoReadonly no encontrado');
                return;
            }
            
            // Ocultar formulario de edici√≥n
            if (form) form.style.display = 'none';
            
            // Mostrar informaci√≥n de solo lectura
            infoReadonly.style.display = 'block';
            
            // Actualizar t√≠tulo del modal
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-check-circle"></i> Informaci√≥n de Cita Completada';
            }
            
            // Formatear fecha y hora
            var fecha = new Date(citaData.fechaHora);
            var fechaStr = fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            var horaStr = fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Llenar campos de solo lectura
            var fechaHoraReadonly = document.getElementById('optionsFechaHoraReadonly');
            var tipoReadonly = document.getElementById('optionsTipoReadonly');
            var dentistaReadonly = document.getElementById('optionsDentistaReadonly');
            var pacienteReadonly = document.getElementById('optionsPacienteReadonly');
            var precioReadonly = document.getElementById('optionsPrecioReadonly');
            var pacienteInfoReadonly = document.getElementById('pacienteInfoReadonly');
            var btnAjustarPrecio = document.getElementById('btnAjustarPrecio');
            
            if (fechaHoraReadonly) {
                fechaHoraReadonly.value = fechaStr + ' a las ' + horaStr;
            }
            
            if (tipoReadonly) {
                tipoReadonly.value = citaData.tipoConsulta || 'No especificado';
            }
            
            if (dentistaReadonly) {
                dentistaReadonly.value = citaData.dentistaNombre || 'Sin dentista asignado';
            }
            
            if (pacienteReadonly) {
                pacienteReadonly.value = citaData.paciente || 'Sin paciente asignado';
            }
            
            if (pacienteInfoReadonly) {
                if (citaData.paciente && citaData.paciente !== '') {
                    pacienteInfoReadonly.style.display = 'block';
                } else {
                    pacienteInfoReadonly.style.display = 'none';
                }
            }
            
            // Mostrar precio con formato chileno
            if (precioReadonly) {
                var precio = citaData.precioCobrado;
                if (!precio && citaData.tipoServicioPrecio) {
                    precio = citaData.tipoServicioPrecio;
                }
                
                if (precio && precio !== null && precio !== 'null' && precio !== '') {
                    // Asegurar que precio sea un n√∫mero v√°lido
                    var precioNum = parseFloat(precio);
                    if (isNaN(precioNum) || precioNum <= 0) {
                        precioReadonly.value = 'No asignado';
                    } else {
                        // Formatear como pesos chilenos ($1.000)
                        var precioStr = Math.round(precioNum).toString();
                        var precioFormateado = '$' + precioStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        precioReadonly.value = precioFormateado;
                    }
                } else {
                    precioReadonly.value = 'No asignado';
                }
            }
            
            // Configurar bot√≥n de ajustar precio
            if (btnAjustarPrecio) {
                btnAjustarPrecio.href = '{% url "ajustar_precio_cita" 0 %}'.replace('0', citaData.id);
            }
            
        } else {
            // Para citas disponibles, mostrar formulario de edici√≥n
            if (!form) {
                console.error('Form #optionsForm no encontrado en el DOM');
                alert('Error: No se encontr√≥ el formulario');
                return;
            }
            
            // Ocultar informaci√≥n de solo lectura
            if (infoReadonly) infoReadonly.style.display = 'none';
            
            // Mostrar formulario de edici√≥n
            form.style.display = 'block';
            
            // Actualizar t√≠tulo del modal
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-edit"></i> Editar Cita';
            }
            
            console.log('Modal y formulario encontrados correctamente');
            
            // Configurar la acci√≥n del formulario
            form.action = '{% url 'editar_cita' 0 %}'.replace('0', citaData.id);
            
            // Llenar los campos del formulario
            var fechaHoraInput = document.getElementById('optionsFechaHora');
            var tipoInput = document.getElementById('optionsTipo');
            var dentistaInput = document.getElementById('optionsDentista');
            var estadoInput = document.getElementById('optionsEstado');
            var notasInput = document.getElementById('optionsNotas');
            
            if (fechaHoraInput) fechaHoraInput.value = citaData.fechaHora;
            if (tipoInput) tipoInput.value = citaData.tipoConsulta || '';
            if (dentistaInput) dentistaInput.value = citaData.dentistaId || '';
            if (estadoInput) estadoInput.value = citaData.estado;
            if (notasInput) notasInput.value = citaData.notas || '';
            
            // Mostrar informaci√≥n del paciente si existe
            var pacienteInfo = document.getElementById('pacienteInfo');
            var pacienteInput = document.getElementById('optionsPaciente');
            
            if (pacienteInfo && pacienteInput) {
                if (citaData.paciente && citaData.paciente !== '') {
                    pacienteInfo.style.display = 'block';
                    pacienteInput.value = citaData.paciente;
                } else {
                    pacienteInfo.style.display = 'none';
                }
            }
        }
        
        console.log('Mostrando modal...');
        // Mostrar modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        console.log('Modal visible');
        
    } catch (error) {
        console.error('Error en openOptionsModal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Funci√≥n global para cerrar el modal de opciones
window.closeOptionsModal = function() {
    var modal = document.getElementById('optionsModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
    currentCitaData = null;
}

// Funci√≥n global para confirmar eliminaci√≥n de cita
window.confirmarEliminarCita = function(event) {
    try {
        if (event) event.preventDefault();
        
        if (!currentCitaData) {
            alert('Error: No hay datos de cita disponibles');
            return;
        }
        
        var confirmModal = document.getElementById('confirmDeleteModal');
        var confirmWarningBox = document.getElementById('confirmWarningBox');
        var confirmInfoBox = document.getElementById('confirmInfoBox');
        
        if (!confirmModal) {
            alert('Error: Modal de confirmaci√≥n no encontrado');
            return;
        }
        
        // Mostrar estado de la cita
        var estadoTexto = '';
        switch(currentCitaData.estado) {
            case 'disponible':
                estadoTexto = 'üìÖ Disponible';
                break;
            case 'reservada':
                estadoTexto = '‚úÖ Reservada';
                break;
            case 'completada':
                estadoTexto = '‚úîÔ∏è Completada';
                break;
            case 'cancelada':
                estadoTexto = '‚ùå Cancelada';
                break;
            default:
                estadoTexto = currentCitaData.estado;
        }
        
        var estadoTextElement = document.getElementById('confirmEstadoText');
        if (estadoTextElement) {
            estadoTextElement.textContent = estadoTexto;
        }
        
        // Mostrar advertencia si la cita est√° reservada
        if (currentCitaData.estado === 'reservada' && currentCitaData.paciente) {
            if (confirmWarningBox) confirmWarningBox.style.display = 'block';
            if (confirmInfoBox) confirmInfoBox.style.display = 'none';
            
            var nombreEl = document.getElementById('confirmClienteNombre');
            var emailEl = document.getElementById('confirmClienteEmail');
            var telefonoEl = document.getElementById('confirmClienteTelefono');
            
            if (nombreEl) nombreEl.textContent = currentCitaData.paciente;
            if (emailEl) emailEl.textContent = currentCitaData.pacienteEmail || 'No disponible';
            if (telefonoEl) telefonoEl.textContent = currentCitaData.pacienteTelefono || 'No disponible';
        } else {
            if (confirmWarningBox) confirmWarningBox.style.display = 'none';
            if (confirmInfoBox) confirmInfoBox.style.display = 'block';
        }
        
        // Mostrar modal de confirmaci√≥n
        confirmModal.classList.add('show');
        
    } catch (error) {
        console.error('Error en confirmarEliminarCita:', error);
        alert('Error: ' + error.message);
    }
}

// Funci√≥n global para cerrar el modal de confirmaci√≥n
window.closeConfirmDeleteModal = function() {
    var modal = document.getElementById('confirmDeleteModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Funci√≥n global para ejecutar la eliminaci√≥n
window.ejecutarEliminarCita = function() {
    try {
        if (!currentCitaData) {
            alert('Error: No hay datos de cita');
            return;
        }
        
        // Crear formulario para eliminar
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url 'eliminar_cita' 0 %}'.replace('0', currentCitaData.id);
        
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            var csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
        
    } catch (error) {
        console.error('Error en ejecutarEliminarCita:', error);
        alert('Error al eliminar: ' + error.message);
    }
}

// Funci√≥n global para abrir modal de opciones (punto de entrada)
window.openOptionsModalForCita = function(citaId) {
    try {
        console.log('Click en bot√≥n de opciones - ID:', citaId);
        
        var citaData = citasDataMap[citaId];
        
        if (!citaData) {
            console.error('No se encontraron datos para la cita ID:', citaId);
            alert('Error: No se pudieron cargar los datos de la cita.');
            return;
        }
        
        console.log('Datos de cita encontrados:', citaData);
        
        // Si es una cita tomada (reservada o confirmada), abrir modal simple
        if (citaData.estado === 'reservada' || citaData.estado === 'confirmada') {
            window.openCitaInfoModal(citaData);
        } else {
            // Si es disponible o completada, abrir modal de edici√≥n
            window.openOptionsModal(citaData);
        }
        
    } catch (error) {
        console.error('Error al abrir modal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Funci√≥n para abrir el modal simple de informaci√≥n de citas tomadas
window.openCitaInfoModal = function(citaData) {
    try {
        var modal = document.getElementById('citaInfoModal');
        
        if (!modal) {
            console.error('Modal #citaInfoModal no encontrado');
            return;
        }
        
        // Formatear fecha y hora
        var fecha = new Date(citaData.fechaHora);
        var fechaStr = fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        var horaStr = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        // Llenar la informaci√≥n
        document.getElementById('modalCitaFecha').textContent = fechaStr;
        document.getElementById('modalCitaHora').textContent = horaStr;
        // Usar nombre_paciente que ya viene del servidor con el nombre completo correcto
        document.getElementById('modalCitaPaciente').textContent = citaData.paciente || 'Sin informaci√≥n';
        document.getElementById('modalCitaTipo').textContent = citaData.tipoConsulta || 'No especificado';
        
        // Obtener nombre del dentista
        var dentistaSelect = document.getElementById('optionsDentista');
        var dentistaNombre = 'Sin asignar';
        if (citaData.dentistaId && dentistaSelect) {
            var option = dentistaSelect.querySelector('option[value="' + citaData.dentistaId + '"]');
            if (option) {
                dentistaNombre = option.textContent;
            }
        }
        document.getElementById('modalCitaDentista').textContent = dentistaNombre;
        
        // Estado con badge
        var estadoSpan = document.getElementById('modalCitaEstado');
        estadoSpan.textContent = citaData.estado === 'reservada' ? 'Reservada' : 'Confirmada';
        estadoSpan.className = 'badge-estado ' + citaData.estado;
        
        // Mostrar informaci√≥n de ficha odontol√≥gica
        var fichaContainer = document.getElementById('infoFichaContainer');
        var fichaValue = document.getElementById('modalCitaFicha');
        if (fichaContainer && fichaValue) {
            if (citaData.tieneFicha) {
                fichaContainer.style.display = 'flex';
                fichaValue.innerHTML = '<span style="color: #10b981; font-weight: 600;"><i class="fas fa-check-circle"></i> Ficha creada</span>';
            } else {
                fichaContainer.style.display = 'flex';
                fichaValue.innerHTML = '<span style="color: #ef4444; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Ficha no creada</span>';
            }
        }
        
        // Configurar botones de acci√≥n
        var btnCompletar = document.getElementById('btnCompletarCita');
        if (btnCompletar) {
            btnCompletar.href = '{% url "completar_cita" 0 %}'.replace('0', citaData.id);
            // Guardar informaci√≥n de ficha en el bot√≥n para validaci√≥n
            btnCompletar.setAttribute('data-tiene-ficha', citaData.tieneFicha ? 'true' : 'false');
        }
        document.getElementById('btnCancelarCita').href = '{% url "cancelar_cita_admin" 0 %}'.replace('0', citaData.id);
        
        // Mostrar modal
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
    } catch (error) {
        console.error('Error en openCitaInfoModal:', error);
        alert('Error al abrir el modal: ' + error.message);
    }
}

// Funci√≥n para validar antes de completar cita
window.validarCompletarCita = function() {
    var btnCompletar = document.getElementById('btnCompletarCita');
    if (!btnCompletar) return false;
    
    var tieneFicha = btnCompletar.getAttribute('data-tiene-ficha') === 'true';
    
    if (!tieneFicha) {
        alert('‚ö†Ô∏è No se puede completar la cita sin crear la ficha odontol√≥gica.\n\nPor favor, aseg√∫rate de que el dentista haya creado la ficha antes de marcar la cita como completada.');
        return false;
    }
    
    return confirm('¬øMarcar esta cita como completada?');
}

// Funci√≥n para cerrar el modal simple
window.closeCitaInfoModal = function() {
    var modal = document.getElementById('citaInfoModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM Cargado completamente ===');
    console.log('Total de citas en el mapa:', Object.keys(citasDataMap).length);
    console.log('Funci√≥n openOptionsModalForCita:', typeof window.openOptionsModalForCita);
    
    // Verificar que los modales existen
    var optionsModal = document.getElementById('optionsModal');
    var confirmModal = document.getElementById('confirmDeleteModal');
    
    console.log('Modal de opciones existe:', !!optionsModal);
    console.log('Modal de confirmaci√≥n existe:', !!confirmModal);
    
    // Event listeners para cerrar modales DESHABILITADOS
    // Los modales solo se pueden cerrar con el bot√≥n X para evitar p√©rdida de datos
    console.log('Modales configurados para cerrarse solo con el bot√≥n X');
    
    // Tabs functionality
    const tabButtons = document.querySelectorAll('.tab-btn');
    const sections = {
        list: document.getElementById('tab-content-list'),
        taken: document.getElementById('tab-content-taken'),
        completed: document.getElementById('tab-content-completed'),
        calendar: document.getElementById('tab-content-calendar')
    };

    function showTab(name) {
        Object.keys(sections).forEach(key => {
            sections[key].style.display = (key === name) ? '' : 'none';
        });
        tabButtons.forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === name);
        });
        if (name === 'calendar' && window.calendarInstance) {
            window.calendarInstance.render();
        }
    }

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => showTab(btn.getAttribute('data-tab')));
    });

    // Calendar initialization
    const calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        // Build events from server-rendered citas
        const events = [];
        {% for c in citas_creadas %}
        events.push({
            id: '{{ c.id }}',
            title: '{{ c.tipo_consulta|default:"Disponible"|escapejs }}',
            start: '{{ c.fecha_hora|date:"Y-m-d\\TH:i:s" }}',
            extendedProps: {
                estado: 'disponible',
                paciente: 'Sin asignar',
                notas: '{{ c.notas|default_if_none:""|escapejs }}'
            },
            color: '#10b981'
        });
        {% endfor %}
        {% for c in citas_tomadas %}
        events.push({
            id: '{{ c.id }}',
            title: '{{ c.tipo_consulta|default:"Cita"|escapejs }} - {{ c.paciente_nombre|default:""|escapejs }}',
            start: '{{ c.fecha_hora|date:"Y-m-d\\TH:i:s" }}',
            extendedProps: {
                estado: '{{ c.estado|escapejs }}',
                paciente: '{{ c.paciente_nombre|default:""|escapejs }}',
                notas: '{{ c.notas|default_if_none:""|escapejs }}'
            },
            color: '#f59e0b'
        });
        {% endfor %}

        const calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'es',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'D√≠a',
                list: 'Lista'
            },
            navLinks: true,
            editable: false,
            selectable: false,
            events: events,
            eventClick: function(info) {
                showAppointmentDetails(info.event);
            },
            eventDisplay: 'block',
            eventTextColor: '#ffffff',
            eventBackgroundColor: '#3b82f6',
            eventBorderColor: '#2563eb'
        });
        window.calendarInstance = calendar;
        // Do not render until the calendar tab is opened to avoid layout issues
    }

    // Default to show list tab
    showTab('list');
});

// Modal functionality
function openEditModal(citaId, fechaHora, tipoConsulta, notas) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');
    
    // Set form action URL using Django URL pattern
    form.action = `{% url 'editar_cita' 0 %}`.replace('0', citaId);
    
    // Populate form fields
    document.getElementById('editFechaHora').value = fechaHora;
    document.getElementById('editTipoConsulta').value = tipoConsulta;
    document.getElementById('editNotas').value = notas;
    
    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Focus on first input
    setTimeout(() => {
        document.getElementById('editFechaHora').focus();
    }, 100);
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Close modal when clicking outside
var editModal = document.getElementById('editModal');
if (editModal) {
    editModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
}

// C√≥digo duplicado eliminado - las funciones ya est√°n definidas arriba


// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeOptionsModal();
        closeConfirmDeleteModal();
    }
});

// Form submission handling para el modal de opciones
var optionsForm = document.getElementById('optionsForm');
if (optionsForm) {
    optionsForm.addEventListener('submit', function(e) {
        e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('.btn-save-edit');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    submitBtn.disabled = true;
    
    // Submit form
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Guardado!';
            submitBtn.style.background = '#10b981';
            
            // Close modal and reload page after a short delay
            setTimeout(() => {
                closeOptionsModal();
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    })
    .catch(error => {
        // Show error state
        submitBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error al guardar';
        submitBtn.style.background = '#ef4444';
        
        // Reset after a delay
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.style.background = '';
            submitBtn.disabled = false;
        }, 2000);
        
        console.error('Error:', error);
    });
    });
}

// Form submission handling
var editForm = document.getElementById('editForm');
if (editForm) {
    editForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    submitBtn.disabled = true;
    
    // Submit form
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Guardado!';
            submitBtn.style.background = '#10b981';
            
            // Close modal and reload page after a short delay
            setTimeout(() => {
                closeEditModal();
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    })
    .catch(error => {
        // Show error state
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        submitBtn.style.background = '#ef4444';
        
        // Reset button after delay
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.style.background = '';
            submitBtn.disabled = false;
        }, 2000);
    });
    });
}

// Appointment Details Modal Functions
function showAppointmentDetails(event) {
    const modal = document.getElementById('appointmentModal');
    const props = event.extendedProps || {};
    
    // Format date and time
    const startDate = new Date(event.start);
    const formattedDateTime = startDate.toLocaleString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Populate modal with appointment data
    document.getElementById('appointmentDateTime').textContent = formattedDateTime;
    document.getElementById('appointmentType').textContent = event.title || 'Sin especificar';
    document.getElementById('appointmentPatient').textContent = props.paciente || 'Sin asignar';
    document.getElementById('appointmentNotes').textContent = props.notas || 'Sin notas';
    
    // Set status badge
    const statusElement = document.getElementById('appointmentStatus');
    const estado = props.estado || 'disponible';
    statusElement.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
    statusElement.className = `status-badge ${estado}`;
    
    // Show/hide edit button based on appointment status
    const editBtn = document.getElementById('editAppointmentBtn');
    if (estado === 'disponible') {
        editBtn.style.display = 'inline-flex';
        editBtn.onclick = () => editAppointmentFromCalendar(event.id, startDate, event.title, props.notas);
    } else {
        editBtn.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeAppointmentModal() {
    const modal = document.getElementById('appointmentModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

function editAppointmentFromCalendar(citaId, fechaHora, tipoConsulta, notas) {
    // Close appointment modal
    closeAppointmentModal();
    
    // Format date for input
    const isoString = fechaHora.toISOString().slice(0, 16);
    
    // Open edit modal with appointment data
    openEditModal(citaId, isoString, tipoConsulta, notas || '');
}

// Close appointment modal when clicking outside
var appointmentModal = document.getElementById('appointmentModal');
if (appointmentModal) {
    appointmentModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeAppointmentModal();
        }
    });
}

// Close appointment modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const appointmentModal = document.getElementById('appointmentModal');
        if (appointmentModal && appointmentModal.classList.contains('show')) {
            closeAppointmentModal();
        }
        const addCitaModal = document.getElementById('addCitaModal');
        if (addCitaModal && addCitaModal.classList.contains('show')) {
            closeAddCitaModal();
        }
    }
});

// Manejar b√∫squeda de clientes en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    initClienteSearch();
});

// Manejar el env√≠o del formulario de agregar cita
document.addEventListener('DOMContentLoaded', function() {
    // Obtener datos de horarios desde el script tag generado por json_script
    var horariosDentistasScript = document.getElementById('horarios-dentistas-data');
    var horariosDentistas = horariosDentistasScript ? JSON.parse(horariosDentistasScript.textContent) : {};
    
    // Funci√≥n para validar y ajustar la hora seg√∫n el horario del dentista
    function validarHoraSegunHorarioDentista() {
        var dentistaSelect = document.getElementById('addCitaDentista');
        var fechaInput = document.getElementById('addCitaFechaHora');
        
        if (!dentistaSelect || !fechaInput || !dentistaSelect.value || !fechaInput.value) {
            return;
        }
        
        var dentistaId = parseInt(dentistaSelect.value);
        var horarios = horariosDentistas[dentistaId];
        
        if (!horarios || horarios.length === 0) {
            // Si el dentista no tiene horarios configurados, permitir cualquier hora
            return;
        }
        
        var fechaSeleccionada = new Date(fechaInput.value);
        var diaSemana = fechaSeleccionada.getDay(); // 0=Domingo, 1=Lunes, etc.
        // Ajustar: Django usa 0=Lunes, JavaScript usa 0=Domingo
        var diaSemanaDjango = diaSemana === 0 ? 6 : diaSemana - 1;
        
        var horaSeleccionada = fechaSeleccionada.getHours();
        var minutoSeleccionado = fechaSeleccionada.getMinutes();
        var horaCompleta = horaSeleccionada * 60 + minutoSeleccionado; // En minutos desde medianoche
        
        // Buscar horarios v√°lidos para ese d√≠a
        var horariosValidos = horarios.filter(function(h) {
            return h.dia_semana === diaSemanaDjango;
        });
        
        if (horariosValidos.length === 0) {
            alert('El dentista seleccionado no trabaja ese d√≠a. Por favor, seleccione otro d√≠a.');
            fechaInput.value = '';
            return;
        }
        
        // Verificar si la hora est√° dentro de alg√∫n bloque
        var horaValida = false;
        for (var i = 0; i < horariosValidos.length; i++) {
            var horario = horariosValidos[i];
            var horaInicio = parseInt(horario.hora_inicio.split(':')[0]) * 60 + parseInt(horario.hora_inicio.split(':')[1]);
            var horaFin = parseInt(horario.hora_fin.split(':')[0]) * 60 + parseInt(horario.hora_fin.split(':')[1]);
            
            if (horaCompleta >= horaInicio && horaCompleta < horaFin) {
                horaValida = true;
                break;
            }
        }
        
        if (!horaValida) {
            var horariosStr = horariosValidos.map(function(h) {
                return h.hora_inicio + '-' + h.hora_fin;
            }).join(', ');
            alert('La hora seleccionada no est√° dentro del horario de trabajo del dentista.\nHorarios disponibles: ' + horariosStr);
            fechaInput.value = '';
        }
    }
    
    // Esperar a que el DOM est√© completamente cargado
    var formAgregarCita = document.getElementById('formAgregarCitaModal');
    console.log('Formulario encontrado:', formAgregarCita);
    
    if (!formAgregarCita) {
        console.error('ERROR: No se encontr√≥ el formulario formAgregarCitaModal');
        return;
    }
    
    if (formAgregarCita) {
        // Actualizar campo hidden tipo_servicio cuando se selecciona un servicio
        var tipoSelect = document.getElementById('addCitaTipo');
        var tipoServicioIdInput = document.getElementById('tipoServicioIdInput');
        if (tipoSelect && tipoServicioIdInput) {
            tipoSelect.addEventListener('change', function() {
                var selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.hasAttribute('data-servicio-id')) {
                    tipoServicioIdInput.value = selectedOption.getAttribute('data-servicio-id');
                } else {
                    tipoServicioIdInput.value = '';
                }
            });
        }
        
        // Validar hora cuando cambia el dentista o la fecha
        var dentistaSelect = document.getElementById('addCitaDentista');
        var fechaInput = document.getElementById('addCitaFechaHora');
        
        if (dentistaSelect) {
            dentistaSelect.addEventListener('change', function() {
                if (fechaInput && fechaInput.value) {
                    validarHoraSegunHorarioDentista();
                }
            });
        }
        
        if (fechaInput) {
            fechaInput.addEventListener('change', function() {
                if (dentistaSelect && dentistaSelect.value) {
                    validarHoraSegunHorarioDentista();
                }
            });
        }
        
        // Agregar listener con capture para asegurar que se ejecute primero
        console.log('Agregando listener al formulario');
        formAgregarCita.addEventListener('submit', function(e) {
            // Prevenir el comportamiento por defecto inmediatamente
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log('Formulario interceptado, previniendo env√≠o tradicional');
            
            var formData = new FormData(this);
            var submitBtn = this.querySelector('button[type="submit"]');
            var originalText = submitBtn.innerHTML;
            
            // Asegurar que tipo_servicio se env√≠e correctamente
            var tipoSelect = document.getElementById('addCitaTipo');
            var tipoServicioIdInput = document.getElementById('tipoServicioIdInput');
            if (tipoSelect && tipoServicioIdInput) {
                var selectedOption = tipoSelect.options[tipoSelect.selectedIndex];
                if (selectedOption && selectedOption.hasAttribute('data-servicio-id')) {
                    tipoServicioIdInput.value = selectedOption.getAttribute('data-servicio-id');
                    formData.set('tipo_servicio', tipoServicioIdInput.value);
                }
            }
            
            // Validar que la fecha no sea en el pasado
            var fechaInput = document.getElementById('addCitaFechaHora');
            if (fechaInput && fechaInput.value) {
                var fechaSeleccionada = new Date(fechaInput.value);
                var ahora = new Date();
                if (fechaSeleccionada < ahora) {
                    alert('No se pueden crear citas en fechas pasadas. Por favor, seleccione una fecha y hora futura.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    fechaInput.focus();
                    return false;
                }
            }
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            submitBtn.disabled = true;
            
            // Obtener la URL del atributo data-action
            var actionUrl = formAgregarCita.getAttribute('data-action');
            if (!actionUrl) {
                // Si no hay data-action, usar la URL directamente
                actionUrl = '{% url "agregar_hora" %}';
            }
            
            console.log('Enviando formulario a:', actionUrl);
            
            // Enviar formulario con fetch
            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                // Siempre intentar parsear como JSON
                return response.json().then(data => {
                    // Si la respuesta no fue exitosa, lanzar error con el mensaje
                    if (!response.ok || (data && !data.success)) {
                        var errorMsg = data && data.error ? data.error : 'Error al crear la cita';
                        throw new Error(errorMsg);
                    }
                    return data;
                }).catch(parseError => {
                    // Si no se puede parsear como JSON, puede ser una redirecci√≥n
                    if (response.redirected) {
                        window.location.href = response.url;
                        return null;
                    }
                    // Si hay un error de parseo pero la respuesta fue exitosa, puede ser HTML
                    if (response.ok) {
                        // Recargar la p√°gina si recibimos HTML (redirecci√≥n exitosa)
                        window.location.reload();
                        return null;
                    }
                    throw parseError;
                });
            })
            .then(data => {
                // Si data es null, ya se manej√≥ (redirecci√≥n o recarga)
                if (data === null) {
                    return;
                }
                
                if (data && data.success) {
                    // Mostrar mensaje de √©xito
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> ¬°Cita creada!';
                    submitBtn.style.background = '#10b981';
                    
                    // Mostrar mensaje de √©xito
                    if (data.message) {
                        alert('‚úÖ ' + data.message);
                    }
                    
                    // Cerrar modal y recargar p√°gina despu√©s de un breve delay
                    setTimeout(() => {
                        closeAddCitaModal();
                        window.location.reload();
                    }, 1000);
                } else {
                    // Mostrar error del servidor
                    var errorMsg = data && data.error ? data.error : 'Error al crear la cita';
                    throw new Error(errorMsg);
                }
            })
            .catch(error => {
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.style.background = '';
                submitBtn.disabled = false;
                
                console.error('Error al procesar la respuesta:', error);
                // Mostrar alerta con el mensaje de error
                var errorMessage = error.message || 'Error al crear la cita';
                console.error('Mensaje de error:', errorMessage);
                alert('‚ö†Ô∏è ' + errorMessage);
            });
            
            return false;
        });
        
        console.log('Listener agregado correctamente al formulario');
    }
    
    // Cerrar modal al hacer clic fuera
    var addCitaModal = document.getElementById('addCitaModal');
    if (addCitaModal) {
        addCitaModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddCitaModal();
            }
        });
    } else {
        console.warn('Modal addCitaModal no encontrado');
    }
});

    // ========== FUNCIONES DE FILTRADO ==========
    
    // Funci√≥n gen√©rica para filtrar filas de tabla
    function filtrarTabla(tipo) {
        console.log(`Filtrando tabla: ${tipo}`);
        try {
            const textoInput = document.getElementById(`filtro-${tipo}-texto`);
            const fechaInput = document.getElementById(`filtro-${tipo}-fecha`);
            const dentistaInput = document.getElementById(`filtro-${tipo}-dentista`);
            const servicioInput = document.getElementById(`filtro-${tipo}-servicio`);
            
            console.log('Elementos encontrados:', {
                texto: !!textoInput,
                fecha: !!fechaInput,
                dentista: !!dentistaInput,
                servicio: !!servicioInput
            });
            
            if (!textoInput || !fechaInput || !dentistaInput || !servicioInput) {
                console.warn(`No se encontraron todos los elementos de filtro para ${tipo}`);
                return;
            }
            
            const texto = textoInput.value ? textoInput.value.toLowerCase() : '';
            const fecha = fechaInput.value || '';
            const dentista = dentistaInput.value || '';
            const servicio = servicioInput.value || '';
            
            console.log('Valores de filtros:', { texto, fecha, dentista, servicio });
            
            const tabContentId = tipo === 'disponibles' ? 'list' : tipo === 'tomadas' ? 'taken' : 'completed';
            const tabContent = document.getElementById(`tab-content-${tabContentId}`);
            
            console.log('Tab content ID:', tabContentId);
            console.log('Tab content encontrado:', !!tabContent);
            
            if (!tabContent) {
                console.warn(`No se encontr√≥ el contenedor de pesta√±a para ${tipo}`);
                return;
            }
            
            const filas = tabContent.querySelectorAll('.fila-cita');
            const tabla = tabContent.querySelector('.tabla-citas');
            const mensajeDiv = document.getElementById(`mensaje-sin-resultados-${tipo}`);
            const mensajeTitulo = document.getElementById(`mensaje-titulo-${tipo}`);
            const mensajeDescripcion = document.getElementById(`mensaje-descripcion-${tipo}`);
            
            console.log('Filas encontradas:', filas.length);
            console.log('Tabla encontrada:', !!tabla);
            console.log('Mensaje div encontrado:', !!mensajeDiv);
            
            let visible = 0;
            
            filas.forEach(elemento => {
                const dataFecha = elemento.getAttribute('data-fecha') || '';
                const dataDentista = elemento.getAttribute('data-dentista') || '';
                const dataServicio = elemento.getAttribute('data-servicio') || '';
                const dataCliente = elemento.getAttribute('data-cliente') || '';
                
                // Filtro por texto (busca en servicio, dentista, cliente)
                const matchTexto = !texto || 
                    dataServicio.toLowerCase().includes(texto) ||
                    dataDentista.toLowerCase().includes(texto) ||
                    dataCliente.toLowerCase().includes(texto);
                
                // Filtro por fecha
                const matchFecha = !fecha || dataFecha === fecha;
                
                // Filtro por dentista
                const matchDentista = !dentista || dataDentista === dentista;
                
                // Filtro por servicio
                const matchServicio = !servicio || dataServicio === servicio;
                
                if (matchTexto && matchFecha && matchDentista && matchServicio) {
                    elemento.style.display = '';
                    visible++;
                } else {
                    elemento.style.display = 'none';
                }
            });
            
            // Actualizar contador
            const countElement = document.getElementById(`count-${tipo}`);
            if (countElement) {
                countElement.textContent = `${visible} ${tipo === 'disponibles' ? 'horario(s) libre(s)' : tipo === 'tomadas' ? 'cita(s) reservada(s)' : 'cita(s) completada(s)'}`;
            }
            
            console.log(`Filas visibles despu√©s de filtrar: ${visible} de ${filas.length}`);
            
            // Mostrar/ocultar mensaje cuando no hay resultados
            // Solo mostrar si hay citas pero no coinciden con los filtros
            const hayFiltrosActivos = texto || fecha || dentista || servicio;
            if (visible === 0 && filas.length > 0 && hayFiltrosActivos) {
                // Hay filtros aplicados pero no hay resultados
                if (tabla) tabla.style.display = 'none';
                if (mensajeDiv) {
                    mensajeDiv.style.display = 'block';
                    
                    // Generar mensaje espec√≠fico seg√∫n los filtros aplicados
                    let mensajeTituloTexto = 'No se encontraron resultados';
                    let mensajeDescripcionTexto = 'Intenta ajustar los filtros de b√∫squeda';
                    
                    const filtrosActivos = [];
                    if (fecha) {
                        // Formatear fecha de manera m√°s legible
                        const fechaObj = new Date(fecha + 'T00:00:00');
                        const fechaFormateada = fechaObj.toLocaleDateString('es-ES', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        // Capitalizar primera letra
                        const fechaCapitalizada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);
                        filtrosActivos.push(`fecha: ${fechaCapitalizada}`);
                        mensajeTituloTexto = 'No existen citas en la fecha seleccionada';
                        mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para el ${fechaCapitalizada}`;
                    }
                    if (dentista) {
                        filtrosActivos.push(`dentista: ${dentista}`);
                        if (!fecha) {
                            mensajeTituloTexto = 'No se encontraron citas para este dentista';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para ${dentista}`;
                        }
                    }
                    if (servicio) {
                        filtrosActivos.push(`servicio: ${servicio}`);
                        if (!fecha && !dentista) {
                            mensajeTituloTexto = 'No se encontraron citas para este servicio';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} para ${servicio}`;
                        }
                    }
                    if (texto) {
                        filtrosActivos.push(`b√∫squeda: "${texto}"`);
                        if (!fecha && !dentista && !servicio) {
                            mensajeTituloTexto = 'No se encontraron resultados';
                            mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} que coincidan con "${texto}"`;
                        }
                    }
                    
                    // Si hay m√∫ltiples filtros, usar mensaje gen√©rico
                    if (filtrosActivos.length > 1) {
                        mensajeTituloTexto = 'No se encontraron resultados';
                        mensajeDescripcionTexto = `No hay ${tipo === 'disponibles' ? 'horarios disponibles' : tipo === 'tomadas' ? 'citas reservadas' : 'citas completadas'} que coincidan con los filtros aplicados`;
                    }
                    
                    if (mensajeTitulo) mensajeTitulo.textContent = mensajeTituloTexto;
                    if (mensajeDescripcion) mensajeDescripcion.textContent = mensajeDescripcionTexto;
                }
            } else {
                // Hay resultados o no hay filtros aplicados
                if (tabla) tabla.style.display = '';
                if (mensajeDiv) mensajeDiv.style.display = 'none';
            }
        } catch (error) {
            console.error(`Error al filtrar tabla ${tipo}:`, error);
        }
    }
    
    // Funciones para aplicar filtros
    function aplicarFiltrosDisponibles() {
        console.log('Aplicando filtros para disponibles...');
        filtrarTabla('disponibles');
    }
    
    function aplicarFiltrosTomadas() {
        console.log('Aplicando filtros para tomadas...');
        filtrarTabla('tomadas');
    }
    
    function aplicarFiltrosCompletadas() {
        console.log('Aplicando filtros para completadas...');
        filtrarTabla('completadas');
    }
    
    // Funci√≥n para limpiar filtros
    function limpiarFiltrosDisponibles() {
        document.getElementById('filtro-disponibles-texto').value = '';
        document.getElementById('filtro-disponibles-fecha').value = '';
        document.getElementById('filtro-disponibles-dentista').value = '';
        document.getElementById('filtro-disponibles-servicio').value = '';
        filtrarTabla('disponibles');
    }
    
    function limpiarFiltrosTomadas() {
        document.getElementById('filtro-tomadas-texto').value = '';
        document.getElementById('filtro-tomadas-fecha').value = '';
        document.getElementById('filtro-tomadas-dentista').value = '';
        document.getElementById('filtro-tomadas-servicio').value = '';
        filtrarTabla('tomadas');
    }
    
    function limpiarFiltrosCompletadas() {
        document.getElementById('filtro-completadas-texto').value = '';
        document.getElementById('filtro-completadas-fecha').value = '';
        document.getElementById('filtro-completadas-dentista').value = '';
        document.getElementById('filtro-completadas-servicio').value = '';
        filtrarTabla('completadas');
    }
    
    // Funci√≥n para inicializar los event listeners de filtros
    function inicializarFiltros() {
        console.log('Inicializando filtros...');
        
        // Event listeners para filtros de Disponibles
        const filtroDisponiblesTexto = document.getElementById('filtro-disponibles-texto');
        const filtroDisponiblesFecha = document.getElementById('filtro-disponibles-fecha');
        const filtroDisponiblesDentista = document.getElementById('filtro-disponibles-dentista');
        const filtroDisponiblesServicio = document.getElementById('filtro-disponibles-servicio');
        
        console.log('Filtros disponibles encontrados:', {
            texto: !!filtroDisponiblesTexto,
            fecha: !!filtroDisponiblesFecha,
            dentista: !!filtroDisponiblesDentista,
            servicio: !!filtroDisponiblesServicio
        });
        
        if (filtroDisponiblesTexto) {
            filtroDisponiblesTexto.addEventListener('input', () => {
                console.log('Evento input en filtro texto disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesFecha) {
            filtroDisponiblesFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesDentista) {
            filtroDisponiblesDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista disponibles');
                filtrarTabla('disponibles');
            });
        }
        if (filtroDisponiblesServicio) {
            filtroDisponiblesServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio disponibles');
                filtrarTabla('disponibles');
            });
        }
        
        // Event listeners para filtros de Tomadas
        const filtroTomadasTexto = document.getElementById('filtro-tomadas-texto');
        const filtroTomadasFecha = document.getElementById('filtro-tomadas-fecha');
        const filtroTomadasDentista = document.getElementById('filtro-tomadas-dentista');
        const filtroTomadasServicio = document.getElementById('filtro-tomadas-servicio');
        
        if (filtroTomadasTexto) {
            filtroTomadasTexto.addEventListener('input', () => filtrarTabla('tomadas'));
        }
        if (filtroTomadasFecha) {
            filtroTomadasFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha tomadas');
                filtrarTabla('tomadas');
            });
        }
        if (filtroTomadasDentista) {
            filtroTomadasDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista tomadas');
                filtrarTabla('tomadas');
            });
        }
        if (filtroTomadasServicio) {
            filtroTomadasServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio tomadas');
                filtrarTabla('tomadas');
            });
        }
        
        // Event listeners para filtros de Completadas
        const filtroCompletadasTexto = document.getElementById('filtro-completadas-texto');
        const filtroCompletadasFecha = document.getElementById('filtro-completadas-fecha');
        const filtroCompletadasDentista = document.getElementById('filtro-completadas-dentista');
        const filtroCompletadasServicio = document.getElementById('filtro-completadas-servicio');
        
        if (filtroCompletadasTexto) {
            filtroCompletadasTexto.addEventListener('input', () => {
                console.log('Evento input en filtro texto completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasFecha) {
            filtroCompletadasFecha.addEventListener('change', () => {
                console.log('Evento change en filtro fecha completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasDentista) {
            filtroCompletadasDentista.addEventListener('change', () => {
                console.log('Evento change en filtro dentista completadas');
                filtrarTabla('completadas');
            });
        }
        if (filtroCompletadasServicio) {
            filtroCompletadasServicio.addEventListener('change', () => {
                console.log('Evento change en filtro servicio completadas');
                filtrarTabla('completadas');
            });
        }
        
        console.log('Filtros inicializados correctamente');
    }
    
    // Inicializar filtros cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarFiltros);
    } else {
        // DOM ya est√° listo
        inicializarFiltros();
    }
</script>

{# Script tag para horarios de dentistas (generado por json_script) - debe estar fuera del script principal #}
{{ horarios_dentistas|json_script:"horarios-dentistas-data" }}

{% endblock %}
