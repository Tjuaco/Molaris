<style>
    /* ===== MODAL DEL VISUALIZADOR MEJORADO ===== */
    .visualizador-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(13, 148, 136, 0.05));
        backdrop-filter: blur(4px);
        overflow: hidden;
        animation: fadeInModal 0.3s ease;
    }

    @keyframes fadeInModal {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .visualizador-modal.active {
        display: flex;
        flex-direction: column;
    }

    .modal-content-visualizador {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 12px;
        box-sizing: border-box;
        background: transparent;
        gap: 10px;
    }

    /* ===== HEADER DEL MODAL ===== */
    .modal-header-visualizador {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: linear-gradient(135deg, #ffffff, #f0fdfa);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 2px solid #e0f2fe;
    }

    .modal-header-visualizador .header-title-section {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-header-visualizador h2 {
        margin: 0;
        color: #1e293b;
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        letter-spacing: -0.2px;
    }

    .btn-help-shortcuts {
        padding: 5px 10px;
        background: linear-gradient(135deg, #64748b, #475569);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px rgba(100, 116, 139, 0.3);
    }

    .btn-help-shortcuts:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(100, 116, 139, 0.4);
    }

    .modal-header-visualizador h2 i {
        color: #14b8a6;
        font-size: 18px;
    }

    .modal-close-visualizador {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
    }

    .modal-close-visualizador:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    /* ===== CONTROLES DEL MODAL ===== */
    .modal-controls-visualizador {
        background: white;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 2px solid #e0f2fe;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
    }

    .modal-controls-visualizador .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .modal-controls-visualizador label {
        color: #1e293b;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .modal-controls-visualizador label i {
        color: #14b8a6;
        font-size: 13px;
    }

    .modal-controls-visualizador .form-control,
    .modal-controls-visualizador select {
        background: white;
        border: 2px solid #e0f2fe;
        color: #1e293b;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.2s ease;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
    }

    .modal-controls-visualizador .form-control:focus,
    .modal-controls-visualizador select:focus {
        outline: none;
        border-color: #14b8a6;
        box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.1);
        background: #f0fdfa;
    }

    .modal-controls-visualizador .tool-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .modal-controls-visualizador .tool-btn {
        padding: 6px 10px;
        border: 2px solid #e0f2fe;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        color: #475569;
        font-size: 11px;
        font-weight: 600;
        flex: 1;
        min-width: 70px;
    }

    .modal-controls-visualizador .tool-btn:hover {
        background: #f0fdfa;
        border-color: #14b8a6;
        color: #14b8a6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.2);
    }

    .modal-controls-visualizador .tool-btn.active {
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        border-color: #0d9488;
        color: white;
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3);
    }

    .modal-controls-visualizador .tool-btn.btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-color: #dc2626;
        color: white;
    }

    .modal-controls-visualizador .tool-btn.btn-danger:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    /* ===== COLOR BUTTONS ===== */
    .color-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .color-btn {
        flex: 1;
        min-width: 60px;
        padding: 6px 10px;
        border: 2px solid #e0f2fe;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .color-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .color-btn.active {
        border-width: 3px;
        border-color: #14b8a6;
        box-shadow: 0 4px 16px rgba(20, 184, 166, 0.4);
        transform: translateY(-2px);
    }

    /* ===== SLIDERS ===== */
    .modal-controls-visualizador input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: #e0f2fe;
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
    }

    .modal-controls-visualizador input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
        transition: all 0.2s ease;
    }

    .modal-controls-visualizador input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
    }

    .modal-controls-visualizador input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3);
    }

    .modal-controls-visualizador input[type="range"]+label {
        font-size: 10px;
        color: #64748b;
        font-weight: 600;
        margin-top: 2px;
    }

    .modal-controls-visualizador input[type="range"]+label span {
        color: #14b8a6;
        font-weight: 700;
        font-size: 11px;
    }

    /* ===== CANVAS CONTAINER ===== */
    .modal-canvas-container {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        overflow: hidden;
        min-height: 0;
    }

    .modal-canvas-wrapper {
        position: relative;
        background: #000;
        border-radius: 16px;
        overflow: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 3px solid #e0f2fe;
        transition: all 0.3s ease;
    }

    .modal-canvas-wrapper:hover {
        border-color: #14b8a6;
        box-shadow: 0 12px 40px rgba(20, 184, 166, 0.3);
    }

    .modal-canvas-wrapper canvas {
        display: block;
        cursor: crosshair;
        touch-action: none;
        max-width: none;
        max-height: none;
    }

    .modal-canvas-info {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(240, 253, 250, 0.98));
        backdrop-filter: blur(10px);
        color: #1e293b;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        border: 2px solid #e0f2fe;
        z-index: 10;
    }

    .modal-canvas-info span {
        color: #14b8a6;
        font-weight: 700;
        font-size: 12px;
    }

    .modal-canvas-info .canvas-info-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .zoom-indicator {
        font-size: 11px;
        color: #64748b;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 8px;
        border-radius: 6px;
        border: 1px solid #e0f2fe;
    }

    .modal-canvas-info .canvas-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .reset-zoom-btn {
        padding: 5px 10px;
        background: white;
        border: 2px solid #e0f2fe;
        color: #14b8a6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .reset-zoom-btn:hover {
        background: #f0fdfa;
        border-color: #14b8a6;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(20, 184, 166, 0.2);
    }

    .btn-download {
        padding: 5px 10px;
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 1px 4px rgba(16, 185, 129, 0.3);
    }

    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .modal-content-visualizador {
            padding: 12px;
            gap: 12px;
        }

        .modal-header-visualizador {
            padding: 16px 20px;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
        }

        .modal-header-visualizador h2 {
            font-size: 20px;
        }

        .modal-close-visualizador {
            width: 100%;
            justify-content: center;
        }

        .modal-controls-visualizador {
            grid-template-columns: 1fr;
            padding: 20px;
            gap: 16px;
        }

        .modal-canvas-container {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .modal-canvas-info {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .canvas-actions {
            width: 100%;
            justify-content: stretch;
        }

        .reset-zoom-btn,
        .btn-download {
            flex: 1;
        }
    }
</style>

<!-- Modal del Visualizador -->
<div id="visualizadorModal" class="visualizador-modal">
    <div class="modal-content-visualizador">
        <div class="modal-header-visualizador">
            <div class="header-title-section">
                <h2><i class="fas fa-eye"></i> Visualizador de Radiografías - {{ paciente.nombre_completo }}</h2>
                <button class="btn-help-shortcuts" onclick="showKeyboardShortcuts()" title="Ver atajos de teclado">
                    <i class="fas fa-keyboard"></i> Atajos
                </button>
            </div>
            <button class="modal-close-visualizador" onclick="cerrarModalVisualizador()" title="Cerrar (ESC)">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>

        <div class="modal-controls-visualizador">
            <div class="control-group">
                <label for="modal-radio1-select">
                    <i class="fas fa-image"></i> Radiografía 1
                </label>
                <select id="modal-radio1-select" class="form-control">
                    <option value="">Seleccionar...</option>
                    {% for radiografia in radiografias %}
                    <option value="{{ radiografia.id }}" data-url="{{ radiografia.imagen.url }}"
                        data-label="{% if radiografia.fecha_tomada %}{{ radiografia.fecha_tomada|date:" d/m/Y" }}{% else
                        %}{{ radiografia.fecha_carga|date:"d/m/Y" }}{% endif %}">
                        {{ radiografia.get_tipo_display }}
                        {% if radiografia.fecha_tomada %}
                        - Tomada: {{ radiografia.fecha_tomada|date:"d/m/Y" }}
                        {% else %}
                        - Cargada: {{ radiografia.fecha_carga|date:"d/m/Y" }}
                        {% endif %}
                        {% if radiografia.cita %}
                        - Cita: {{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}
                        {% endif %}
                        {% if radiografia.descripcion %}
                        - {{ radiografia.descripcion|truncatewords:5 }}
                        {% endif %}
                        {% if radiografia.imagen_anotada %} (con anotaciones){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label for="modal-radio2-select">
                    <i class="fas fa-image"></i> Radiografía 2
                </label>
                <select id="modal-radio2-select" class="form-control">
                    <option value="">Seleccionar...</option>
                    {% for radiografia in radiografias %}
                    <option value="{{ radiografia.id }}" data-url="{{ radiografia.imagen.url }}"
                        data-label="{% if radiografia.fecha_tomada %}{{ radiografia.fecha_tomada|date:" d/m/Y" }}{% else
                        %}{{ radiografia.fecha_carga|date:"d/m/Y" }}{% endif %}"
                        data-has-annotations="{% if radiografia.imagen_anotada %}true{% else %}false{% endif %}">
                        {{ radiografia.get_tipo_display }}
                        {% if radiografia.fecha_tomada %}
                        - Tomada: {{ radiografia.fecha_tomada|date:"d/m/Y" }}
                        {% else %}
                        - Cargada: {{ radiografia.fecha_carga|date:"d/m/Y" }}
                        {% endif %}
                        {% if radiografia.cita %}
                        - Cita: {{ radiografia.cita.fecha_hora|date:"d/m/Y H:i" }}
                        {% endif %}
                        {% if radiografia.descripcion %}
                        - {{ radiografia.descripcion|truncatewords:5 }}
                        {% endif %}
                        {% if radiografia.imagen_anotada %} (con anotaciones){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-pencil-alt"></i> Color del Lápiz
                </label>
                <div class="color-buttons">
                    <button class="color-btn active" data-color="#ff0000" style="background: #ff0000; color: white;"
                        onclick="seleccionarColorModal('#ff0000')">
                        <i class="fas fa-circle"></i> Rojo
                    </button>
                    <button class="color-btn" data-color="#00ff00" style="background: #00ff00; color: #333;"
                        onclick="seleccionarColorModal('#00ff00')">
                        <i class="fas fa-circle"></i> Verde
                    </button>
                    <button class="color-btn" data-color="#0000ff" style="background: #0000ff; color: white;"
                        onclick="seleccionarColorModal('#0000ff')">
                        <i class="fas fa-circle"></i> Azul
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-sliders-h"></i> Ajustes de Imagen
                </label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div>
                        <label
                            style="font-size: 10px; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">
                            Brillo: <span id="brightness-value" style="color: #14b8a6; font-weight: 700;">100</span>%
                        </label>
                        <input type="range" id="brightness-slider" min="0" max="200" value="100"
                            oninput="adjustBrightness(this.value)">
                    </div>
                    <div>
                        <label
                            style="font-size: 10px; color: #64748b; font-weight: 600; margin-bottom: 4px; display: block;">
                            Contraste: <span id="contrast-value" style="color: #14b8a6; font-weight: 700;">100</span>%
                        </label>
                        <input type="range" id="contrast-slider" min="0" max="200" value="100"
                            oninput="adjustContrast(this.value)">
                    </div>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-tools"></i> Herramientas
                </label>
                <div class="tool-buttons">
                    <button class="tool-btn" onclick="rotateImage(1, 90)" title="Rotar Radiografía 1 (R)">
                        <i class="fas fa-redo"></i> Rotar 1
                    </button>
                    <button class="tool-btn" onclick="rotateImage(2, 90)" title="Rotar Radiografía 2">
                        <i class="fas fa-redo"></i> Rotar 2
                    </button>
                    <button class="tool-btn" onclick="toggleInvertColors()" title="Invertir colores (I)"
                        id="invert-colors-btn">
                        <i class="fas fa-adjust"></i> Negativo
                    </button>
                    <button id="modal-clear-btn" class="tool-btn btn-danger" title="Limpiar todo (L)"
                        onclick="limpiarTodoModal()">
                        <i class="fas fa-broom"></i> Limpiar
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-pencil-alt"></i> Herramienta de Dibujo
                </label>
                <div class="tool-buttons">
                    <button class="tool-btn active" id="tool-freehand-btn" onclick="setTool('freehand')"
                        title="Dibujo libre (D)">
                        <i class="fas fa-pencil-alt"></i> Dibujar
                    </button>
                    <button class="tool-btn" onclick="clearMeasurements()" title="Limpiar dibujos">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label>
                    <i class="fas fa-expand"></i> Vista
                </label>
                <div class="tool-buttons">
                    <button class="tool-btn" onclick="toggleFullscreen()" title="Pantalla completa (F11)">
                        <i class="fas fa-expand"></i> Pantalla Completa
                    </button>
                    <button class="tool-btn" onclick="syncZoom()" title="Sincronizar zoom entre ambas imágenes">
                        <i class="fas fa-link"></i> Sincronizar Zoom
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-canvas-container">
            <div class="modal-canvas-wrapper" id="modal-canvas-container-1">
                <canvas id="modal-canvas1"></canvas>
                <div class="modal-canvas-info">
                    <div class="canvas-info-left">
                        <span id="modal-canvas1-label">Radiografía 1</span>
                        <span class="zoom-indicator" id="zoom-indicator-1">100%</span>
                    </div>
                    <div class="canvas-actions">
                        <button class="reset-zoom-btn" onclick="resetModalZoom(1)" title="Restablecer zoom (0)">
                            <i class="fas fa-search-minus"></i> Zoom: <span id="zoom-value-1">100%</span>
                        </button>
                        <button class="btn-download" onclick="downloadCanvas(1)" title="Descargar imagen (Ctrl+D)">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-canvas-wrapper" id="modal-canvas-container-2">
                <canvas id="modal-canvas2"></canvas>
                <div class="modal-canvas-info">
                    <div class="canvas-info-left">
                        <span id="modal-canvas2-label">Radiografía 2</span>
                        <span class="zoom-indicator" id="zoom-indicator-2">100%</span>
                    </div>
                    <div class="canvas-actions">
                        <button class="reset-zoom-btn" onclick="resetModalZoom(2)" title="Restablecer zoom (0)">
                            <i class="fas fa-search-minus"></i> Zoom: <span id="zoom-value-2">100%</span>
                        </button>
                        <button class="btn-download" onclick="downloadCanvas(2)" title="Descargar imagen (Ctrl+D)">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    console.log('Cargando componente visualizador de radiografías...');

    // Variables globales del modal
    let modalCanvas1, modalCtx1, modalImg1 = null;
    let modalCanvas2, modalCtx2, modalImg2 = null;
    let modalIsDrawing = false;
    let modalCurrentColor = '#ff0000';
    let modalBrushSize = 3;
    let modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
    let modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };
    let currentTool = 'freehand'; // Solo dibujo libre
    let isInverted = false;
    let isFullscreen = false;
    let isZoomSynced = false;
    let measurements = { canvas1: [], canvas2: [] }; // Inicializar measurements
    let modalEventListenersSetup = false;

    // Definir la función globalmente primero
    window.abrirModalVisualizador = function (radiografiaId) {
        console.log('Intentando abrir visualizador para ID:', radiografiaId);
        try {
            const modal = document.getElementById('visualizadorModal');
            if (!modal) {
                console.error('Modal no encontrado');
                alert('Error: No se pudo iniciar el visualizador (Modal no encontrado).');
                return;
            }

            console.log('Modal encontrado. Estado actual:', modal.style.display, modal.className);

            // Mover al body para asegurar que se vea por encima de todo
            if (modal.parentNode !== document.body) {
                console.log('Moviendo modal al body para asegurar visibilidad...');
                document.body.appendChild(modal);
            }

            // Forzar display flex antes de añadir la clase active
            modal.style.display = 'flex';

            // Pequeño timeout para asegurar que el navegador procese el cambio
            setTimeout(() => {
                modal.classList.add('active');
                console.log('Clase active añadida. Clases finales:', modal.className);
            }, 10);

            document.body.style.overflow = 'hidden';

            // Inicializar canvas
            modalCanvas1 = document.getElementById('modal-canvas1');
            modalCanvas2 = document.getElementById('modal-canvas2');

            if (!modalCanvas1 || !modalCanvas2) {
                console.error('Canvas no encontrado');
                return;
            }

            modalCtx1 = modalCanvas1.getContext('2d');
            modalCtx2 = modalCanvas2.getContext('2d');

            // Resetear estado
            isInverted = false;
            currentTool = 'freehand';
            updateToolButtons();

            // Verificar datos
            console.log('Verificando datos para ID:', radiografiaId);
            if (typeof radiografiasData !== 'undefined') {
                console.log('IDs disponibles:', Object.keys(radiografiasData));
            } else {
                console.error('radiografiasData no está definido');
            }

            // Seleccionar la radiografía
            const select1 = document.getElementById('modal-radio1-select');
            if (select1 && typeof radiografiasData !== 'undefined' && radiografiasData[radiografiaId]) {
                select1.value = radiografiaId;
                console.log('Cargando imagen inicial:', radiografiasData[radiografiaId].url);
                loadModalImage(1, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label);
            } else {
                console.warn('No se encontraron datos para la radiografía ID:', radiografiaId);
            }

            // Event listeners solo una vez
            if (!modalEventListenersSetup) {
                if (select1) {
                    select1.addEventListener('change', function () {
                        const radiografiaId = this.value;
                        if (radiografiaId && radiografiasData[radiografiaId]) {
                            loadModalImage(1, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label);
                        }
                    });
                }

                const select2 = document.getElementById('modal-radio2-select');
                if (select2) {
                    select2.addEventListener('change', function () {
                        const radiografiaId = this.value;
                        if (radiografiaId && radiografiasData[radiografiaId]) {
                            loadModalImage(2, radiografiasData[radiografiaId].url, radiografiasData[radiografiaId].label);
                        }
                    });
                }

                // Eventos de dibujo
                setupModalDrawingCanvas(modalCanvas1, modalCtx1, 1);
                setupModalDrawingCanvas(modalCanvas2, modalCtx2, 2);

                // Zoom con rueda del mouse (mejorado)
                setupModalZoom(modalCanvas1, 1);
                setupModalZoom(modalCanvas2, 2);

                // Actualizar indicadores iniciales
                updateZoomIndicators();
                
                // Configurar atajos de teclado
                setupKeyboardShortcuts();
                modalEventListenersSetup = true;
            }
        } catch (error) {
            console.error('Error abriendo visualizador:', error);
            alert('Error al abrir el visualizador. Por favor, recargue la página.');
        }
    };

    // Función para cargar imagen en el modal (debe estar fuera de abrirModalVisualizador)
    function loadModalImage(canvasNum, url, label) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function () {
            const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
            const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
            const container = canvasNum === 1 ? document.getElementById('modal-canvas-container-1') :
                document.getElementById('modal-canvas-container-2');

            if (!container) return;

            // Establecer el tamaño del canvas basado en el contenedor
            const containerRect = container.getBoundingClientRect();
            const maxWidth = containerRect.width - 40; // Margen
            const maxHeight = containerRect.height - 100; // Espacio para controles

            // Calcular tamaño manteniendo la proporción
            let canvasWidth = img.width;
            let canvasHeight = img.height;

            if (canvasWidth > maxWidth) {
                canvasHeight = (canvasHeight * maxWidth) / canvasWidth;
                canvasWidth = maxWidth;
            }
            if (canvasHeight > maxHeight) {
                canvasWidth = (canvasWidth * maxHeight) / canvasHeight;
                canvasHeight = maxHeight;
            }

            canvas.width = img.width;
            canvas.height = img.height;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';

            // Guardar imagen
            if (canvasNum === 1) modalImg1 = img;
            else modalImg2 = img;

            // Resetear zoom
            if (canvasNum === 1) modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
            else modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };

            // Actualizar label
            if (canvasNum === 1) {
                const labelEl = document.getElementById('modal-canvas1-label');
                if (labelEl) labelEl.textContent = label;
            } else {
                const labelEl = document.getElementById('modal-canvas2-label');
                if (labelEl) labelEl.textContent = label;
            }

            drawModalImageOnCanvasWithFilters(canvasNum);
            updateZoomIndicators();
        };
        img.onerror = function () {
            console.error('Error cargando imagen:', url);
            alert('Error al cargar la imagen. Por favor, verifique que la imagen existe.');
        };
        img.src = url;
    }

    // Función para cerrar el modal
    window.cerrarModalVisualizador = function() {
        const modal = document.getElementById('visualizadorModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
            document.body.style.overflow = '';
        }
    };

    // Hacer funciones globales accesibles
    window.seleccionarColorModal = function(color) {
        modalCurrentColor = color;
        document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
        const btn = document.querySelector(`.color-btn[data-color="${color}"]`);
        if (btn) btn.classList.add('active');
    };

    window.limpiarTodoModal = function() {
        if (confirm('¿Estás seguro de limpiar todos los dibujos?')) {
            if (modalCtx1 && modalCanvas1) {
                modalCtx1.clearRect(0, 0, modalCanvas1.width, modalCanvas1.height);
                drawModalImageOnCanvasWithFilters(1);
            }
            if (modalCtx2 && modalCanvas2) {
                modalCtx2.clearRect(0, 0, modalCanvas2.width, modalCanvas2.height);
                drawModalImageOnCanvasWithFilters(2);
            }
        }
    };

    // Variables para ajustes de imagen (globales)
    let brightness = 100;
    let contrast = 100;
    let rotation1 = 0;
    let rotation2 = 0;

    // Funciones globales para ajustes
    window.adjustBrightness = function(value) {
        brightness = value;
        const el = document.getElementById('brightness-value');
        if (el) el.textContent = value;
        applyImageFilters();
    };

    window.adjustContrast = function(value) {
        contrast = value;
        const el = document.getElementById('contrast-value');
        if (el) el.textContent = value;
        applyImageFilters();
    };

    function applyImageFilters() {
        if (modalImg1) drawModalImageOnCanvasWithFilters(1);
        if (modalImg2) drawModalImageOnCanvasWithFilters(2);
    }

    window.rotateImage = function(canvasNum, degrees) {
        if (canvasNum === 1) {
            rotation1 = (rotation1 + degrees) % 360;
            drawModalImageOnCanvasWithFilters(1);
        } else {
            rotation2 = (rotation2 + degrees) % 360;
            drawModalImageOnCanvasWithFilters(2);
        }
    };

    window.downloadCanvas = function(canvasNum) {
        const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
        if (canvas) {
            const link = document.createElement('a');
            link.download = 'radiografia-' + new Date().getTime() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    };

    function updateZoomIndicators() {
        try {
            const zoom1 = Math.round(modalZoom1.scale * 100);
            const zoom2 = Math.round(modalZoom2.scale * 100);

            const indicator1 = document.getElementById('zoom-indicator-1');
            const indicator2 = document.getElementById('zoom-indicator-2');
            const value1 = document.getElementById('zoom-value-1');
            const value2 = document.getElementById('zoom-value-2');

            if (indicator1) indicator1.textContent = zoom1 + '%';
            if (indicator2) indicator2.textContent = zoom2 + '%';
            if (value1) value1.textContent = zoom1 + '%';
            if (value2) value2.textContent = zoom2 + '%';
        } catch (error) {
            console.error('Error actualizando indicadores de zoom:', error);
        }
    }

    window.setTool = function(tool) {
        currentTool = tool;
        updateToolButtons();
        if (modalCanvas1) modalCanvas1.style.cursor = 'crosshair';
        if (modalCanvas2) modalCanvas2.style.cursor = 'crosshair';
    };

    function updateToolButtons() {
        try {
            const freehandBtn = document.getElementById('tool-freehand-btn');
            if (freehandBtn) freehandBtn.classList.toggle('active', currentTool === 'freehand');
        } catch (error) {
            console.error('Error actualizando botones de herramientas:', error);
        }
    }

    window.toggleInvertColors = function() {
        try {
            isInverted = !isInverted;
            const btn = document.getElementById('invert-colors-btn');
            if (btn) {
                btn.classList.toggle('active', isInverted);
            }
            applyImageFilters();
        } catch (error) {
            console.error('Error invirtiendo colores:', error);
        }
    };

    window.toggleFullscreen = function() {
        try {
            const modal = document.getElementById('visualizadorModal');
            if (!modal) return;

            if (!isFullscreen) {
                if (modal.requestFullscreen) {
                    modal.requestFullscreen();
                } else if (modal.webkitRequestFullscreen) {
                    modal.webkitRequestFullscreen();
                } else if (modal.msRequestFullscreen) {
                    modal.msRequestFullscreen();
                }
                isFullscreen = true;
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                isFullscreen = false;
            }
        } catch (error) {
            console.error('Error en pantalla completa:', error);
        }
    };

    window.syncZoom = function() {
        try {
            isZoomSynced = !isZoomSynced;
            if (isZoomSynced) {
                modalZoom2.scale = modalZoom1.scale;
                modalZoom2.offsetX = modalZoom1.offsetX;
                modalZoom2.offsetY = modalZoom1.offsetY;
                drawModalImageOnCanvasWithFilters(2);
                updateZoomIndicators();
            }
        } catch (error) {
            console.error('Error sincronizando zoom:', error);
        }
    };

    window.clearMeasurements = function() {
        try {
            if (confirm('¿Estás seguro de limpiar todos los dibujos?')) {
                if (modalCtx1 && modalCanvas1) {
                    modalCtx1.clearRect(0, 0, modalCanvas1.width, modalCanvas1.height);
                    drawModalImageOnCanvasWithFilters(1);
                }
                if (modalCtx2 && modalCanvas2) {
                    modalCtx2.clearRect(0, 0, modalCanvas2.width, modalCanvas2.height);
                    drawModalImageOnCanvasWithFilters(2);
                }
            }
        } catch (error) {
            console.error('Error limpiando dibujos:', error);
        }
    };

    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('visualizadorModal');
            if (!modal || !modal.classList.contains('active')) return;

            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            try {
                if (e.key === 'Escape') {
                    cerrarModalVisualizador();
                    e.preventDefault();
                }
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                }
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    if (modalImg1) downloadCanvas(1);
                }
                if (e.key === '0') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        resetModalZoom(2);
                    } else {
                        resetModalZoom(1);
                    }
                }
                if (e.key === 'i' || e.key === 'I') {
                    e.preventDefault();
                    toggleInvertColors();
                }
                if (e.key === 'l' || e.key === 'L') {
                    e.preventDefault();
                    limpiarTodoModal();
                }
                if (e.key === 'd' && !e.ctrlKey) {
                    e.preventDefault();
                    setTool('freehand');
                }
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    rotateImage(1, 90);
                }
                if (e.key === '+' || e.key === '=') {
                    e.preventDefault();
                    zoomIn(1);
                }
                if (e.key === '-' || e.key === '_') {
                    e.preventDefault();
                    zoomOut(1);
                }
            } catch (error) {
                console.error('Error en atajo de teclado:', error);
            }
        });
    }

    function zoomIn(canvasNum) {
        try {
            const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
            zoom.scale = Math.min(zoom.scale * 1.2, 5);
            drawModalImageOnCanvasWithFilters(canvasNum);
            updateZoomIndicators();
            if (isZoomSynced && canvasNum === 1) {
                syncZoom();
            }
        } catch (error) {
            console.error('Error en zoom in:', error);
        }
    }

    function zoomOut(canvasNum) {
        try {
            const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
            zoom.scale = Math.max(zoom.scale / 1.2, 0.5);
            drawModalImageOnCanvasWithFilters(canvasNum);
            updateZoomIndicators();
            if (isZoomSynced && canvasNum === 1) {
                syncZoom();
            }
        } catch (error) {
            console.error('Error en zoom out:', error);
        }
    }

    function setupModalZoom(canvas, canvasNum) {
        if (!canvas) return;

        canvas.addEventListener('wheel', function (e) {
            e.preventDefault();
            try {
                const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.5, Math.min(5, zoom.scale * zoomFactor));

                zoom.offsetX = mouseX - (mouseX - zoom.offsetX) * (newScale / zoom.scale);
                zoom.offsetY = mouseY - (mouseY - zoom.offsetY) * (newScale / zoom.scale);
                zoom.scale = newScale;

                drawModalImageOnCanvasWithFilters(canvasNum);
                updateZoomIndicators();

                if (isZoomSynced && canvasNum === 1) {
                    syncZoom();
                }
            } catch (error) {
                console.error('Error en zoom con rueda:', error);
            }
        });

        let isPanning = false;
        let panStart = { x: 0, y: 0 };

        canvas.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        canvas.addEventListener('mousedown', function (e) {
            if (e.button === 2 || e.ctrlKey) {
                isPanning = true;
                const rect = canvas.getBoundingClientRect();
                panStart.x = e.clientX - rect.left;
                panStart.y = e.clientY - rect.top;
                canvas.style.cursor = 'grabbing';
            }
        });

        canvas.addEventListener('mousemove', function (e) {
            if (isPanning) {
                try {
                    const rect = canvas.getBoundingClientRect();
                    const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;

                    zoom.offsetX += (e.clientX - rect.left) - panStart.x;
                    zoom.offsetY += (e.clientY - rect.top) - panStart.y;

                    panStart.x = e.clientX - rect.left;
                    panStart.y = e.clientY - rect.top;

                    drawModalImageOnCanvasWithFilters(canvasNum);
                    updateZoomIndicators();
                } catch (error) {
                    console.error('Error en pan:', error);
                }
            }
        });

        canvas.addEventListener('mouseup', function () {
            if (isPanning) {
                isPanning = false;
                canvas.style.cursor = 'crosshair';
            }
        });
    }

    window.resetModalZoom = function(canvasNum) {
        try {
            if (canvasNum === 1) {
                modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
                drawModalImageOnCanvasWithFilters(1);
            } else {
                modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };
                drawModalImageOnCanvasWithFilters(2);
            }
            updateZoomIndicators();
        } catch (error) {
            console.error('Error reseteando zoom:', error);
        }
    };

    function setupModalDrawingCanvas(canvas, ctx, canvasNum) {
        if (!canvas) return;

        let lastX, lastY;
        let isDrawing = false;

        function getCanvasCoordinates(e) {
            try {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / canvas.offsetWidth;
                const scaleY = canvas.height / canvas.offsetHeight;

                let clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
                let clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);

                const x = (clientX - rect.left) * scaleX;
                const y = (clientY - rect.top) * scaleY;

                const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
                const adjustedX = (x - zoom.offsetX * scaleX) / zoom.scale;
                const adjustedY = (y - zoom.offsetY * scaleY) / zoom.scale;

                return { x: adjustedX, y: adjustedY };
            } catch (error) {
                console.error('Error obteniendo coordenadas:', error);
                return { x: 0, y: 0 };
            }
        }

        function startDraw(e) {
            if (e.button === 2 || e.ctrlKey) return;
            try {
                e.preventDefault();
                isDrawing = true;
                const coords = getCanvasCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
            } catch (error) {
                console.error('Error iniciando dibujo:', error);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            try {
                const coords = getCanvasCoordinates(e);
                const currentX = coords.x;
                const currentY = coords.y;
                const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;

                ctx.save();
                ctx.translate(zoom.offsetX * (canvas.width / canvas.offsetWidth), zoom.offsetY * (canvas.height / canvas.offsetHeight));
                ctx.scale(zoom.scale, zoom.scale);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.lineWidth = modalBrushSize / zoom.scale;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = modalCurrentColor;
                ctx.globalCompositeOperation = 'source-over';
                ctx.stroke();

                ctx.restore();

                lastX = currentX;
                lastY = currentY;
            } catch (error) {
                console.error('Error dibujando:', error);
            }
        }

        function stopDraw() {
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDraw);
        canvas.addEventListener('mouseout', stopDraw);
        canvas.addEventListener('touchstart', startDraw);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDraw);
        canvas.addEventListener('touchcancel', stopDraw);
    }

    function drawModalImageOnCanvasWithFilters(canvasNum) {
        try {
            const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
            const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
            const img = canvasNum === 1 ? modalImg1 : modalImg2;
            const zoom = canvasNum === 1 ? modalZoom1 : modalZoom2;
            const rotation = canvasNum === 1 ? rotation1 : rotation2;

            if (!img || !canvas || !ctx) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();

            let filterString = `brightness(${brightness}%) contrast(${contrast}%)`;
            if (isInverted) {
                filterString += ' invert(1)';
            }
            ctx.filter = filterString;

            if (rotation !== 0) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((rotation * Math.PI) / 180);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);
            }

            ctx.translate(zoom.offsetX, zoom.offsetY);
            ctx.scale(zoom.scale, zoom.scale);

            ctx.drawImage(img, 0, 0);
            ctx.restore();

            const key = canvasNum === 1 ? 'canvas1' : 'canvas2';
            if (measurements && measurements[key]) {
                measurements[key].forEach(measurement => {
                    ctx.save();
                    ctx.translate(zoom.offsetX * (canvas.width / canvas.offsetWidth), zoom.offsetY * (canvas.height / canvas.offsetHeight));
                    ctx.scale(zoom.scale, zoom.scale);
                    ctx.beginPath();
                    ctx.moveTo(measurement.start.x, measurement.start.y);
                    ctx.lineTo(measurement.end.x, measurement.end.y);
                    ctx.lineWidth = 2 / zoom.scale;
                    ctx.strokeStyle = measurement.color;
                    ctx.stroke();

                    const dx = measurement.end.x - measurement.start.x;
                    const dy = measurement.end.y - measurement.start.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const midX = (measurement.start.x + measurement.end.x) / 2;
                    const midY = (measurement.start.y + measurement.end.y) / 2;

                    ctx.fillStyle = measurement.color;
                    ctx.font = `${12 / zoom.scale}px Arial`;
                    ctx.fillText(Math.round(distance) + 'px', midX, midY - 5 / zoom.scale);
                    ctx.restore();
                });
            }
        } catch (error) {
            console.error('Error dibujando imagen con filtros:', error);
        }
    }

    function loadModalImage(canvasNum, url, label) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function () {
            const canvas = canvasNum === 1 ? modalCanvas1 : modalCanvas2;
            const ctx = canvasNum === 1 ? modalCtx1 : modalCtx2;
            const container = canvasNum === 1 ? document.getElementById('modal-canvas-container-1') : document.getElementById('modal-canvas-container-2');

            if (!container) return;

            const containerRect = container.getBoundingClientRect();
            const maxWidth = containerRect.width - 40;
            const maxHeight = containerRect.height - 100;

            let canvasWidth = img.width;
            let canvasHeight = img.height;

            if (canvasWidth > maxWidth) {
                canvasHeight = (canvasHeight * maxWidth) / canvasWidth;
                canvasWidth = maxWidth;
            }
            if (canvasHeight > maxHeight) {
                canvasWidth = (canvasWidth * maxHeight) / canvasHeight;
                canvasHeight = maxHeight;
            }

            canvas.width = img.width;
            canvas.height = img.height;
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';

            if (canvasNum === 1) modalImg1 = img;
            else modalImg2 = img;

            if (canvasNum === 1) modalZoom1 = { scale: 1, offsetX: 0, offsetY: 0 };
            else modalZoom2 = { scale: 1, offsetX: 0, offsetY: 0 };

            if (canvasNum === 1) {
                const labelEl = document.getElementById('modal-canvas1-label');
                if (labelEl) labelEl.textContent = label;
            } else {
                const labelEl = document.getElementById('modal-canvas2-label');
                if (labelEl) labelEl.textContent = label;
            }

            drawModalImageOnCanvasWithFilters(canvasNum);
            updateZoomIndicators();
        };
        img.onerror = function () {
            console.error('Error cargando imagen:', url);
            alert('Error al cargar la imagen. Por favor, verifique que la imagen existe.');
        };
        img.src = url;
    }

    window.showKeyboardShortcuts = function() {
        const shortcuts = [
            { key: 'ESC', action: 'Cerrar visualizador' },
            { key: 'F11', action: 'Pantalla completa' },
            { key: 'Ctrl+D', action: 'Descargar imagen' },
            { key: '0', action: 'Restablecer zoom' },
            { key: '+ / -', action: 'Zoom in/out' },
            { key: 'I', action: 'Invertir colores (negativo)' },
            { key: 'L', action: 'Limpiar dibujos' },
            { key: 'D', action: 'Herramienta de dibujo libre' },
            { key: 'R', action: 'Rotar imagen 1' },
            { key: 'Ctrl+Click / Click derecho', action: 'Mover imagen (Pan)' },
            { key: 'Rueda del mouse', action: 'Zoom' }
        ];

        let message = 'ATAJOS DE TECLADO:\n\n';
        shortcuts.forEach(shortcut => {
            message += `${shortcut.key.padEnd(25)} → ${shortcut.action}\n`;
        });

        alert(message);
    };

    // Manejar cambios de pantalla completa
    document.addEventListener('fullscreenchange', function () {
        isFullscreen = !!document.fullscreenElement;
    });

    document.addEventListener('webkitfullscreenchange', function () {
        isFullscreen = !!document.webkitFullscreenElement;
    });

    document.addEventListener('msfullscreenchange', function () {
        isFullscreen = !!document.msFullscreenElement;
    });

    // Verificar que la función esté disponible
    console.log('Visualizador cargado. abrirModalVisualizador disponible:', typeof window.abrirModalVisualizador);
</script>